<!doctype html>
<html lang="en">
  <head>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.13/html-to-image.min.js"
      integrity="sha512-iZ2ORl595Wx6miw+GuadDet4WQbdSWS3JLMoNfY8cRGoEFy6oT3G9IbcrBeL6AfkgpA51ETt/faX6yLV+/gFJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style type="text/css" data-guidde-blur-css="true">
      /* Repetition and !important are needed to override host page top-level styles */
      /* CSS Variables are defined by JS */

      .GUIDDE-JS-BlurCandidate.GUIDDE-JS-BlurCandidate.GUIDDE-JS-BlurCandidate {
        background-color: var(--guidde-highlight-bg) !important;
        outline: var(--guidde-highlight-border) !important;
      }

      .GUIDDE-JS-AutoBlurred.GUIDDE-JS-AutoBlurred.GUIDDE-JS-AutoBlurred,
      .GUIDDE-JS-Blurred.GUIDDE-JS-Blurred.GUIDDE-JS-Blurred {
        filter: var(--guidde-blur) !important;
      }
    </style>
    <script>
      (function () {
        const originalConsole = window.console;
        window.console = {
          log: (...args) => {
            originalConsole.log(...args);
            window.parent.postMessage(
              { type: "console", message: args.join(" ") },
              "*",
            );
          },
          error: (...args) => {
            originalConsole.error(...args);
            window.parent.postMessage(
              { type: "console", message: "Error: " + args.join(" ") },
              "*",
            );
          },
          warn: (...args) => {
            originalConsole.warn(...args);
            window.parent.postMessage(
              { type: "console", message: "Warning: " + args.join(" ") },
              "*",
            );
          },
        };

        let requestId = 0;
        let callbacksMap = new Map();
        let streamControllers = new Map();

        window.claude = {
          complete: (prompt) => {
            return new Promise((resolve, reject) => {
              const id = requestId++;
              callbacksMap.set(id, { resolve, reject });
              window.parent.postMessage(
                { type: "claudeComplete", id, prompt },
                "*",
              );
            });
          },
        };

        window.storage = {
          get: (key, shared = false) => {
            return new Promise((resolve, reject) => {
              const id = requestId++;
              callbacksMap.set(id, { resolve, reject });
              window.parent.postMessage(
                { type: "storageGet", id, key, shared },
                "*",
              );
            });
          },
          set: (key, value, shared = false) => {
            return new Promise((resolve, reject) => {
              const id = requestId++;
              callbacksMap.set(id, { resolve, reject });
              window.parent.postMessage(
                { type: "storageSet", id, key, value, shared },
                "*",
              );
            });
          },
          delete: (key, shared = false) => {
            return new Promise((resolve, reject) => {
              const id = requestId++;
              callbacksMap.set(id, { resolve, reject });
              window.parent.postMessage(
                { type: "storageDelete", id, key, shared },
                "*",
              );
            });
          },
          list: (prefix, shared = false) => {
            return new Promise((resolve, reject) => {
              const id = requestId++;
              callbacksMap.set(id, { resolve, reject });
              window.parent.postMessage(
                { type: "storageList", id, prefix, shared },
                "*",
              );
            });
          },
        };

        let pendingBlobs = new Map();
        URL.createObjectURL = (blob) => {
          // Store the blob and create an ID and URL for it
          const blobId = `blob-${Date.now()}-${Math.random()}`;
          pendingBlobs.set(blobId, blob);
          return `blob-request://${blobId}`;
        };

        URL.revokeObjectURL = (url) => {
          // Remove the blob from our store
          const blobId = url.replace("blob-request://", "");
          pendingBlobs.delete(blobId);
        };

        const getBlobFromURL = (url) => {
          const blobId = url.replace("blob-request://", "");
          return pendingBlobs.get(blobId);
        };

        // Override global fetch with streaming support
        window.fetch = (url, init = {}) => {
          return new Promise((resolve, reject) => {
            const id = requestId++;
            const channelId = `fetch-${id}-${Date.now()}`;

            callbacksMap.set(id, {
              resolve: (response) => {
                // Create a ReadableStream for the response body
                const stream = new ReadableStream({
                  start(controller) {
                    streamControllers.set(channelId, controller);
                  },
                  cancel() {
                    streamControllers.delete(channelId);
                  },
                });

                // Create and return the Response with the stream
                resolve(
                  new Response(stream, {
                    status: response.status,
                    statusText: response.statusText,
                    headers: response.headers,
                  }),
                );
              },
              reject,
              channelId,
            });

            window.parent.postMessage(
              {
                type: "proxyFetch",
                id,
                url,
                init,
                channelId,
              },
              "*",
            );
          });
        };

        window.addEventListener("message", async (event) => {
          const trustedOrigin = new URL(
            document.referrer || window.location.href,
          ).origin;
          if (event.origin !== trustedOrigin) return;
          if (event.source !== window.parent) return;
          if (!event.data || typeof event.data.type !== "string") return;

          if (event.data.type === "takeScreenshot") {
            const rootElement = document.getElementById(
              "artifacts-component-root-html",
            );
            if (!rootElement) {
              window.parent.postMessage(
                {
                  type: "screenshotError",
                  error: new Error("Root element not found"),
                },
                "*",
              );
              return;
            }
            const screenshot = await htmlToImage.toPng(rootElement, {
              imagePlaceholder:
                "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdjePDgwX8ACOQDoNsk0PMAAAAASUVORK5CYII=",
            });
            window.parent.postMessage(
              {
                type: "screenshotData",
                data: screenshot,
              },
              "*",
            );
          } else if (event.data.type === "claudeComplete") {
            const callback = callbacksMap.get(event.data.id);
            if (!callback) return;
            if (event.data.error) {
              callback.reject(new Error(event.data.error));
            } else {
              callback.resolve(event.data.completion);
            }
            callbacksMap.delete(event.data.id);
          } else if (event.data.type === "proxyFetchResponse") {
            const callback = callbacksMap.get(event.data.id);
            if (!callback) return;
            if (event.data.error) {
              callback.reject(new Error(event.data.error));
              callbacksMap.delete(event.data.id);
            } else {
              // Initial response with headers, status, etc.
              callback.resolve({
                status: event.data.status,
                statusText: event.data.statusText,
                headers: event.data.headers,
              });
              // Don't delete the callback yet if streaming
              if (!event.data.body) {
                callbacksMap.delete(event.data.id);
              }
            }
          } else if (event.data.type === "proxyFetchStream") {
            // Handle streaming data chunks
            const controller = streamControllers.get(event.data.channelId);
            if (controller) {
              if (event.data.error) {
                controller.error(new Error(event.data.error));
                streamControllers.delete(event.data.channelId);
              } else if (event.data.done) {
                controller.close();
                streamControllers.delete(event.data.channelId);
                // Clean up the callback
                const callback = Array.from(callbacksMap.entries()).find(
                  ([_, value]) => value.channelId === event.data.channelId,
                );
                if (callback) {
                  callbacksMap.delete(callback[0]);
                }
              } else if (event.data.chunk) {
                controller.enqueue(new Uint8Array(event.data.chunk));
              }
            }
          } else if (event.data.type === "storageGet") {
            const callback = callbacksMap.get(event.data.id);
            if (!callback) return;
            if (event.data.error) {
              callback.reject(new Error(event.data.error));
            } else {
              callback.resolve(event.data.result);
            }
            callbacksMap.delete(event.data.id);
          } else if (event.data.type === "storageSet") {
            const callback = callbacksMap.get(event.data.id);
            if (!callback) return;
            if (event.data.error) {
              callback.reject(new Error(event.data.error));
            } else {
              callback.resolve(event.data.result);
            }
            callbacksMap.delete(event.data.id);
          } else if (event.data.type === "storageDelete") {
            const callback = callbacksMap.get(event.data.id);
            if (!callback) return;
            if (event.data.error) {
              callback.reject(new Error(event.data.error));
            } else {
              callback.resolve(event.data.result);
            }
            callbacksMap.delete(event.data.id);
          } else if (event.data.type === "storageList") {
            const callback = callbacksMap.get(event.data.id);
            if (!callback) return;
            if (event.data.error) {
              callback.reject(new Error(event.data.error));
            } else {
              callback.resolve(event.data.result);
            }
            callbacksMap.delete(event.data.id);
          }
        });

        window.addEventListener("click", (event) => {
          const isEl = event.target instanceof HTMLElement;
          if (!isEl) return;

          // find ancestor links
          const linkEl = event.target.closest("a");
          if (!linkEl || !linkEl.href) return;

          event.preventDefault();
          event.stopImmediatePropagation();

          if (linkEl.href.startsWith("blob-request:")) {
            const blob = getBlobFromURL(linkEl.href);
            if (!blob) return;
            void blob.arrayBuffer().then((data) => {
              window.parent.postMessage({
                type: "downloadFile",
                filename: linkEl.download,
                data,
                mimeType: blob.type || "application/octet-stream",
              });
            });
          } else if (linkEl.href.startsWith("data:")) {
            const [header, base64Data] = linkEl.href.split(",");
            const mimeMatch = header.match(/data:([^;]+)/);
            const mimeType = mimeMatch
              ? mimeMatch[1]
              : "application/octet-stream";
            const binaryString = atob(base64Data);
            const data = Uint8Array.from(binaryString, (c) =>
              c.charCodeAt(0),
            ).buffer;
            window.parent.postMessage({
              type: "downloadFile",
              filename: linkEl.download,
              data,
              mimeType,
            });
          } else {
            let linkUrl;
            try {
              linkUrl = new URL(linkEl.href);
            } catch (error) {
              return;
            }

            if (linkUrl.hostname === window.location.hostname) return;

            window.parent.postMessage(
              {
                type: "openExternal",
                href: linkEl.href,
              },
              "*",
            );
          }
        });

        const originalOpen = window.open;
        window.open = function (url) {
          window.parent.postMessage(
            {
              type: "openExternal",
              href: url,
            },
            "*",
          );
        };

        window.addEventListener("error", (event) => {
          window.parent.postMessage(
            { type: "console", message: "Uncaught Error: " + event.message },
            "*",
          );
        });
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OutcomeHQ — Daily Launchpad</title>
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&amp;display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
      :root {
        --sidebar-bg: #1e1245;
        --sidebar-active: #2d1b69;
        --sidebar-hover: rgba(255, 255, 255, 0.08);
        --sidebar-text: rgba(255, 255, 255, 0.6);
        --sidebar-text-active: #fff;
        --page-bg: #f3f4f6;
        --card-bg: #fff;
        --card-border: #e8e4f0;
        --text-primary: #1a1135;
        --text-secondary: #6b6480;
        --text-tertiary: #9990ab;
        --purple-accent: #6c5ce7;
        --purple-light: #a29bfe;
        --purple-bg: #f0eeff;
        --purple-dark: #2d1b69;
        --coral: #e17055;
        --coral-light: #fab1a0;
        --coral-bg: #fff0ed;
        --teal: #00b894;
        --teal-light: #55efc4;
        --teal-bg: #e8faf5;
        --amber: #fdcb6e;
        --amber-bg: #fef9e7;
        --red: #d63031;
        --blue: #0984e3;
        --blue-light: #74b9ff;
        --stat-card-bg: #2d1b69;
        --stat-card-text: rgba(255, 255, 255, 0.65);
        --stat-card-value: #fff;
        --live-green: #00b894;
        --font: "DM Sans", -apple-system, BlinkMacSystemFont, sans-serif;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: var(--font);
        background: var(--page-bg);
        color: var(--text-primary);
        overflow-x: hidden;
      }

      /* Sidebar */
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: 64px;
        background: var(--sidebar-bg);
        z-index: 100;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 16px 0;
      }
      .sidebar-logo {
        width: 36px;
        height: 36px;
        margin-bottom: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .sidebar-logo svg {
        width: 32px;
        height: 32px;
      }
      .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 100%;
        padding: 0 8px;
      }
      .sidebar-item {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        border-radius: 12px;
        cursor: pointer;
        color: var(--sidebar-text);
        transition: all 0.2s;
        position: relative;
      }
      .sidebar-item:hover {
        background: var(--sidebar-hover);
        color: var(--sidebar-text-active);
      }
      .sidebar-item.active {
        background: var(--sidebar-active);
        color: var(--sidebar-text-active);
      }
      .sidebar-item svg {
        width: 22px;
        height: 22px;
      }
      .sidebar-item .tooltip {
        position: absolute;
        left: 60px;
        background: #1a1135;
        color: #fff;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s;
        z-index: 10;
      }
      .sidebar-item:hover .tooltip {
        opacity: 1;
      }
      .sidebar-bottom {
        margin-top: auto;
        padding: 0 8px;
      }

      /* Main */
      .main {
        margin-left: 64px;
        min-height: 100vh;
      }

      /* Topbar */
      .topbar {
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--card-border);
        padding: 12px 32px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .topbar-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .topbar-brand {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
      }
      .topbar-brand .ohq-mark {
        font-weight: 700;
        color: var(--text-primary);
      }
      .topbar-brand .ohq-sub {
        font-weight: 400;
        color: var(--text-tertiary);
        font-size: 13px;
      }
      .topbar-search {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--page-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 8px 16px;
        width: 360px;
      }
      .topbar-search input {
        border: none;
        background: none;
        outline: none;
        font-family: var(--font);
        font-size: 13px;
        color: var(--text-primary);
        width: 100%;
      }
      .topbar-search input::placeholder {
        color: var(--text-tertiary);
      }
      .topbar-search svg {
        width: 16px;
        height: 16px;
        color: var(--text-tertiary);
        flex-shrink: 0;
      }
      .topbar-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .topbar-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--purple-accent), var(--coral));
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 12px;
        font-weight: 600;
      }

      /* Brand Header */
      .brand-header {
        padding: 24px 32px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .brand-info {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .brand-logo {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        background: #ee7623;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
        color: #fff;
        letter-spacing: -0.3px;
        line-height: 1.1;
        text-align: center;
      }
      .brand-meta h1 {
        font-size: 22px;
        font-weight: 700;
      }
      .brand-meta .brand-cat {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 2px;
      }
      .brand-actions {
        display: flex;
        gap: 8px;
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        border-radius: 8px;
        font-family: var(--font);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.15s;
      }
      .btn-primary {
        background: var(--purple-accent);
        color: #fff;
      }
      .btn-primary:hover {
        background: #5a4bd6;
      }
      .btn-outline {
        background: #fff;
        color: var(--text-primary);
        border: 1px solid var(--card-border);
      }
      .btn-outline:hover {
        border-color: var(--purple-accent);
        color: var(--purple-accent);
      }
      .btn-coral {
        background: var(--coral);
        color: #fff;
      }
      .btn-coral:hover {
        background: #d35d43;
      }
      .btn-teal {
        background: var(--teal);
        color: #fff;
      }
      .btn-teal:hover {
        background: #00a381;
      }
      .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
      }
      .btn svg {
        width: 16px;
        height: 16px;
      }
      .btn-ghost {
        background: none;
        border: none;
        color: var(--purple-accent);
        font-weight: 600;
        padding: 4px 0;
      }
      .btn-ghost:hover {
        text-decoration: underline;
      }

      /* Filters */
      .filter-bar {
        padding: 16px 32px;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .filter-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        background: var(--purple-bg);
        color: var(--purple-accent);
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.15s;
      }
      .filter-pill:hover {
        border-color: var(--purple-accent);
      }
      .filter-pill.active {
        background: var(--purple-accent);
        color: #fff;
      }
      .filter-pill.toggle {
        cursor: pointer;
      }
      .filter-pill.toggle:not(.active) {
        opacity: 0.45;
        text-decoration: line-through;
      }
      .filter-divider {
        width: 1px;
        height: 24px;
        background: var(--card-border);
        margin: 0 4px;
      }
      .filter-group {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .fg-label {
        font-size: 9.5px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-tertiary);
        min-width: 42px;
      }
      .fg-pills {
        display: flex;
        gap: 4px;
      }
      .filter-select {
        font-family: var(--font);
        font-size: 12px;
        font-weight: 500;
        padding: 6px 28px 6px 12px;
        border-radius: 20px;
        border: 1px solid var(--card-border);
        background: #fff
          url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%239990ab' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E")
          no-repeat right 10px center;
        color: var(--text-primary);
        cursor: pointer;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
      }
      .filter-select:focus {
        border-color: var(--purple-accent);
      }
      .compare-btn {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 12px;
        font-weight: 600;
        color: var(--purple-accent);
        cursor: pointer;
        padding: 6px 14px;
        border-radius: 20px;
        border: 1px dashed var(--purple-accent);
        background: none;
        transition: all 0.15s;
        font-family: var(--font);
      }
      .compare-btn:hover {
        background: var(--purple-bg);
      }
      .compare-btn.active {
        background: var(--purple-accent);
        color: #fff;
        border-style: solid;
      }
      .compare-select {
        transition: all 0.2s;
      }
      .active-filter-tag {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        font-size: 10px;
        font-weight: 600;
        padding: 3px 8px;
        border-radius: 12px;
        background: var(--purple-bg);
        color: var(--purple-accent);
      }

      /* KPI Row */
      .kpi-row {
        padding: 0 32px 16px;
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 12px;
        overflow: visible;
        position: relative;
        z-index: 10;
      }
      .kpi-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 16px 20px;
        position: relative;
      }
      .kpi-card.dark {
        background: var(--stat-card-bg);
        border-color: transparent;
      }
      .kpi-label {
        font-size: 10.5px;
        font-weight: 600;
        letter-spacing: 0.8px;
        text-transform: uppercase;
        color: var(--text-tertiary);
        margin-bottom: 6px;
      }
      .kpi-card.dark .kpi-label {
        color: var(--stat-card-text);
      }
      .kpi-value {
        font-size: 26px;
        font-weight: 700;
        display: flex;
        align-items: baseline;
        gap: 8px;
      }
      .kpi-card.dark .kpi-value {
        color: #fff;
      }
      .kpi-delta {
        font-size: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 2px;
        padding: 2px 6px;
        border-radius: 4px;
      }
      .kpi-delta.up {
        color: var(--teal);
        background: var(--teal-bg);
      }
      .kpi-delta.down {
        color: var(--red);
        background: rgba(214, 48, 49, 0.08);
      }
      .kpi-card.dark .kpi-delta.up {
        background: rgba(0, 184, 148, 0.15);
      }

      /* Cards */
      .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 14px;
        overflow: hidden;
      }
      .card-header {
        padding: 18px 22px 14px;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
      }
      .card-title {
        font-size: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .card-subtitle {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 2px;
      }
      .card-body {
        padding: 0 22px 22px;
      }
      .badge {
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        padding: 3px 8px;
        border-radius: 4px;
        background: var(--live-green);
        color: #fff;
      }

      /* Section */
      .section-pad {
        padding: 0 32px 16px;
      }
      .section-label {
        padding: 16px 32px 8px;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--text-tertiary);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .section-label::after {
        content: "";
        flex: 1;
        height: 1px;
        background: var(--card-border);
      }

      /* Cohort Grid */
      .cohort-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 10px;
      }
      .cohort-card {
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 14px;
        cursor: pointer;
        transition: all 0.2s;
        background: #fff;
        position: relative;
        overflow: visible;
      }
      .cohort-card:hover {
        border-color: var(--purple-accent);
        box-shadow: 0 2px 12px rgba(108, 92, 231, 0.1);
      }
      .cohort-card.active {
        border-color: var(--purple-accent);
        background: linear-gradient(135deg, #faf9fd, #f0eeff);
      }
      /* Header — icon + name/desc inline */
      .cohort-header {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 10px;
      }
      .cohort-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .cohort-icon svg {
        width: 17px;
        height: 17px;
      }
      .cohort-header-text {
        flex: 1;
        min-width: 0;
      }
      .cohort-badge {
        font-size: 7px;
        font-weight: 700;
        letter-spacing: 0.4px;
        text-transform: uppercase;
        padding: 2px 5px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 3px;
        background: var(--teal-bg);
        color: var(--teal);
        flex-shrink: 0;
        margin-top: 2px;
      }
      .cohort-badge .live-dot {
        width: 4px;
        height: 4px;
        background: var(--teal);
      }
      .cohort-name {
        font-size: 12.5px;
        font-weight: 700;
        line-height: 1.2;
        margin-bottom: 1px;
      }
      .cohort-desc {
        font-size: 9.5px;
        color: var(--text-secondary);
        font-weight: 500;
        font-style: italic;
        line-height: 1.3;
      }
      /* KPI layout — hero metric on top, 2×2 grid below */
      .cohort-kpis {
        display: flex;
        flex-direction: column;
        gap: 5px;
        margin-bottom: 8px;
      }
      .cohort-kpi-hero {
        display: flex;
        align-items: baseline;
        gap: 6px;
        padding: 7px 10px;
        background: var(--page-bg);
        border-radius: 8px;
        border: 1px solid var(--card-border);
      }
      .cohort-kpi-hero .kh-left {
        flex: 1;
        min-width: 0;
      }
      .cohort-kpi-hero .cohort-kpi-val {
        font-size: 18px;
        font-weight: 800;
        letter-spacing: -0.4px;
      }
      .cohort-kpi-hero .cohort-kpi-label {
        font-size: 8.5px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: var(--text-tertiary);
      }
      .cohort-kpi-hero .cohort-kpi-delta {
        font-size: 11px;
        font-weight: 700;
        white-space: nowrap;
      }
      .cohort-kpi-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4px;
      }
      .cohort-kpi-cell {
        padding: 5px 8px;
        border-radius: 6px;
        background: var(--page-bg);
        display: flex;
        align-items: baseline;
        justify-content: space-between;
      }
      .cohort-kpi-cell > div:first-child {
        min-width: 0;
      }
      .cohort-kpi-cell .cohort-kpi-val {
        font-size: 13.5px;
        font-weight: 700;
      }
      .cohort-kpi-cell .cohort-kpi-label {
        font-size: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: var(--text-tertiary);
      }
      .cohort-kpi-cell .cohort-kpi-delta {
        font-size: 9px;
        font-weight: 700;
        margin-top: 0;
        white-space: nowrap;
        flex-shrink: 0;
      }
      .cohort-goal {
        font-size: 10px;
        color: var(--text-secondary);
        padding-top: 8px;
        border-top: 1px solid var(--card-border);
        line-height: 1.4;
      }
      .cohort-goal strong {
        color: var(--text-primary);
        font-weight: 700;
      }
      .cohort-cta {
        margin-top: 8px;
        display: flex;
        gap: 4px;
      }
      .cohort-cta-btn {
        font-size: 9px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-family: var(--font);
        transition: all 0.15s;
      }
      .cohort-cta-btn.activate {
        background: var(--teal-bg);
        color: var(--teal);
      }
      .cohort-cta-btn.activate:hover {
        background: var(--teal);
        color: #fff;
      }
      .cohort-cta-btn.track {
        background: var(--purple-bg);
        color: var(--purple-accent);
      }
      .cohort-cta-btn.track:hover {
        background: var(--purple-accent);
        color: #fff;
      }

      /* Content Grid */
      .content-grid {
        padding: 0 32px 16px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .content-grid .full {
        grid-column: 1/-1;
      }

      /* Market Share */
      .market-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
        border-bottom: 1px solid var(--card-border);
      }
      .market-row:last-child {
        border-bottom: none;
      }
      .market-bar-wrap {
        flex: 1;
        height: 8px;
        background: #f0eeff;
        border-radius: 4px;
        overflow: hidden;
      }
      .market-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 0.6s ease;
      }
      .market-label {
        font-size: 12px;
        font-weight: 500;
        width: 100px;
      }
      .market-value {
        font-size: 12px;
        font-weight: 600;
        width: 50px;
        text-align: right;
      }

      /* Inline on-ramp prompt */
      .inline-prompt {
        margin-top: 16px;
        padding: 14px 16px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .inline-prompt.purple {
        background: linear-gradient(135deg, #f0eeff 0%, #e8e4f8 100%);
        border: 1px solid #d5d0e8;
      }
      .inline-prompt.coral {
        background: linear-gradient(135deg, #fff0ed 0%, #fde8e4 100%);
        border: 1px solid #f0d5ce;
      }
      .inline-prompt.teal {
        background: linear-gradient(135deg, #e8faf5 0%, #d5f5ed 100%);
        border: 1px solid #b8e8d8;
      }
      .inline-prompt.amber {
        background: linear-gradient(135deg, #fef9e7 0%, #fdf3d4 100%);
        border: 1px solid #f0e4b0;
      }
      .inline-prompt-text {
        font-size: 12.5px;
        font-weight: 500;
        color: var(--text-primary);
        line-height: 1.4;
      }
      .inline-prompt-text strong {
        font-weight: 700;
      }
      .inline-prompt-sub {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 2px;
      }

      /* Blurred premium teaser */
      .premium-teaser {
        position: relative;
        overflow: hidden;
        border-radius: 10px;
      }
      .premium-blur {
        filter: blur(4px);
        opacity: 0.6;
        pointer-events: none;
      }
      .premium-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2;
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(2px);
      }
      .premium-lock-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--purple-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
      }
      .premium-lock-icon svg {
        width: 18px;
        height: 18px;
        color: var(--purple-accent);
      }
      .premium-overlay-text {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        text-align: center;
      }
      .premium-overlay-sub {
        font-size: 11.5px;
        color: var(--text-secondary);
        margin-top: 4px;
        text-align: center;
        max-width: 260px;
      }

      /* Collapsible Cards */
      .collapsible-body {
        transition: all 0.25s ease;
        overflow: hidden;
      }
      .collapsible-card.collapsed .collapsible-body {
        display: none;
      }
      .collapse-chevron {
        transition: transform 0.25s ease;
        flex-shrink: 0;
        cursor: pointer;
        display: block;
      }
      .collapse-chevron:hover {
        opacity: 0.6;
      }
      .collapsible-card.collapsed .collapse-chevron {
        transform: rotate(-90deg);
      }
      .collapsible-header {
        user-select: none;
      }
      .collapsible-card.collapsed .card-header {
        padding: 16px 22px !important;
        min-height: 0;
        align-items: center;
      }
      .collapsible-card.collapsed .card-header > div:first-child {
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .collapsible-card.collapsed .card-subtitle {
        margin-top: 2px;
      }
      .collapsible-card.collapsed .hide-collapsed {
        display: none !important;
      }
      .collapsible-card:not(.collapsed) .show-collapsed {
        display: none !important;
      }

      /* Campaign Table */
      .campaign-table {
        width: 100%;
        border-collapse: collapse;
      }
      .campaign-table th {
        font-size: 10.5px;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        color: var(--text-tertiary);
        text-align: left;
        padding: 10px 12px;
        border-bottom: 1px solid var(--card-border);
      }
      .campaign-table td {
        font-size: 13px;
        padding: 12px;
        border-bottom: 1px solid var(--card-border);
      }
      .campaign-table tr:last-child td {
        border-bottom: none;
      }
      .campaign-table .camp-name {
        font-weight: 600;
      }
      .campaign-table .camp-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }
      .campaign-table td.num {
        font-variant-numeric: tabular-nums;
        font-weight: 500;
      }
      .campaign-table .tag-btn {
        font-size: 10.5px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 5px;
        border: 1px dashed var(--purple-accent);
        color: var(--purple-accent);
        background: none;
        cursor: pointer;
        font-family: var(--font);
        transition: all 0.15s;
      }
      .campaign-table .tag-btn:hover {
        background: var(--purple-accent);
        color: #fff;
        border-style: solid;
      }
      .campaign-table .tagged {
        font-size: 10.5px;
        font-weight: 600;
        color: var(--teal);
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* Donut */
      .attr-sales-big {
        font-size: 34px;
        font-weight: 700;
      }
      .donut-wrap {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-top: 14px;
      }
      .donut-legend {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .donut-legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--text-secondary);
      }
      .donut-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      /* Insights teaser tiles */
      .insight-tile-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .insight-tile {
        border: 1px solid var(--card-border);
        border-radius: 10px;
        padding: 14px;
        background: #fff;
      }
      .insight-tile-label {
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        color: var(--text-tertiary);
        margin-bottom: 6px;
      }
      .insight-tile-value {
        font-size: 20px;
        font-weight: 700;
      }
      .insight-tile-sub {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 2px;
      }
      .insight-tile-bar {
        height: 4px;
        border-radius: 2px;
        background: #f0eeff;
        margin-top: 8px;
        overflow: hidden;
      }
      .insight-tile-bar-fill {
        height: 100%;
        border-radius: 2px;
      }

      /* Live pulse */
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }
      .live-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--live-green);
        animation: pulse 2s infinite;
        display: inline-block;
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 200;
        background: var(--stat-card-bg);
        color: #fff;
        padding: 14px 24px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        transform: translateY(80px);
        opacity: 0;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        max-width: 420px;
      }
      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }
      .toast svg {
        width: 20px;
        height: 20px;
        color: var(--live-green);
        flex-shrink: 0;
      }

      /* Drawer overlay */
      .drawer-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 150;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }
      .drawer-overlay.open {
        opacity: 1;
        pointer-events: all;
      }
      .drawer {
        position: fixed;
        top: 0;
        right: -520px;
        bottom: 0;
        width: 500px;
        background: #fff;
        z-index: 160;
        box-shadow: -8px 0 40px rgba(0, 0, 0, 0.15);
        transition: right 0.35s ease;
        overflow-y: auto;
      }
      .drawer.open {
        right: 0 !important;
      }
      #drawer-audience {
        width: 560px;
        right: -580px;
      }
      .drawer-header {
        padding: 24px;
        border-bottom: 1px solid var(--card-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .drawer-header h2 {
        font-size: 18px;
        font-weight: 700;
      }
      .drawer-close {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: none;
        background: var(--page-bg);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .drawer-close svg {
        width: 18px;
        height: 18px;
        color: var(--text-primary);
      }
      .drawer-body {
        padding: 24px;
      }
      .drawer-section {
        margin-bottom: 24px;
      }
      .drawer-section h3 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .drawer-section p {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.6;
      }
      .drawer-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 11px;
        font-weight: 600;
        margin-right: 4px;
        margin-bottom: 4px;
      }

      /* Animations */
      .fade-in {
        animation: fadeIn 0.4s ease forwards;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .stagger-1 {
        animation-delay: 0.05s;
        opacity: 0;
      }
      .stagger-2 {
        animation-delay: 0.1s;
        opacity: 0;
      }
      .stagger-3 {
        animation-delay: 0.15s;
        opacity: 0;
      }
      .stagger-4 {
        animation-delay: 0.2s;
        opacity: 0;
      }
      .stagger-5 {
        animation-delay: 0.25s;
        opacity: 0;
      }

      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: var(--card-border);
        border-radius: 3px;
      }

      /* Audience Builder */
      .aud-pill {
        font-family: var(--font);
        font-size: 11.5px;
        font-weight: 500;
        padding: 8px 14px;
        border-radius: 20px;
        border: 1px solid var(--card-border);
        background: #fff;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.15s;
        text-align: left;
        line-height: 1.4;
      }
      .aud-pill:hover {
        border-color: var(--purple-accent);
        color: var(--purple-accent);
        background: var(--purple-bg);
      }
      .aud-cohort-btn {
        font-family: var(--font);
        font-size: 12px;
        font-weight: 500;
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid var(--card-border);
        background: #fff;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.15s;
        text-align: left;
      }
      .aud-cohort-btn:hover {
        border-color: var(--purple-accent);
        background: var(--purple-bg);
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .gen-step {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        font-size: 13px;
        color: var(--text-secondary);
        transition: opacity 0.4s;
      }
      .gen-check {
        font-size: 14px;
        width: 20px;
        text-align: center;
      }
      .gen-step.done {
        opacity: 1 !important;
        color: var(--teal);
      }
      .gen-step.done .gen-check {
        color: var(--teal);
      }
      .gen-step.active {
        opacity: 1 !important;
        color: var(--purple-accent);
      }
      .gen-step.active .gen-check {
        color: var(--purple-accent);
      }
      .spec-row {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 8px 12px;
        border-bottom: 1px solid var(--card-border);
        font-size: 12px;
      }
      .spec-row:last-child {
        border-bottom: none;
      }
      .spec-label {
        font-weight: 600;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        font-size: 10px;
        min-width: 90px;
        padding-top: 2px;
      }
      .spec-value {
        color: var(--text-primary);
        font-weight: 500;
        line-height: 1.5;
      }
      .spec-value .spec-tag {
        display: inline-flex;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10.5px;
        font-weight: 600;
        margin: 1px 2px;
        background: var(--purple-bg);
        color: var(--purple-accent);
      }
      .endpoint-opt {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        border: 1px solid var(--card-border);
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.15s;
      }
      .endpoint-opt:hover {
        border-color: var(--purple-accent);
      }
      .endpoint-opt:has(input:checked) {
        border-color: var(--purple-accent);
        background: var(--purple-bg);
      }
      .endpoint-icon {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        flex-shrink: 0;
      }
      .endpoint-cb {
        accent-color: var(--purple-accent);
        width: 16px;
        height: 16px;
      }
      .toggle-switch {
        position: relative;
        width: 44px;
        height: 24px;
        flex-shrink: 0;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-slider {
        position: absolute;
        inset: 0;
        background: var(--card-border);
        border-radius: 24px;
        cursor: pointer;
        transition: 0.3s;
      }
      .toggle-slider::before {
        content: "";
        position: absolute;
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background: #fff;
        border-radius: 50%;
        transition: 0.3s;
      }
      .toggle-switch input:checked + .toggle-slider {
        background: var(--purple-accent);
      }
      .toggle-switch input:checked + .toggle-slider::before {
        transform: translateX(20px);
      }
      .insight-mini {
        background: #fff;
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 10px 12px;
      }
      .insight-mini-label {
        font-size: 9px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        color: var(--text-tertiary);
      }
      .insight-mini-value {
        font-size: 16px;
        font-weight: 700;
        margin-top: 2px;
      }
      .insight-mini-sub {
        font-size: 10.5px;
        color: var(--text-secondary);
        margin-top: 1px;
      }
      @keyframes confettiBurst {
        0% {
          transform: scale(0);
          opacity: 1;
        }
        50% {
          transform: scale(1.2);
          opacity: 0.8;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      .result-burst {
        animation: confettiBurst 0.5s ease forwards;
      }

      @media (max-width: 1400px) {
        .cohort-grid {
          grid-template-columns: repeat(3, 1fr);
        }
        .kpi-row {
          grid-template-columns: repeat(3, 1fr);
        }
        .content-grid {
          grid-template-columns: 1fr;
        }
      }
      /* Mode Toggle */
      .mode-bar {
        padding: 12px 32px 0;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .mode-toggle {
        display: flex;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 10px;
        overflow: hidden;
      }
      .mode-opt {
        padding: 8px 20px;
        font-size: 12.5px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--text-tertiary);
      }
      .mode-opt.active {
        background: var(--purple-accent);
        color: #fff;
      }
      .mode-opt svg {
        width: 15px;
        height: 15px;
      }
      .mode-hint {
        font-size: 12px;
        color: var(--text-secondary);
      }
      /* Cohort Edit */
      .cohort-edit {
        display: none;
        position: absolute;
        top: calc(100% + 4px);
        left: -4px;
        right: -4px;
        z-index: 50;
        background: #fff;
        border: 1px solid var(--card-border);
        border-radius: 10px;
        padding: 14px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      }
      .cohort-edit.open {
        display: block;
      }
      .cohort-edit.open ~ *,
      .cohort-card:has(.cohort-edit.open) {
        z-index: 40;
      }
      .rfm-row {
        margin-bottom: 10px;
      }
      .rfm-label {
        font-size: 10px;
        font-weight: 600;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
      }
      .rfm-label span {
        color: var(--purple-accent);
        font-weight: 700;
        text-transform: none;
        font-size: 11px;
      }
      .rfm-slider {
        width: 100%;
        -webkit-appearance: none;
        appearance: none;
        height: 4px;
        border-radius: 2px;
        background: #e8e4f0;
        outline: none;
      }
      .rfm-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: var(--purple-accent);
        cursor: pointer;
      }
      .cohort-cta-btn.edit-btn {
        background: none;
        color: var(--text-tertiary);
        border: 1px solid var(--card-border);
      }
      .cohort-cta-btn.edit-btn:hover {
        color: var(--purple-accent);
        border-color: var(--purple-accent);
      }
      .cohort-trash-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: 1px solid var(--card-border);
        background: var(--card-bg);
        color: var(--text-tertiary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        padding: 0;
      }
      .cohort-trash-btn:hover {
        color: #d63031;
        border-color: #d63031;
        background: #ffeaea;
      }
      /* View toggle */
      .cohort-view-btn {
        padding: 5px 8px;
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-tertiary);
        transition: all 0.15s;
        display: flex;
        align-items: center;
      }
      .cohort-view-btn:hover {
        color: var(--purple-accent);
      }
      .cohort-view-btn.active {
        background: var(--purple-accent);
        color: #fff;
      }
      /* List view — clean table rows, labels from header only */
      .cohort-grid.list-view {
        display: flex;
        flex-direction: column;
        gap: 0;
      }
      .cohort-grid.list-view .cohort-card {
        border-radius: 0;
        border-bottom: 1px solid var(--card-border);
        border-left: 1px solid var(--card-border);
        border-right: 1px solid var(--card-border);
        border-top: none;
        display: grid;
        grid-template-columns: 200px 1fr 1fr 1fr 1fr 1fr 90px;
        align-items: center;
        gap: 0;
        padding: 14px 20px;
      }
      .cohort-grid.list-view .cohort-card:first-child {
        border-top: 1px solid var(--card-border);
        border-radius: 0;
      }
      .cohort-grid.list-view .cohort-card:last-child {
        border-radius: 0 0 10px 10px;
      }
      .cohort-grid.list-view .cohort-header {
        margin-bottom: 0;
        flex-shrink: 0;
        min-width: 0;
      }
      .cohort-grid.list-view .cohort-badge {
        display: none;
      }
      .cohort-grid.list-view .cohort-name {
        font-size: 13px;
      }
      .cohort-grid.list-view .cohort-desc {
        display: none;
      }
      .cohort-grid.list-view .cohort-kpis {
        display: contents;
        margin: 0;
      }
      .cohort-grid.list-view .cohort-kpi-hero {
        display: flex;
        flex-direction: column;
        padding: 0;
        background: none;
        border: none;
        gap: 2px;
      }
      .cohort-grid.list-view .cohort-kpi-hero .kh-left {
        display: contents;
      }
      .cohort-grid.list-view .cohort-kpi-hero .cohort-kpi-val {
        font-size: 15px;
        font-weight: 800;
      }
      .cohort-grid.list-view .cohort-kpi-hero .cohort-kpi-label {
        display: none;
      }
      .cohort-grid.list-view .cohort-kpi-hero .cohort-kpi-delta {
        font-size: 11px;
        font-weight: 700;
      }
      .cohort-grid.list-view .cohort-kpi-grid {
        display: contents;
      }
      .cohort-grid.list-view .cohort-kpi-cell {
        padding: 0;
        background: none;
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
      }
      .cohort-grid.list-view .cohort-kpi-cell > div:first-child {
        display: contents;
      }
      .cohort-grid.list-view .cohort-kpi-cell .cohort-kpi-val {
        font-size: 15px;
        font-weight: 700;
      }
      .cohort-grid.list-view .cohort-kpi-cell .cohort-kpi-label {
        display: none;
      }
      .cohort-grid.list-view .cohort-kpi-cell .cohort-kpi-delta {
        font-size: 11px;
        font-weight: 700;
      }
      .cohort-grid.list-view .cohort-goal {
        display: none;
      }
      .cohort-grid.list-view .cohort-cta {
        margin-top: 0;
        flex-shrink: 0;
        justify-content: flex-end;
      }
      .cohort-grid.list-view .cohort-edit {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 320px;
        z-index: 100;
      }
      /* List header — matches grid columns */
      .cohort-list-header {
        display: none;
        grid-template-columns: 200px 1fr 1fr 1fr 1fr 1fr 90px;
        align-items: center;
        padding: 10px 20px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-tertiary);
        border: 1px solid var(--card-border);
        border-bottom: none;
        border-radius: 10px 10px 0 0;
        background: var(--page-bg);
      }
      .cohort-list-header .clh-segment {
        padding-left: 40px;
      }
      .cohort-list-header .clh-metric {
        cursor: pointer;
        transition: color 0.15s;
      }
      .cohort-list-header .clh-metric:hover {
        color: var(--purple-accent);
      }
      /* Collapsible filter */
      .filter-collapse-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-tertiary);
        cursor: pointer;
        padding: 4px 10px;
        border-radius: 6px;
        border: none;
        background: none;
        font-family: var(--font);
        transition: all 0.15s;
      }
      .filter-collapse-btn:hover {
        color: var(--purple-accent);
      }
      .filter-collapse-btn svg {
        transition: transform 0.2s;
      }
      .filter-collapse-btn.collapsed svg {
        transform: rotate(-90deg);
      }
      .filter-bar.collapsed .filter-inner {
        display: none;
      }
      /* Reports shelf */
      /* Media Optimization Grid */
      .opt-tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid var(--card-border);
      }
      .opt-tab {
        padding: 8px 14px;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-tertiary);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.15s;
      }
      .opt-tab:hover {
        color: var(--text-primary);
      }
      .opt-tab.active {
        color: var(--purple-accent);
        border-bottom-color: var(--purple-accent);
      }
      .opt-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }
      .opt-table thead {
        position: sticky;
        top: 0;
        z-index: 1;
      }
      .opt-table th {
        padding: 8px 10px;
        font-size: 9px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        color: var(--text-tertiary);
        text-align: right;
        white-space: nowrap;
        border-bottom: 1px solid var(--card-border);
        transition: color 0.15s;
        user-select: none;
      }
      .opt-table th:hover {
        color: var(--purple-accent);
      }
      .opt-table th:first-child {
        text-align: left;
      }
      .opt-table th.media-col {
        background: var(--page-bg);
      }
      .opt-table th.outcome-col {
        background: linear-gradient(135deg, #f0eeff, #e8e4fd);
        color: var(--purple-accent);
      }
      .opt-table th.divider-col {
        width: 12px;
        padding: 0;
        background: none;
        border-bottom-color: transparent;
      }
      .opt-table td {
        padding: 10px 10px;
        text-align: right;
        border-bottom: 1px solid var(--card-border);
        position: relative;
        font-variant-numeric: tabular-nums;
      }
      .opt-table td:first-child {
        text-align: left;
        font-weight: 600;
        color: var(--text-primary);
      }
      .opt-table td.divider-col {
        width: 12px;
        padding: 0;
        border-bottom-color: transparent;
        background: linear-gradient(
          to right,
          var(--card-border) 0%,
          var(--card-border) 1px,
          transparent 1px
        );
      }
      .opt-table tr:hover td {
        background: var(--page-bg);
      }
      .opt-table tr:hover td.divider-col {
        background: linear-gradient(
          to right,
          var(--card-border) 0%,
          var(--card-border) 1px,
          var(--page-bg) 1px
        );
      }
      .opt-table tr:last-child td {
        border-bottom: none;
      }
      /* Impression bar behind the name cell */
      .opt-imp-bar {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        opacity: 0.08;
        border-radius: 0 3px 3px 0;
        transition: width 0.4s ease;
      }
      /* Outcome pill coloring */
      .opt-pill {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 5px;
        font-weight: 700;
        font-size: 11.5px;
      }
      .opt-pill.top {
        background: #d4efdf;
        color: #1e8449;
      }
      .opt-pill.good {
        background: #e8f6ef;
        color: #27ae60;
      }
      .opt-pill.mid {
        background: #fef9e7;
        color: #b7950b;
      }
      .opt-pill.low {
        background: #fde8e8;
        color: #c0392b;
      }
      /* Nutrition signal */
      .opt-signal {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        font-size: 9px;
        font-weight: 700;
        padding: 2px 5px;
        border-radius: 3px;
      }
      .opt-signal.top {
        background: #d4efdf;
        color: #1e8449;
      }
      .opt-signal.good {
        background: #e8f6ef;
        color: #27ae60;
      }
      .opt-signal.mid {
        background: #fef9e7;
        color: #b7950b;
      }
      .opt-signal.low {
        background: #fde8e8;
        color: #c0392b;
      }
      .opt-parent:hover > td {
        background: var(--page-bg);
      }
      .opt-parent:hover > td.divider-col {
        background: linear-gradient(
          to right,
          var(--card-border) 0%,
          var(--card-border) 1px,
          var(--page-bg) 1px
        );
      }
      .opt-child td {
        background: #faf9fd !important;
        border-bottom-color: #f0eeff !important;
      }
      .opt-child:last-of-type td {
        border-bottom-color: var(--card-border) !important;
      }
      /* Measured Campaign Cards */
      .mc-card {
        border: 1px solid var(--card-border);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 10px;
        transition: all 0.2s;
        background: #fff;
      }
      .mc-card:last-child {
        margin-bottom: 0;
      }
      .mc-card:hover {
        border-color: var(--purple-accent);
        box-shadow: 0 2px 12px rgba(108, 92, 231, 0.06);
      }
      .mc-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 10px;
        gap: 12px;
      }
      .mc-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }
      .mc-status {
        font-size: 9.5px;
        font-weight: 700;
        padding: 2px 7px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .mc-status.active {
        background: var(--teal-bg);
        color: var(--teal);
      }
      .mc-status.active .mc-dot {
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: var(--teal);
        animation: pulse 2s infinite;
      }
      .mc-status.completed {
        background: var(--page-bg);
        color: var(--text-tertiary);
      }
      .mc-study-type {
        font-size: 8px;
        font-weight: 700;
        padding: 2px 7px;
        border-radius: 4px;
        background: #f0eeff;
        color: var(--purple-accent);
        text-transform: uppercase;
        letter-spacing: 0.4px;
      }
      .mc-advertiser {
        font-size: 10px;
        color: var(--text-tertiary);
        font-weight: 600;
      }
      .mc-name {
        font-size: 14px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1px;
      }
      .mc-dates {
        font-size: 9.5px;
        color: var(--text-tertiary);
      }
      .mc-metrics {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 2px;
        background: var(--page-bg);
        border-radius: 8px;
        padding: 2px;
      }
      .mc-metric {
        padding: 8px 4px;
        text-align: center;
        border-radius: 6px;
        background: #fff;
      }
      .mc-metric-val {
        font-size: 13.5px;
        font-weight: 700;
        margin-bottom: 1px;
      }
      .mc-metric-label {
        font-size: 7.5px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: var(--text-tertiary);
      }
      .mc-expand-btn {
        background: var(--purple-bg);
        border: 1px solid #d8d0ef;
        border-radius: 7px;
        padding: 6px 12px;
        cursor: pointer;
        font-family: var(--font);
        font-size: 11px;
        font-weight: 600;
        color: var(--purple-accent);
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
      }
      .mc-expand-btn:hover {
        background: var(--purple-accent);
        color: #fff;
        border-color: var(--purple-accent);
      }
      .mc-expand-btn:hover svg {
        stroke: #fff;
      }
      .mc-wrap-btn {
        background: var(--coral-bg);
        border: 1px solid #f0c4b8;
        border-radius: 7px;
        padding: 6px 12px;
        cursor: pointer;
        font-family: var(--font);
        font-size: 11px;
        font-weight: 600;
        color: var(--coral);
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
      }
      .mc-wrap-btn:hover {
        background: var(--coral);
        color: #fff;
        border-color: var(--coral);
      }
      .mc-wrap-btn:hover svg {
        stroke: #fff;
      }
      .mc-ai-recap {
        margin-top: 10px;
        padding: 12px 14px;
        background: linear-gradient(135deg, #f0eeff, #faf9fd);
        border-radius: 8px;
        border: 1px solid #e0dced;
        font-size: 12px;
        line-height: 1.6;
        color: var(--text-secondary);
        animation: fadeSlide 0.3s ease;
      }
      .mc-ai-recap strong {
        color: var(--text-primary);
      }
      @keyframes fadeSlide {
        from {
          opacity: 0;
          transform: translateY(-6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes modeSwap {
        0% {
          opacity: 0;
          transform: translateY(4px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes labelFlash {
        0% {
          color: var(--purple-accent);
          transform: scale(1.05);
        }
        100% {
          color: inherit;
          transform: scale(1);
        }
      }
      @keyframes hintPulse {
        0% {
          color: var(--purple-accent);
          background: var(--purple-bg);
          padding: 2px 8px;
          border-radius: 4px;
        }
        100% {
          color: var(--text-secondary);
          background: transparent;
          padding: 2px 0;
          border-radius: 4px;
        }
      }
      .mode-swap .cohort-kpi-grid,
      .mode-swap .cohort-kpi-hero {
        animation: modeSwap 0.25s ease both;
      }
      .mode-swap .cohort-kpi-label {
        animation: labelFlash 0.5s ease both;
      }
      .mode-swap .kpi-card {
        animation: modeSwap 0.2s ease both;
      }
      .hint-pulse {
        animation: hintPulse 0.6s ease both;
      }
      .mc-setup-card {
        border: 1.5px dashed #c8c3d6;
        border-radius: 10px;
        padding: 28px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--page-bg);
      }
      .mc-setup-card:hover {
        border-color: var(--purple-accent);
        background: linear-gradient(135deg, #faf9fd, #f0eeff);
      }
      .mc-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--card-border);
      }
      .mc-link {
        font-size: 11px;
        font-weight: 600;
        color: var(--purple-accent);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: opacity 0.15s;
      }
      .mc-link:hover {
        opacity: 0.7;
      }
      .mc-report-btn {
        background: var(--teal-bg);
        border: 1px solid #b8e6d0;
        border-radius: 7px;
        padding: 6px 12px;
        cursor: pointer;
        font-family: var(--font);
        font-size: 11px;
        font-weight: 600;
        color: var(--teal);
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .mc-report-btn:hover {
        background: var(--teal);
        color: #fff;
        border-color: var(--teal);
      }
      .mc-report-btn:hover svg {
        stroke: #fff;
      }
      /* Report Settings Modal */
      .rpt-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
      }
      .rpt-modal {
        background: #fff;
        border-radius: 14px;
        width: 780px;
        max-width: 95vw;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        animation: slideUp 0.3s ease;
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .rpt-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 22px;
        border-bottom: 1px solid var(--card-border);
      }
      .rpt-header h3 {
        font-size: 15px;
        margin: 0;
      }
      .rpt-body {
        display: flex;
        flex: 1;
        overflow: hidden;
        min-height: 0;
      }
      .rpt-settings {
        width: 240px;
        border-right: 1px solid var(--card-border);
        padding: 16px;
        overflow-y: auto;
        flex-shrink: 0;
      }
      .rpt-preview {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: var(--page-bg);
      }
      .rpt-settings-group {
        margin-bottom: 14px;
      }
      .rpt-settings-label {
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        color: var(--text-tertiary);
        margin-bottom: 5px;
      }
      .rpt-toggle-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }
      .rpt-toggle {
        width: 36px;
        height: 20px;
        border-radius: 10px;
        background: var(--card-border);
        cursor: pointer;
        position: relative;
        transition: background 0.2s;
      }
      .rpt-toggle.on {
        background: var(--teal);
      }
      .rpt-toggle::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #fff;
        transition: transform 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      .rpt-toggle.on::after {
        transform: translateX(16px);
      }
      /* Email preview card inside modal */
      .email-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        max-width: 600px;
        margin: 0 auto;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        overflow: hidden;
      }
      /* Intake Form */
      .intake-step {
        flex: 1;
        text-align: center;
        padding: 8px 4px;
        font-size: 9.5px;
        font-weight: 600;
        color: var(--text-tertiary);
        border-bottom: 2px solid var(--card-border);
        transition: all 0.2s;
        cursor: default;
      }
      .intake-step.active {
        color: var(--purple-accent);
        border-bottom-color: var(--purple-accent);
      }
      .intake-step.done {
        color: var(--teal);
        border-bottom-color: var(--teal);
      }
      .intake-step-num {
        display: inline-flex;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: 700;
        background: var(--page-bg);
        color: var(--text-tertiary);
        margin-right: 4px;
        border: 1.5px solid var(--card-border);
      }
      .intake-step.active .intake-step-num {
        background: var(--purple-accent);
        color: #fff;
        border-color: var(--purple-accent);
      }
      .intake-step.done .intake-step-num {
        background: var(--teal);
        color: #fff;
        border-color: var(--teal);
      }
      .intake-group {
        margin-bottom: 12px;
      }
      .intake-label {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 5px;
      }
      .intake-input {
        width: 100%;
        font-family: var(--font);
        font-size: 12px;
        padding: 9px 12px;
        border: 1px solid var(--card-border);
        border-radius: 8px;
        background: #fff;
        color: var(--text-primary);
        transition: border-color 0.15s;
        box-sizing: border-box;
      }
      .intake-input:focus {
        outline: none;
        border-color: var(--purple-accent);
        box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.08);
      }
      .intake-input::placeholder {
        color: #c0b8d4;
      }
      .intake-divider {
        height: 1px;
        background: var(--card-border);
        margin: 16px 0;
      }
      .intake-study-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px;
        border: 1.5px solid var(--card-border);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        background: #fff;
      }
      .intake-study-card:hover {
        border-color: var(--purple-accent);
        box-shadow: 0 2px 8px rgba(108, 92, 231, 0.08);
      }
      .intake-study-card.selected {
        border-color: var(--purple-accent);
        background: linear-gradient(135deg, #faf9fd, #f0eeff);
      }
      .intake-study-icon {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
      }
      .intake-study-info {
        flex: 1;
        min-width: 0;
      }
      .intake-study-name {
        font-size: 12.5px;
        font-weight: 700;
        margin-bottom: 2px;
      }
      .intake-study-desc {
        font-size: 10.5px;
        color: var(--text-secondary);
        line-height: 1.4;
      }
      .intake-study-check {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid var(--card-border);
        flex-shrink: 0;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .intake-study-card.selected .intake-study-check {
        border-color: var(--purple-accent);
        background: var(--purple-accent);
      }
      .intake-study-card.selected .intake-study-check::after {
        content: "";
        display: block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #fff;
      }
      .intake-toggle-pill {
        font-size: 11px;
        font-weight: 600;
        padding: 6px 14px;
        border: 1.5px solid var(--card-border);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        color: var(--text-tertiary);
      }
      .intake-toggle-pill:hover {
        border-color: var(--purple-accent);
        color: var(--purple-accent);
      }
      .intake-toggle-pill.active {
        background: var(--purple-accent);
        color: #fff;
        border-color: var(--purple-accent);
      }
      .intake-chip {
        font-size: 10px;
        font-weight: 600;
        padding: 5px 10px;
        border: 1px solid var(--card-border);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        color: var(--text-tertiary);
      }
      .intake-chip:hover {
        border-color: var(--purple-accent);
      }
      .intake-chip.active {
        background: var(--purple-bg);
        color: var(--purple-accent);
        border-color: var(--purple-accent);
      }
      .intake-dropzone {
        border: 1.5px dashed var(--card-border);
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--page-bg);
      }
      .intake-dropzone:hover {
        border-color: var(--purple-accent);
        background: linear-gradient(135deg, #faf9fd, #f0eeff);
      }
      .intake-dropzone.drag-over {
        border-color: var(--purple-accent);
        background: linear-gradient(135deg, #f0eeff, #e8e4fd);
        border-style: solid;
      }
      .intake-dropzone.has-file {
        border-style: solid;
        border-color: var(--teal);
        background: var(--teal-bg);
      }
      .reports-shelf {
        position: fixed;
        bottom: 0;
        left: 64px;
        right: 0;
        z-index: 90;
        background: #fff;
        border-top: 1px solid var(--card-border);
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
        transform: translateY(100%);
        transition: transform 0.35s ease;
        max-height: 340px;
        overflow-y: auto;
      }
      .reports-shelf.open {
        transform: translateY(0);
      }
      .reports-header {
        padding: 16px 32px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--card-border);
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1;
      }
      .report-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 32px;
        border-bottom: 1px solid var(--card-border);
        transition: background 0.15s;
      }
      .report-item:hover {
        background: var(--page-bg);
      }
      .report-item:last-child {
        border-bottom: none;
      }
      .report-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      .report-icon svg {
        width: 18px;
        height: 18px;
      }
      .report-badge {
        font-size: 9px;
        font-weight: 700;
        padding: 2px 7px;
        border-radius: 10px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }
      /* AI Drawer */
      #drawer-ai {
        width: 520px;
        right: -540px;
      }
      .ai-block {
        margin-bottom: 16px;
        opacity: 0;
        animation: fadeIn 0.4s ease forwards;
      }
      .ai-block-title {
        font-size: 13px;
        font-weight: 700;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .ai-block-body {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.65;
      }
      .ai-metric-row {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .ai-metric {
        flex: 1;
        background: var(--page-bg);
        border-radius: 8px;
        padding: 10px;
        text-align: center;
      }
      .ai-metric-val {
        font-size: 18px;
        font-weight: 700;
      }
      .ai-metric-label {
        font-size: 9.5px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: var(--text-tertiary);
        margin-top: 2px;
      }
      .ai-typing {
        display: inline-block;
        width: 12px;
        height: 16px;
        background: var(--purple-accent);
        border-radius: 2px;
        animation: blink 0.8s infinite;
      }
      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.2;
        }
      }
      /* Library */
      .aud-tabs {
        display: flex;
        border-bottom: 1px solid var(--card-border);
        margin-bottom: 16px;
      }
      .aud-tab {
        padding: 10px 18px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-tertiary);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.15s;
      }
      .aud-tab:hover {
        color: var(--text-primary);
      }
      .aud-tab.active {
        color: var(--purple-accent);
        border-bottom-color: var(--purple-accent);
        font-weight: 600;
      }
      .lib-card {
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: all 0.15s;
      }
      .lib-card:hover {
        border-color: var(--purple-accent);
        background: var(--purple-bg);
      }
      /* Migration enhanced */
      .mig-stat {
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }
      .mig-stat::before {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
      }
      .mig-stat.up {
        background: var(--teal-bg);
      }
      .mig-stat.up::before {
        background: var(--teal);
      }
      .mig-stat.cq {
        background: var(--purple-bg);
      }
      .mig-stat.cq::before {
        background: var(--purple-accent);
      }
      .mig-stat.risk {
        background: var(--coral-bg);
      }
      .mig-stat.risk::before {
        background: var(--coral);
      }
      .sankey-wrap {
        position: relative;
        margin: 14px 0;
      }
      .sankey-node {
        position: absolute;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 600;
        transition: all 0.4s ease;
      }
      .sankey-node .sn-name {
        font-weight: 700;
        font-size: 11px;
      }
      .sankey-node .sn-val {
        font-size: 9px;
        opacity: 0.7;
        margin-top: 1px;
      }
    </style>
  </head>
  <body id="artifacts-component-root-html">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div
        class="sidebar-logo"
        onclick="backToHub()"
        style="cursor: pointer"
        title="PHD Media Portfolio"
      >
        <svg viewBox="0 0 32 32" fill="none">
          <rect width="32" height="32" rx="8" fill="#6c5ce7"></rect>
          <text
            x="4"
            y="21"
            font-family="DM Sans"
            font-weight="700"
            font-size="11"
            fill="#fff"
          >
            OHQ
          </text>
        </svg>
      </div>
      <div class="sidebar-nav">
        <div class="sidebar-item active">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline></svg
          ><span class="tooltip">Launchpad</span>
        </div>
        <div class="sidebar-item">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg
          ><span class="tooltip">Audiences</span>
        </div>
        <div class="sidebar-item">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg
          ><span class="tooltip">Insights</span>
        </div>
        <div class="sidebar-item">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line></svg
          ><span class="tooltip">Measurement</span>
        </div>
        <div class="sidebar-item">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg
          ><span class="tooltip">Attribution</span>
        </div>
      </div>
      <div class="sidebar-bottom">
        <div class="sidebar-item">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="3"></circle>
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
            ></path></svg
          ><span class="tooltip">Settings</span>
        </div>
      </div>
    </nav>

    <div class="main">
      <!-- Topbar -->
      <div class="topbar">
        <div class="topbar-left">
          <div class="topbar-brand">
            <span class="ohq-mark">outcome</span><span class="ohq-sub">HQ</span>
          </div>
          <div
            style="width: 1px; height: 24px; background: var(--card-border)"
          ></div>
          <div style="font-size: 13px; color: var(--text-secondary)">
            Google Analytics for Real-World Sales Insight
          </div>
        </div>
        <div class="topbar-right">
          <div class="topbar-search">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input
              placeholder="Enter a brand, merchant, category, or campaign..."
            />
          </div>
          <div class="topbar-avatar">VS</div>
        </div>
      </div>

      <!-- ═══ AGENCY HUB ═══ -->
      <div id="agencyHub" style="display: none">
        <div class="brand-header fade-in">
          <div class="brand-info">
            <div
              class="brand-logo"
              style="
                background: linear-gradient(135deg, #6c5ce7, #a29bfe);
                font-size: 12px;
              "
            >
              PHD
            </div>
            <div class="brand-meta">
              <h1>PHD Media Portfolio</h1>
              <div class="brand-cat">
                12 Active Accounts • 8 with Measurement • Q4 2025
              </div>
            </div>
          </div>
          <div class="brand-actions">
            <button
              class="btn btn-outline"
              onclick="showToast('Exporting portfolio summary...')"
            >
              <svg
                viewBox="0 0 24 24"
                width="14"
                height="14"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              Export
            </button>
            <button
              class="btn btn-outline"
              onclick="openDrawer('audience')"
              style="color: var(--teal); border-color: var(--teal)"
            >
              <svg
                viewBox="0 0 24 24"
                width="14"
                height="14"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <line x1="19" y1="8" x2="19" y2="14"></line>
                <line x1="22" y1="11" x2="16" y2="11"></line>
              </svg>
              Build Audience
            </button>
            <button class="btn btn-primary" onclick="openDrawer('measurement')">
              <svg
                viewBox="0 0 24 24"
                width="14"
                height="14"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Onboard Account
            </button>
          </div>
        </div>

        <!-- Portfolio Hero KPIs -->
        <div
          class="kpi-row fade-in stagger-1"
          style="
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 18px;
          "
        >
          <div class="kpi-card dark">
            <div class="kpi-label">Measured Impressions</div>
            <div class="kpi-value">
              10.9B <span class="kpi-delta up">▲ 18.2%</span>
            </div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Total Attributed Sales</div>
            <div class="kpi-value">
              $312.6M <span class="kpi-delta up">▲ 9.4%</span>
            </div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Predicted Customer LTV</div>
            <div class="kpi-value" style="color: var(--purple-accent)">
              $797M <span class="kpi-delta up">▲ 11.8%</span>
            </div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Campaigns Measured</div>
            <div class="kpi-value">
              23 <span class="kpi-delta up">▲ 5</span>
            </div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Total Media Spend</div>
            <div class="kpi-value">
              $128.1M <span class="kpi-delta up">▲ 12.4%</span>
            </div>
          </div>
        </div>

        <!-- Account Cards -->
        <div
          class="section-label fade-in stagger-2"
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
          "
        >
          <span>Accounts</span>
          <div style="display: flex; gap: 8px; align-items: center">
            <select
              class="filter-select"
              id="agencyFilter"
              onchange="renderAgencyAccounts()"
              style="font-size: 11px; padding: 5px 28px 5px 10px"
            >
              <option value="all">All Accounts</option>
              <option value="active">With Measurement</option>
              <option value="inactive">Not Yet Onboarded</option>
            </select>
            <select
              class="filter-select"
              id="agencySort"
              onchange="renderAgencyAccounts()"
              style="font-size: 11px; padding: 5px 28px 5px 10px"
            >
              <option value="spend">Sort: Spend</option>
              <option value="iroas">Sort: Attr. Sales</option>
              <option value="coverage">Sort: Campaigns</option>
            </select>
          </div>
        </div>
        <div class="card full fade-in stagger-3">
          <div class="card-body" style="padding: 8px" id="agencyBody">
            <div
              style="
                border: 1px solid var(--card-border);
                border-radius: 10px;
                padding: 14px 16px;
                margin-bottom: 6px;
                background: #fff;
                transition: border-color 0.2s;
              "
              onmouseenter="this.style.borderColor = 'var(--purple-accent)'"
              onmouseleave="this.style.borderColor = 'var(--card-border)'"
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  cursor: pointer;
                "
                onclick="toggleAgencyCard('scj')"
              >
                <svg
                  viewBox="0 0 24 24"
                  width="14"
                  height="14"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                  style="
                    transition: transform 0.2s;
                    transform: rotate(0deg);
                    flex-shrink: 0;
                  "
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <div
                  style="
                    width: 40px;
                    height: 40px;
                    border-radius: 10px;
                    background: linear-gradient(135deg, #d63031, #e17055);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 11px;
                    font-weight: 800;
                    color: #fff;
                    flex-shrink: 0;
                    letter-spacing: 0.3px;
                  "
                >
                  SCJ
                </div>
                <div style="flex: 1; min-width: 0">
                  <div style="display: flex; align-items: center; gap: 8px">
                    <span
                      style="
                        font-size: 13px;
                        font-weight: 700;
                        color: var(--text-primary);
                      "
                      >SC Johnson</span
                    ><span
                      style="
                        font-size: 9px;
                        padding: 2px 7px;
                        border-radius: 10px;
                        background: var(--page-bg);
                        color: var(--text-tertiary);
                        font-weight: 600;
                      "
                      >Household</span
                    >
                  </div>
                  <div
                    style="
                      font-size: 10.5px;
                      color: var(--text-tertiary);
                      margin-top: 1px;
                    "
                  >
                    4 campaigns · 2.46B impressions · $22.8M spend
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    gap: 18px;
                    align-items: center;
                    flex-shrink: 0;
                  "
                >
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--text-primary);
                      "
                    >
                      $77.6M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Attr. Sales
                    </div>
                  </div>
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--purple-accent);
                      "
                    >
                      $194M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Predicted LTV
                    </div>
                  </div>
                </div>
                <div
                  style="flex-shrink: 0; margin-left: 8px"
                  onclick="event.stopPropagation()"
                >
                  <button
                    class="btn btn-outline btn-sm"
                    style="font-size: 10px; padding: 5px 10px"
                    onclick="openAccount('scj')"
                  >
                    Open →
                  </button>
                </div>
              </div>
            </div>
            <div
              style="
                border: 1px solid var(--card-border);
                border-radius: 10px;
                padding: 14px 16px;
                margin-bottom: 6px;
                background: #fff;
                transition: border-color 0.2s;
              "
              onmouseenter="this.style.borderColor = 'var(--purple-accent)'"
              onmouseleave="this.style.borderColor = 'var(--card-border)'"
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  cursor: pointer;
                "
                onclick="toggleAgencyCard('bk')"
              >
                <svg
                  viewBox="0 0 24 24"
                  width="14"
                  height="14"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                  style="
                    transition: transform 0.2s;
                    transform: rotate(0deg);
                    flex-shrink: 0;
                  "
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <div
                  style="
                    width: 40px;
                    height: 40px;
                    border-radius: 10px;
                    background: linear-gradient(135deg, #e17055, #fdcb6e);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 11px;
                    font-weight: 800;
                    color: #fff;
                    flex-shrink: 0;
                    letter-spacing: 0.3px;
                  "
                >
                  BK
                </div>
                <div style="flex: 1; min-width: 0">
                  <div style="display: flex; align-items: center; gap: 8px">
                    <span
                      style="
                        font-size: 13px;
                        font-weight: 700;
                        color: var(--text-primary);
                      "
                      >Burger King</span
                    ><span
                      style="
                        font-size: 9px;
                        padding: 2px 7px;
                        border-radius: 10px;
                        background: var(--page-bg);
                        color: var(--text-tertiary);
                        font-weight: 600;
                      "
                      >QSR</span
                    >
                  </div>
                  <div
                    style="
                      font-size: 10.5px;
                      color: var(--text-tertiary);
                      margin-top: 1px;
                    "
                  >
                    3 campaigns · 1.84B impressions · $18.2M spend
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    gap: 18px;
                    align-items: center;
                    flex-shrink: 0;
                  "
                >
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--text-primary);
                      "
                    >
                      $44.6M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Attr. Sales
                    </div>
                  </div>
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--purple-accent);
                      "
                    >
                      $112M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Predicted LTV
                    </div>
                  </div>
                </div>
                <div
                  style="flex-shrink: 0; margin-left: 8px"
                  onclick="event.stopPropagation()"
                >
                  <button
                    class="btn btn-outline btn-sm"
                    style="font-size: 10px; padding: 5px 10px"
                    onclick="openAccount('bk')"
                  >
                    Open →
                  </button>
                </div>
              </div>
            </div>
            <div
              style="
                border: 1px solid var(--card-border);
                border-radius: 10px;
                padding: 14px 16px;
                margin-bottom: 6px;
                background: #fff;
                transition: border-color 0.2s;
              "
              onmouseenter="this.style.borderColor = 'var(--purple-accent)'"
              onmouseleave="this.style.borderColor = 'var(--card-border)'"
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  cursor: pointer;
                "
                onclick="toggleAgencyCard('kd')"
              >
                <svg
                  viewBox="0 0 24 24"
                  width="14"
                  height="14"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                  style="
                    transition: transform 0.2s;
                    transform: rotate(0deg);
                    flex-shrink: 0;
                  "
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <div
                  style="
                    width: 40px;
                    height: 40px;
                    border-radius: 10px;
                    background: linear-gradient(135deg, #00b894, #0984e3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 11px;
                    font-weight: 800;
                    color: #fff;
                    flex-shrink: 0;
                    letter-spacing: 0.3px;
                  "
                >
                  KDP
                </div>
                <div style="flex: 1; min-width: 0">
                  <div style="display: flex; align-items: center; gap: 8px">
                    <span
                      style="
                        font-size: 13px;
                        font-weight: 700;
                        color: var(--text-primary);
                      "
                      >Keurig Dr Pepper</span
                    ><span
                      style="
                        font-size: 9px;
                        padding: 2px 7px;
                        border-radius: 10px;
                        background: var(--page-bg);
                        color: var(--text-tertiary);
                        font-weight: 600;
                      "
                      >Beverages</span
                    >
                  </div>
                  <div
                    style="
                      font-size: 10.5px;
                      color: var(--text-tertiary);
                      margin-top: 1px;
                    "
                  >
                    3 campaigns · 2.08B impressions · $16.4M spend
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    gap: 18px;
                    align-items: center;
                    flex-shrink: 0;
                  "
                >
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--text-primary);
                      "
                    >
                      $53.2M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Attr. Sales
                    </div>
                  </div>
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--purple-accent);
                      "
                    >
                      $138M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Predicted LTV
                    </div>
                  </div>
                </div>
                <div
                  style="flex-shrink: 0; margin-left: 8px"
                  onclick="event.stopPropagation()"
                >
                  <button
                    class="btn btn-outline btn-sm"
                    style="font-size: 10px; padding: 5px 10px"
                    onclick="openAccount('kd')"
                  >
                    Open →
                  </button>
                </div>
              </div>
            </div>
            <div
              style="
                border: 1px dashed #d8d0ef;
                border-radius: 10px;
                padding: 14px 16px;
                margin-bottom: 6px;
                background: linear-gradient(135deg, #fafafe, #f8f6fc);
                display: flex;
                align-items: center;
                gap: 14px;
              "
            >
              <div
                style="
                  width: 40px;
                  height: 40px;
                  border-radius: 10px;
                  background: linear-gradient(135deg, #0984e3, #74b9ff);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 11px;
                  font-weight: 800;
                  color: #fff;
                  flex-shrink: 0;
                  letter-spacing: 0.3px;
                "
              >
                CLX
              </div>
              <div style="flex: 1">
                <div style="display: flex; align-items: center; gap: 8px">
                  <span
                    style="
                      font-size: 13px;
                      font-weight: 700;
                      color: var(--text-primary);
                    "
                    >Clorox</span
                  ><span
                    style="
                      font-size: 9px;
                      padding: 2px 7px;
                      border-radius: 10px;
                      background: var(--page-bg);
                      color: var(--text-tertiary);
                      font-weight: 600;
                    "
                    >Household</span
                  >
                </div>
                <div
                  style="
                    font-size: 10.5px;
                    color: var(--text-tertiary);
                    margin-top: 2px;
                  "
                >
                  $14.6M est. media spend · No campaigns measured · No
                  attributed sales tracked
                </div>
              </div>
              <div style="display: flex; gap: 6px; flex-shrink: 0">
                <button
                  class="btn btn-outline btn-sm"
                  style="font-size: 10px; padding: 5px 12px"
                  onclick="openAccount('clx')"
                >
                  View Insights →</button
                ><button
                  class="btn btn-primary btn-sm"
                  style="font-size: 10px; padding: 5px 12px"
                  onclick="
                    showToast('Starting onboarding for Clorox...');
                    openDrawer('measurement');
                  "
                >
                  Onboard →
                </button>
              </div>
            </div>
            <div
              style="
                border: 1px solid var(--card-border);
                border-radius: 10px;
                padding: 14px 16px;
                margin-bottom: 6px;
                background: #fff;
                transition: border-color 0.2s;
              "
              onmouseenter="this.style.borderColor = 'var(--purple-accent)'"
              onmouseleave="this.style.borderColor = 'var(--card-border)'"
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  cursor: pointer;
                "
                onclick="toggleAgencyCard('pb')"
              >
                <svg
                  viewBox="0 0 24 24"
                  width="14"
                  height="14"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                  style="
                    transition: transform 0.2s;
                    transform: rotate(0deg);
                    flex-shrink: 0;
                  "
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <div
                  style="
                    width: 40px;
                    height: 40px;
                    border-radius: 10px;
                    background: linear-gradient(135deg, #6c5ce7, #a29bfe);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 11px;
                    font-weight: 800;
                    color: #fff;
                    flex-shrink: 0;
                    letter-spacing: 0.3px;
                  "
                >
                  PR
                </div>
                <div style="flex: 1; min-width: 0">
                  <div style="display: flex; align-items: center; gap: 8px">
                    <span
                      style="
                        font-size: 13px;
                        font-weight: 700;
                        color: var(--text-primary);
                      "
                      >Pernod Ricard</span
                    ><span
                      style="
                        font-size: 9px;
                        padding: 2px 7px;
                        border-radius: 10px;
                        background: var(--page-bg);
                        color: var(--text-tertiary);
                        font-weight: 600;
                      "
                      >Spirits &amp; Wine</span
                    >
                  </div>
                  <div
                    style="
                      font-size: 10.5px;
                      color: var(--text-tertiary);
                      margin-top: 1px;
                    "
                  >
                    3 campaigns · 1.38B impressions · $11.3M spend
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    gap: 18px;
                    align-items: center;
                    flex-shrink: 0;
                  "
                >
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--text-primary);
                      "
                    >
                      $54.6M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Attr. Sales
                    </div>
                  </div>
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--purple-accent);
                      "
                    >
                      $148M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Predicted LTV
                    </div>
                  </div>
                </div>
                <div
                  style="flex-shrink: 0; margin-left: 8px"
                  onclick="event.stopPropagation()"
                >
                  <button
                    class="btn btn-outline btn-sm"
                    style="font-size: 10px; padding: 5px 10px"
                    onclick="openAccount('pb')"
                  >
                    Open →
                  </button>
                </div>
              </div>
            </div>
            <div
              style="
                border: 1px solid var(--card-border);
                border-radius: 10px;
                padding: 14px 16px;
                margin-bottom: 6px;
                background: #fff;
                transition: border-color 0.2s;
              "
              onmouseenter="this.style.borderColor = 'var(--purple-accent)'"
              onmouseleave="this.style.borderColor = 'var(--card-border)'"
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  cursor: pointer;
                "
                onclick="toggleAgencyCard('gb')"
              >
                <svg
                  viewBox="0 0 24 24"
                  width="14"
                  height="14"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                  style="
                    transition: transform 0.2s;
                    transform: rotate(0deg);
                    flex-shrink: 0;
                  "
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <div
                  style="
                    width: 40px;
                    height: 40px;
                    border-radius: 10px;
                    background: linear-gradient(135deg, #00b894, #55efc4);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 11px;
                    font-weight: 800;
                    color: #fff;
                    flex-shrink: 0;
                    letter-spacing: 0.3px;
                  "
                >
                  GB
                </div>
                <div style="flex: 1; min-width: 0">
                  <div style="display: flex; align-items: center; gap: 8px">
                    <span
                      style="
                        font-size: 13px;
                        font-weight: 700;
                        color: var(--text-primary);
                      "
                      >Grupo Bimbo</span
                    ><span
                      style="
                        font-size: 9px;
                        padding: 2px 7px;
                        border-radius: 10px;
                        background: var(--page-bg);
                        color: var(--text-tertiary);
                        font-weight: 600;
                      "
                      >Packaged Bakery</span
                    >
                  </div>
                  <div
                    style="
                      font-size: 10.5px;
                      color: var(--text-tertiary);
                      margin-top: 1px;
                    "
                  >
                    2 campaigns · 892M impressions · $9.4M spend
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    gap: 18px;
                    align-items: center;
                    flex-shrink: 0;
                  "
                >
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--text-primary);
                      "
                    >
                      $35.0M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Attr. Sales
                    </div>
                  </div>
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--purple-accent);
                      "
                    >
                      $86M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Predicted LTV
                    </div>
                  </div>
                </div>
                <div
                  style="flex-shrink: 0; margin-left: 8px"
                  onclick="event.stopPropagation()"
                >
                  <button
                    class="btn btn-outline btn-sm"
                    style="font-size: 10px; padding: 5px 10px"
                    onclick="openAccount('gb')"
                  >
                    Open →
                  </button>
                </div>
              </div>
            </div>
            <div
              style="
                border: 1px solid var(--card-border);
                border-radius: 10px;
                padding: 14px 16px;
                margin-bottom: 6px;
                background: #fff;
                transition: border-color 0.2s;
              "
              onmouseenter="this.style.borderColor = 'var(--purple-accent)'"
              onmouseleave="this.style.borderColor = 'var(--card-border)'"
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  cursor: pointer;
                "
                onclick="toggleAgencyCard('dg')"
              >
                <svg
                  viewBox="0 0 24 24"
                  width="14"
                  height="14"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                  style="
                    transition: transform 0.2s;
                    transform: rotate(0deg);
                    flex-shrink: 0;
                  "
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <div
                  style="
                    width: 40px;
                    height: 40px;
                    border-radius: 10px;
                    background: linear-gradient(135deg, #fdcb6e, #e17055);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 11px;
                    font-weight: 800;
                    color: #fff;
                    flex-shrink: 0;
                    letter-spacing: 0.3px;
                  "
                >
                  DG
                </div>
                <div style="flex: 1; min-width: 0">
                  <div style="display: flex; align-items: center; gap: 8px">
                    <span
                      style="
                        font-size: 13px;
                        font-weight: 700;
                        color: var(--text-primary);
                      "
                      >Dollar General</span
                    ><span
                      style="
                        font-size: 9px;
                        padding: 2px 7px;
                        border-radius: 10px;
                        background: var(--page-bg);
                        color: var(--text-tertiary);
                        font-weight: 600;
                      "
                      >Discount Retail</span
                    >
                  </div>
                  <div
                    style="
                      font-size: 10.5px;
                      color: var(--text-tertiary);
                      margin-top: 1px;
                    "
                  >
                    2 campaigns · 1.12B impressions · $8.1M spend
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    gap: 18px;
                    align-items: center;
                    flex-shrink: 0;
                  "
                >
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--text-primary);
                      "
                    >
                      $16.7M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Attr. Sales
                    </div>
                  </div>
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--purple-accent);
                      "
                    >
                      $41M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Predicted LTV
                    </div>
                  </div>
                </div>
                <div
                  style="flex-shrink: 0; margin-left: 8px"
                  onclick="event.stopPropagation()"
                >
                  <button
                    class="btn btn-outline btn-sm"
                    style="font-size: 10px; padding: 5px 10px"
                    onclick="openAccount('dg')"
                  >
                    Open →
                  </button>
                </div>
              </div>
            </div>
            <div
              style="
                border: 1px solid var(--card-border);
                border-radius: 10px;
                padding: 14px 16px;
                margin-bottom: 6px;
                background: #fff;
                transition: border-color 0.2s;
              "
              onmouseenter="this.style.borderColor = 'var(--purple-accent)'"
              onmouseleave="this.style.borderColor = 'var(--card-border)'"
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  cursor: pointer;
                "
                onclick="toggleAgencyCard('cc')"
              >
                <svg
                  viewBox="0 0 24 24"
                  width="14"
                  height="14"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                  style="
                    transition: transform 0.2s;
                    transform: rotate(0deg);
                    flex-shrink: 0;
                  "
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <div
                  style="
                    width: 40px;
                    height: 40px;
                    border-radius: 10px;
                    background: linear-gradient(135deg, #0984e3, #6c5ce7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 11px;
                    font-weight: 800;
                    color: #fff;
                    flex-shrink: 0;
                    letter-spacing: 0.3px;
                  "
                >
                  CHD
                </div>
                <div style="flex: 1; min-width: 0">
                  <div style="display: flex; align-items: center; gap: 8px">
                    <span
                      style="
                        font-size: 13px;
                        font-weight: 700;
                        color: var(--text-primary);
                      "
                      >Church &amp; Dwight</span
                    ><span
                      style="
                        font-size: 9px;
                        padding: 2px 7px;
                        border-radius: 10px;
                        background: var(--page-bg);
                        color: var(--text-tertiary);
                        font-weight: 600;
                      "
                      >Household</span
                    >
                  </div>
                  <div
                    style="
                      font-size: 10.5px;
                      color: var(--text-tertiary);
                      margin-top: 1px;
                    "
                  >
                    2 campaigns · 684M impressions · $7.2M spend
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    gap: 18px;
                    align-items: center;
                    flex-shrink: 0;
                  "
                >
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--text-primary);
                      "
                    >
                      $18.9M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Attr. Sales
                    </div>
                  </div>
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--purple-accent);
                      "
                    >
                      $47M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Predicted LTV
                    </div>
                  </div>
                </div>
                <div
                  style="flex-shrink: 0; margin-left: 8px"
                  onclick="event.stopPropagation()"
                >
                  <button
                    class="btn btn-outline btn-sm"
                    style="font-size: 10px; padding: 5px 10px"
                    onclick="openAccount('cc')"
                  >
                    Open →
                  </button>
                </div>
              </div>
            </div>
            <div
              style="
                border: 1px dashed #d8d0ef;
                border-radius: 10px;
                padding: 14px 16px;
                margin-bottom: 6px;
                background: linear-gradient(135deg, #fafafe, #f8f6fc);
                display: flex;
                align-items: center;
                gap: 14px;
              "
            >
              <div
                style="
                  width: 40px;
                  height: 40px;
                  border-radius: 10px;
                  background: linear-gradient(135deg, #d63031, #fdcb6e);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 11px;
                  font-weight: 800;
                  color: #fff;
                  flex-shrink: 0;
                  letter-spacing: 0.3px;
                "
              >
                HRL
              </div>
              <div style="flex: 1">
                <div style="display: flex; align-items: center; gap: 8px">
                  <span
                    style="
                      font-size: 13px;
                      font-weight: 700;
                      color: var(--text-primary);
                    "
                    >Hormel Foods</span
                  ><span
                    style="
                      font-size: 9px;
                      padding: 2px 7px;
                      border-radius: 10px;
                      background: var(--page-bg);
                      color: var(--text-tertiary);
                      font-weight: 600;
                    "
                    >Packaged Meats</span
                  >
                </div>
                <div
                  style="
                    font-size: 10.5px;
                    color: var(--text-tertiary);
                    margin-top: 2px;
                  "
                >
                  $6.8M est. media spend · No campaigns measured · No attributed
                  sales tracked
                </div>
              </div>
              <div style="display: flex; gap: 6px; flex-shrink: 0">
                <button
                  class="btn btn-outline btn-sm"
                  style="font-size: 10px; padding: 5px 12px"
                  onclick="openAccount('hrl')"
                >
                  View Insights →</button
                ><button
                  class="btn btn-primary btn-sm"
                  style="font-size: 10px; padding: 5px 12px"
                  onclick="
                    showToast('Starting onboarding for Hormel Foods...');
                    openDrawer('measurement');
                  "
                >
                  Onboard →
                </button>
              </div>
            </div>
            <div
              style="
                border: 1px dashed #d8d0ef;
                border-radius: 10px;
                padding: 14px 16px;
                margin-bottom: 6px;
                background: linear-gradient(135deg, #fafafe, #f8f6fc);
                display: flex;
                align-items: center;
                gap: 14px;
              "
            >
              <div
                style="
                  width: 40px;
                  height: 40px;
                  border-radius: 10px;
                  background: linear-gradient(135deg, #fdcb6e, #00b894);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 11px;
                  font-weight: 800;
                  color: #fff;
                  flex-shrink: 0;
                  letter-spacing: 0.3px;
                "
              >
                EPC
              </div>
              <div style="flex: 1">
                <div style="display: flex; align-items: center; gap: 8px">
                  <span
                    style="
                      font-size: 13px;
                      font-weight: 700;
                      color: var(--text-primary);
                    "
                    >Edgewell Personal Care</span
                  ><span
                    style="
                      font-size: 9px;
                      padding: 2px 7px;
                      border-radius: 10px;
                      background: var(--page-bg);
                      color: var(--text-tertiary);
                      font-weight: 600;
                    "
                    >Personal Care</span
                  >
                </div>
                <div
                  style="
                    font-size: 10.5px;
                    color: var(--text-tertiary);
                    margin-top: 2px;
                  "
                >
                  $5.1M est. media spend · No campaigns measured · No attributed
                  sales tracked
                </div>
              </div>
              <div style="display: flex; gap: 6px; flex-shrink: 0">
                <button
                  class="btn btn-outline btn-sm"
                  style="font-size: 10px; padding: 5px 12px"
                  onclick="openAccount('es')"
                >
                  View Insights →</button
                ><button
                  class="btn btn-primary btn-sm"
                  style="font-size: 10px; padding: 5px 12px"
                  onclick="
                    showToast(
                      'Starting onboarding for Edgewell Personal Care...',
                    );
                    openDrawer('measurement');
                  "
                >
                  Onboard →
                </button>
              </div>
            </div>
            <div
              style="
                border: 1px solid var(--card-border);
                border-radius: 10px;
                padding: 14px 16px;
                margin-bottom: 6px;
                background: #fff;
                transition: border-color 0.2s;
              "
              onmouseenter="this.style.borderColor = 'var(--purple-accent)'"
              onmouseleave="this.style.borderColor = 'var(--card-border)'"
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  cursor: pointer;
                "
                onclick="toggleAgencyCard('post')"
              >
                <svg
                  viewBox="0 0 24 24"
                  width="14"
                  height="14"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                  style="
                    transition: transform 0.2s;
                    transform: rotate(0deg);
                    flex-shrink: 0;
                  "
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <div
                  style="
                    width: 40px;
                    height: 40px;
                    border-radius: 10px;
                    background: linear-gradient(135deg, #e17055, #d63031);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 11px;
                    font-weight: 800;
                    color: #fff;
                    flex-shrink: 0;
                    letter-spacing: 0.3px;
                  "
                >
                  PST
                </div>
                <div style="flex: 1; min-width: 0">
                  <div style="display: flex; align-items: center; gap: 8px">
                    <span
                      style="
                        font-size: 13px;
                        font-weight: 700;
                        color: var(--text-primary);
                      "
                      >Post Holdings</span
                    ><span
                      style="
                        font-size: 9px;
                        padding: 2px 7px;
                        border-radius: 10px;
                        background: var(--page-bg);
                        color: var(--text-tertiary);
                        font-weight: 600;
                      "
                      >Cereal &amp; Snacks</span
                    >
                  </div>
                  <div
                    style="
                      font-size: 10.5px;
                      color: var(--text-tertiary);
                      margin-top: 1px;
                    "
                  >
                    1 campaigns · 412M impressions · $4.8M spend
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    gap: 18px;
                    align-items: center;
                    flex-shrink: 0;
                  "
                >
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--text-primary);
                      "
                    >
                      $12.0M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Attr. Sales
                    </div>
                  </div>
                  <div style="text-align: right">
                    <div
                      style="
                        font-size: 15px;
                        font-weight: 800;
                        color: var(--purple-accent);
                      "
                    >
                      $31M
                    </div>
                    <div
                      style="
                        font-size: 7.5px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.3px;
                        color: var(--text-tertiary);
                      "
                    >
                      Predicted LTV
                    </div>
                  </div>
                </div>
                <div
                  style="flex-shrink: 0; margin-left: 8px"
                  onclick="event.stopPropagation()"
                >
                  <button
                    class="btn btn-outline btn-sm"
                    style="font-size: 10px; padding: 5px 10px"
                    onclick="openAccount('post')"
                  >
                    Open →
                  </button>
                </div>
              </div>
            </div>
            <div
              style="
                border: 1px dashed #d8d0ef;
                border-radius: 10px;
                padding: 14px 16px;
                margin-bottom: 6px;
                background: linear-gradient(135deg, #fafafe, #f8f6fc);
                display: flex;
                align-items: center;
                gap: 14px;
              "
            >
              <div
                style="
                  width: 40px;
                  height: 40px;
                  border-radius: 10px;
                  background: linear-gradient(135deg, #a29bfe, #74b9ff);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 11px;
                  font-weight: 800;
                  color: #fff;
                  flex-shrink: 0;
                  letter-spacing: 0.3px;
                "
              >
                SPB
              </div>
              <div style="flex: 1">
                <div style="display: flex; align-items: center; gap: 8px">
                  <span
                    style="
                      font-size: 13px;
                      font-weight: 700;
                      color: var(--text-primary);
                    "
                    >Spectrum Brands</span
                  ><span
                    style="
                      font-size: 9px;
                      padding: 2px 7px;
                      border-radius: 10px;
                      background: var(--page-bg);
                      color: var(--text-tertiary);
                      font-weight: 600;
                    "
                    >Home &amp; Garden</span
                  >
                </div>
                <div
                  style="
                    font-size: 10.5px;
                    color: var(--text-tertiary);
                    margin-top: 2px;
                  "
                >
                  $3.9M est. media spend · No campaigns measured · No attributed
                  sales tracked
                </div>
              </div>
              <div style="display: flex; gap: 6px; flex-shrink: 0">
                <button
                  class="btn btn-outline btn-sm"
                  style="font-size: 10px; padding: 5px 12px"
                  onclick="openAccount('sm')"
                >
                  View Insights →</button
                ><button
                  class="btn btn-primary btn-sm"
                  style="font-size: 10px; padding: 5px 12px"
                  onclick="
                    showToast('Starting onboarding for Spectrum Brands...');
                    openDrawer('measurement');
                  "
                >
                  Onboard →
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ═══ ACCOUNT VIEW (BK Dashboard) ═══ -->
      <div id="accountView">
        <!-- Sticky Brand + Mode Bar -->
        <div
          style="
            position: sticky;
            top: 49px;
            z-index: 45;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--card-border);
            padding: 10px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0 -32px;
          "
          id="brandModeBar"
        >
          <div style="display: flex; align-items: center; gap: 12px">
            <div style="position: relative">
              <div
                onclick="toggleAccountSwitcher()"
                style="
                  display: flex;
                  align-items: center;
                  gap: 10px;
                  cursor: pointer;
                  padding: 4px 8px 4px 4px;
                  border-radius: 8px;
                  transition: background 0.15s;
                "
                onmouseenter="this.style.background = 'var(--page-bg)'"
                onmouseleave="this.style.background = 'transparent'"
              >
                <div
                  class="brand-logo"
                  style="width: 34px; height: 34px; font-size: 12px"
                >
                  BK
                </div>
                <div>
                  <div
                    style="
                      font-size: 14px;
                      font-weight: 700;
                      color: var(--text-primary);
                      display: flex;
                      align-items: center;
                      gap: 4px;
                    "
                  >
                    Burger King
                    <svg
                      viewBox="0 0 24 24"
                      width="12"
                      height="12"
                      fill="none"
                      stroke="var(--text-tertiary)"
                      stroke-width="2"
                    >
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </div>
                  <div style="font-size: 9.5px; color: var(--text-tertiary)">
                    Quick Service Restaurants
                  </div>
                </div>
              </div>
              <!-- Account Switcher Dropdown -->
              <div
                id="accountSwitcher"
                style="
                  display: none;
                  position: absolute;
                  top: calc(100% + 6px);
                  left: 0;
                  width: 280px;
                  background: #fff;
                  border: 1px solid var(--card-border);
                  border-radius: 10px;
                  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
                  z-index: 60;
                  overflow: hidden;
                "
              >
                <div
                  onclick="
                    backToHub();
                    toggleAccountSwitcher();
                  "
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 10px 14px;
                    cursor: pointer;
                    border-bottom: 1px solid var(--card-border);
                    transition: background 0.15s;
                  "
                  onmouseenter="this.style.background = 'var(--purple-bg)'"
                  onmouseleave="this.style.background = 'transparent'"
                >
                  <svg
                    viewBox="0 0 24 24"
                    width="14"
                    height="14"
                    fill="none"
                    stroke="var(--purple-accent)"
                    stroke-width="2"
                  >
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                  <span
                    style="
                      font-size: 11px;
                      font-weight: 600;
                      color: var(--purple-accent);
                    "
                    >PHD Media Portfolio</span
                  >
                </div>
                <div
                  style="padding: 6px 0; max-height: 280px; overflow-y: auto"
                  id="accountSwitcherList"
                ></div>
              </div>
            </div>
            <div
              style="
                width: 1px;
                height: 28px;
                background: var(--card-border);
                margin: 0 4px;
              "
            ></div>
            <div class="mode-toggle">
              <div class="mode-opt" onclick="setMode('insights', this)">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg
                >Insights
              </div>
              <div
                class="mode-opt active"
                onclick="setMode('attribution', this)"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline
                    points="22 12 18 12 15 21 9 3 6 12 2 12"
                  ></polyline></svg
                >Attribution
              </div>
            </div>
            <div class="mode-hint" id="modeHint" style="font-size: 11px">
              Showing longitudinal purchase insights
            </div>
          </div>
          <div
            class="brand-actions"
            style="display: flex; gap: 8px; margin-right: 8px"
          >
            <button
              class="btn btn-outline btn-sm"
              onclick="toggleReports()"
              style="font-size: 10px"
            >
              <svg
                viewBox="0 0 24 24"
                width="12"
                height="12"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line></svg
              >Reports
            </button>
            <button
              class="btn btn-outline btn-sm"
              onclick="openDrawer('ai')"
              style="font-size: 10px"
            >
              <svg
                viewBox="0 0 24 24"
                width="12"
                height="12"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polygon
                  points="13 2 3 14 12 14 11 22 21 10 12 10"
                ></polygon></svg
              >AI Summary
            </button>
            <button
              class="btn btn-primary btn-sm"
              onclick="openDrawer('audience')"
              style="font-size: 10px"
            >
              <svg
                viewBox="0 0 24 24"
                width="12"
                height="12"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <line x1="19" y1="8" x2="19" y2="14"></line>
                <line x1="22" y1="11" x2="16" y2="11"></line></svg
              >Build Audience
            </button>
          </div>
        </div>

        <!-- Filter Bar — Mode-Aware -->
        <div class="filter-bar fade-in stagger-1" id="filterBar">
          <button
            class="filter-collapse-btn"
            id="filterCollapseBtn"
            onclick="toggleFilters()"
          >
            <svg
              viewBox="0 0 24 24"
              width="14"
              height="14"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="6 9 12 15 18 9"></polyline></svg
            >Filters
          </button>
          <div
            class="filter-inner"
            id="filterInner"
            style="
              display: flex;
              align-items: center;
              gap: 6px;
              flex-wrap: wrap;
              flex: 1;
            "
          >
            <!-- Insights mode filters -->
            <div
              id="insightsFilters"
              style="
                display: none;
                align-items: center;
                gap: 6px;
                flex-wrap: wrap;
              "
            >
              <div class="fg-pills" id="insTimePills">
                <div
                  class="filter-pill"
                  data-time="1m"
                  onclick="setInsightsTime(this)"
                >
                  1M
                </div>
                <div
                  class="filter-pill"
                  data-time="3m"
                  onclick="setInsightsTime(this)"
                >
                  3M
                </div>
                <div
                  class="filter-pill"
                  data-time="6m"
                  onclick="setInsightsTime(this)"
                >
                  6M
                </div>
                <div
                  class="filter-pill active"
                  data-time="12m"
                  onclick="setInsightsTime(this)"
                >
                  12M
                </div>
                <div
                  class="filter-pill"
                  data-time="custom"
                  onclick="setInsightsTime(this)"
                >
                  Custom
                </div>
              </div>
              <div class="filter-divider"></div>
              <select
                class="filter-select"
                id="insDimension"
                onchange="setDimension(this.value)"
                style="font-size: 11px; padding: 4px 8px"
              >
                <option value="cohort">Customer Type</option>
                <option value="generation">Generation</option>
                <option value="geo">Geography</option>
                <option value="education">Education</option>
                <option value="gender">Gender</option>
                <option value="hhi">HH Income</option>
                <option value="ethnicity">Ethnicity</option>
              </select>
              <div class="filter-divider"></div>
              <select
                class="filter-select"
                id="insCompare"
                onchange="setCompare(this.value)"
                style="font-size: 11px; padding: 4px 8px"
              >
                <option value="">+ Overlay Competitor</option>
                <option value="mcdonalds">McDonald's</option>
                <option value="wendys">Wendy's</option>
                <option value="popeyes">Popeye's</option>
                <option value="chickfila">Chick-fil-A</option>
                <option value="subway">Subway</option>
              </select>
            </div>

            <!-- Attribution mode filters -->
            <div
              id="attrFilters"
              style="
                display: flex;
                align-items: center;
                gap: 6px;
                flex-wrap: wrap;
              "
            >
              <div class="fg-pills" id="timePills">
                <div
                  class="filter-pill active"
                  data-time="week"
                  onclick="setTime(this)"
                >
                  Week
                </div>
                <div
                  class="filter-pill"
                  data-time="30d"
                  onclick="setTime(this)"
                >
                  30D
                </div>
                <div
                  class="filter-pill"
                  data-time="90d"
                  onclick="setTime(this)"
                >
                  90D
                </div>
              </div>
              <div class="filter-divider"></div>
              <div class="fg-pills" id="viewPills">
                <div
                  class="filter-pill active"
                  data-view="cohort"
                  onclick="setView(this)"
                >
                  Cohort
                </div>
                <div
                  class="filter-pill"
                  data-view="channel"
                  onclick="setView(this)"
                >
                  Channel
                </div>
                <div
                  class="filter-pill"
                  data-view="geo"
                  onclick="setView(this)"
                >
                  Geo
                </div>
              </div>
              <div class="filter-divider"></div>
              <div class="fg-pills" id="channelPills">
                <div
                  class="filter-pill toggle active"
                  data-ch="all"
                  onclick="toggleChannel(this)"
                >
                  All
                </div>
                <div
                  class="filter-pill toggle active"
                  data-ch="display"
                  onclick="toggleChannel(this)"
                >
                  Display
                </div>
                <div
                  class="filter-pill toggle active"
                  data-ch="social"
                  onclick="toggleChannel(this)"
                >
                  Social
                </div>
                <div
                  class="filter-pill toggle active"
                  data-ch="ctv"
                  onclick="toggleChannel(this)"
                >
                  CTV
                </div>
                <div
                  class="filter-pill toggle"
                  data-ch="audio"
                  onclick="toggleChannel(this)"
                >
                  Audio
                </div>
              </div>
              <div class="filter-divider"></div>
              <select
                class="filter-select"
                id="creativeSelect"
                onchange="setCreative(this.value)"
                style="font-size: 11px; padding: 4px 8px"
              >
                <option value="all">All Creatives</option>
                <option value="whopper">Whopper Value Meal</option>
                <option value="flame">Flame-Grilled Taste</option>
                <option value="family">Family Bundle</option>
                <option value="app">BK App Promo</option>
              </select>
              <select
                class="filter-select"
                id="compareSelect"
                onchange="setCompare(this.value)"
                style="font-size: 11px; padding: 4px 8px"
              >
                <option value="">+ Compare</option>
                <option value="mcdonalds">vs McDonald's</option>
                <option value="wendys">vs Wendy's</option>
                <option value="popeyes">vs Popeye's</option>
                <option value="chickfila">vs Chick-fil-A</option>
                <option value="subway">vs Subway</option>
              </select>
            </div>
          </div>
          <!-- /filter-inner -->
        </div>

        <div class="kpi-row fade-in stagger-2" id="kpiRow">
          <div class="kpi-card dark">
            <div class="kpi-label">Total Sales</div>
            <div class="kpi-value">
              $653K <span class="kpi-delta up">▲ 9.8%</span>
            </div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Attributed Sales</div>
            <div class="kpi-value">
              $271.8K <span class="kpi-delta up">▲ 41.6%</span>
            </div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">ROAS</div>
            <div class="kpi-value">
              3.59x <span class="kpi-delta up">▲ 12.1%</span>
            </div>
          </div>
          <div class="kpi-card" style="position: relative">
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
              "
            >
              <div class="kpi-label">Converting Buyers</div>
              <div
                onclick="
                  event.stopPropagation();
                  toggleKpiGear('buyerGear');
                "
                style="
                  cursor: pointer;
                  color: var(--text-tertiary);
                  padding: 2px;
                  border-radius: 4px;
                  transition: color 0.15s;
                "
                onmouseenter="this.style.color = 'var(--purple-accent)'"
                onmouseleave="this.style.color = 'var(--text-tertiary)'"
              >
                <svg
                  viewBox="0 0 24 24"
                  width="11"
                  height="11"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="3"></circle>
                  <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"
                  ></path>
                </svg>
              </div>
            </div>
            <div class="kpi-value">
              19,461 <span class="kpi-delta down">▼ 2.0%</span>
            </div>
            <div style="display: flex; gap: 0; margin-top: 5px">
              <div
                onclick="
                  event.stopPropagation();
                  kpiBuyerNnb = false;
                  renderKPIs();
                "
                style="
                  font-size: 8px;
                  font-weight: 600;
                  padding: 2px 6px;
                  border-radius: 3px 0 0 3px;
                  cursor: pointer;
                  border: 1px solid var(--card-border);
                  background: var(--purple-accent);
                  color: #fff;
                  border-color: var(--purple-accent);
                "
              >
                All
              </div>
              <div
                onclick="
                  event.stopPropagation();
                  kpiBuyerNnb = true;
                  renderKPIs();
                "
                style="
                  font-size: 8px;
                  font-weight: 600;
                  padding: 2px 6px;
                  border-radius: 0 3px 3px 0;
                  cursor: pointer;
                  border: 1px solid var(--card-border);
                  border-left: 0;
                  background: transparent;
                  color: var(--text-tertiary);
                "
              >
                Net-New
              </div>
            </div>
            <div
              id="buyerGear"
              style="
                display: none;
                position: absolute;
                top: calc(100% + 4px);
                left: -4px;
                right: -4px;
                z-index: 50;
                background: #fff;
                border: 1px solid var(--card-border);
                border-radius: 10px;
                padding: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
              "
            >
              <div
                style="
                  font-size: 10px;
                  font-weight: 700;
                  color: var(--text-primary);
                  margin-bottom: 8px;
                "
              >
                Attribution Window
              </div>
              <div
                style="
                  font-size: 9px;
                  color: var(--text-tertiary);
                  margin-bottom: 8px;
                "
              >
                How long after ad exposure should a purchase receive campaign
                credit?
              </div>
              <div
                style="
                  display: flex;
                  flex-wrap: wrap;
                  gap: 4px;
                  margin-bottom: 10px;
                "
              >
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiAttrWindow('1 day');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  1 day
                </div>
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiAttrWindow('3 days');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  3 days
                </div>
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiAttrWindow('4 days');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  4 days
                </div>
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiAttrWindow('7 days');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  7 days
                </div>
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiAttrWindow('14 days');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  14 days
                </div>
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiAttrWindow('30 days');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  30 days
                </div>
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiAttrWindow('45 days');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  45 days
                </div>
              </div>
              <div
                onclick="
                  event.stopPropagation();
                  resetKpiWindows();
                "
                style="
                  font-size: 9px;
                  font-weight: 600;
                  color: var(--coral);
                  cursor: pointer;
                  text-align: center;
                  padding-top: 6px;
                  border-top: 1px solid var(--card-border);
                "
              >
                Reset to defaults
              </div>
            </div>
          </div>
          <div
            class="kpi-card"
            style="
              position: relative;
              background: linear-gradient(135deg, #f0eeff, #faf9fd);
              border: 1px solid #e0dced;
            "
          >
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
              "
            >
              <div class="kpi-label" style="color: var(--purple-accent)">
                Predicted CLTV
              </div>
              <div
                onclick="
                  event.stopPropagation();
                  toggleKpiGear('cltvGear');
                "
                style="
                  cursor: pointer;
                  color: var(--text-tertiary);
                  padding: 2px;
                  border-radius: 4px;
                  transition: color 0.15s;
                "
                onmouseenter="this.style.color = 'var(--purple-accent)'"
                onmouseleave="this.style.color = 'var(--text-tertiary)'"
              >
                <svg
                  viewBox="0 0 24 24"
                  width="11"
                  height="11"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="3"></circle>
                  <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"
                  ></path>
                </svg>
              </div>
            </div>
            <div class="kpi-value" style="color: var(--purple-accent)">
              $4.2M <span class="kpi-delta up">▲ 18.6%</span>
            </div>
            <div
              style="
                font-size: 8.5px;
                color: var(--text-tertiary);
                margin-top: 3px;
              "
            >
              From 1,847 net-new converters
            </div>
            <div
              id="cltvGear"
              style="
                display: none;
                position: absolute;
                top: calc(100% + 4px);
                right: -4px;
                left: -4px;
                z-index: 50;
                background: #fff;
                border: 1px solid var(--card-border);
                border-radius: 10px;
                padding: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
              "
            >
              <div
                style="
                  font-size: 10px;
                  font-weight: 700;
                  color: var(--text-primary);
                  margin-bottom: 8px;
                "
              >
                LTV Prediction Window
              </div>
              <div
                style="
                  font-size: 9px;
                  color: var(--text-tertiary);
                  margin-bottom: 8px;
                "
              >
                How far back should we look to define a converter as net-new for
                LTV modeling?
              </div>
              <div
                style="
                  display: flex;
                  flex-wrap: wrap;
                  gap: 4px;
                  margin-bottom: 10px;
                "
              >
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiNnbWindow('30 days');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  30 days
                </div>
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiNnbWindow('45 days');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  45 days
                </div>
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiNnbWindow('90 days');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  90 days
                </div>
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiNnbWindow('180 days');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  180 days
                </div>
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiNnbWindow('12 months');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  12 months
                </div>
                <div
                  onclick="
                    event.stopPropagation();
                    setKpiNnbWindow('18 months');
                  "
                  style="
                    font-size: 9px;
                    font-weight: 600;
                    padding: 3px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    border: 1px solid var(--card-border);
                    background: transparent;
                    color: var(--text-secondary);
                  "
                >
                  18 months
                </div>
              </div>
              <div
                onclick="
                  event.stopPropagation();
                  resetKpiWindows();
                "
                style="
                  font-size: 9px;
                  font-weight: 600;
                  color: var(--coral);
                  cursor: pointer;
                  text-align: center;
                  padding-top: 6px;
                  border-top: 1px solid var(--card-border);
                "
              >
                Reset to defaults
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ ALWAYS-ON SALES SIGNAL ═══ -->
        <!-- ═══ SECTION CONTROLS ═══ -->
        <div
          style="padding: 0 32px 8px; display: flex; justify-content: flex-end"
        >
          <button
            class="btn btn-sm"
            style="
              font-size: 9px;
              padding: 4px 10px;
              border: 1px solid var(--card-border);
              background: var(--card-bg);
              color: var(--text-secondary);
            "
            onclick="toggleAllSections()"
            id="collapseAllBtn"
          >
            <svg
              viewBox="0 0 24 24"
              width="10"
              height="10"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            <span id="collapseAllLabel">Collapse All</span>
          </button>
        </div>

        <div class="section-pad fade-in stagger-3">
          <div class="card collapsible-card">
            <div
              class="card-header collapsible-header"
              onclick="toggleSection(this)"
              style="cursor: pointer"
            >
              <div>
                <div class="card-title" id="chartTitle">
                  % of Sales by Buyer Cohort
                  <span class="badge"
                    ><span
                      class="live-dot"
                      style="width: 6px; height: 6px; margin-right: 4px"
                    ></span
                    >LIVE</span
                  >
                </div>
                <div class="card-subtitle" id="chartSubtitle">
                  % of Sales by cohort — track and compare segment performance
                </div>
              </div>
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  flex-wrap: wrap;
                "
                onclick="event.stopPropagation()"
              >
                <div
                  id="chartActiveFilters"
                  class="hide-collapsed"
                  style="
                    display: flex;
                    gap: 4px;
                    align-items: center;
                    flex-wrap: wrap;
                  "
                ></div>
                <div
                  id="granPills"
                  class="hide-collapsed"
                  style="
                    display: none;
                    background: var(--page-bg);
                    border: 1px solid var(--card-border);
                    border-radius: 6px;
                    overflow: hidden;
                  "
                >
                  <button
                    class="cohort-view-btn"
                    id="granDay"
                    onclick="setGranularity('daily')"
                    title="Daily"
                    style="font-size: 9px; padding: 4px 7px; font-weight: 600"
                  >
                    D
                  </button>
                  <button
                    class="cohort-view-btn active"
                    id="granWeek"
                    onclick="setGranularity('weekly')"
                    title="Weekly"
                    style="font-size: 9px; padding: 4px 7px; font-weight: 600"
                  >
                    W
                  </button>
                  <button
                    class="cohort-view-btn"
                    id="granMonth"
                    onclick="setGranularity('monthly')"
                    title="Monthly"
                    style="font-size: 9px; padding: 4px 7px; font-weight: 600"
                  >
                    M
                  </button>
                </div>
                <div
                  id="chartViewToggle"
                  class="hide-collapsed"
                  style="
                    display: flex;
                    background: var(--page-bg);
                    border: 1px solid var(--card-border);
                    border-radius: 6px;
                    overflow: hidden;
                  "
                >
                  <button
                    class="cohort-view-btn active"
                    id="chartLine"
                    onclick="
                      event.stopPropagation();
                      setChartType('line');
                    "
                    title="Line"
                  >
                    <svg
                      viewBox="0 0 24 24"
                      width="13"
                      height="13"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <polyline
                        points="22 12 18 12 15 21 9 3 6 12 2 12"
                      ></polyline>
                    </svg>
                  </button>
                  <button
                    class="cohort-view-btn"
                    id="chartPie"
                    onclick="
                      event.stopPropagation();
                      setChartType('pie');
                    "
                    title="Pie"
                  >
                    <svg
                      viewBox="0 0 24 24"
                      width="13"
                      height="13"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                      <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                    </svg>
                  </button>
                </div>
                <select
                  class="filter-select hide-collapsed"
                  id="attrMetric"
                  style="font-size: 11px; padding: 5px 28px 5px 10px"
                  onchange="setAttrMetric(this.value)"
                >
                  <option value="pct">% of Sales</option>
                  <option value="roas">ROAS</option>
                  <option value="cpa">CPA</option>
                  <option value="aov">AOV</option>
                  <option value="cvr">CVR</option>
                </select>
                <button
                  id="chartResetBtn"
                  class="hide-collapsed"
                  style="
                    display: none;
                    background: none;
                    border: 1px solid var(--card-border);
                    border-radius: 6px;
                    padding: 4px 8px;
                    cursor: pointer;
                    font-family: var(--font);
                    font-size: 9px;
                    font-weight: 600;
                    color: var(--text-tertiary);
                    transition: all 0.15s;
                    white-space: nowrap;
                  "
                  onmouseover="
                    this.style.color = 'var(--purple-accent)';
                    this.style.borderColor = 'var(--purple-accent)';
                  "
                  onmouseout="
                    this.style.color = 'var(--text-tertiary)';
                    this.style.borderColor = 'var(--card-border)';
                  "
                  onclick="resetChart()"
                >
                  <svg
                    viewBox="0 0 24 24"
                    width="11"
                    height="11"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    style="vertical-align: -1px"
                  >
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                  </svg>
                  Reset
                </button>
                <svg
                  class="collapse-chevron"
                  onclick="
                    event.stopPropagation();
                    toggleSection(this.closest('.collapsible-header'));
                  "
                  viewBox="0 0 24 24"
                  width="16"
                  height="16"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
            </div>
            <div class="collapsible-body">
              <!-- Channel deselection hint -->
              <div id="channelHint" style="display: none; padding: 0 22px">
                <div
                  style="
                    background: var(--amber-bg);
                    border: 1px solid #f0e4b0;
                    border-radius: 8px;
                    padding: 10px 14px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                  "
                >
                  <svg
                    viewBox="0 0 24 24"
                    width="16"
                    height="16"
                    fill="none"
                    stroke="#e17055"
                    stroke-width="2"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                  </svg>
                  <span id="channelHintText"></span>
                </div>
              </div>
              <div class="card-body">
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 5px;
                    flex-wrap: wrap;
                    padding: 0 0 10px;
                  "
                  id="segmentToggles"
                >
                  <span
                    style="
                      font-size: 9px;
                      font-weight: 600;
                      color: var(--text-tertiary);
                      text-transform: uppercase;
                      letter-spacing: 0.4px;
                      margin-right: 2px;
                    "
                    >Segments</span
                  >
                  <div
                    style="
                      padding: 3px 8px;
                      font-size: 10px;
                      font-weight: 600;
                      border-radius: 5px;
                      cursor: pointer;
                      border: 1px solid var(--purple-accent);
                      background: var(--purple-accent);
                      color: #fff;
                    "
                    onclick="toggleSegment(null)"
                  >
                    All
                  </div>
                  <div
                    style="
                      padding: 3px 8px;
                      font-size: 10px;
                      font-weight: 600;
                      border-radius: 5px;
                      cursor: pointer;
                      display: flex;
                      align-items: center;
                      gap: 4px;
                      border: 1.5px solid #6c5ce7;
                      background: #6c5ce718;
                      color: #6c5ce7;
                      opacity: 1;
                    "
                    onclick="toggleSegment('New-to-Category')"
                  >
                    <span
                      style="
                        width: 7px;
                        height: 7px;
                        border-radius: 50%;
                        background: #6c5ce7;
                      "
                    ></span
                    >New-to-Category
                  </div>
                  <div
                    style="
                      padding: 3px 8px;
                      font-size: 10px;
                      font-weight: 600;
                      border-radius: 5px;
                      cursor: pointer;
                      display: flex;
                      align-items: center;
                      gap: 4px;
                      border: 1.5px solid #74b9ff;
                      background: #74b9ff18;
                      color: #74b9ff;
                      opacity: 1;
                    "
                    onclick="toggleSegment('Ultra-Light')"
                  >
                    <span
                      style="
                        width: 7px;
                        height: 7px;
                        border-radius: 50%;
                        background: #74b9ff;
                      "
                    ></span
                    >Ultra-Light
                  </div>
                  <div
                    style="
                      padding: 3px 8px;
                      font-size: 10px;
                      font-weight: 600;
                      border-radius: 5px;
                      cursor: pointer;
                      display: flex;
                      align-items: center;
                      gap: 4px;
                      border: 1.5px solid #e17055;
                      background: #e1705518;
                      color: #e17055;
                      opacity: 1;
                    "
                    onclick="toggleSegment('Competitor')"
                  >
                    <span
                      style="
                        width: 7px;
                        height: 7px;
                        border-radius: 50%;
                        background: #e17055;
                      "
                    ></span
                    >Competitor
                  </div>
                  <div
                    style="
                      padding: 3px 8px;
                      font-size: 10px;
                      font-weight: 600;
                      border-radius: 5px;
                      cursor: pointer;
                      display: flex;
                      align-items: center;
                      gap: 4px;
                      border: 1.5px solid #00b894;
                      background: #00b89418;
                      color: #00b894;
                      opacity: 1;
                    "
                    onclick="toggleSegment('Frequent')"
                  >
                    <span
                      style="
                        width: 7px;
                        height: 7px;
                        border-radius: 50%;
                        background: #00b894;
                      "
                    ></span
                    >Frequent
                  </div>
                  <div
                    style="
                      padding: 3px 8px;
                      font-size: 10px;
                      font-weight: 600;
                      border-radius: 5px;
                      cursor: pointer;
                      display: flex;
                      align-items: center;
                      gap: 4px;
                      border: 1.5px solid #fdcb6e;
                      background: #fdcb6e18;
                      color: #fdcb6e;
                      opacity: 1;
                    "
                    onclick="toggleSegment('Loyal')"
                  >
                    <span
                      style="
                        width: 7px;
                        height: 7px;
                        border-radius: 50%;
                        background: #fdcb6e;
                      "
                    ></span
                    >Loyal
                  </div>
                  <div
                    style="
                      padding: 3px 8px;
                      font-size: 10px;
                      font-weight: 600;
                      border-radius: 5px;
                      cursor: pointer;
                      display: flex;
                      align-items: center;
                      gap: 4px;
                      border: 1.5px solid #a29bfe;
                      background: #a29bfe18;
                      color: #a29bfe;
                      opacity: 1;
                    "
                    onclick="toggleSegment('Occasion-Driven')"
                  >
                    <span
                      style="
                        width: 7px;
                        height: 7px;
                        border-radius: 50%;
                        background: #a29bfe;
                      "
                    ></span
                    >Occasion-Driven
                  </div>
                </div>
                <div style="display: flex; gap: 16px">
                  <div
                    style="
                      flex: 1;
                      height: 280px;
                      position: relative;
                      min-width: 0;
                    "
                  >
                    <canvas
                      id="salesChart"
                      width="3062"
                      height="560"
                      style="
                        display: block;
                        box-sizing: border-box;
                        height: 280px;
                        width: 1531px;
                      "
                    ></canvas>
                  </div>
                  <div
                    id="pieCohortPanel"
                    style="
                      display: none;
                      width: 220px;
                      flex-shrink: 0;
                      overflow-y: auto;
                    "
                  >
                    <!-- Rendered by JS when pie mode active -->
                  </div>
                </div>
                <!-- Compare legend when active -->
                <div
                  id="compareLegend"
                  style="
                    display: none;
                    margin-top: 8px;
                    padding: 8px 12px;
                    background: var(--page-bg);
                    border-radius: 8px;
                    font-size: 11px;
                    color: var(--text-secondary);
                  "
                >
                  <span
                    style="
                      display: inline-block;
                      width: 20px;
                      border-top: 2px solid var(--purple-accent);
                      margin-right: 6px;
                      vertical-align: middle;
                    "
                  ></span>
                  Burger King
                  <span
                    style="
                      display: inline-block;
                      width: 20px;
                      border-top: 2px dashed var(--coral);
                      margin: 0 6px 0 16px;
                      vertical-align: middle;
                    "
                  ></span>
                  <span id="compareName">—</span> (competitor overlay)
                </div>
                <!-- Mode-aware CTA -->
                <div id="heroOnramp" style="margin-top: 14px">
                  <div class="inline-prompt teal">
                    <div>
                      <div class="inline-prompt-text">
                        <strong>Scale what’s converting.</strong> Build
                        lookalike audiences from your highest-ROAS cohorts and
                        activate them directly into your next campaign flight.
                      </div>
                      <div class="inline-prompt-sub">
                        Audiences built from verified converters. Ready in 5
                        business days.
                      </div>
                    </div>
                    <button
                      class="btn btn-teal btn-sm"
                      onclick="openDrawer('audience')"
                      style="white-space: nowrap"
                    >
                      Build Audience →
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <!-- /collapsible-body -->
          </div>
        </div>

        <!-- ═══ BUYER COHORTS with embedded activation CTAs ═══ -->
        <div
          class="card collapsible-card fade-in stagger-4"
          style="margin: 0 32px 16px"
        >
          <div
            class="card-header collapsible-header"
            onclick="toggleSection(this)"
            style="cursor: pointer"
          >
            <div>
              <div class="card-title">
                Real-time Customer Behavior &amp; Audience Activation
              </div>
              <div class="card-subtitle">
                6 universal buyer segments — live purchase signals powering
                always-on audience strategy
              </div>
            </div>
            <div
              style="display: flex; align-items: center; gap: 8px"
              onclick="event.stopPropagation()"
            >
              <select
                class="filter-select hide-collapsed"
                id="cohortSort"
                onchange="renderCohortCards()"
                style="font-size: 11px; padding: 5px 28px 5px 10px"
              >
                <option value="">Default</option>
                <option value="buyers">Sort: Buyers</option>
                <option value="cvr">Sort: CVR</option>
                <option value="cpa">Sort: CPA</option>
                <option value="roas">Sort: ROAS</option>
                <option value="sales">Sort: Sales</option>
              </select>
              <div
                class="hide-collapsed"
                style="
                  display: flex;
                  background: var(--card-bg);
                  border: 1px solid var(--card-border);
                  border-radius: 6px;
                  overflow: hidden;
                "
              >
                <button
                  class="cohort-view-btn active"
                  id="viewTile"
                  onclick="setCohortView('tile')"
                  title="Tile view"
                >
                  <svg
                    viewBox="0 0 24 24"
                    width="14"
                    height="14"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                  </svg>
                </button>
                <button
                  class="cohort-view-btn"
                  id="viewList"
                  onclick="setCohortView('list')"
                  title="List view"
                >
                  <svg
                    viewBox="0 0 24 24"
                    width="14"
                    height="14"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                  </svg>
                </button>
              </div>
              <button
                class="btn btn-primary btn-sm show-collapsed"
                onclick="
                  event.stopPropagation();
                  openDrawer('audience');
                "
                style="white-space: nowrap"
              >
                Activate Audience →
              </button>
              <svg
                class="collapse-chevron"
                onclick="
                  event.stopPropagation();
                  toggleSection(this.closest('.collapsible-header'));
                "
                viewBox="0 0 24 24"
                width="16"
                height="16"
                fill="none"
                stroke="var(--text-tertiary)"
                stroke-width="2"
              >
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
          </div>
          <div class="collapsible-body">
            <div style="padding: 0 22px 18px">
              <div
                class="cohort-list-header"
                id="cohortListHeader"
                style="display: none"
              >
                <div class="clh-segment">Segment</div>
                <div class="clh-metric" onclick="sortCohortBy('proj')">
                  Proj. Buyers
                </div>
                <div class="clh-metric" onclick="sortCohortBy('cvr')">CVR</div>
                <div class="clh-metric" onclick="sortCohortBy('cpa')">CPA</div>
                <div class="clh-metric" onclick="sortCohortBy('roas')">
                  ROAS
                </div>
                <div class="clh-metric" onclick="sortCohortBy('sales')">
                  Sales
                </div>
                <div class="clh-actions"></div>
              </div>
              <div class="cohort-grid" id="cohortGrid">
                <div
                  style="
                    grid-column: 1/4;
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                    padding-bottom: 2px;
                  "
                >
                  <div
                    style="
                      font-size: 9px;
                      font-weight: 700;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      color: var(--purple-accent);
                    "
                  >
                    Drive Household Penetration
                  </div>
                  <div
                    style="
                      height: 2px;
                      border-radius: 1px;
                      background: linear-gradient(
                        90deg,
                        var(--purple-accent) 0%,
                        rgba(108, 92, 231, 0.15) 100%
                      );
                    "
                  ></div>
                </div>
                <div
                  style="
                    grid-column: 4/7;
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                    padding-bottom: 2px;
                  "
                >
                  <div
                    style="
                      font-size: 9px;
                      font-weight: 700;
                      text-transform: uppercase;
                      letter-spacing: 0.5px;
                      color: var(--teal);
                    "
                  >
                    Influence Buy Rate
                  </div>
                  <div
                    style="
                      height: 2px;
                      border-radius: 1px;
                      background: linear-gradient(
                        90deg,
                        var(--teal) 0%,
                        rgba(0, 184, 148, 0.15) 100%
                      );
                    "
                  ></div>
                </div>
                <div
                  class="cohort-card active"
                  onclick="selectCohort(this)"
                  style="
                    position: relative;
                    background: linear-gradient(
                      135deg,
                      #fbfaff 0%,
                      #f5f3fc 100%
                    );
                    border-color: #ddd6f0;
                  "
                >
                  <div class="cohort-header">
                    <div class="cohort-icon" style="background: #f0eeff">
                      <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#6c5ce7"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <polygon
                          points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                        ></polygon>
                      </svg>
                    </div>
                    <div class="cohort-header-text">
                      <div class="cohort-name">New-to-Category</div>
                      <div class="cohort-desc">
                        First BK purchase in last 30d
                      </div>
                    </div>
                    <div class="cohort-badge">
                      <span class="live-dot"></span>Live
                    </div>
                  </div>
                  <div class="cohort-kpis">
                    <div class="cohort-kpi-hero">
                      <div class="kh-left">
                        <div class="cohort-kpi-val">4,328</div>
                        <div class="cohort-kpi-label">Projected Buyers</div>
                      </div>
                      <div class="cohort-kpi-delta" style="color: var(--teal)">
                        +14.4%
                      </div>
                    </div>
                    <div class="cohort-kpi-grid">
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">1.8%</div>
                          <div class="cohort-kpi-label">CVR</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +0.3%
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$14.20</div>
                          <div class="cohort-kpi-label">CPA</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          -$1.40
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$8</div>
                          <div class="cohort-kpi-label">ROAS</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +$1.2
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$38.1K</div>
                          <div class="cohort-kpi-label">Sales</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +$4.8K
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="cohort-goal">
                    <strong>Goal:</strong> Drive household penetration
                  </div>
                  <div class="cohort-cta">
                    <button
                      class="cohort-cta-btn activate"
                      onclick="
                        event.stopPropagation();
                        openDrawer('audience');
                      "
                    >
                      Activate
                    </button>
                    <button
                      class="cohort-cta-btn track"
                      onclick="
                        event.stopPropagation();
                        openDrawer('attribution');
                      "
                    >
                      Track
                    </button>
                    <button
                      class="cohort-cta-btn edit-btn"
                      onclick="
                        event.stopPropagation();
                        toggleCohortEdit('ce0');
                      "
                    >
                      ✎
                    </button>
                  </div>
                  <div class="cohort-edit" id="ce0">
                    <div
                      style="
                        font-size: 11px;
                        font-weight: 600;
                        margin-bottom: 8px;
                        color: var(--text-primary);
                      "
                    >
                      Define: New-to-Category
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Recency window <span id="rv0r">30d</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="7"
                        max="180"
                        value="30"
                        oninput="
                          document.getElementById('rv0r').textContent =
                            this.value + 'd'
                        "
                      />
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Min frequency <span id="rv0f">0x</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="0"
                        max="12"
                        value="0"
                        oninput="
                          document.getElementById('rv0f').textContent =
                            this.value + 'x'
                        "
                      />
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Spend threshold <span id="rv0s">$0</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="0"
                        max="200"
                        value="0"
                        oninput="
                          document.getElementById('rv0s').textContent =
                            '$' + this.value
                        "
                      />
                    </div>
                    <div
                      style="
                        border-top: 1px solid var(--card-border);
                        margin: 8px 0;
                        padding-top: 8px;
                      "
                    >
                      <div
                        style="
                          font-size: 9.5px;
                          font-weight: 600;
                          color: var(--text-tertiary);
                          text-transform: uppercase;
                          letter-spacing: 0.4px;
                          margin-bottom: 6px;
                        "
                      >
                        Filters
                      </div>
                      <div
                        style="
                          display: flex;
                          flex-wrap: wrap;
                          gap: 4px;
                          margin-bottom: 6px;
                        "
                      >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #6c5ce7;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          In-Store</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #6c5ce7;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Online</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #6c5ce7;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Delivery</label
                        >
                      </div>
                      <div style="display: flex; gap: 4px; margin-bottom: 6px">
                        <select
                          style="
                            font-family: var(--font);
                            font-size: 10px;
                            padding: 3px 6px;
                            border: 1px solid var(--card-border);
                            border-radius: 4px;
                            flex: 1;
                          "
                        >
                          <option>All Ages</option>
                          <option>Gen Z (18-27)</option>
                          <option>Millennial (28-43)</option>
                          <option>Gen X (44-59)</option>
                          <option>Boomer+ (60+)</option>
                        </select>
                        <select
                          style="
                            font-family: var(--font);
                            font-size: 10px;
                            padding: 3px 6px;
                            border: 1px solid var(--card-border);
                            border-radius: 4px;
                            flex: 1;
                          "
                        >
                          <option>All Income</option>
                          <option>HHI &lt; $50K</option>
                          <option>HHI $50-100K</option>
                          <option>HHI $100K+</option>
                        </select>
                      </div>
                      <div style="display: flex; flex-wrap: wrap; gap: 4px">
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #6c5ce7;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Has children</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #6c5ce7;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Coupon users</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #6c5ce7;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          App users</label
                        >
                      </div>
                    </div>
                    <button
                      class="btn btn-primary btn-sm"
                      style="
                        width: 100%;
                        margin-top: 8px;
                        justify-content: center;
                      "
                      onclick="
                        document.getElementById('ce0').classList.remove('open');
                        showToast(
                          'Cohort definition updated — recalculating...',
                        );
                      "
                    >
                      Apply Definition
                    </button>
                  </div>
                </div>
                <div
                  class="cohort-card"
                  onclick="selectCohort(this)"
                  style="
                    position: relative;
                    background: linear-gradient(
                      135deg,
                      #fbfaff 0%,
                      #f5f3fc 100%
                    );
                    border-color: #ddd6f0;
                  "
                >
                  <div class="cohort-header">
                    <div class="cohort-icon" style="background: #fff0ed">
                      <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#e17055"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                      </svg>
                    </div>
                    <div class="cohort-header-text">
                      <div class="cohort-name">Competitor Conquest</div>
                      <div class="cohort-desc">
                        Active McD, Wendy's, Popeye's
                      </div>
                    </div>
                    <div class="cohort-badge">
                      <span class="live-dot"></span>Live
                    </div>
                  </div>
                  <div class="cohort-kpis">
                    <div class="cohort-kpi-hero">
                      <div class="kh-left">
                        <div class="cohort-kpi-val">2,987</div>
                        <div class="cohort-kpi-label">Projected Buyers</div>
                      </div>
                      <div class="cohort-kpi-delta" style="color: var(--teal)">
                        +11.5%
                      </div>
                    </div>
                    <div class="cohort-kpi-grid">
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">2.4%</div>
                          <div class="cohort-kpi-label">CVR</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +0.6%
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$9.80</div>
                          <div class="cohort-kpi-label">CPA</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          -$0.90
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$12</div>
                          <div class="cohort-kpi-label">ROAS</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +$2.1
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$51.8K</div>
                          <div class="cohort-kpi-label">Sales</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +$6.2K
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="cohort-goal">
                    <strong>Goal:</strong> Conquest competitive share
                  </div>
                  <div class="cohort-cta">
                    <button
                      class="cohort-cta-btn activate"
                      onclick="
                        event.stopPropagation();
                        openDrawer('audience');
                      "
                    >
                      Activate
                    </button>
                    <button
                      class="cohort-cta-btn track"
                      onclick="
                        event.stopPropagation();
                        openDrawer('attribution');
                      "
                    >
                      Track
                    </button>
                    <button
                      class="cohort-cta-btn edit-btn"
                      onclick="
                        event.stopPropagation();
                        toggleCohortEdit('ce1');
                      "
                    >
                      ✎
                    </button>
                  </div>
                  <div class="cohort-edit" id="ce1">
                    <div
                      style="
                        font-size: 11px;
                        font-weight: 600;
                        margin-bottom: 8px;
                        color: var(--text-primary);
                      "
                    >
                      Define: Competitor Conquest
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Recency window <span id="rv1r">90d</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="7"
                        max="180"
                        value="90"
                        oninput="
                          document.getElementById('rv1r').textContent =
                            this.value + 'd'
                        "
                      />
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Min frequency <span id="rv1f">2x</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="0"
                        max="12"
                        value="2"
                        oninput="
                          document.getElementById('rv1f').textContent =
                            this.value + 'x'
                        "
                      />
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Spend threshold <span id="rv1s">$20</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="0"
                        max="200"
                        value="20"
                        oninput="
                          document.getElementById('rv1s').textContent =
                            '$' + this.value
                        "
                      />
                    </div>
                    <div
                      style="
                        border-top: 1px solid var(--card-border);
                        margin: 8px 0;
                        padding-top: 8px;
                      "
                    >
                      <div
                        style="
                          font-size: 9.5px;
                          font-weight: 600;
                          color: var(--text-tertiary);
                          text-transform: uppercase;
                          letter-spacing: 0.4px;
                          margin-bottom: 6px;
                        "
                      >
                        Filters
                      </div>
                      <div
                        style="
                          display: flex;
                          flex-wrap: wrap;
                          gap: 4px;
                          margin-bottom: 6px;
                        "
                      >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #e17055;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          In-Store</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #e17055;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Online</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #e17055;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Delivery</label
                        >
                      </div>
                      <div style="display: flex; gap: 4px; margin-bottom: 6px">
                        <select
                          style="
                            font-family: var(--font);
                            font-size: 10px;
                            padding: 3px 6px;
                            border: 1px solid var(--card-border);
                            border-radius: 4px;
                            flex: 1;
                          "
                        >
                          <option>All Ages</option>
                          <option>Gen Z (18-27)</option>
                          <option>Millennial (28-43)</option>
                          <option>Gen X (44-59)</option>
                          <option>Boomer+ (60+)</option>
                        </select>
                        <select
                          style="
                            font-family: var(--font);
                            font-size: 10px;
                            padding: 3px 6px;
                            border: 1px solid var(--card-border);
                            border-radius: 4px;
                            flex: 1;
                          "
                        >
                          <option>All Income</option>
                          <option>HHI &lt; $50K</option>
                          <option>HHI $50-100K</option>
                          <option>HHI $100K+</option>
                        </select>
                      </div>
                      <div style="display: flex; flex-wrap: wrap; gap: 4px">
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #e17055;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Has children</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #e17055;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Coupon users</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #e17055;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          App users</label
                        >
                      </div>
                    </div>
                    <button
                      class="btn btn-primary btn-sm"
                      style="
                        width: 100%;
                        margin-top: 8px;
                        justify-content: center;
                      "
                      onclick="
                        document.getElementById('ce1').classList.remove('open');
                        showToast(
                          'Cohort definition updated — recalculating...',
                        );
                      "
                    >
                      Apply Definition
                    </button>
                  </div>
                </div>
                <div
                  class="cohort-card"
                  onclick="selectCohort(this)"
                  style="
                    position: relative;
                    background: linear-gradient(
                      135deg,
                      #fbfaff 0%,
                      #f5f3fc 100%
                    );
                    border-color: #ddd6f0;
                  "
                >
                  <div class="cohort-header">
                    <div class="cohort-icon" style="background: #ffeaea">
                      <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#d63031"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                      </svg>
                    </div>
                    <div class="cohort-header-text">
                      <div class="cohort-name">Lapsed &amp; Lapsing</div>
                      <div class="cohort-desc">No BK purchase in 90+ days</div>
                    </div>
                    <div class="cohort-badge">
                      <span class="live-dot"></span>Live
                    </div>
                  </div>
                  <div class="cohort-kpis">
                    <div class="cohort-kpi-hero">
                      <div class="kh-left">
                        <div class="cohort-kpi-val">1,254</div>
                        <div class="cohort-kpi-label">Projected Buyers</div>
                      </div>
                      <div class="cohort-kpi-delta" style="color: var(--red)">
                        -3.2%
                      </div>
                    </div>
                    <div class="cohort-kpi-grid">
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">0.9%</div>
                          <div class="cohort-kpi-label">CVR</div>
                        </div>
                        <div class="cohort-kpi-delta" style="color: var(--red)">
                          -0.2%
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$18.50</div>
                          <div class="cohort-kpi-label">CPA</div>
                        </div>
                        <div class="cohort-kpi-delta" style="color: var(--red)">
                          +$2.10
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$5</div>
                          <div class="cohort-kpi-label">ROAS</div>
                        </div>
                        <div class="cohort-kpi-delta" style="color: var(--red)">
                          -$0.8
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$10.9K</div>
                          <div class="cohort-kpi-label">Sales</div>
                        </div>
                        <div class="cohort-kpi-delta" style="color: var(--red)">
                          -$1.1K
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="cohort-goal">
                    <strong>Goal:</strong> Win back before defection
                  </div>
                  <div class="cohort-cta">
                    <button
                      class="cohort-cta-btn activate"
                      onclick="
                        event.stopPropagation();
                        openDrawer('audience');
                      "
                    >
                      Activate
                    </button>
                    <button
                      class="cohort-cta-btn track"
                      onclick="
                        event.stopPropagation();
                        openDrawer('attribution');
                      "
                    >
                      Track
                    </button>
                    <button
                      class="cohort-cta-btn edit-btn"
                      onclick="
                        event.stopPropagation();
                        toggleCohortEdit('ce2');
                      "
                    >
                      ✎
                    </button>
                  </div>
                  <div class="cohort-edit" id="ce2">
                    <div
                      style="
                        font-size: 11px;
                        font-weight: 600;
                        margin-bottom: 8px;
                        color: var(--text-primary);
                      "
                    >
                      Define: Lapsed &amp; Lapsing
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Recency window <span id="rv2r">120d</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="7"
                        max="180"
                        value="120"
                        oninput="
                          document.getElementById('rv2r').textContent =
                            this.value + 'd'
                        "
                      />
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Min frequency <span id="rv2f">2x</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="0"
                        max="12"
                        value="2"
                        oninput="
                          document.getElementById('rv2f').textContent =
                            this.value + 'x'
                        "
                      />
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Spend threshold <span id="rv2s">$15</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="0"
                        max="200"
                        value="15"
                        oninput="
                          document.getElementById('rv2s').textContent =
                            '$' + this.value
                        "
                      />
                    </div>
                    <div
                      style="
                        border-top: 1px solid var(--card-border);
                        margin: 8px 0;
                        padding-top: 8px;
                      "
                    >
                      <div
                        style="
                          font-size: 9.5px;
                          font-weight: 600;
                          color: var(--text-tertiary);
                          text-transform: uppercase;
                          letter-spacing: 0.4px;
                          margin-bottom: 6px;
                        "
                      >
                        Filters
                      </div>
                      <div
                        style="
                          display: flex;
                          flex-wrap: wrap;
                          gap: 4px;
                          margin-bottom: 6px;
                        "
                      >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #d63031;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          In-Store</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #d63031;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Online</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #d63031;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Delivery</label
                        >
                      </div>
                      <div style="display: flex; gap: 4px; margin-bottom: 6px">
                        <select
                          style="
                            font-family: var(--font);
                            font-size: 10px;
                            padding: 3px 6px;
                            border: 1px solid var(--card-border);
                            border-radius: 4px;
                            flex: 1;
                          "
                        >
                          <option>All Ages</option>
                          <option>Gen Z (18-27)</option>
                          <option>Millennial (28-43)</option>
                          <option>Gen X (44-59)</option>
                          <option>Boomer+ (60+)</option>
                        </select>
                        <select
                          style="
                            font-family: var(--font);
                            font-size: 10px;
                            padding: 3px 6px;
                            border: 1px solid var(--card-border);
                            border-radius: 4px;
                            flex: 1;
                          "
                        >
                          <option>All Income</option>
                          <option>HHI &lt; $50K</option>
                          <option>HHI $50-100K</option>
                          <option>HHI $100K+</option>
                        </select>
                      </div>
                      <div style="display: flex; flex-wrap: wrap; gap: 4px">
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #d63031;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Has children</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #d63031;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Coupon users</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #d63031;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          App users</label
                        >
                      </div>
                    </div>
                    <button
                      class="btn btn-primary btn-sm"
                      style="
                        width: 100%;
                        margin-top: 8px;
                        justify-content: center;
                      "
                      onclick="
                        document.getElementById('ce2').classList.remove('open');
                        showToast(
                          'Cohort definition updated — recalculating...',
                        );
                      "
                    >
                      Apply Definition
                    </button>
                  </div>
                </div>
                <div
                  class="cohort-card"
                  onclick="selectCohort(this)"
                  style="
                    position: relative;
                    background: linear-gradient(
                      135deg,
                      #f7fcfa 0%,
                      #f0faf6 100%
                    );
                    border-color: #c8e8d8;
                  "
                >
                  <div class="cohort-header">
                    <div class="cohort-icon" style="background: #e8f4ff">
                      <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#74b9ff"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                      </svg>
                    </div>
                    <div class="cohort-header-text">
                      <div class="cohort-name">Ultra-Light Buyers</div>
                      <div class="cohort-desc">1-2 purchases / 90 days</div>
                    </div>
                    <div class="cohort-badge">
                      <span class="live-dot"></span>Live
                    </div>
                  </div>
                  <div class="cohort-kpis">
                    <div class="cohort-kpi-hero">
                      <div class="kh-left">
                        <div class="cohort-kpi-val">8,542</div>
                        <div class="cohort-kpi-label">Projected Buyers</div>
                      </div>
                      <div class="cohort-kpi-delta" style="color: var(--teal)">
                        +9.8%
                      </div>
                    </div>
                    <div class="cohort-kpi-grid">
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">1.4%</div>
                          <div class="cohort-kpi-label">CVR</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +0.2%
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$11.60</div>
                          <div class="cohort-kpi-label">CPA</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          -$0.80
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$9</div>
                          <div class="cohort-kpi-label">ROAS</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +$1.5
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$62.4K</div>
                          <div class="cohort-kpi-label">Sales</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +$5.1K
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="cohort-goal">
                    <strong>Goal:</strong> Increase freq. &amp; basket
                  </div>
                  <div class="cohort-cta">
                    <button
                      class="cohort-cta-btn activate"
                      onclick="
                        event.stopPropagation();
                        openDrawer('audience');
                      "
                    >
                      Activate
                    </button>
                    <button
                      class="cohort-cta-btn track"
                      onclick="
                        event.stopPropagation();
                        openDrawer('attribution');
                      "
                    >
                      Track
                    </button>
                    <button
                      class="cohort-cta-btn edit-btn"
                      onclick="
                        event.stopPropagation();
                        toggleCohortEdit('ce3');
                      "
                    >
                      ✎
                    </button>
                  </div>
                  <div class="cohort-edit" id="ce3">
                    <div
                      style="
                        font-size: 11px;
                        font-weight: 600;
                        margin-bottom: 8px;
                        color: var(--text-primary);
                      "
                    >
                      Define: Ultra-Light Buyers
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Recency window <span id="rv3r">90d</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="7"
                        max="180"
                        value="90"
                        oninput="
                          document.getElementById('rv3r').textContent =
                            this.value + 'd'
                        "
                      />
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Min frequency <span id="rv3f">1x</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="0"
                        max="12"
                        value="1"
                        oninput="
                          document.getElementById('rv3f').textContent =
                            this.value + 'x'
                        "
                      />
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Spend threshold <span id="rv3s">$10</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="0"
                        max="200"
                        value="10"
                        oninput="
                          document.getElementById('rv3s').textContent =
                            '$' + this.value
                        "
                      />
                    </div>
                    <div
                      style="
                        border-top: 1px solid var(--card-border);
                        margin: 8px 0;
                        padding-top: 8px;
                      "
                    >
                      <div
                        style="
                          font-size: 9.5px;
                          font-weight: 600;
                          color: var(--text-tertiary);
                          text-transform: uppercase;
                          letter-spacing: 0.4px;
                          margin-bottom: 6px;
                        "
                      >
                        Filters
                      </div>
                      <div
                        style="
                          display: flex;
                          flex-wrap: wrap;
                          gap: 4px;
                          margin-bottom: 6px;
                        "
                      >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #74b9ff;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          In-Store</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #74b9ff;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Online</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #74b9ff;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Delivery</label
                        >
                      </div>
                      <div style="display: flex; gap: 4px; margin-bottom: 6px">
                        <select
                          style="
                            font-family: var(--font);
                            font-size: 10px;
                            padding: 3px 6px;
                            border: 1px solid var(--card-border);
                            border-radius: 4px;
                            flex: 1;
                          "
                        >
                          <option>All Ages</option>
                          <option>Gen Z (18-27)</option>
                          <option>Millennial (28-43)</option>
                          <option>Gen X (44-59)</option>
                          <option>Boomer+ (60+)</option>
                        </select>
                        <select
                          style="
                            font-family: var(--font);
                            font-size: 10px;
                            padding: 3px 6px;
                            border: 1px solid var(--card-border);
                            border-radius: 4px;
                            flex: 1;
                          "
                        >
                          <option>All Income</option>
                          <option>HHI &lt; $50K</option>
                          <option>HHI $50-100K</option>
                          <option>HHI $100K+</option>
                        </select>
                      </div>
                      <div style="display: flex; flex-wrap: wrap; gap: 4px">
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #74b9ff;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Has children</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #74b9ff;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Coupon users</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #74b9ff;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          App users</label
                        >
                      </div>
                    </div>
                    <button
                      class="btn btn-primary btn-sm"
                      style="
                        width: 100%;
                        margin-top: 8px;
                        justify-content: center;
                      "
                      onclick="
                        document.getElementById('ce3').classList.remove('open');
                        showToast(
                          'Cohort definition updated — recalculating...',
                        );
                      "
                    >
                      Apply Definition
                    </button>
                  </div>
                </div>
                <div
                  class="cohort-card"
                  onclick="selectCohort(this)"
                  style="
                    position: relative;
                    background: linear-gradient(
                      135deg,
                      #f7fcfa 0%,
                      #f0faf6 100%
                    );
                    border-color: #c8e8d8;
                  "
                >
                  <div class="cohort-header">
                    <div class="cohort-icon" style="background: #e8faf5">
                      <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#00b894"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path
                          d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"
                        ></path>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <path d="M16 10a4 4 0 01-8 0"></path>
                      </svg>
                    </div>
                    <div class="cohort-header-text">
                      <div class="cohort-name">Frequent Buyers</div>
                      <div class="cohort-desc">4+ purchases per month</div>
                    </div>
                    <div class="cohort-badge">
                      <span class="live-dot"></span>Live
                    </div>
                  </div>
                  <div class="cohort-kpis">
                    <div class="cohort-kpi-hero">
                      <div class="kh-left">
                        <div class="cohort-kpi-val">10,106</div>
                        <div class="cohort-kpi-label">Projected Buyers</div>
                      </div>
                      <div class="cohort-kpi-delta" style="color: var(--teal)">
                        +7.1%
                      </div>
                    </div>
                    <div class="cohort-kpi-grid">
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">3.9%</div>
                          <div class="cohort-kpi-label">CVR</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +0.4%
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$6.20</div>
                          <div class="cohort-kpi-label">CPA</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          -$0.50
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$21</div>
                          <div class="cohort-kpi-label">ROAS</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +$2.8
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$86.2K</div>
                          <div class="cohort-kpi-label">Sales</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +$8.4K
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="cohort-goal">
                    <strong>Goal:</strong> Optimize repeat purchase
                  </div>
                  <div class="cohort-cta">
                    <button
                      class="cohort-cta-btn activate"
                      onclick="
                        event.stopPropagation();
                        openDrawer('audience');
                      "
                    >
                      Activate
                    </button>
                    <button
                      class="cohort-cta-btn track"
                      onclick="
                        event.stopPropagation();
                        openDrawer('attribution');
                      "
                    >
                      Track
                    </button>
                    <button
                      class="cohort-cta-btn edit-btn"
                      onclick="
                        event.stopPropagation();
                        toggleCohortEdit('ce4');
                      "
                    >
                      ✎
                    </button>
                  </div>
                  <div class="cohort-edit" id="ce4">
                    <div
                      style="
                        font-size: 11px;
                        font-weight: 600;
                        margin-bottom: 8px;
                        color: var(--text-primary);
                      "
                    >
                      Define: Frequent Buyers
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Recency window <span id="rv4r">30d</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="7"
                        max="180"
                        value="30"
                        oninput="
                          document.getElementById('rv4r').textContent =
                            this.value + 'd'
                        "
                      />
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Min frequency <span id="rv4f">4x</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="0"
                        max="12"
                        value="4"
                        oninput="
                          document.getElementById('rv4f').textContent =
                            this.value + 'x'
                        "
                      />
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Spend threshold <span id="rv4s">$40</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="0"
                        max="200"
                        value="40"
                        oninput="
                          document.getElementById('rv4s').textContent =
                            '$' + this.value
                        "
                      />
                    </div>
                    <div
                      style="
                        border-top: 1px solid var(--card-border);
                        margin: 8px 0;
                        padding-top: 8px;
                      "
                    >
                      <div
                        style="
                          font-size: 9.5px;
                          font-weight: 600;
                          color: var(--text-tertiary);
                          text-transform: uppercase;
                          letter-spacing: 0.4px;
                          margin-bottom: 6px;
                        "
                      >
                        Filters
                      </div>
                      <div
                        style="
                          display: flex;
                          flex-wrap: wrap;
                          gap: 4px;
                          margin-bottom: 6px;
                        "
                      >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #00b894;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          In-Store</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #00b894;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Online</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #00b894;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Delivery</label
                        >
                      </div>
                      <div style="display: flex; gap: 4px; margin-bottom: 6px">
                        <select
                          style="
                            font-family: var(--font);
                            font-size: 10px;
                            padding: 3px 6px;
                            border: 1px solid var(--card-border);
                            border-radius: 4px;
                            flex: 1;
                          "
                        >
                          <option>All Ages</option>
                          <option>Gen Z (18-27)</option>
                          <option>Millennial (28-43)</option>
                          <option>Gen X (44-59)</option>
                          <option>Boomer+ (60+)</option>
                        </select>
                        <select
                          style="
                            font-family: var(--font);
                            font-size: 10px;
                            padding: 3px 6px;
                            border: 1px solid var(--card-border);
                            border-radius: 4px;
                            flex: 1;
                          "
                        >
                          <option>All Income</option>
                          <option>HHI &lt; $50K</option>
                          <option>HHI $50-100K</option>
                          <option>HHI $100K+</option>
                        </select>
                      </div>
                      <div style="display: flex; flex-wrap: wrap; gap: 4px">
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #00b894;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Has children</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #00b894;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Coupon users</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #00b894;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          App users</label
                        >
                      </div>
                    </div>
                    <button
                      class="btn btn-primary btn-sm"
                      style="
                        width: 100%;
                        margin-top: 8px;
                        justify-content: center;
                      "
                      onclick="
                        document.getElementById('ce4').classList.remove('open');
                        showToast(
                          'Cohort definition updated — recalculating...',
                        );
                      "
                    >
                      Apply Definition
                    </button>
                  </div>
                </div>
                <div
                  class="cohort-card"
                  onclick="selectCohort(this)"
                  style="
                    position: relative;
                    background: linear-gradient(
                      135deg,
                      #f7fcfa 0%,
                      #f0faf6 100%
                    );
                    border-color: #c8e8d8;
                  "
                >
                  <div class="cohort-header">
                    <div class="cohort-icon" style="background: #fef9e7">
                      <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="#fdcb6e"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path
                          d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                        ></path>
                      </svg>
                    </div>
                    <div class="cohort-header-text">
                      <div class="cohort-name">Most Loyal / VIP</div>
                      <div class="cohort-desc">
                        8+ visits/mo, top spend tier
                      </div>
                    </div>
                    <div class="cohort-badge">
                      <span class="live-dot"></span>Live
                    </div>
                  </div>
                  <div class="cohort-kpis">
                    <div class="cohort-kpi-hero">
                      <div class="kh-left">
                        <div class="cohort-kpi-val">1,733</div>
                        <div class="cohort-kpi-label">Projected Buyers</div>
                      </div>
                      <div class="cohort-kpi-delta" style="color: var(--teal)">
                        +4.8%
                      </div>
                    </div>
                    <div class="cohort-kpi-grid">
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">5.2%</div>
                          <div class="cohort-kpi-label">CVR</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +0.1%
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$4.80</div>
                          <div class="cohort-kpi-label">CPA</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          -$0.30
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$28</div>
                          <div class="cohort-kpi-label">ROAS</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +$1.0
                        </div>
                      </div>
                      <div class="cohort-kpi-cell">
                        <div>
                          <div class="cohort-kpi-val">$22.4K</div>
                          <div class="cohort-kpi-label">Sales</div>
                        </div>
                        <div
                          class="cohort-kpi-delta"
                          style="color: var(--teal)"
                        >
                          +$1.2K
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="cohort-goal">
                    <strong>Goal:</strong> Retain, upsell, grow app
                  </div>
                  <div class="cohort-cta">
                    <button
                      class="cohort-cta-btn activate"
                      onclick="
                        event.stopPropagation();
                        openDrawer('audience');
                      "
                    >
                      Activate
                    </button>
                    <button
                      class="cohort-cta-btn track"
                      onclick="
                        event.stopPropagation();
                        openDrawer('attribution');
                      "
                    >
                      Track
                    </button>
                    <button
                      class="cohort-cta-btn edit-btn"
                      onclick="
                        event.stopPropagation();
                        toggleCohortEdit('ce5');
                      "
                    >
                      ✎
                    </button>
                  </div>
                  <div class="cohort-edit" id="ce5">
                    <div
                      style="
                        font-size: 11px;
                        font-weight: 600;
                        margin-bottom: 8px;
                        color: var(--text-primary);
                      "
                    >
                      Define: Most Loyal / VIP
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Recency window <span id="rv5r">14d</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="7"
                        max="180"
                        value="14"
                        oninput="
                          document.getElementById('rv5r').textContent =
                            this.value + 'd'
                        "
                      />
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Min frequency <span id="rv5f">8x</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="0"
                        max="12"
                        value="8"
                        oninput="
                          document.getElementById('rv5f').textContent =
                            this.value + 'x'
                        "
                      />
                    </div>
                    <div class="rfm-row">
                      <div class="rfm-label">
                        Spend threshold <span id="rv5s">$100</span>
                      </div>
                      <input
                        type="range"
                        class="rfm-slider"
                        min="0"
                        max="200"
                        value="100"
                        oninput="
                          document.getElementById('rv5s').textContent =
                            '$' + this.value
                        "
                      />
                    </div>
                    <div
                      style="
                        border-top: 1px solid var(--card-border);
                        margin: 8px 0;
                        padding-top: 8px;
                      "
                    >
                      <div
                        style="
                          font-size: 9.5px;
                          font-weight: 600;
                          color: var(--text-tertiary);
                          text-transform: uppercase;
                          letter-spacing: 0.4px;
                          margin-bottom: 6px;
                        "
                      >
                        Filters
                      </div>
                      <div
                        style="
                          display: flex;
                          flex-wrap: wrap;
                          gap: 4px;
                          margin-bottom: 6px;
                        "
                      >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #fdcb6e;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          In-Store</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #fdcb6e;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Online</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            checked=""
                            style="
                              accent-color: #fdcb6e;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Delivery</label
                        >
                      </div>
                      <div style="display: flex; gap: 4px; margin-bottom: 6px">
                        <select
                          style="
                            font-family: var(--font);
                            font-size: 10px;
                            padding: 3px 6px;
                            border: 1px solid var(--card-border);
                            border-radius: 4px;
                            flex: 1;
                          "
                        >
                          <option>All Ages</option>
                          <option>Gen Z (18-27)</option>
                          <option>Millennial (28-43)</option>
                          <option>Gen X (44-59)</option>
                          <option>Boomer+ (60+)</option>
                        </select>
                        <select
                          style="
                            font-family: var(--font);
                            font-size: 10px;
                            padding: 3px 6px;
                            border: 1px solid var(--card-border);
                            border-radius: 4px;
                            flex: 1;
                          "
                        >
                          <option>All Income</option>
                          <option>HHI &lt; $50K</option>
                          <option>HHI $50-100K</option>
                          <option>HHI $100K+</option>
                        </select>
                      </div>
                      <div style="display: flex; flex-wrap: wrap; gap: 4px">
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #fdcb6e;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Has children</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #fdcb6e;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          Coupon users</label
                        >
                        <label
                          style="
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            gap: 3px;
                            cursor: pointer;
                          "
                          ><input
                            type="checkbox"
                            style="
                              accent-color: #fdcb6e;
                              width: 12px;
                              height: 12px;
                            "
                          />
                          App users</label
                        >
                      </div>
                    </div>
                    <button
                      class="btn btn-primary btn-sm"
                      style="
                        width: 100%;
                        margin-top: 8px;
                        justify-content: center;
                      "
                      onclick="
                        document.getElementById('ce5').classList.remove('open');
                        showToast(
                          'Cohort definition updated — recalculating...',
                        );
                      "
                    >
                      Apply Definition
                    </button>
                  </div>
                </div>
                <div
                  class="cohort-card"
                  onclick="openDrawer('audience')"
                  style="
                    position: relative;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    min-height: 220px;
                    border-style: dashed;
                    border-color: #c8c3d6;
                    background: var(--page-bg);
                    cursor: pointer;
                  "
                >
                  <div
                    style="
                      width: 40px;
                      height: 40px;
                      border-radius: 50%;
                      background: var(--purple-bg);
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      margin-bottom: 8px;
                    "
                  >
                    <svg
                      viewBox="0 0 24 24"
                      width="20"
                      height="20"
                      fill="none"
                      stroke="var(--purple-accent)"
                      stroke-width="2"
                    >
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </div>
                  <div
                    style="
                      font-size: 12px;
                      font-weight: 700;
                      color: var(--purple-accent);
                      margin-bottom: 4px;
                    "
                  >
                    Add Custom Audience
                  </div>
                  <div
                    style="
                      font-size: 9.5px;
                      color: var(--text-secondary);
                      text-align: center;
                      line-height: 1.3;
                      padding: 0 8px;
                    "
                  >
                    Build with AI or select from library
                  </div>
                </div>
              </div>
              <!-- ★ AUDIENCE ACTIVATION ON-RAMP -->
              <div class="inline-prompt teal" style="margin-top: 12px">
                <div>
                  <div class="inline-prompt-text">
                    <strong>Activate any cohort directly.</strong> Launch
                    purchase-based audiences, build custom segments with AI, or
                    select from the audience library — all prescriptively
                    aligned to these business objectives.
                  </div>
                  <div class="inline-prompt-sub">
                    Audiences deliver in 5 days. Push to Meta, TikTok, The Trade
                    Desk, DV360, and 20+ destinations.
                  </div>
                </div>
                <button
                  class="btn btn-teal btn-sm"
                  onclick="openDrawer('audience')"
                  style="white-space: nowrap"
                >
                  Build Audience →
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ MEDIA OPTIMIZATION GRID — Attribution mode only ═══ -->
        <div
          class="card collapsible-card fade-in stagger-5"
          id="mediaOptGrid"
          style="margin: 0 32px 16px"
        >
          <div
            class="card-header collapsible-header"
            onclick="toggleSection(this)"
            style="padding-bottom: 0; cursor: pointer"
          >
            <div>
              <div class="card-title">Media Investment Optimizer</div>
              <div class="card-subtitle">
                DSP delivery metrics mapped to purchase outcomes — identify
                where media efficiency drives real conversions
              </div>
            </div>
            <div
              style="display: flex; align-items: center; gap: 8px"
              onclick="event.stopPropagation()"
            >
              <select
                class="filter-select hide-collapsed"
                id="optMetricSelect"
                onchange="renderOptGrid()"
                style="font-size: 11px; padding: 5px 28px 5px 10px"
              >
                <option value="cvr">Outcome: CVR</option>
                <option value="roas" selected="">Outcome: ROAS</option>
                <option value="cpa">Outcome: CPA</option>
                <option value="sales">Outcome: Sales</option>
              </select>
              <button
                class="btn btn-primary btn-sm show-collapsed"
                onclick="
                  event.stopPropagation();
                  openDrawer('attribution');
                "
                style="white-space: nowrap"
              >
                Tag Channel →
              </button>
              <svg
                class="collapse-chevron"
                onclick="
                  event.stopPropagation();
                  toggleSection(this.closest('.collapsible-header'));
                "
                viewBox="0 0 24 24"
                width="16"
                height="16"
                fill="none"
                stroke="var(--text-tertiary)"
                stroke-width="2"
              >
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
          </div>
          <div class="collapsible-body">
            <div style="padding: 6px 22px 0">
              <div class="opt-tabs" id="optTabs">
                <div
                  class="opt-tab active"
                  onclick="setOptDim('channel', this)"
                >
                  Channel
                </div>
                <div class="opt-tab" onclick="setOptDim('creative', this)">
                  Creative
                </div>
                <div class="opt-tab" onclick="setOptDim('publisher', this)">
                  Publisher
                </div>
                <div class="opt-tab" onclick="setOptDim('platform', this)">
                  Platform
                </div>
                <div class="opt-tab" onclick="setOptDim('format', this)">
                  Format
                </div>
                <div class="opt-tab" onclick="setOptDim('device', this)">
                  Device
                </div>
              </div>
            </div>
            <div class="card-body" style="padding-top: 8px; overflow-x: auto">
              <table class="opt-table" id="optTable">
                <thead>
                  <tr id="optHead">
                    <th
                      class="media-col"
                      style="cursor: pointer; text-align: left"
                      onclick="sortOptCol('name')"
                    >
                      Channel
                    </th>
                    <th
                      class="media-col"
                      style="cursor: pointer"
                      onclick="sortOptCol('impr')"
                    >
                      Impr.
                    </th>
                    <th
                      class="media-col"
                      style="cursor: pointer"
                      onclick="sortOptCol('spend')"
                    >
                      Spend
                    </th>
                    <th
                      class="media-col"
                      style="cursor: pointer"
                      onclick="sortOptCol('cpm')"
                    >
                      CPM
                    </th>
                    <th class="media-col" colspan="2">Media Metric</th>
                    <th class="divider-col"></th>
                    <th
                      class="outcome-col"
                      style="cursor: pointer"
                      onclick="sortOptCol('conv')"
                    >
                      Conv.
                    </th>
                    <th
                      class="outcome-col"
                      style="cursor: pointer"
                      onclick="sortOptCol('outcome')"
                    >
                      ROAS
                    </th>
                    <th
                      class="outcome-col"
                      style="cursor: pointer"
                      onclick="sortOptCol('eff')"
                    >
                      Efficiency
                    </th>
                  </tr>
                </thead>
                <tbody id="optBody">
                  <tr
                    class="opt-parent"
                    onclick="toggleOptRow(0)"
                    style="cursor: pointer"
                  >
                    <td style="position: relative">
                      <div
                        class="opt-imp-bar"
                        style="width: 34%; background: var(--purple-accent)"
                      ></div>
                      <span
                        style="
                          position: relative;
                          z-index: 1;
                          display: flex;
                          align-items: center;
                          gap: 6px;
                        "
                        ><svg
                          viewBox="0 0 24 24"
                          width="12"
                          height="12"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2.5"
                          style="
                            transition: transform 0.2s;
                            transform: rotate(0deg);
                            flex-shrink: 0;
                          "
                        >
                          <polyline points="9 18 15 12 9 6"></polyline></svg
                        >CTV / OTT</span
                      >
                    </td>
                    <td>4.2M</td>
                    <td>$84K</td>
                    <td>$20.00</td>
                    <td
                      style="
                        font-size: 9px;
                        font-weight: 600;
                        color: var(--text-tertiary);
                        text-align: right;
                        padding-right: 2px;
                      "
                      title="3,956,400 completions ÷ 4,200,000 impr"
                    >
                      VCR
                    </td>
                    <td
                      style="font-weight: 700; padding-left: 4px"
                      title="3,956,400 completions ÷ 4,200,000 impr"
                    >
                      94.2%
                    </td>
                    <td class="divider-col"></td>
                    <td style="font-weight: 700">4K</td>
                    <td><span class="opt-pill good">$3.32</span></td>
                    <td>
                      <span
                        class="opt-signal good"
                        title="Media cost to outcome ratio"
                        style="font-size: 10px"
                        >3.3 : 1</span
                      >
                    </td>
                  </tr>
                  <tr
                    class="opt-parent"
                    onclick="toggleOptRow(1)"
                    style="cursor: pointer"
                  >
                    <td style="position: relative">
                      <div
                        class="opt-imp-bar"
                        style="width: 55%; background: var(--purple-accent)"
                      ></div>
                      <span
                        style="
                          position: relative;
                          z-index: 1;
                          display: flex;
                          align-items: center;
                          gap: 6px;
                        "
                        ><svg
                          viewBox="0 0 24 24"
                          width="12"
                          height="12"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2.5"
                          style="
                            transition: transform 0.2s;
                            transform: rotate(0deg);
                            flex-shrink: 0;
                          "
                        >
                          <polyline points="9 18 15 12 9 6"></polyline></svg
                        >Pre-Roll Video</span
                      >
                    </td>
                    <td>6.8M</td>
                    <td>$68K</td>
                    <td>$10.00</td>
                    <td
                      style="
                        font-size: 9px;
                        font-weight: 600;
                        color: var(--text-tertiary);
                        text-align: right;
                        padding-right: 2px;
                      "
                      title="5,202,000 completions ÷ 6,800,000 impr"
                    >
                      VCR
                    </td>
                    <td
                      style="font-weight: 700; padding-left: 4px"
                      title="5,202,000 completions ÷ 6,800,000 impr"
                    >
                      76.5%
                    </td>
                    <td class="divider-col"></td>
                    <td style="font-weight: 700">5K</td>
                    <td><span class="opt-pill top">$5.84</span></td>
                    <td>
                      <span
                        class="opt-signal top"
                        title="Media cost to outcome ratio"
                        style="font-size: 10px"
                        >5.8 : 1</span
                      >
                    </td>
                  </tr>
                  <tr
                    class="opt-parent"
                    onclick="toggleOptRow(2)"
                    style="cursor: pointer"
                  >
                    <td style="position: relative">
                      <div
                        class="opt-imp-bar"
                        style="width: 100%; background: var(--purple-accent)"
                      ></div>
                      <span
                        style="
                          position: relative;
                          z-index: 1;
                          display: flex;
                          align-items: center;
                          gap: 6px;
                        "
                        ><svg
                          viewBox="0 0 24 24"
                          width="12"
                          height="12"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2.5"
                          style="
                            transition: transform 0.2s;
                            transform: rotate(0deg);
                            flex-shrink: 0;
                          "
                        >
                          <polyline points="9 18 15 12 9 6"></polyline></svg
                        >Display Standard</span
                      >
                    </td>
                    <td>12.4M</td>
                    <td>$50K</td>
                    <td>$4.00</td>
                    <td
                      style="
                        font-size: 9px;
                        font-weight: 600;
                        color: var(--text-tertiary);
                        text-align: right;
                        padding-right: 2px;
                      "
                      title="9,920 clicks ÷ 12,400,000 impr"
                    >
                      CTR
                    </td>
                    <td
                      style="font-weight: 700; padding-left: 4px"
                      title="9,920 clicks ÷ 12,400,000 impr"
                    >
                      0.08%
                    </td>
                    <td class="divider-col"></td>
                    <td style="font-weight: 700">5K</td>
                    <td><span class="opt-pill good">$4.16</span></td>
                    <td>
                      <span
                        class="opt-signal good"
                        title="Media cost to outcome ratio"
                        style="font-size: 10px"
                        >4.2 : 1</span
                      >
                    </td>
                  </tr>
                  <tr
                    class="opt-parent"
                    onclick="toggleOptRow(3)"
                    style="cursor: pointer"
                  >
                    <td style="position: relative">
                      <div
                        class="opt-imp-bar"
                        style="width: 25%; background: var(--purple-accent)"
                      ></div>
                      <span
                        style="
                          position: relative;
                          z-index: 1;
                          display: flex;
                          align-items: center;
                          gap: 6px;
                        "
                        ><svg
                          viewBox="0 0 24 24"
                          width="12"
                          height="12"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2.5"
                          style="
                            transition: transform 0.2s;
                            transform: rotate(0deg);
                            flex-shrink: 0;
                          "
                        >
                          <polyline points="9 18 15 12 9 6"></polyline></svg
                        >Native</span
                      >
                    </td>
                    <td>3.1M</td>
                    <td>$22K</td>
                    <td>$7.00</td>
                    <td
                      style="
                        font-size: 9px;
                        font-weight: 600;
                        color: var(--text-tertiary);
                        text-align: right;
                        padding-right: 2px;
                      "
                      title="6,820 clicks ÷ 3,100,000 impr"
                    >
                      CTR
                    </td>
                    <td
                      style="font-weight: 700; padding-left: 4px"
                      title="6,820 clicks ÷ 3,100,000 impr"
                    >
                      0.22%
                    </td>
                    <td class="divider-col"></td>
                    <td style="font-weight: 700">2K</td>
                    <td><span class="opt-pill top">$6.27</span></td>
                    <td>
                      <span
                        class="opt-signal top"
                        title="Media cost to outcome ratio"
                        style="font-size: 10px"
                        >6.3 : 1</span
                      >
                    </td>
                  </tr>
                  <tr
                    class="opt-parent"
                    onclick="toggleOptRow(4)"
                    style="cursor: pointer"
                  >
                    <td style="position: relative">
                      <div
                        class="opt-imp-bar"
                        style="width: 69%; background: var(--purple-accent)"
                      ></div>
                      <span
                        style="
                          position: relative;
                          z-index: 1;
                          display: flex;
                          align-items: center;
                          gap: 6px;
                        "
                        ><svg
                          viewBox="0 0 24 24"
                          width="12"
                          height="12"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2.5"
                          style="
                            transition: transform 0.2s;
                            transform: rotate(0deg);
                            flex-shrink: 0;
                          "
                        >
                          <polyline points="9 18 15 12 9 6"></polyline></svg
                        >Social Display</span
                      >
                    </td>
                    <td>8.6M</td>
                    <td>$52K</td>
                    <td>$6.00</td>
                    <td
                      style="
                        font-size: 9px;
                        font-weight: 600;
                        color: var(--text-tertiary);
                        text-align: right;
                        padding-right: 2px;
                      "
                      title="12,040 clicks ÷ 8,600,000 impr"
                    >
                      CTR
                    </td>
                    <td
                      style="font-weight: 700; padding-left: 4px"
                      title="12,040 clicks ÷ 8,600,000 impr"
                    >
                      0.14%
                    </td>
                    <td class="divider-col"></td>
                    <td style="font-weight: 700">3K</td>
                    <td><span class="opt-pill low">$2.86</span></td>
                    <td>
                      <span
                        class="opt-signal low"
                        title="Media cost to outcome ratio"
                        style="font-size: 10px"
                        >2.9 : 1</span
                      >
                    </td>
                  </tr>
                  <tr
                    class="opt-parent"
                    onclick="toggleOptRow(5)"
                    style="cursor: pointer"
                  >
                    <td style="position: relative">
                      <div
                        class="opt-imp-bar"
                        style="width: 15%; background: var(--purple-accent)"
                      ></div>
                      <span
                        style="
                          position: relative;
                          z-index: 1;
                          display: flex;
                          align-items: center;
                          gap: 6px;
                        "
                        ><svg
                          viewBox="0 0 24 24"
                          width="12"
                          height="12"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2.5"
                          style="
                            transition: transform 0.2s;
                            transform: rotate(0deg);
                            flex-shrink: 0;
                          "
                        >
                          <polyline points="9 18 15 12 9 6"></polyline></svg
                        >Audio / Podcast</span
                      >
                    </td>
                    <td>1.8M</td>
                    <td>$16K</td>
                    <td>$9.00</td>
                    <td
                      style="
                        font-size: 9px;
                        font-weight: 600;
                        color: var(--text-tertiary);
                        text-align: right;
                        padding-right: 2px;
                      "
                      title="1,747,800 listens ÷ 1,800,000 impr"
                    >
                      Listen Rate
                    </td>
                    <td
                      style="font-weight: 700; padding-left: 4px"
                      title="1,747,800 listens ÷ 1,800,000 impr"
                    >
                      97.1%
                    </td>
                    <td class="divider-col"></td>
                    <td style="font-weight: 700">720</td>
                    <td><span class="opt-pill low">$2.14</span></td>
                    <td>
                      <span
                        class="opt-signal low"
                        title="Media cost to outcome ratio"
                        style="font-size: 10px"
                        >2.1 : 1</span
                      >
                    </td>
                  </tr>
                </tbody>
              </table>
              <div
                id="optInsight"
                style="
                  margin-top: 12px;
                  padding: 10px 14px;
                  background: linear-gradient(135deg, #f0eeff, #faf9fd);
                  border-radius: 8px;
                  border: 1px solid #e0dced;
                  font-size: 11.5px;
                  color: var(--text-secondary);
                  line-height: 1.5;
                "
              >
                <span style="font-weight: 700; color: var(--purple-accent)"
                  >⚡ Optimization signal:</span
                >
                <strong>Native</strong> delivers the best efficiency at 6.3 : 1
                (media cost → ROAS) on 3.1M impressions.
                <strong>Audio / Podcast</strong> shows weakest conversion at 2.1
                : 1 — consider reallocating budget or testing new placements.
              </div>
              <div
                id="optAvailPlatforms"
                style="
                  margin-top: 16px;
                  border-top: 2px solid var(--card-border);
                  padding-top: 14px;
                "
              >
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 8px;
                    margin-top: 4px;
                  "
                >
                  <div style="display: flex; align-items: center; gap: 6px">
                    <span style="font-size: 13px">📡</span
                    ><span
                      style="
                        font-size: 11px;
                        font-weight: 700;
                        color: var(--text-primary);
                      "
                      >Data In</span
                    ><span
                      style="
                        font-size: 9px;
                        color: var(--text-tertiary);
                        font-weight: 500;
                      "
                      >DSP &amp; programmatic measurement</span
                    >
                  </div>
                </div>
                <div
                  style="
                    display: grid;
                    grid-template-columns: repeat(
                      auto-fill,
                      minmax(220px, 1fr)
                    );
                    gap: 6px;
                    margin-bottom: 14px;
                  "
                >
                  <div
                    style="
                      border: 1px solid #c8e8d8;
                      border-radius: 8px;
                      padding: 10px 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      background: #f4fbf8;
                      transition: all 0.15s;
                    "
                  >
                    <div
                      style="
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        opacity: 1;
                      "
                    >
                      <svg viewBox="0 0 28 28" width="20" height="20">
                        <rect
                          x="2"
                          y="6"
                          width="6"
                          height="16"
                          rx="1"
                          fill="#0099FA"
                        ></rect>
                        <rect
                          x="11"
                          y="2"
                          width="6"
                          height="24"
                          rx="1"
                          fill="#0099FA"
                        ></rect>
                        <rect
                          x="20"
                          y="10"
                          width="6"
                          height="12"
                          rx="1"
                          fill="#0099FA"
                        ></rect>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 10px;
                          font-weight: 700;
                          color: var(--text-primary);
                        "
                      >
                        The Trade Desk
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: var(--text-secondary);
                          line-height: 1.3;
                        "
                      >
                        Programmatic measurement via PMP tags
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: #00b894;
                          font-weight: 600;
                          margin-top: 2px;
                        "
                      >
                        18.4M impr · 4.82x ROAS
                      </div>
                    </div>
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 3px;
                        flex-shrink: 0;
                      "
                    >
                      <div
                        style="
                          width: 6px;
                          height: 6px;
                          border-radius: 50%;
                          background: #00b894;
                          animation: pulse 2s infinite;
                        "
                      ></div>
                      <span
                        style="font-size: 8px; font-weight: 600; color: #00b894"
                        >LIVE</span
                      >
                    </div>
                  </div>
                  <div
                    style="
                      border: 1px solid #c8e8d8;
                      border-radius: 8px;
                      padding: 10px 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      background: #f4fbf8;
                      transition: all 0.15s;
                    "
                  >
                    <div
                      style="
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        opacity: 1;
                      "
                    >
                      <svg viewBox="0 0 28 28" width="20" height="20">
                        <path
                          d="M14 3L3 8v5c0 7.2 4.7 13.5 11 15 6.3-1.5 11-7.8 11-15V8L14 3z"
                          fill="none"
                          stroke="#4285f4"
                          stroke-width="2"
                        ></path>
                        <path
                          d="M9 14l3 3 7-7"
                          fill="none"
                          stroke="#4285f4"
                          stroke-width="2.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        ></path>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 10px;
                          font-weight: 700;
                          color: var(--text-primary);
                        "
                      >
                        DV360
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: var(--text-secondary);
                          line-height: 1.3;
                        "
                      >
                        Google programmatic campaign attribution
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: #00b894;
                          font-weight: 600;
                          margin-top: 2px;
                        "
                      >
                        10.2M impr · 4.14x ROAS
                      </div>
                    </div>
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 3px;
                        flex-shrink: 0;
                      "
                    >
                      <div
                        style="
                          width: 6px;
                          height: 6px;
                          border-radius: 50%;
                          background: #00b894;
                          animation: pulse 2s infinite;
                        "
                      ></div>
                      <span
                        style="font-size: 8px; font-weight: 600; color: #00b894"
                        >LIVE</span
                      >
                    </div>
                  </div>
                  <div
                    style="
                      border: 1px solid #c8e8d8;
                      border-radius: 8px;
                      padding: 10px 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      background: #f4fbf8;
                      transition: all 0.15s;
                    "
                  >
                    <div
                      style="
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        opacity: 1;
                      "
                    >
                      <svg viewBox="0 0 28 28" width="20" height="20">
                        <rect
                          x="3"
                          y="4"
                          width="22"
                          height="20"
                          rx="3"
                          fill="none"
                          stroke="#6c5ce7"
                          stroke-width="2"
                        ></rect>
                        <line
                          x1="3"
                          y1="10"
                          x2="25"
                          y2="10"
                          stroke="#6c5ce7"
                          stroke-width="2"
                        ></line>
                        <line
                          x1="10"
                          y1="10"
                          x2="10"
                          y2="24"
                          stroke="#6c5ce7"
                          stroke-width="2"
                        ></line>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 10px;
                          font-weight: 700;
                          color: var(--text-primary);
                        "
                      >
                        Direct Publishers
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: var(--text-secondary);
                          line-height: 1.3;
                        "
                      >
                        Publisher-direct deal measurement
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: #00b894;
                          font-weight: 600;
                          margin-top: 2px;
                        "
                      >
                        5M impr · 3.28x ROAS
                      </div>
                    </div>
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 3px;
                        flex-shrink: 0;
                      "
                    >
                      <div
                        style="
                          width: 6px;
                          height: 6px;
                          border-radius: 50%;
                          background: #00b894;
                          animation: pulse 2s infinite;
                        "
                      ></div>
                      <span
                        style="font-size: 8px; font-weight: 600; color: #00b894"
                        >LIVE</span
                      >
                    </div>
                  </div>
                  <div
                    style="
                      border: 1px dashed #d8d6de;
                      border-radius: 8px;
                      padding: 10px 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      background: #fafafa;
                      transition: all 0.15s;
                    "
                  >
                    <div
                      style="
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        opacity: 0.4;
                      "
                    >
                      <svg viewBox="0 0 28 28" width="20" height="20">
                        <path
                          d="M4 6l7 9v7h6v-7l7-9"
                          fill="none"
                          stroke="#6001d2"
                          stroke-width="2.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        ></path>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 10px;
                          font-weight: 700;
                          color: var(--text-secondary);
                        "
                      >
                        Yahoo DSP
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: var(--text-secondary);
                          line-height: 1.3;
                        "
                      >
                        Closed-loop attribution for Yahoo demand-side buys
                      </div>
                    </div>
                    <button
                      class="btn btn-sm"
                      style="
                        font-size: 8px;
                        padding: 2px 8px;
                        border: 1px dashed var(--purple-accent);
                        color: var(--purple-accent);
                        background: none;
                        white-space: nowrap;
                        flex-shrink: 0;
                      "
                      onclick="
                        event.stopPropagation();
                        showToast(
                          'Yahoo DSP integration requested — our team will reach out',
                        );
                      "
                    >
                      Connect →
                    </button>
                  </div>
                  <div
                    style="
                      border: 1px dashed #d8d6de;
                      border-radius: 8px;
                      padding: 10px 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      background: #fafafa;
                      transition: all 0.15s;
                    "
                  >
                    <div
                      style="
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        opacity: 0.4;
                      "
                    >
                      <svg viewBox="0 0 28 28" width="20" height="20">
                        <rect
                          x="3"
                          y="5"
                          width="22"
                          height="14"
                          rx="2"
                          fill="none"
                          stroke="#662d91"
                          stroke-width="2"
                        ></rect>
                        <line
                          x1="10"
                          y1="22"
                          x2="18"
                          y2="22"
                          stroke="#662d91"
                          stroke-width="2"
                          stroke-linecap="round"
                        ></line>
                        <line
                          x1="14"
                          y1="19"
                          x2="14"
                          y2="22"
                          stroke="#662d91"
                          stroke-width="2"
                        ></line>
                        <circle
                          cx="14"
                          cy="12"
                          r="3"
                          fill="#662d91"
                          opacity=".3"
                        ></circle>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 10px;
                          font-weight: 700;
                          color: var(--text-secondary);
                        "
                      >
                        Roku OneView
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: var(--text-secondary);
                          line-height: 1.3;
                        "
                      >
                        CTV-to-purchase measurement for Roku campaigns
                      </div>
                    </div>
                    <button
                      class="btn btn-sm"
                      style="
                        font-size: 8px;
                        padding: 2px 8px;
                        border: 1px dashed var(--purple-accent);
                        color: var(--purple-accent);
                        background: none;
                        white-space: nowrap;
                        flex-shrink: 0;
                      "
                      onclick="
                        event.stopPropagation();
                        showToast(
                          'Roku OneView integration requested — our team will reach out',
                        );
                      "
                    >
                      Connect →
                    </button>
                  </div>
                  <div
                    style="
                      border: 1px dashed #d8d6de;
                      border-radius: 8px;
                      padding: 10px 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      background: #fafafa;
                      transition: all 0.15s;
                    "
                  >
                    <div
                      style="
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        opacity: 0.4;
                      "
                    >
                      <svg viewBox="0 0 28 28" width="20" height="20">
                        <path
                          d="M6 18c4 3 12 3 16 0"
                          fill="none"
                          stroke="#ff9900"
                          stroke-width="2.5"
                          stroke-linecap="round"
                        ></path>
                        <path
                          d="M20 18l2.5-1"
                          fill="none"
                          stroke="#ff9900"
                          stroke-width="2.5"
                          stroke-linecap="round"
                        ></path>
                        <text
                          x="14"
                          y="14"
                          text-anchor="middle"
                          font-size="11"
                          font-weight="800"
                          fill="#ff9900"
                        >
                          a
                        </text>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 10px;
                          font-weight: 700;
                          color: var(--text-secondary);
                        "
                      >
                        Amazon DSP
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: var(--text-secondary);
                          line-height: 1.3;
                        "
                      >
                        Measure purchase outcomes from Amazon programmatic
                        campaigns
                      </div>
                    </div>
                    <button
                      class="btn btn-sm"
                      style="
                        font-size: 8px;
                        padding: 2px 8px;
                        border: 1px dashed var(--purple-accent);
                        color: var(--purple-accent);
                        background: none;
                        white-space: nowrap;
                        flex-shrink: 0;
                      "
                      onclick="
                        event.stopPropagation();
                        showToast(
                          'Amazon DSP integration requested — our team will reach out',
                        );
                      "
                    >
                      Connect →
                    </button>
                  </div>
                  <div
                    style="
                      border: 1px dashed #d8d6de;
                      border-radius: 8px;
                      padding: 10px 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      background: #fafafa;
                      transition: all 0.15s;
                    "
                  >
                    <div
                      style="
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        opacity: 0.4;
                      "
                    >
                      <svg viewBox="0 0 28 28" width="20" height="20">
                        <line
                          x1="14"
                          y1="4"
                          x2="14"
                          y2="12"
                          stroke="#0071dc"
                          stroke-width="3"
                          stroke-linecap="round"
                        ></line>
                        <line
                          x1="6"
                          y1="10"
                          x2="10"
                          y2="16"
                          stroke="#0071dc"
                          stroke-width="3"
                          stroke-linecap="round"
                        ></line>
                        <line
                          x1="22"
                          y1="10"
                          x2="18"
                          y2="16"
                          stroke="#0071dc"
                          stroke-width="3"
                          stroke-linecap="round"
                        ></line>
                        <line
                          x1="14"
                          y1="24"
                          x2="14"
                          y2="16"
                          stroke="#0071dc"
                          stroke-width="3"
                          stroke-linecap="round"
                        ></line>
                        <line
                          x1="6"
                          y1="18"
                          x2="10"
                          y2="12"
                          stroke="#0071dc"
                          stroke-width="3"
                          stroke-linecap="round"
                        ></line>
                        <line
                          x1="22"
                          y1="18"
                          x2="18"
                          y2="12"
                          stroke="#0071dc"
                          stroke-width="3"
                          stroke-linecap="round"
                        ></line>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 10px;
                          font-weight: 700;
                          color: var(--text-secondary);
                        "
                      >
                        Walmart DSP
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: var(--text-secondary);
                          line-height: 1.3;
                        "
                      >
                        Connect in-store and online purchase data to Walmart
                        media
                      </div>
                    </div>
                    <button
                      class="btn btn-sm"
                      style="
                        font-size: 8px;
                        padding: 2px 8px;
                        border: 1px dashed var(--purple-accent);
                        color: var(--purple-accent);
                        background: none;
                        white-space: nowrap;
                        flex-shrink: 0;
                      "
                      onclick="
                        event.stopPropagation();
                        showToast(
                          'Walmart DSP integration requested — our team will reach out',
                        );
                      "
                    >
                      Connect →
                    </button>
                  </div>
                </div>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 8px;
                    margin-top: 4px;
                  "
                >
                  <div style="display: flex; align-items: center; gap: 6px">
                    <span style="font-size: 13px">📤</span
                    ><span
                      style="
                        font-size: 11px;
                        font-weight: 700;
                        color: var(--text-primary);
                      "
                      >Data Out</span
                    ><span
                      style="
                        font-size: 9px;
                        color: var(--text-tertiary);
                        font-weight: 500;
                      "
                      >CAPI &amp; conversion feeds</span
                    >
                  </div>
                </div>
                <div
                  style="
                    display: grid;
                    grid-template-columns: repeat(
                      auto-fill,
                      minmax(220px, 1fr)
                    );
                    gap: 6px;
                    margin-bottom: 14px;
                  "
                >
                  <div
                    style="
                      border: 1px solid #c8e8d8;
                      border-radius: 8px;
                      padding: 10px 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      background: #f4fbf8;
                      transition: all 0.15s;
                    "
                  >
                    <div
                      style="
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        opacity: 1;
                      "
                    >
                      <svg viewBox="0 0 28 28" width="20" height="20">
                        <path
                          d="M14 4C8.5 4 4 8.5 4 14s4.5 10 10 10 10-4.5 10-10S19.5 4 14 4z"
                          fill="none"
                          stroke="#0081fb"
                          stroke-width="2"
                        ></path>
                        <path
                          d="M14 4c-3 0-5 4.5-5 10s2 10 5 10 5-4.5 5-10-2-10-5-10z"
                          fill="none"
                          stroke="#0081fb"
                          stroke-width="1.5"
                        ></path>
                        <line
                          x1="4"
                          y1="14"
                          x2="24"
                          y2="14"
                          stroke="#0081fb"
                          stroke-width="1.5"
                        ></line>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 10px;
                          font-weight: 700;
                          color: var(--text-primary);
                        "
                      >
                        Meta CAPI
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: var(--text-secondary);
                          line-height: 1.3;
                        "
                      >
                        Server-side conversion feed
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: #00b894;
                          font-weight: 600;
                          margin-top: 2px;
                        "
                      >
                        3.2K events/day · 94% match rate
                      </div>
                    </div>
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 3px;
                        flex-shrink: 0;
                      "
                    >
                      <div
                        style="
                          width: 6px;
                          height: 6px;
                          border-radius: 50%;
                          background: #00b894;
                          animation: pulse 2s infinite;
                        "
                      ></div>
                      <span
                        style="font-size: 8px; font-weight: 600; color: #00b894"
                        >LIVE</span
                      >
                    </div>
                  </div>
                  <div
                    style="
                      border: 1px solid #c8e8d8;
                      border-radius: 8px;
                      padding: 10px 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      background: #f4fbf8;
                      transition: all 0.15s;
                    "
                  >
                    <div
                      style="
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        opacity: 1;
                      "
                    >
                      <svg viewBox="0 0 28 28" width="20" height="20">
                        <circle
                          cx="9"
                          cy="19"
                          r="5"
                          fill="#4285f4"
                          opacity=".2"
                          stroke="#4285f4"
                          stroke-width="1.5"
                        ></circle>
                        <rect
                          x="12"
                          y="4"
                          width="5"
                          height="20"
                          rx="2.5"
                          fill="#fbbc04"
                          opacity=".8"
                        ></rect>
                        <rect
                          x="4"
                          y="4"
                          width="5"
                          height="20"
                          rx="2.5"
                          fill="#4285f4"
                          opacity=".8"
                          transform="rotate(-30 6.5 14)"
                        ></rect>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 10px;
                          font-weight: 700;
                          color: var(--text-primary);
                        "
                      >
                        Google Ads
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: var(--text-secondary);
                          line-height: 1.3;
                        "
                      >
                        Offline conversion import
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: #00b894;
                          font-weight: 600;
                          margin-top: 2px;
                        "
                      >
                        1.8K events/day · 89% match rate
                      </div>
                    </div>
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 3px;
                        flex-shrink: 0;
                      "
                    >
                      <div
                        style="
                          width: 6px;
                          height: 6px;
                          border-radius: 50%;
                          background: #00b894;
                          animation: pulse 2s infinite;
                        "
                      ></div>
                      <span
                        style="font-size: 8px; font-weight: 600; color: #00b894"
                        >LIVE</span
                      >
                    </div>
                  </div>
                  <div
                    style="
                      border: 1px dashed #d8d6de;
                      border-radius: 8px;
                      padding: 10px 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      background: #fafafa;
                      transition: all 0.15s;
                    "
                  >
                    <div
                      style="
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        opacity: 0.4;
                      "
                    >
                      <svg viewBox="0 0 28 28" width="20" height="20">
                        <path
                          d="M18 5c0 3 2.5 5 5 5.5v4c-2.5 0-4.5-1-5.5-2v7.5c0 4-3 7-7 7s-7-3-7-7 3-7 7-7v4c-1.7 0-3 1.3-3 3s1.3 3 3 3 3-1.3 3-3V5h4z"
                          fill="#010101"
                          opacity=".7"
                        ></path>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 10px;
                          font-weight: 700;
                          color: var(--text-secondary);
                        "
                      >
                        TikTok Events API
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: var(--text-secondary);
                          line-height: 1.3;
                        "
                      >
                        Purchase attribution for TikTok ad campaigns
                      </div>
                    </div>
                    <button
                      class="btn btn-sm"
                      style="
                        font-size: 8px;
                        padding: 2px 8px;
                        border: 1px dashed var(--purple-accent);
                        color: var(--purple-accent);
                        background: none;
                        white-space: nowrap;
                        flex-shrink: 0;
                      "
                      onclick="
                        event.stopPropagation();
                        showToast(
                          'TikTok Events API integration requested — our team will reach out',
                        );
                      "
                    >
                      Connect →
                    </button>
                  </div>
                  <div
                    style="
                      border: 1px dashed #d8d6de;
                      border-radius: 8px;
                      padding: 10px 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      background: #fafafa;
                      transition: all 0.15s;
                    "
                  >
                    <div
                      style="
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        opacity: 0.4;
                      "
                    >
                      <svg viewBox="0 0 28 28" width="20" height="20">
                        <path
                          d="M14 4c-3 0-5.5 2-5.5 5.5 0 2-.5 4-2.5 5 1 .5 2.5 1 2 2-.3.8-2 1.5-2 1.5s2.5.5 3 1.5c.3.5-.5 1.5-.5 1.5s2-1 5-1 5 1 5 1-.8-1-.5-1.5c.5-1 3-1.5 3-1.5s-1.7-.7-2-1.5c-.5-1 1-1.5 2-2-2-1-2.5-3-2.5-5C19.5 6 17 4 14 4z"
                          fill="#FFFC00"
                          stroke="#ccc"
                          stroke-width=".5"
                        ></path>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 10px;
                          font-weight: 700;
                          color: var(--text-secondary);
                        "
                      >
                        Snap CAPI
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: var(--text-secondary);
                          line-height: 1.3;
                        "
                      >
                        Push purchase signals to Snap ad optimization
                      </div>
                    </div>
                    <button
                      class="btn btn-sm"
                      style="
                        font-size: 8px;
                        padding: 2px 8px;
                        border: 1px dashed var(--purple-accent);
                        color: var(--purple-accent);
                        background: none;
                        white-space: nowrap;
                        flex-shrink: 0;
                      "
                      onclick="
                        event.stopPropagation();
                        showToast(
                          'Snap CAPI integration requested — our team will reach out',
                        );
                      "
                    >
                      Connect →
                    </button>
                  </div>
                  <div
                    style="
                      border: 1px dashed #d8d6de;
                      border-radius: 8px;
                      padding: 10px 12px;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      background: #fafafa;
                      transition: all 0.15s;
                    "
                  >
                    <div
                      style="
                        width: 28px;
                        height: 28px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        opacity: 0.4;
                      "
                    >
                      <svg viewBox="0 0 28 28" width="20" height="20">
                        <circle
                          cx="14"
                          cy="14"
                          r="10"
                          fill="none"
                          stroke="#e60023"
                          stroke-width="2"
                        ></circle>
                        <path
                          d="M14 7c-3 0-5.5 2.5-5.5 5.5 0 2 1 3.5 2.5 4.3 0-.5 0-1 .3-1.5l1-3.5s-.3-.5-.3-1.2c0-1.2.7-2 1.5-2s1.2.5 1.2 1.3c0 .8-.5 2-.8 3 0 .8.5 1.3 1.3 1.3 1.5 0 2.5-2 2.5-4.3 0-1.8-1.2-3-3.5-3-2.5 0-4 2-4 4 0 .7.2 1.2.5 1.5.2.2.2.3.2.4l-.2.7c0 .2-.2.3-.3.2-1.2-.5-1.8-2-1.8-3.3 0-2.5 2-5.3 6-5.3s5.2 2.8 5.2 5.3c0 3.2-1.8 5.5-4.5 5.5-.8 0-1.7-.5-2-1l-.5 2.2c-.2.7-.7 1.5-1 2"
                          fill="#e60023"
                        ></path>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 10px;
                          font-weight: 700;
                          color: var(--text-secondary);
                        "
                      >
                        Pinterest CAPI
                      </div>
                      <div
                        style="
                          font-size: 8px;
                          color: var(--text-secondary);
                          line-height: 1.3;
                        "
                      >
                        Conversion event feed for Pinterest campaigns
                      </div>
                    </div>
                    <button
                      class="btn btn-sm"
                      style="
                        font-size: 8px;
                        padding: 2px 8px;
                        border: 1px dashed var(--purple-accent);
                        color: var(--purple-accent);
                        background: none;
                        white-space: nowrap;
                        flex-shrink: 0;
                      "
                      onclick="
                        event.stopPropagation();
                        showToast(
                          'Pinterest CAPI integration requested — our team will reach out',
                        );
                      "
                    >
                      Connect →
                    </button>
                  </div>
                </div>
              </div>
              <div class="inline-prompt purple" style="margin-top: 12px">
                <div>
                  <div class="inline-prompt-text">
                    <strong
                      >Send conversion signals to Meta &amp; Google.</strong
                    >
                    Pipe these purchase outcomes via CAPI to optimize platform
                    algorithms against real sales — not just clicks.
                  </div>
                </div>
                <button
                  class="btn btn-primary btn-sm"
                  onclick="showToast('CAPI integration details loading...')"
                  style="white-space: nowrap"
                >
                  Connect CAPI →
                </button>
              </div>
            </div>
          </div>
          <!-- /collapsible-body -->
        </div>

        <!-- ═══ MEASURED CAMPAIGNS COLLECTION ═══ -->
        <div
          class="card collapsible-card"
          id="measuredCampaigns"
          style="margin: 0 32px 16px"
        >
          <div
            class="card-header collapsible-header"
            onclick="toggleSection(this)"
            style="cursor: pointer"
          >
            <div>
              <div class="card-title">Measured Campaigns</div>
              <div class="card-subtitle">
                Comprehensive measurement studies — active, completed, and
                pending setup
              </div>
            </div>
            <div style="display: flex; gap: 8px; align-items: center">
              <button
                class="mc-expand-btn hide-collapsed"
                onclick="
                  event.stopPropagation();
                  mcToggleAll();
                "
                id="mcToggleAllBtn"
                style="padding: 4px 10px; font-size: 10px"
              >
                <svg
                  viewBox="0 0 24 24"
                  width="11"
                  height="11"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
                <span id="mcToggleLabel">Expand All</span>
              </button>
              <select
                class="filter-select hide-collapsed"
                id="mcFilter"
                onchange="renderMeasuredCampaigns()"
                style="font-size: 11px; padding: 5px 28px 5px 10px"
                onclick="event.stopPropagation()"
              >
                <option value="all">All Studies</option>
                <option value="active">Active</option>
                <option value="completed">Completed</option>
              </select>
              <button
                class="btn btn-primary btn-sm"
                onclick="
                  event.stopPropagation();
                  openDrawer('measurement');
                "
                style="white-space: nowrap"
              >
                <svg
                  viewBox="0 0 24 24"
                  width="13"
                  height="13"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Study
              </button>
              <svg
                class="collapse-chevron"
                onclick="
                  event.stopPropagation();
                  toggleSection(this.closest('.collapsible-header'));
                "
                viewBox="0 0 24 24"
                width="16"
                height="16"
                fill="none"
                stroke="var(--text-tertiary)"
                stroke-width="2"
              >
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
          </div>
          <div class="collapsible-body">
            <div class="card-body" style="padding-top: 0" id="mcBody">
              <div class="mc-card">
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    cursor: pointer;
                  "
                  onclick="toggleMcCard('mc1')"
                >
                  <div style="flex-shrink: 0">
                    <svg
                      viewBox="0 0 24 24"
                      width="14"
                      height="14"
                      fill="none"
                      stroke="var(--text-tertiary)"
                      stroke-width="2"
                      style="
                        transition: transform 0.2s;
                        transform: rotate(0deg);
                      "
                    >
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </div>
                  <div style="flex: 1; min-width: 0">
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        flex-wrap: wrap;
                      "
                    >
                      <span class="mc-status active" style="font-size: 9px"
                        ><span class="mc-dot"></span> Live</span
                      ><span
                        style="
                          font-size: 13px;
                          font-weight: 700;
                          color: var(--text-primary);
                        "
                        >Black Friday "Flame Deals" Blitz</span
                      ><span class="mc-study-type" style="font-size: 9px"
                        >Sales Lift</span
                      >
                    </div>
                    <div
                      style="
                        font-size: 10px;
                        color: var(--text-tertiary);
                        margin-top: 1px;
                      "
                    >
                      Burger King · Nov 15 – Dec 15, 2025
                    </div>
                  </div>
                  <div
                    style="
                      display: flex;
                      gap: 12px;
                      align-items: center;
                      flex-shrink: 0;
                    "
                  >
                    <div style="text-align: center">
                      <div
                        style="
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--teal);
                        "
                      >
                        4.2x
                      </div>
                      <div
                        style="
                          font-size: 7px;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.3px;
                          color: var(--text-tertiary);
                        "
                      >
                        iROAS
                      </div>
                    </div>
                    <div style="text-align: center">
                      <div
                        style="
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--text-primary);
                        "
                      >
                        $1.31M
                      </div>
                      <div
                        style="
                          font-size: 7px;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.3px;
                          color: var(--text-tertiary);
                        "
                      >
                        Inc. Sales
                      </div>
                    </div>
                    <div style="text-align: center">
                      <div
                        style="
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--text-primary);
                        "
                      >
                        6.8%
                      </div>
                      <div
                        style="
                          font-size: 7px;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.3px;
                          color: var(--text-tertiary);
                        "
                      >
                        CVR
                      </div>
                    </div>
                  </div>
                  <div
                    style="display: flex; gap: 5px; flex-shrink: 0"
                    onclick="event.stopPropagation()"
                  >
                    <button
                      class="mc-expand-btn"
                      onclick="toggleMcRecap('mc1')"
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="12"
                        height="12"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polygon
                          points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                        ></polygon></svg
                      >AI Recap</button
                    ><button
                      class="mc-report-btn"
                      onclick="openReportSettings('mc1')"
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="12"
                        height="12"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <rect x="2" y="3" width="20" height="14" rx="2"></rect>
                        <polyline points="8 21 12 17 16 21"></polyline></svg
                      >Weekly Report
                    </button>
                  </div>
                </div>
              </div>
              <div class="mc-card">
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    cursor: pointer;
                  "
                  onclick="toggleMcCard('mc2')"
                >
                  <div style="flex-shrink: 0">
                    <svg
                      viewBox="0 0 24 24"
                      width="14"
                      height="14"
                      fill="none"
                      stroke="var(--text-tertiary)"
                      stroke-width="2"
                      style="
                        transition: transform 0.2s;
                        transform: rotate(0deg);
                      "
                    >
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </div>
                  <div style="flex: 1; min-width: 0">
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        flex-wrap: wrap;
                      "
                    >
                      <span class="mc-status active" style="font-size: 9px"
                        ><span class="mc-dot"></span> Live</span
                      ><span
                        style="
                          font-size: 13px;
                          font-weight: 700;
                          color: var(--text-primary);
                        "
                        >Q1 2025 Whopper Conquest Campaign</span
                      ><span class="mc-study-type" style="font-size: 9px"
                        >Brand Lift &amp; Sales Impact</span
                      >
                    </div>
                    <div
                      style="
                        font-size: 10px;
                        color: var(--text-tertiary);
                        margin-top: 1px;
                      "
                    >
                      Burger King · Jan 6 – Mar 31, 2025
                    </div>
                  </div>
                  <div
                    style="
                      display: flex;
                      gap: 12px;
                      align-items: center;
                      flex-shrink: 0;
                    "
                  >
                    <div style="text-align: center">
                      <div
                        style="
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--teal);
                        "
                      >
                        3.8x
                      </div>
                      <div
                        style="
                          font-size: 7px;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.3px;
                          color: var(--text-tertiary);
                        "
                      >
                        iROAS
                      </div>
                    </div>
                    <div style="text-align: center">
                      <div
                        style="
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--text-primary);
                        "
                      >
                        $1.84M
                      </div>
                      <div
                        style="
                          font-size: 7px;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.3px;
                          color: var(--text-tertiary);
                        "
                      >
                        Inc. Sales
                      </div>
                    </div>
                    <div style="text-align: center">
                      <div
                        style="
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--text-primary);
                        "
                      >
                        5.4%
                      </div>
                      <div
                        style="
                          font-size: 7px;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.3px;
                          color: var(--text-tertiary);
                        "
                      >
                        CVR
                      </div>
                    </div>
                  </div>
                  <div
                    style="display: flex; gap: 5px; flex-shrink: 0"
                    onclick="event.stopPropagation()"
                  >
                    <button
                      class="mc-expand-btn"
                      onclick="toggleMcRecap('mc2')"
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="12"
                        height="12"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polygon
                          points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                        ></polygon></svg
                      >AI Recap</button
                    ><button
                      class="mc-report-btn"
                      onclick="openReportSettings('mc2')"
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="12"
                        height="12"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <rect x="2" y="3" width="20" height="14" rx="2"></rect>
                        <polyline points="8 21 12 17 16 21"></polyline></svg
                      >Weekly Report
                    </button>
                  </div>
                </div>
              </div>
              <div class="mc-card">
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    cursor: pointer;
                  "
                  onclick="toggleMcCard('mc3')"
                >
                  <div style="flex-shrink: 0">
                    <svg
                      viewBox="0 0 24 24"
                      width="14"
                      height="14"
                      fill="none"
                      stroke="var(--text-tertiary)"
                      stroke-width="2"
                      style="
                        transition: transform 0.2s;
                        transform: rotate(0deg);
                      "
                    >
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </div>
                  <div style="flex: 1; min-width: 0">
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        flex-wrap: wrap;
                      "
                    >
                      <span class="mc-status completed" style="font-size: 9px"
                        >Completed</span
                      ><span
                        style="
                          font-size: 13px;
                          font-weight: 700;
                          color: var(--text-primary);
                        "
                        >Summer BBQ Season Push</span
                      ><span class="mc-study-type" style="font-size: 9px"
                        >Sales Lift</span
                      >
                    </div>
                    <div
                      style="
                        font-size: 10px;
                        color: var(--text-tertiary);
                        margin-top: 1px;
                      "
                    >
                      Burger King · Jun 1 – Aug 15, 2024
                    </div>
                  </div>
                  <div
                    style="
                      display: flex;
                      gap: 12px;
                      align-items: center;
                      flex-shrink: 0;
                    "
                  >
                    <div style="text-align: center">
                      <div
                        style="
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--teal);
                        "
                      >
                        3.1x
                      </div>
                      <div
                        style="
                          font-size: 7px;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.3px;
                          color: var(--text-tertiary);
                        "
                      >
                        iROAS
                      </div>
                    </div>
                    <div style="text-align: center">
                      <div
                        style="
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--text-primary);
                        "
                      >
                        $694K
                      </div>
                      <div
                        style="
                          font-size: 7px;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.3px;
                          color: var(--text-tertiary);
                        "
                      >
                        Inc. Sales
                      </div>
                    </div>
                    <div style="text-align: center">
                      <div
                        style="
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--text-primary);
                        "
                      >
                        4.9%
                      </div>
                      <div
                        style="
                          font-size: 7px;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.3px;
                          color: var(--text-tertiary);
                        "
                      >
                        CVR
                      </div>
                    </div>
                  </div>
                  <div
                    style="display: flex; gap: 5px; flex-shrink: 0"
                    onclick="event.stopPropagation()"
                  >
                    <button
                      class="mc-expand-btn"
                      onclick="toggleMcRecap('mc3')"
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="12"
                        height="12"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polygon
                          points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                        ></polygon></svg
                      >AI Recap</button
                    ><button
                      class="mc-wrap-btn"
                      onclick="
                        showToast(
                          'Downloading wrap report for Summer BBQ Season Push...',
                        )
                      "
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="12"
                        height="12"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                        ></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line></svg
                      >Wrap Report
                    </button>
                  </div>
                </div>
              </div>
              <div class="mc-card">
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    cursor: pointer;
                  "
                  onclick="toggleMcCard('mc4')"
                >
                  <div style="flex-shrink: 0">
                    <svg
                      viewBox="0 0 24 24"
                      width="14"
                      height="14"
                      fill="none"
                      stroke="var(--text-tertiary)"
                      stroke-width="2"
                      style="
                        transition: transform 0.2s;
                        transform: rotate(0deg);
                      "
                    >
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </div>
                  <div style="flex: 1; min-width: 0">
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        flex-wrap: wrap;
                      "
                    >
                      <span class="mc-status completed" style="font-size: 9px"
                        >Completed</span
                      ><span
                        style="
                          font-size: 13px;
                          font-weight: 700;
                          color: var(--text-primary);
                        "
                        >Impossible Whopper Health-Conscious Launch</span
                      ><span class="mc-study-type" style="font-size: 9px"
                        >Brand Lift &amp; Visitation &amp; Sales Impact</span
                      >
                    </div>
                    <div
                      style="
                        font-size: 10px;
                        color: var(--text-tertiary);
                        margin-top: 1px;
                      "
                    >
                      Burger King · Mar 1 – May 30, 2024
                    </div>
                  </div>
                  <div
                    style="
                      display: flex;
                      gap: 12px;
                      align-items: center;
                      flex-shrink: 0;
                    "
                  >
                    <div style="text-align: center">
                      <div
                        style="
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--teal);
                        "
                      >
                        2.4x
                      </div>
                      <div
                        style="
                          font-size: 7px;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.3px;
                          color: var(--text-tertiary);
                        "
                      >
                        iROAS
                      </div>
                    </div>
                    <div style="text-align: center">
                      <div
                        style="
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--text-primary);
                        "
                      >
                        $427K
                      </div>
                      <div
                        style="
                          font-size: 7px;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.3px;
                          color: var(--text-tertiary);
                        "
                      >
                        Inc. Sales
                      </div>
                    </div>
                    <div style="text-align: center">
                      <div
                        style="
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--text-primary);
                        "
                      >
                        3.8%
                      </div>
                      <div
                        style="
                          font-size: 7px;
                          font-weight: 600;
                          text-transform: uppercase;
                          letter-spacing: 0.3px;
                          color: var(--text-tertiary);
                        "
                      >
                        CVR
                      </div>
                    </div>
                  </div>
                  <div
                    style="display: flex; gap: 5px; flex-shrink: 0"
                    onclick="event.stopPropagation()"
                  >
                    <button
                      class="mc-expand-btn"
                      onclick="toggleMcRecap('mc4')"
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="12"
                        height="12"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polygon
                          points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                        ></polygon></svg
                      >AI Recap</button
                    ><button
                      class="mc-wrap-btn"
                      onclick="
                        showToast(
                          'Downloading wrap report for Impossible Whopper Health-Conscious Launch...',
                        )
                      "
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="12"
                        height="12"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
                        ></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line></svg
                      >Wrap Report
                    </button>
                  </div>
                </div>
              </div>
              <div class="mc-setup-card" onclick="openDrawer('measurement')">
                <div
                  style="
                    width: 44px;
                    height: 44px;
                    border-radius: 50%;
                    background: var(--purple-bg);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 10px;
                  "
                >
                  <svg
                    viewBox="0 0 24 24"
                    width="22"
                    height="22"
                    fill="none"
                    stroke="var(--purple-accent)"
                    stroke-width="2"
                  >
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </div>
                <div
                  style="
                    font-size: 13px;
                    font-weight: 700;
                    color: var(--purple-accent);
                    margin-bottom: 4px;
                  "
                >
                  Set Up a New Measurement Study
                </div>
                <div
                  style="
                    font-size: 10.5px;
                    color: var(--text-secondary);
                    line-height: 1.4;
                    max-width: 400px;
                    margin: 0 auto;
                  "
                >
                  Launch Sales Lift, Brand Lift, Full-Funnel, or Visitation
                  studies.<br />Turnkey setup via PMP — results begin within 7
                  days of campaign start.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══ MARKET SHARE + PREMIUM INSIGHTS ═══ -->
        <div class="content-grid fade-in stagger-5">
          <!-- Market Share — Competitive Intelligence -->
          <div class="card collapsible-card">
            <div
              class="card-header collapsible-header"
              onclick="toggleSection(this)"
              style="padding-bottom: 0; cursor: pointer"
            >
              <div>
                <div class="card-title">Competitive Intelligence</div>
                <div class="card-subtitle">
                  Share of wallet, cross-shop, and indexed share — trailing 90
                  days
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 8px">
                <button
                  class="btn btn-primary btn-sm show-collapsed"
                  onclick="
                    event.stopPropagation();
                    openDrawer('insights');
                  "
                  style="white-space: nowrap"
                >
                  Subscribe to Premium Insights →
                </button>
                <svg
                  class="collapse-chevron"
                  onclick="
                    event.stopPropagation();
                    toggleSection(this.closest('.collapsible-header'));
                  "
                  viewBox="0 0 24 24"
                  width="16"
                  height="16"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
            </div>
            <div class="collapsible-body">
              <div style="padding: 6px 22px 0">
                <div class="opt-tabs" id="ciTabs">
                  <div
                    class="opt-tab active"
                    onclick="setCiTab('wallet', this)"
                  >
                    Share of Wallet
                  </div>
                  <div class="opt-tab" onclick="setCiTab('cohort', this)">
                    By Cohort
                  </div>
                  <div class="opt-tab" onclick="setCiTab('crossshop', this)">
                    Cross-Shop
                  </div>
                  <div class="opt-tab" onclick="setCiTab('indexed', this)">
                    Indexed
                  </div>
                </div>
              </div>
              <div class="card-body" id="ciBody">
                <table
                  style="
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 11px;
                    margin-bottom: 12px;
                  "
                >
                  <thead>
                    <tr>
                      <th
                        style="
                          text-align: left;
                          padding: 5px 8px;
                          font-size: 8px;
                          font-weight: 700;
                          text-transform: uppercase;
                          letter-spacing: 0.4px;
                          color: var(--text-tertiary);
                          border-bottom: 1px solid var(--card-border);
                        "
                      >
                        #
                      </th>
                      <th
                        style="
                          text-align: left;
                          padding: 5px 8px;
                          font-size: 8px;
                          font-weight: 700;
                          text-transform: uppercase;
                          letter-spacing: 0.4px;
                          color: var(--text-tertiary);
                          border-bottom: 1px solid var(--card-border);
                        "
                      >
                        Brand
                      </th>
                      <th
                        style="
                          text-align: right;
                          padding: 5px 8px;
                          font-size: 8px;
                          font-weight: 700;
                          text-transform: uppercase;
                          letter-spacing: 0.4px;
                          color: var(--text-tertiary);
                          border-bottom: 1px solid var(--card-border);
                        "
                      >
                        Share
                      </th>
                      <th
                        style="
                          text-align: right;
                          padding: 5px 6px;
                          font-size: 8px;
                          font-weight: 700;
                          text-transform: uppercase;
                          letter-spacing: 0.4px;
                          color: var(--text-tertiary);
                          border-bottom: 1px solid var(--card-border);
                        "
                      >
                        WoW
                      </th>
                      <th
                        style="
                          text-align: right;
                          padding: 5px 6px;
                          font-size: 8px;
                          font-weight: 700;
                          text-transform: uppercase;
                          letter-spacing: 0.4px;
                          color: var(--text-tertiary);
                          border-bottom: 1px solid var(--card-border);
                        "
                      >
                        MoM
                      </th>
                      <th
                        style="
                          padding: 5px 8px;
                          border-bottom: 1px solid var(--card-border);
                          width: 30%;
                        "
                      ></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr style="background: var(--purple-bg)">
                      <td
                        style="
                          padding: 7px 8px;
                          font-size: 11px;
                          font-weight: 700;
                          color: var(--text-tertiary);
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        1
                      </td>
                      <td
                        style="
                          padding: 7px 8px;
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        <div
                          style="display: flex; align-items: center; gap: 6px"
                        >
                          <div
                            style="
                              width: 8px;
                              height: 8px;
                              border-radius: 50%;
                              background: #6c5ce7;
                            "
                          ></div>
                          <span style="font-weight: 700; color: #6c5ce7"
                            >Burger King</span
                          >
                        </div>
                      </td>
                      <td
                        style="
                          text-align: right;
                          padding: 7px 8px;
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--text-primary);
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        34%
                      </td>
                      <td
                        style="
                          text-align: right;
                          padding: 7px 6px;
                          font-weight: 700;
                          color: var(--teal);
                          border-bottom: 1px solid var(--page-bg);
                          font-size: 11px;
                        "
                      >
                        +0.4
                      </td>
                      <td
                        style="
                          text-align: right;
                          padding: 7px 6px;
                          font-weight: 700;
                          color: var(--teal);
                          border-bottom: 1px solid var(--page-bg);
                          font-size: 11px;
                        "
                      >
                        +0.9
                      </td>
                      <td
                        style="
                          padding: 7px 8px;
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        <div
                          style="
                            height: 10px;
                            background: var(--page-bg);
                            border-radius: 4px;
                            overflow: hidden;
                          "
                        >
                          <div
                            style="
                              height: 100%;
                              width: 34%;
                              background: #6c5ce7;
                              border-radius: 4px;
                              opacity: 0.5;
                            "
                          ></div>
                        </div>
                      </td>
                    </tr>
                    <tr style="">
                      <td
                        style="
                          padding: 7px 8px;
                          font-size: 11px;
                          font-weight: 700;
                          color: var(--text-tertiary);
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        2
                      </td>
                      <td
                        style="
                          padding: 7px 8px;
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        <div
                          style="display: flex; align-items: center; gap: 6px"
                        >
                          <div
                            style="
                              width: 8px;
                              height: 8px;
                              border-radius: 50%;
                              background: #e17055;
                            "
                          ></div>
                          <span
                            style="font-weight: 600; color: var(--text-primary)"
                            >McDonald's</span
                          >
                        </div>
                      </td>
                      <td
                        style="
                          text-align: right;
                          padding: 7px 8px;
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--text-primary);
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        29.2%
                      </td>
                      <td
                        style="
                          text-align: right;
                          padding: 7px 6px;
                          font-weight: 700;
                          color: var(--coral);
                          border-bottom: 1px solid var(--page-bg);
                          font-size: 11px;
                        "
                      >
                        -0.3
                      </td>
                      <td
                        style="
                          text-align: right;
                          padding: 7px 6px;
                          font-weight: 700;
                          color: var(--coral);
                          border-bottom: 1px solid var(--page-bg);
                          font-size: 11px;
                        "
                      >
                        -0.6
                      </td>
                      <td
                        style="
                          padding: 7px 8px;
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        <div
                          style="
                            height: 10px;
                            background: var(--page-bg);
                            border-radius: 4px;
                            overflow: hidden;
                          "
                        >
                          <div
                            style="
                              height: 100%;
                              width: 29.2%;
                              background: #e17055;
                              border-radius: 4px;
                              opacity: 0.5;
                            "
                          ></div>
                        </div>
                      </td>
                    </tr>
                    <tr style="">
                      <td
                        style="
                          padding: 7px 8px;
                          font-size: 11px;
                          font-weight: 700;
                          color: var(--text-tertiary);
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        3
                      </td>
                      <td
                        style="
                          padding: 7px 8px;
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        <div
                          style="display: flex; align-items: center; gap: 6px"
                        >
                          <div
                            style="
                              width: 8px;
                              height: 8px;
                              border-radius: 50%;
                              background: #fdcb6e;
                            "
                          ></div>
                          <span
                            style="font-weight: 600; color: var(--text-primary)"
                            >Wendy's</span
                          >
                        </div>
                      </td>
                      <td
                        style="
                          text-align: right;
                          padding: 7px 8px;
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--text-primary);
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        21.6%
                      </td>
                      <td
                        style="
                          text-align: right;
                          padding: 7px 6px;
                          font-weight: 700;
                          color: var(--text-tertiary);
                          border-bottom: 1px solid var(--page-bg);
                          font-size: 11px;
                        "
                      >
                        0.0
                      </td>
                      <td
                        style="
                          text-align: right;
                          padding: 7px 6px;
                          font-weight: 700;
                          color: var(--coral);
                          border-bottom: 1px solid var(--page-bg);
                          font-size: 11px;
                        "
                      >
                        -0.3
                      </td>
                      <td
                        style="
                          padding: 7px 8px;
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        <div
                          style="
                            height: 10px;
                            background: var(--page-bg);
                            border-radius: 4px;
                            overflow: hidden;
                          "
                        >
                          <div
                            style="
                              height: 100%;
                              width: 21.6%;
                              background: #fdcb6e;
                              border-radius: 4px;
                              opacity: 0.5;
                            "
                          ></div>
                        </div>
                      </td>
                    </tr>
                    <tr style="">
                      <td
                        style="
                          padding: 7px 8px;
                          font-size: 11px;
                          font-weight: 700;
                          color: var(--text-tertiary);
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        4
                      </td>
                      <td
                        style="
                          padding: 7px 8px;
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        <div
                          style="display: flex; align-items: center; gap: 6px"
                        >
                          <div
                            style="
                              width: 8px;
                              height: 8px;
                              border-radius: 50%;
                              background: #00b894;
                            "
                          ></div>
                          <span
                            style="font-weight: 600; color: var(--text-primary)"
                            >Popeye's</span
                          >
                        </div>
                      </td>
                      <td
                        style="
                          text-align: right;
                          padding: 7px 8px;
                          font-size: 14px;
                          font-weight: 800;
                          color: var(--text-primary);
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        15.2%
                      </td>
                      <td
                        style="
                          text-align: right;
                          padding: 7px 6px;
                          font-weight: 700;
                          color: var(--teal);
                          border-bottom: 1px solid var(--page-bg);
                          font-size: 11px;
                        "
                      >
                        +0.1
                      </td>
                      <td
                        style="
                          text-align: right;
                          padding: 7px 6px;
                          font-weight: 700;
                          color: var(--teal);
                          border-bottom: 1px solid var(--page-bg);
                          font-size: 11px;
                        "
                      >
                        +0.2
                      </td>
                      <td
                        style="
                          padding: 7px 8px;
                          border-bottom: 1px solid var(--page-bg);
                        "
                      >
                        <div
                          style="
                            height: 10px;
                            background: var(--page-bg);
                            border-radius: 4px;
                            overflow: hidden;
                          "
                        >
                          <div
                            style="
                              height: 100%;
                              width: 15.2%;
                              background: #00b894;
                              border-radius: 4px;
                              opacity: 0.5;
                            "
                          ></div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 8px;
                  "
                >
                  <div
                    style="
                      font-size: 10px;
                      font-weight: 600;
                      color: var(--text-tertiary);
                      white-space: nowrap;
                    "
                  >
                    SHARE TREND
                  </div>
                  <div style="flex: 1"></div>
                  <select
                    class="filter-select"
                    style="font-size: 10px; padding: 3px 24px 3px 8px"
                    onchange="setCiCamp(this.value)"
                  >
                    <option value="" selected="">Organic</option>
                    <option value="mc1">Black Friday "Flame Deals" B...</option>
                    <option value="mc2">Q1 2025 Whopper Conquest Cam...</option>
                    <option value="mc3">Summer BBQ Season Push</option>
                    <option value="mc4">Impossible Whopper Health-Co...</option>
                  </select>
                  <div style="display: flex; gap: 2px">
                    <div
                      class="filter-pill"
                      style="font-size: 9px; padding: 3px 7px; cursor: pointer"
                      onclick="setCiTime('90d')"
                    >
                      90D
                    </div>
                    <div
                      class="filter-pill"
                      style="font-size: 9px; padding: 3px 7px; cursor: pointer"
                      onclick="setCiTime('6m')"
                    >
                      6M
                    </div>
                    <div
                      class="filter-pill active"
                      style="font-size: 9px; padding: 3px 7px; cursor: pointer"
                      onclick="setCiTime('1y')"
                    >
                      1Y
                    </div>
                    <div
                      class="filter-pill"
                      style="font-size: 9px; padding: 3px 7px; cursor: pointer"
                      onclick="setCiTime('2y')"
                    >
                      2Y
                    </div>
                  </div>
                </div>
                <div style="height: 140px">
                  <canvas
                    id="ciShareCanvas"
                    width="1469"
                    height="280"
                    style="
                      display: block;
                      box-sizing: border-box;
                      height: 140px;
                      width: 734px;
                    "
                  ></canvas>
                </div>
                <div
                  style="
                    margin-top: 10px;
                    padding: 11px 14px;
                    background: linear-gradient(135deg, #f0eeff, #faf9fd);
                    border-radius: 8px;
                    border: 1px solid #e0dced;
                    font-size: 11px;
                    line-height: 1.55;
                  "
                >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 5px;
                      margin-bottom: 5px;
                    "
                  >
                    <svg
                      viewBox="0 0 24 24"
                      width="13"
                      height="13"
                      fill="none"
                      stroke="var(--purple-accent)"
                      stroke-width="2"
                    >
                      <polygon
                        points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                      ></polygon></svg
                    ><span
                      style="
                        font-size: 9px;
                        font-weight: 700;
                        color: var(--purple-accent);
                        text-transform: uppercase;
                        letter-spacing: 0.4px;
                      "
                      >outcome AI</span
                    >
                  </div>
                  <strong style="color: var(--text-primary)"
                    >BK is gaining share for the 4th consecutive week.</strong
                  >
                  <span style="color: var(--text-secondary)"
                    >You're up +0.4pp WoW and +0.9pp MoM, primarily at
                    McDonald's expense (–0.3pp WoW). This organic momentum
                    suggests strong brand health independent of media. Select a
                    measured campaign from the dropdown to see how much media is
                    accelerating these gains.</span
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- ═══ PREMIUM INSIGHTS SUITE ═══ -->
          <div class="card collapsible-card" style="overflow: hidden">
            <div
              class="card-header collapsible-header"
              onclick="toggleSection(this)"
              style="padding-bottom: 4px; cursor: pointer"
            >
              <div>
                <div class="card-title">
                  Premium Insights Suite
                  <span
                    style="
                      font-size: 9px;
                      font-weight: 700;
                      color: #fff;
                      background: linear-gradient(
                        135deg,
                        var(--purple-accent),
                        #a29bfe
                      );
                      padding: 3px 10px;
                      border-radius: 4px;
                      letter-spacing: 0.3px;
                    "
                    >PREVIEW</span
                  >
                </div>
                <div class="card-subtitle">
                  Consumer spend behavior across 10,000+ merchants, retailers,
                  and brands — down to the item level
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 8px">
                <button
                  class="btn btn-primary btn-sm"
                  onclick="
                    event.stopPropagation();
                    openDrawer('insights');
                  "
                  style="white-space: nowrap"
                >
                  Unlock Full Suite →
                </button>
                <svg
                  class="collapse-chevron"
                  onclick="
                    event.stopPropagation();
                    toggleSection(this.closest('.collapsible-header'));
                  "
                  viewBox="0 0 24 24"
                  width="16"
                  height="16"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
            </div>
            <div class="collapsible-body">
              <div class="card-body" style="padding-top: 8px">
                <!-- Visible KPI row -->
                <div
                  style="
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 10px;
                    margin-bottom: 14px;
                  "
                >
                  <div
                    style="
                      border: 1px solid var(--card-border);
                      border-radius: 8px;
                      padding: 12px;
                      background: #fff;
                    "
                  >
                    <div
                      style="
                        font-size: 8px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        color: var(--text-tertiary);
                      "
                    >
                      Avg Total Spend
                    </div>
                    <div
                      style="font-size: 22px; font-weight: 800; margin-top: 2px"
                    >
                      $36.32
                    </div>
                    <div
                      style="
                        font-size: 9px;
                        color: var(--text-secondary);
                        margin-top: 2px;
                      "
                    >
                      Per buyer · trailing 12mo
                    </div>
                  </div>
                  <div
                    style="
                      border: 1px solid var(--card-border);
                      border-radius: 8px;
                      padding: 12px;
                      background: #fff;
                    "
                  >
                    <div
                      style="
                        font-size: 8px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        color: var(--text-tertiary);
                      "
                    >
                      Avg Spend / Transaction
                    </div>
                    <div
                      style="font-size: 22px; font-weight: 800; margin-top: 2px"
                    >
                      $15.57
                    </div>
                    <div
                      style="
                        font-size: 9px;
                        color: var(--text-secondary);
                        margin-top: 2px;
                      "
                    >
                      +3.2% vs QSR avg
                    </div>
                  </div>
                  <div
                    style="
                      border: 1px solid var(--card-border);
                      border-radius: 8px;
                      padding: 12px;
                      background: #fff;
                    "
                  >
                    <div
                      style="
                        font-size: 8px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        color: var(--text-tertiary);
                      "
                    >
                      Avg Purchase Frequency
                    </div>
                    <div
                      style="font-size: 22px; font-weight: 800; margin-top: 2px"
                    >
                      2.3x
                    </div>
                    <div
                      style="
                        font-size: 9px;
                        color: var(--text-secondary);
                        margin-top: 2px;
                      "
                    >
                      Per quarter
                    </div>
                  </div>
                  <div
                    style="
                      border: 1px solid var(--card-border);
                      border-radius: 8px;
                      padding: 12px;
                      background: #fff;
                    "
                  >
                    <div
                      style="
                        font-size: 8px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        color: var(--text-tertiary);
                      "
                    >
                      Basket Percentage
                    </div>
                    <div
                      style="font-size: 22px; font-weight: 800; margin-top: 2px"
                    >
                      0.83%
                    </div>
                    <div
                      style="
                        font-size: 9px;
                        color: var(--text-secondary);
                        margin-top: 2px;
                      "
                    >
                      Category share of wallet
                    </div>
                  </div>
                </div>
                <!-- Demographics preview -->
                <div
                  style="
                    border: 1px solid var(--card-border);
                    border-radius: 10px;
                    padding: 14px;
                    margin-bottom: 10px;
                    background: #fff;
                  "
                >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                      margin-bottom: 10px;
                    "
                  >
                    <div style="font-size: 13px; font-weight: 700">
                      Demographics
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px">
                      <span style="font-size: 9px; color: var(--text-tertiary)"
                        >Category</span
                      >
                      <span
                        style="
                          font-size: 10px;
                          font-weight: 600;
                          color: var(--text-primary);
                          background: var(--page-bg);
                          padding: 4px 10px;
                          border-radius: 5px;
                          border: 1px solid var(--card-border);
                        "
                        >Age Generation ▾</span
                      >
                    </div>
                  </div>
                  <div
                    style="
                      display: grid;
                      grid-template-columns: 140px 1fr 60px 70px;
                      gap: 0;
                      font-size: 10px;
                    "
                  >
                    <div
                      style="
                        padding: 6px 0;
                        color: var(--text-tertiary);
                        font-weight: 600;
                        border-bottom: 1px solid var(--card-border);
                      "
                    >
                      Subcategory
                    </div>
                    <div
                      style="
                        padding: 6px 0;
                        color: var(--text-tertiary);
                        font-weight: 600;
                        border-bottom: 1px solid var(--card-border);
                      "
                    >
                      Percent of audience
                    </div>
                    <div
                      style="
                        padding: 6px 0;
                        color: var(--text-tertiary);
                        font-weight: 600;
                        border-bottom: 1px solid var(--card-border);
                        text-align: right;
                      "
                    ></div>
                    <div
                      style="
                        padding: 6px 0;
                        color: var(--text-tertiary);
                        font-weight: 600;
                        border-bottom: 1px solid var(--card-border);
                        text-align: right;
                      "
                    >
                      Index
                    </div>
                    <div style="padding: 8px 0; font-weight: 600">
                      Gen X (1965–1980)
                    </div>
                    <div
                      style="
                        padding: 8px 0;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                      "
                    >
                      <div
                        style="
                          flex: 1;
                          height: 6px;
                          border-radius: 3px;
                          background: #e8e6ef;
                        "
                      >
                        <div
                          style="
                            width: 62%;
                            height: 100%;
                            border-radius: 3px;
                            background: linear-gradient(
                              90deg,
                              #b8e0b8,
                              #6cb86c
                            );
                          "
                        ></div>
                      </div>
                      <span
                        style="
                          font-size: 9px;
                          color: var(--text-secondary);
                          min-width: 36px;
                          text-align: right;
                        "
                        >32.27%</span
                      >
                    </div>
                    <div style="padding: 8px 0; text-align: right">
                      <span
                        style="
                          font-size: 8px;
                          font-weight: 600;
                          color: #00b894;
                          background: #e8faf5;
                          padding: 2px 6px;
                          border-radius: 3px;
                        "
                        >↑ High</span
                      >
                    </div>
                    <div
                      style="
                        padding: 8px 0;
                        text-align: right;
                        font-weight: 700;
                      "
                    >
                      117
                    </div>
                    <div style="padding: 8px 0; font-weight: 600">
                      Millennial (1981–1996)
                    </div>
                    <div
                      style="
                        padding: 8px 0;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                      "
                    >
                      <div
                        style="
                          flex: 1;
                          height: 6px;
                          border-radius: 3px;
                          background: #e8e6ef;
                        "
                      >
                        <div
                          style="
                            width: 54%;
                            height: 100%;
                            border-radius: 3px;
                            background: linear-gradient(
                              90deg,
                              #b8e0b8,
                              #6cb86c
                            );
                          "
                        ></div>
                      </div>
                      <span
                        style="
                          font-size: 9px;
                          color: var(--text-secondary);
                          min-width: 36px;
                          text-align: right;
                        "
                        >27.69%</span
                      >
                    </div>
                    <div style="padding: 8px 0; text-align: right">
                      <span
                        style="
                          font-size: 8px;
                          font-weight: 600;
                          color: var(--text-tertiary);
                          background: #f0f0f0;
                          padding: 2px 6px;
                          border-radius: 3px;
                        "
                        >— Neutral</span
                      >
                    </div>
                    <div
                      style="
                        padding: 8px 0;
                        text-align: right;
                        font-weight: 700;
                      "
                    >
                      93
                    </div>
                  </div>
                </div>
                <!-- Blurred capabilities grid -->
                <div class="premium-teaser">
                  <div
                    class="premium-blur"
                    style="
                      display: grid;
                      grid-template-columns: 1fr 1fr;
                      gap: 10px;
                    "
                  >
                    <div
                      style="
                        border: 1px solid var(--card-border);
                        border-radius: 10px;
                        padding: 14px;
                        background: #fff;
                      "
                    >
                      <div
                        style="
                          font-size: 12px;
                          font-weight: 700;
                          margin-bottom: 4px;
                        "
                      >
                        Switching Breakdown
                      </div>
                      <div
                        style="
                          font-size: 9px;
                          color: var(--text-secondary);
                          margin-bottom: 10px;
                        "
                      >
                        Sources of growth/decline from competitor switching
                      </div>
                      <svg
                        viewBox="0 0 200 80"
                        style="width: 100%; height: 80px"
                      >
                        <rect
                          x="0"
                          y="5"
                          width="180"
                          height="12"
                          rx="3"
                          fill="#ffeaa7"
                          opacity=".6"
                        ></rect>
                        <text x="4" y="14" font-size="7" fill="#636e72">
                          McDonald's: 27.6%
                        </text>
                        <rect
                          x="0"
                          y="22"
                          width="160"
                          height="12"
                          rx="3"
                          fill="#81ecec"
                          opacity=".6"
                        ></rect>
                        <text x="4" y="31" font-size="7" fill="#636e72">
                          Wendy's: 25.6%
                        </text>
                        <rect
                          x="0"
                          y="39"
                          width="120"
                          height="12"
                          rx="3"
                          fill="#fab1a0"
                          opacity=".6"
                        ></rect>
                        <text x="4" y="48" font-size="7" fill="#636e72">
                          Popeyes: 16.6%
                        </text>
                        <rect
                          x="0"
                          y="56"
                          width="90"
                          height="12"
                          rx="3"
                          fill="#dfe6e9"
                          opacity=".6"
                        ></rect>
                        <text x="4" y="65" font-size="7" fill="#636e72">
                          Chick-fil-A: 12.7%
                        </text>
                      </svg>
                    </div>
                    <div
                      style="
                        border: 1px solid var(--card-border);
                        border-radius: 10px;
                        padding: 14px;
                        background: #fff;
                      "
                    >
                      <div
                        style="
                          font-size: 12px;
                          font-weight: 700;
                          margin-bottom: 4px;
                        "
                      >
                        Cross-Purchase Breakdown
                      </div>
                      <div
                        style="
                          font-size: 9px;
                          color: var(--text-secondary);
                          margin-bottom: 10px;
                        "
                      >
                        Where your buyers also shop
                      </div>
                      <svg
                        viewBox="0 0 200 80"
                        style="width: 100%; height: 80px"
                      >
                        <circle
                          cx="70"
                          cy="40"
                          r="32"
                          fill="#fab1a0"
                          opacity=".3"
                          stroke="#e17055"
                          stroke-width=".5"
                        ></circle>
                        <circle
                          cx="110"
                          cy="35"
                          r="28"
                          fill="#81ecec"
                          opacity=".3"
                          stroke="#00b894"
                          stroke-width=".5"
                        ></circle>
                        <circle
                          cx="90"
                          cy="55"
                          r="24"
                          fill="#a29bfe"
                          opacity=".3"
                          stroke="#6c5ce7"
                          stroke-width=".5"
                        ></circle>
                        <text x="55" y="36" font-size="6" fill="#636e72">
                          34.7%
                        </text>
                        <text x="100" y="30" font-size="6" fill="#636e72">
                          44.6%
                        </text>
                        <text x="82" y="56" font-size="6" fill="#636e72">
                          14.8%
                        </text>
                      </svg>
                    </div>
                    <div
                      style="
                        border: 1px solid var(--card-border);
                        border-radius: 10px;
                        padding: 14px;
                        background: #fff;
                      "
                    >
                      <div
                        style="
                          font-size: 12px;
                          font-weight: 700;
                          margin-bottom: 4px;
                        "
                      >
                        Brand Share of Wallet
                      </div>
                      <div
                        style="
                          font-size: 9px;
                          color: var(--text-secondary);
                          margin-bottom: 10px;
                        "
                      >
                        Quarterly spend share vs competitive set
                      </div>
                      <svg
                        viewBox="0 0 200 60"
                        style="width: 100%; height: 60px"
                      >
                        <polyline
                          points="10,10 60,12 120,11 180,9"
                          fill="none"
                          stroke="#6c5ce7"
                          stroke-width="2"
                        ></polyline>
                        <polyline
                          points="10,35 60,33 120,30 180,28"
                          fill="none"
                          stroke="#e17055"
                          stroke-width="1.5"
                        ></polyline>
                        <polyline
                          points="10,42 60,40 120,38 180,36"
                          fill="none"
                          stroke="#00b894"
                          stroke-width="1.5"
                        ></polyline>
                        <polyline
                          points="10,48 60,47 120,46 180,44"
                          fill="none"
                          stroke="#fdcb6e"
                          stroke-width="1.5"
                        ></polyline>
                        <text x="10" y="58" font-size="6" fill="#9990ab">
                          Q1
                        </text>
                        <text x="60" y="58" font-size="6" fill="#9990ab">
                          Q2
                        </text>
                        <text x="120" y="58" font-size="6" fill="#9990ab">
                          Q3
                        </text>
                        <text x="180" y="58" font-size="6" fill="#9990ab">
                          Q4
                        </text>
                      </svg>
                    </div>
                    <div
                      style="
                        border: 1px solid var(--card-border);
                        border-radius: 10px;
                        padding: 14px;
                        background: #fff;
                      "
                    >
                      <div
                        style="
                          font-size: 12px;
                          font-weight: 700;
                          margin-bottom: 4px;
                        "
                      >
                        Category Shopping Affinities
                      </div>
                      <div
                        style="
                          font-size: 9px;
                          color: var(--text-secondary);
                          margin-bottom: 10px;
                        "
                      >
                        Cross-shopping behavior across all categories
                      </div>
                      <div
                        style="display: flex; flex-direction: column; gap: 5px"
                      >
                        <div
                          style="
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            font-size: 9px;
                          "
                        >
                          <span style="width: 80px; font-weight: 600"
                            >Food &amp; Drink</span
                          >
                          <div
                            style="
                              flex: 1;
                              height: 5px;
                              border-radius: 2px;
                              background: #e8e6ef;
                            "
                          >
                            <div
                              style="
                                width: 92%;
                                height: 100%;
                                border-radius: 2px;
                                background: linear-gradient(
                                  90deg,
                                  #b8e0b8,
                                  #4a8
                                );
                              "
                            ></div>
                          </div>
                          <span>97.5%</span>
                        </div>
                        <div
                          style="
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            font-size: 9px;
                          "
                        >
                          <span style="width: 80px; font-weight: 600"
                            >Entertainment</span
                          >
                          <div
                            style="
                              flex: 1;
                              height: 5px;
                              border-radius: 2px;
                              background: #e8e6ef;
                            "
                          >
                            <div
                              style="
                                width: 86%;
                                height: 100%;
                                border-radius: 2px;
                                background: linear-gradient(
                                  90deg,
                                  #b8e0b8,
                                  #4a8
                                );
                              "
                            ></div>
                          </div>
                          <span>91.3%</span>
                        </div>
                        <div
                          style="
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            font-size: 9px;
                          "
                        >
                          <span style="width: 80px; font-weight: 600"
                            >Personal Care</span
                          >
                          <div
                            style="
                              flex: 1;
                              height: 5px;
                              border-radius: 2px;
                              background: #e8e6ef;
                            "
                          >
                            <div
                              style="
                                width: 60%;
                                height: 100%;
                                border-radius: 2px;
                                background: linear-gradient(
                                  90deg,
                                  #b8e0b8,
                                  #4a8
                                );
                              "
                            ></div>
                          </div>
                          <span>63.5%</span>
                        </div>
                        <div
                          style="
                            display: flex;
                            align-items: center;
                            gap: 6px;
                            font-size: 9px;
                          "
                        >
                          <span style="width: 80px; font-weight: 600"
                            >Travel</span
                          >
                          <div
                            style="
                              flex: 1;
                              height: 5px;
                              border-radius: 2px;
                              background: #e8e6ef;
                            "
                          >
                            <div
                              style="
                                width: 44%;
                                height: 100%;
                                border-radius: 2px;
                                background: linear-gradient(
                                  90deg,
                                  #b8e0b8,
                                  #4a8
                                );
                              "
                            ></div>
                          </div>
                          <span>46.7%</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="premium-overlay">
                    <div class="premium-lock-icon">
                      <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <rect
                          x="3"
                          y="11"
                          width="18"
                          height="11"
                          rx="2"
                          ry="2"
                        ></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                      </svg>
                    </div>
                    <div class="premium-overlay-text">
                      Unlock the Premium Insights Suite
                    </div>
                    <div class="premium-overlay-sub">
                      Switching behavior, cross-purchase breakdowns, share of
                      wallet trends, propensity &amp; CLV scoring,
                      psychographics, category affinities, and more — across
                      10,000+ merchants
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 14px">
                      <button
                        class="btn btn-primary"
                        onclick="
                          event.stopPropagation();
                          openDrawer('insights');
                        "
                      >
                        Explore Full Suite →
                      </button>
                      <button
                        class="btn"
                        style="
                          border: 1px solid var(--card-border);
                          background: #fff;
                          font-size: 11px;
                        "
                        onclick="
                          event.stopPropagation();
                          showToast('Demo video opening...');
                        "
                      >
                        Watch Demo
                      </button>
                    </div>
                    <div
                      style="
                        margin-top: 10px;
                        display: flex;
                        gap: 12px;
                        font-size: 9px;
                        color: var(--text-tertiary);
                      "
                    >
                      <span>✓ Profile any brand's customers</span>
                      <span>✓ New business pitch research</span>
                      <span>✓ Competitive intelligence</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Cohort Migration Tracker — full width -->
          <div class="card full collapsible-card">
            <div
              class="card-header collapsible-header"
              onclick="toggleSection(this)"
              style="padding-bottom: 4px; cursor: pointer"
            >
              <div>
                <div class="card-title">Cohort Migration</div>
                <div class="card-subtitle" id="migSub">
                  All buyer movement · 3–6 Months Ago → Last 3 Months
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 8px">
                <div
                  class="mode-toggle hide-collapsed"
                  style="transform: scale(0.85); transform-origin: right center"
                  onclick="event.stopPropagation()"
                >
                  <div
                    class="mode-opt active"
                    onclick="setMigMode('organic', this)"
                    id="migOrgBtn"
                    style="padding: 6px 14px; font-size: 11px"
                  >
                    Organic
                  </div>
                  <div
                    class="mode-opt"
                    onclick="setMigMode('attribution', this)"
                    id="migAttrBtn"
                    style="padding: 6px 14px; font-size: 11px"
                  >
                    Attribution
                  </div>
                </div>
                <svg
                  class="collapse-chevron"
                  onclick="
                    event.stopPropagation();
                    toggleSection(this.closest('.collapsible-header'));
                  "
                  viewBox="0 0 24 24"
                  width="16"
                  height="16"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                >
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
            </div>
            <div class="collapsible-body">
              <div
                style="
                  padding: 0 22px;
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  gap: 12px;
                "
              >
                <div style="display: flex; align-items: center; gap: 6px">
                  <span
                    style="
                      font-size: 9px;
                      font-weight: 600;
                      color: var(--text-tertiary);
                      text-transform: uppercase;
                      letter-spacing: 0.4px;
                    "
                    >From</span
                  >
                  <div class="fg-pills" id="migLeftPills">
                    <div
                      class="filter-pill active"
                      onclick="setMigLeft('3-6', this)"
                    >
                      3–6 mo ago
                    </div>
                    <div class="filter-pill" onclick="setMigLeft('6-12', this)">
                      6–12 mo ago
                    </div>
                  </div>
                </div>
                <svg
                  viewBox="0 0 24 24"
                  width="16"
                  height="16"
                  fill="none"
                  stroke="var(--text-tertiary)"
                  stroke-width="2"
                >
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
                <div style="display: flex; align-items: center; gap: 6px">
                  <span
                    style="
                      font-size: 9px;
                      font-weight: 600;
                      color: var(--text-tertiary);
                      text-transform: uppercase;
                      letter-spacing: 0.4px;
                    "
                    >To</span
                  >
                  <div class="fg-pills" id="migRightPills">
                    <div
                      class="filter-pill active"
                      onclick="setMigRight('3', this)"
                    >
                      Last 3 mo
                    </div>
                    <div class="filter-pill" onclick="setMigRight('6', this)">
                      Last 6 mo
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body" id="migBody">
                <div style="position: relative">
                  <svg
                    viewBox="0 0 520 266"
                    style="width: 100%; height: 266px; margin-top: 8px"
                    id="migSvg"
                  >
                    <g
                      class="mig-flow"
                      data-fi="0"
                      data-from="New-to-Category"
                      data-to="Ultra-Light Buyers"
                      data-val="1204"
                      data-dir="up"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 32 C212 32 308 152 420 152"
                        fill="none"
                        stroke="rgba(0,184,148,.2)"
                        stroke-width="2.58"
                        class="mig-path"
                        data-base="rgba(0,184,148,.2)"
                        data-hover="rgba(0,184,148,.5)"
                      ></path>
                      <text
                        x="260"
                        y="91"
                        text-anchor="middle"
                        font-size="8"
                        font-weight="700"
                        fill="#00b894"
                        opacity=".5"
                        class="mig-flow-label"
                      >
                        1,204
                      </text>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="1"
                      data-from="New-to-Category"
                      data-to="New-to-Category"
                      data-val="2180"
                      data-dir="stay"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 32 C212 32 308 32 420 32"
                        fill="none"
                        stroke="rgba(150,150,170,.12)"
                        stroke-width="4.671428571428572"
                        class="mig-path"
                        data-base="rgba(150,150,170,.12)"
                        data-hover="rgba(150,150,170,.35)"
                      ></path>
                      <text
                        x="260"
                        y="31"
                        text-anchor="middle"
                        font-size="8"
                        font-weight="700"
                        fill="#9990ab"
                        opacity=".5"
                        class="mig-flow-label"
                      >
                        2,180
                      </text>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="2"
                      data-from="New-to-Category"
                      data-to="Lapsed &amp; Lapsing"
                      data-val="944"
                      data-dir="down"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 32 C212 32 308 112 420 112"
                        fill="none"
                        stroke="rgba(214,48,49,.15)"
                        stroke-width="2.022857142857143"
                        class="mig-path"
                        data-base="rgba(214,48,49,.15)"
                        data-hover="rgba(214,48,49,.4)"
                      ></path>
                      <text
                        x="260"
                        y="71"
                        text-anchor="middle"
                        font-size="8"
                        font-weight="700"
                        fill="#d63031"
                        opacity=".5"
                        class="mig-flow-label"
                      >
                        944
                      </text>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="3"
                      data-from="Competitor Conquest"
                      data-to="New-to-Category"
                      data-val="312"
                      data-dir="up"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 72 C212 72 308 32 420 32"
                        fill="none"
                        stroke="rgba(0,184,148,.2)"
                        stroke-width="2"
                        class="mig-path"
                        data-base="rgba(0,184,148,.2)"
                        data-hover="rgba(0,184,148,.5)"
                      ></path>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="4"
                      data-from="Competitor Conquest"
                      data-to="Competitor Conquest"
                      data-val="1840"
                      data-dir="stay"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 72 C212 72 308 72 420 72"
                        fill="none"
                        stroke="rgba(150,150,170,.12)"
                        stroke-width="3.942857142857143"
                        class="mig-path"
                        data-base="rgba(150,150,170,.12)"
                        data-hover="rgba(150,150,170,.35)"
                      ></path>
                      <text
                        x="260"
                        y="71"
                        text-anchor="middle"
                        font-size="8"
                        font-weight="700"
                        fill="#9990ab"
                        opacity=".5"
                        class="mig-flow-label"
                      >
                        1,840
                      </text>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="5"
                      data-from="Competitor Conquest"
                      data-to="Ultra-Light Buyers"
                      data-val="835"
                      data-dir="up"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 72 C212 72 308 152 420 152"
                        fill="none"
                        stroke="rgba(0,184,148,.2)"
                        stroke-width="2"
                        class="mig-path"
                        data-base="rgba(0,184,148,.2)"
                        data-hover="rgba(0,184,148,.5)"
                      ></path>
                      <text
                        x="260"
                        y="111"
                        text-anchor="middle"
                        font-size="8"
                        font-weight="700"
                        fill="#00b894"
                        opacity=".5"
                        class="mig-flow-label"
                      >
                        835
                      </text>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="6"
                      data-from="Lapsed &amp; Lapsing"
                      data-to="New-to-Category"
                      data-val="148"
                      data-dir="up"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 112 C212 112 308 32 420 32"
                        fill="none"
                        stroke="rgba(0,184,148,.2)"
                        stroke-width="2"
                        class="mig-path"
                        data-base="rgba(0,184,148,.2)"
                        data-hover="rgba(0,184,148,.5)"
                      ></path>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="7"
                      data-from="Lapsed &amp; Lapsing"
                      data-to="Lapsed &amp; Lapsing"
                      data-val="820"
                      data-dir="stay"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 112 C212 112 308 112 420 112"
                        fill="none"
                        stroke="rgba(150,150,170,.12)"
                        stroke-width="2"
                        class="mig-path"
                        data-base="rgba(150,150,170,.12)"
                        data-hover="rgba(150,150,170,.35)"
                      ></path>
                      <text
                        x="260"
                        y="111"
                        text-anchor="middle"
                        font-size="8"
                        font-weight="700"
                        fill="#9990ab"
                        opacity=".5"
                        class="mig-flow-label"
                      >
                        820
                      </text>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="8"
                      data-from="Lapsed &amp; Lapsing"
                      data-to="Ultra-Light Buyers"
                      data-val="286"
                      data-dir="up"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 112 C212 112 308 152 420 152"
                        fill="none"
                        stroke="rgba(0,184,148,.2)"
                        stroke-width="2"
                        class="mig-path"
                        data-base="rgba(0,184,148,.2)"
                        data-hover="rgba(0,184,148,.5)"
                      ></path>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="9"
                      data-from="Ultra-Light Buyers"
                      data-to="Frequent Buyers"
                      data-val="847"
                      data-dir="up"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 152 C212 152 308 192 420 192"
                        fill="none"
                        stroke="rgba(0,184,148,.2)"
                        stroke-width="2"
                        class="mig-path"
                        data-base="rgba(0,184,148,.2)"
                        data-hover="rgba(0,184,148,.5)"
                      ></path>
                      <text
                        x="260"
                        y="171"
                        text-anchor="middle"
                        font-size="8"
                        font-weight="700"
                        fill="#00b894"
                        opacity=".5"
                        class="mig-flow-label"
                      >
                        847
                      </text>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="10"
                      data-from="Ultra-Light Buyers"
                      data-to="Ultra-Light Buyers"
                      data-val="6100"
                      data-dir="stay"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 152 C212 152 308 152 420 152"
                        fill="none"
                        stroke="rgba(150,150,170,.12)"
                        stroke-width="13.071428571428571"
                        class="mig-path"
                        data-base="rgba(150,150,170,.12)"
                        data-hover="rgba(150,150,170,.35)"
                      ></path>
                      <text
                        x="260"
                        y="151"
                        text-anchor="middle"
                        font-size="8"
                        font-weight="700"
                        fill="#9990ab"
                        opacity=".5"
                        class="mig-flow-label"
                      >
                        6,100
                      </text>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="11"
                      data-from="Ultra-Light Buyers"
                      data-to="Lapsed &amp; Lapsing"
                      data-val="1595"
                      data-dir="down"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 152 C212 152 308 112 420 112"
                        fill="none"
                        stroke="rgba(214,48,49,.15)"
                        stroke-width="3.4178571428571427"
                        class="mig-path"
                        data-base="rgba(214,48,49,.15)"
                        data-hover="rgba(214,48,49,.4)"
                      ></path>
                      <text
                        x="260"
                        y="131"
                        text-anchor="middle"
                        font-size="8"
                        font-weight="700"
                        fill="#d63031"
                        opacity=".5"
                        class="mig-flow-label"
                      >
                        1,595
                      </text>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="12"
                      data-from="Frequent Buyers"
                      data-to="Most Loyal / VIP"
                      data-val="211"
                      data-dir="up"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 192 C212 192 308 232 420 232"
                        fill="none"
                        stroke="rgba(0,184,148,.2)"
                        stroke-width="2"
                        class="mig-path"
                        data-base="rgba(0,184,148,.2)"
                        data-hover="rgba(0,184,148,.5)"
                      ></path>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="13"
                      data-from="Frequent Buyers"
                      data-to="Frequent Buyers"
                      data-val="8400"
                      data-dir="stay"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 192 C212 192 308 192 420 192"
                        fill="none"
                        stroke="rgba(150,150,170,.12)"
                        stroke-width="18"
                        class="mig-path"
                        data-base="rgba(150,150,170,.12)"
                        data-hover="rgba(150,150,170,.35)"
                      ></path>
                      <text
                        x="260"
                        y="191"
                        text-anchor="middle"
                        font-size="8"
                        font-weight="700"
                        fill="#9990ab"
                        opacity=".5"
                        class="mig-flow-label"
                      >
                        8,400
                      </text>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="14"
                      data-from="Frequent Buyers"
                      data-to="Ultra-Light Buyers"
                      data-val="1495"
                      data-dir="down"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 192 C212 192 308 152 420 152"
                        fill="none"
                        stroke="rgba(214,48,49,.15)"
                        stroke-width="3.2035714285714287"
                        class="mig-path"
                        data-base="rgba(214,48,49,.15)"
                        data-hover="rgba(214,48,49,.4)"
                      ></path>
                      <text
                        x="260"
                        y="171"
                        text-anchor="middle"
                        font-size="8"
                        font-weight="700"
                        fill="#d63031"
                        opacity=".5"
                        class="mig-flow-label"
                      >
                        1,495
                      </text>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="15"
                      data-from="Most Loyal / VIP"
                      data-to="Most Loyal / VIP"
                      data-val="1420"
                      data-dir="stay"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 232 C212 232 308 232 420 232"
                        fill="none"
                        stroke="rgba(150,150,170,.12)"
                        stroke-width="3.042857142857143"
                        class="mig-path"
                        data-base="rgba(150,150,170,.12)"
                        data-hover="rgba(150,150,170,.35)"
                      ></path>
                      <text
                        x="260"
                        y="231"
                        text-anchor="middle"
                        font-size="8"
                        font-weight="700"
                        fill="#9990ab"
                        opacity=".5"
                        class="mig-flow-label"
                      >
                        1,420
                      </text>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="16"
                      data-from="Most Loyal / VIP"
                      data-to="Frequent Buyers"
                      data-val="157"
                      data-dir="down"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 232 C212 232 308 192 420 192"
                        fill="none"
                        stroke="rgba(214,48,49,.15)"
                        stroke-width="2"
                        class="mig-path"
                        data-base="rgba(214,48,49,.15)"
                        data-hover="rgba(214,48,49,.4)"
                      ></path>
                    </g>
                    <g
                      class="mig-flow"
                      data-fi="17"
                      data-from="Most Loyal / VIP"
                      data-to="Lapsed &amp; Lapsing"
                      data-val="156"
                      data-dir="down"
                      style="cursor: pointer"
                    >
                      <path
                        d="M100 232 C212 232 308 112 420 112"
                        fill="none"
                        stroke="rgba(214,48,49,.15)"
                        stroke-width="2"
                        class="mig-path"
                        data-base="rgba(214,48,49,.15)"
                        data-hover="rgba(214,48,49,.4)"
                      ></path>
                    </g>
                    <rect
                      x="0"
                      y="18"
                      width="100"
                      height="28"
                      rx="5"
                      fill="#6c5ce7"
                      opacity="0.1"
                    ></rect>
                    <text
                      x="8"
                      y="30"
                      font-size="9"
                      font-weight="700"
                      fill="#6c5ce7"
                    >
                      New-to-Cat
                    </text>
                    <text
                      x="8"
                      y="41"
                      font-size="7.5"
                      fill="#6c5ce7"
                      opacity=".5"
                    >
                      4,328 buyers
                    </text>
                    <rect
                      x="0"
                      y="58"
                      width="100"
                      height="28"
                      rx="5"
                      fill="#e17055"
                      opacity="0.1"
                    ></rect>
                    <text
                      x="8"
                      y="70"
                      font-size="9"
                      font-weight="700"
                      fill="#e17055"
                    >
                      Competitor
                    </text>
                    <text
                      x="8"
                      y="81"
                      font-size="7.5"
                      fill="#e17055"
                      opacity=".5"
                    >
                      2,987 buyers
                    </text>
                    <rect
                      x="0"
                      y="98"
                      width="100"
                      height="28"
                      rx="5"
                      fill="#d63031"
                      opacity="0.1"
                    ></rect>
                    <text
                      x="8"
                      y="110"
                      font-size="9"
                      font-weight="700"
                      fill="#d63031"
                    >
                      Lapsed
                    </text>
                    <text
                      x="8"
                      y="121"
                      font-size="7.5"
                      fill="#d63031"
                      opacity=".5"
                    >
                      1,254 buyers
                    </text>
                    <rect
                      x="0"
                      y="138"
                      width="100"
                      height="28"
                      rx="5"
                      fill="#74b9ff"
                      opacity="0.1"
                    ></rect>
                    <text
                      x="8"
                      y="150"
                      font-size="9"
                      font-weight="700"
                      fill="#74b9ff"
                    >
                      Ultra-Light
                    </text>
                    <text
                      x="8"
                      y="161"
                      font-size="7.5"
                      fill="#74b9ff"
                      opacity=".5"
                    >
                      8,542 buyers
                    </text>
                    <rect
                      x="0"
                      y="178"
                      width="100"
                      height="28"
                      rx="5"
                      fill="#00b894"
                      opacity="0.1"
                    ></rect>
                    <text
                      x="8"
                      y="190"
                      font-size="9"
                      font-weight="700"
                      fill="#00b894"
                    >
                      Frequent
                    </text>
                    <text
                      x="8"
                      y="201"
                      font-size="7.5"
                      fill="#00b894"
                      opacity=".5"
                    >
                      10,106 buyers
                    </text>
                    <rect
                      x="0"
                      y="218"
                      width="100"
                      height="28"
                      rx="5"
                      fill="#fdcb6e"
                      opacity="0.1"
                    ></rect>
                    <text
                      x="8"
                      y="230"
                      font-size="9"
                      font-weight="700"
                      fill="#fdcb6e"
                    >
                      Loyal
                    </text>
                    <text
                      x="8"
                      y="241"
                      font-size="7.5"
                      fill="#fdcb6e"
                      opacity=".5"
                    >
                      1,733 buyers
                    </text>
                    <rect
                      x="420"
                      y="18"
                      width="100"
                      height="28"
                      rx="5"
                      fill="#6c5ce7"
                      opacity="0.1"
                    ></rect>
                    <text
                      x="428"
                      y="30"
                      font-size="9"
                      font-weight="700"
                      fill="#6c5ce7"
                    >
                      New-to-Cat
                    </text>
                    <text
                      x="428"
                      y="41"
                      font-size="7.5"
                      fill="#6c5ce7"
                      opacity=".5"
                    >
                      2,640 buyers
                    </text>
                    <rect
                      x="420"
                      y="58"
                      width="100"
                      height="28"
                      rx="5"
                      fill="#e17055"
                      opacity="0.1"
                    ></rect>
                    <text
                      x="428"
                      y="70"
                      font-size="9"
                      font-weight="700"
                      fill="#e17055"
                    >
                      Competitor
                    </text>
                    <text
                      x="428"
                      y="81"
                      font-size="7.5"
                      fill="#e17055"
                      opacity=".5"
                    >
                      1,840 buyers
                    </text>
                    <rect
                      x="420"
                      y="98"
                      width="100"
                      height="28"
                      rx="5"
                      fill="#d63031"
                      opacity="0.1"
                    ></rect>
                    <text
                      x="428"
                      y="110"
                      font-size="9"
                      font-weight="700"
                      fill="#d63031"
                    >
                      Lapsed
                    </text>
                    <text
                      x="428"
                      y="121"
                      font-size="7.5"
                      fill="#d63031"
                      opacity=".5"
                    >
                      3,515 buyers
                    </text>
                    <rect
                      x="420"
                      y="138"
                      width="100"
                      height="28"
                      rx="5"
                      fill="#74b9ff"
                      opacity="0.1"
                    ></rect>
                    <text
                      x="428"
                      y="150"
                      font-size="9"
                      font-weight="700"
                      fill="#74b9ff"
                    >
                      Ultra-Light
                    </text>
                    <text
                      x="428"
                      y="161"
                      font-size="7.5"
                      fill="#74b9ff"
                      opacity=".5"
                    >
                      9,920 buyers
                    </text>
                    <rect
                      x="420"
                      y="178"
                      width="100"
                      height="28"
                      rx="5"
                      fill="#00b894"
                      opacity="0.1"
                    ></rect>
                    <text
                      x="428"
                      y="190"
                      font-size="9"
                      font-weight="700"
                      fill="#00b894"
                    >
                      Frequent
                    </text>
                    <text
                      x="428"
                      y="201"
                      font-size="7.5"
                      fill="#00b894"
                      opacity=".5"
                    >
                      9,404 buyers
                    </text>
                    <rect
                      x="420"
                      y="218"
                      width="100"
                      height="28"
                      rx="5"
                      fill="#fdcb6e"
                      opacity="0.1"
                    ></rect>
                    <text
                      x="428"
                      y="230"
                      font-size="9"
                      font-weight="700"
                      fill="#fdcb6e"
                    >
                      Loyal
                    </text>
                    <text
                      x="428"
                      y="241"
                      font-size="7.5"
                      fill="#fdcb6e"
                      opacity=".5"
                    >
                      1,631 buyers
                    </text>
                    <text
                      x="50"
                      y="10"
                      text-anchor="middle"
                      font-size="8"
                      font-weight="600"
                      fill="#9990ab"
                      letter-spacing=".5"
                    >
                      3–6 MONTHS AGO
                    </text>
                    <text
                      x="470"
                      y="10"
                      text-anchor="middle"
                      font-size="8"
                      font-weight="600"
                      fill="#9990ab"
                      letter-spacing=".5"
                    >
                      LAST 3 MONTHS
                    </text>
                  </svg>
                  <div
                    id="migTooltip"
                    style="
                      display: none;
                      position: absolute;
                      z-index: 30;
                      background: #fff;
                      border: 1px solid var(--card-border);
                      border-radius: 10px;
                      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
                      padding: 12px 16px;
                      pointer-events: auto;
                      min-width: 220px;
                    "
                  ></div>
                </div>
                <div
                  style="
                    margin-top: 10px;
                    padding: 8px 12px;
                    background: linear-gradient(135deg, #e8faf5, #f0fcf8);
                    border-radius: 8px;
                    border: 1px solid #c8e8d8;
                    font-size: 11px;
                    color: var(--text-secondary);
                    line-height: 1.5;
                  "
                >
                  <strong style="color: var(--teal)"
                    >3,843 buyers moved up</strong
                  >
                  the loyalty ladder,
                  <strong style="color: var(--red)">4,347 moved down</strong>,
                  and <strong>20,760 retained</strong> their cohort. Net
                  migration ratio: <strong>0.9x</strong> positive.
                </div>
                <div
                  style="
                    margin-top: 14px;
                    padding: 14px;
                    background: linear-gradient(135deg, #f8f7ff, #f0eeff);
                    border-radius: 10px;
                    border: 1px solid #e0dced;
                  "
                >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 6px;
                      margin-bottom: 10px;
                    "
                  >
                    <div
                      class="ai-typing"
                      style="
                        animation: none;
                        width: 16px;
                        height: 16px;
                        background: linear-gradient(
                          135deg,
                          var(--purple-accent),
                          #a29bfe
                        );
                        border-radius: 4px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                      "
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="10"
                        height="10"
                        fill="none"
                        stroke="#fff"
                        stroke-width="2"
                      >
                        <path
                          d="M12 2l3 7h7l-5.5 4 2 7L12 16l-6.5 4 2-7L2 9h7z"
                        ></path>
                      </svg>
                    </div>
                    <span
                      style="
                        font-size: 11px;
                        font-weight: 700;
                        color: var(--purple-accent);
                      "
                      >AI Audience Recommendations</span
                    ><span style="font-size: 9px; color: var(--text-tertiary)"
                      >Based on migration patterns</span
                    >
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 8px">
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 10px 12px;
                        background: #fff;
                        border-radius: 8px;
                        border: 1px solid var(--card-border);
                      "
                    >
                      <div style="flex: 1; min-width: 0">
                        <div
                          style="
                            font-size: 11px;
                            font-weight: 700;
                            color: var(--text-primary);
                          "
                        >
                          Revive Lapsed &amp; Lapsing Buyers
                        </div>
                        <div
                          style="
                            font-size: 10px;
                            color: var(--text-secondary);
                            line-height: 1.4;
                            margin-top: 2px;
                          "
                        >
                          <strong style="color: var(--red)">4,347</strong>
                          buyers migrated down the loyalty ladder. Target those
                          who were active Frequent or Loyal buyers and have
                          since lapsed — they already know the brand but need a
                          reason to come back.
                        </div>
                      </div>
                      <button
                        class="btn btn-primary btn-sm"
                        style="
                          white-space: nowrap;
                          flex-shrink: 0;
                          font-size: 9px;
                        "
                        onclick="
                          document.getElementById('audInput').value =
                            'Previously Frequent and Loyal buyers who lapsed or moved down — winback campaign targeting buyers with proven purchase history who have gone dormant in the last 3-6 months';
                          openDrawer('audience');
                          showToast('Seeded: Lapsed Winback audience');
                        "
                      >
                        Build Audience →
                      </button>
                    </div>
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 10px 12px;
                        background: #fff;
                        border-radius: 8px;
                        border: 1px solid var(--card-border);
                      "
                    >
                      <div style="flex: 1; min-width: 0">
                        <div
                          style="
                            font-size: 11px;
                            font-weight: 700;
                            color: var(--text-primary);
                          "
                        >
                          Accelerate New-to-Category → Loyalty
                        </div>
                        <div
                          style="
                            font-size: 10px;
                            color: var(--text-secondary);
                            line-height: 1.4;
                            margin-top: 2px;
                          "
                        >
                          <strong style="color: var(--teal)">1,204</strong>
                          new-to-category buyers progressed to light or frequent
                          status. Double down — seed an audience from these
                          early converts to accelerate them up the loyalty
                          ladder with frequency-driving creative.
                        </div>
                      </div>
                      <button
                        class="btn btn-primary btn-sm"
                        style="
                          white-space: nowrap;
                          flex-shrink: 0;
                          font-size: 9px;
                        "
                        onclick="
                          document.getElementById('audInput').value =
                            'New-to-Category buyers who became Ultra-Light or Frequent — accelerate their purchase frequency with repeat-visit incentives and loyalty-driving messaging';
                          openDrawer('audience');
                          showToast('Seeded: NTC Acceleration audience');
                        "
                      >
                        Build Audience →
                      </button>
                    </div>
                    <div
                      style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 10px 12px;
                        background: #fff;
                        border-radius: 8px;
                        border: 1px solid var(--card-border);
                      "
                    >
                      <div style="flex: 1; min-width: 0">
                        <div
                          style="
                            font-size: 11px;
                            font-weight: 700;
                            color: var(--text-primary);
                          "
                        >
                          Defend Against Competitive Switching
                        </div>
                        <div
                          style="
                            font-size: 10px;
                            color: var(--text-secondary);
                            line-height: 1.4;
                            margin-top: 2px;
                          "
                        >
                          Competitor Conquest buyers who didn't stick are at
                          high risk of switching back. Build a retention
                          audience from conquest buyers who regressed — they
                          tried you once but need reinforcement to stay.
                        </div>
                      </div>
                      <button
                        class="btn btn-primary btn-sm"
                        style="
                          white-space: nowrap;
                          flex-shrink: 0;
                          font-size: 9px;
                        "
                        onclick="
                          document.getElementById('audInput').value =
                            'Competitor Conquest buyers who regressed or lapsed — defensive retention campaign to prevent switch-back with value-reinforcing creative';
                          openDrawer('audience');
                          showToast('Seeded: Conquest Defense audience');
                        "
                      >
                        Build Audience →
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="height: 40px"></div>
      </div>

      <!-- ═══ DRAWER PANELS ═══ -->
      <div
        class="drawer-overlay"
        id="drawerOverlay"
        onclick="closeDrawer()"
      ></div>

      <!-- Attribution Drawer -->
      <div class="drawer" id="drawer-attribution">
        <div class="drawer-header">
          <h2>Sales Attribution &amp; Optimization</h2>
          <button class="drawer-close" onclick="closeDrawer()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="drawer-body">
          <div class="drawer-section">
            <h3>How it works</h3>
            <p>
              Tag your campaigns within a Pubmatic PMP and Attain automatically
              tracks sales performance in real time. No third-party measurement
              vendors. No clean room setup. Just toggle it on.
            </p>
          </div>
          <div class="drawer-section">
            <h3>What you get</h3>
            <p>
              Daily sales attribution dashboard — "Google Analytics for the real
              world." Weekly executive email reports. In-flight optimization
              signals showing which audiences, channels, placements, and
              creatives most efficiently drive ROAS.
            </p>
          </div>
          <div class="drawer-section">
            <h3>Supported platforms</h3>
            <div>
              <span
                class="drawer-tag"
                style="
                  background: var(--purple-bg);
                  color: var(--purple-accent);
                "
                >Pubmatic PMP</span
              ><span
                class="drawer-tag"
                style="background: var(--teal-bg); color: var(--teal)"
                >The Trade Desk</span
              ><span
                class="drawer-tag"
                style="background: var(--coral-bg); color: var(--coral)"
                >DV360</span
              ><span
                class="drawer-tag"
                style="background: var(--amber-bg); color: #e17055"
                >Meta CAPI</span
              >
            </div>
          </div>
          <div class="drawer-section">
            <h3>Cost</h3>
            <p>
              Through the dentsu.Connect Impact Partner Program,
              <strong>Pubmatic may sponsor the data fees entirely</strong> —
              meaning turnkey closed-loop reporting at no incremental cost.
            </p>
          </div>
          <button
            class="btn btn-primary"
            style="width: 100%; justify-content: center; margin-top: 8px"
            onclick="
              showToast('Attribution setup initiated for Burger King');
              closeDrawer();
            "
          >
            Start Attribution Setup →
          </button>
        </div>
      </div>

      <!-- Audience Drawer — Functional AI Builder -->
      <div class="drawer" id="drawer-audience">
        <div class="drawer-header">
          <div>
            <h2>Audience Builder</h2>
            <div
              style="
                font-size: 12px;
                color: var(--text-secondary);
                margin-top: 2px;
              "
            >
              Powered by OutcomeAI • Burger King workspace
            </div>
          </div>
          <button class="drawer-close" onclick="closeDrawer()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="drawer-body" id="audBody">
          <div class="aud-tabs">
            <div class="aud-tab active" onclick="showAudTab('builder', this)">
              AI Builder
            </div>
            <div class="aud-tab" onclick="showAudTab('library', this)">
              Audience Library
            </div>
          </div>
          <div id="audTabBuilder">
            <!-- PHASE 1: Input -->
            <div id="audPhase1">
              <div class="drawer-section">
                <h3 style="margin-bottom: 4px">Describe your audience</h3>
                <p
                  style="
                    font-size: 12.5px;
                    color: var(--text-secondary);
                    margin-bottom: 14px;
                  "
                >
                  Use natural language. Attain translates your brief into a
                  purchase-verified audience built from 10M+ opted-in consumers.
                </p>
                <div id="audNudge"></div>
                <div style="position: relative">
                  <textarea
                    id="audInput"
                    rows="3"
                    placeholder='e.g. "Hispanic moms 25-44 who buy Burger King at least twice a month and also shop at Walmart"'
                    style="
                      width: 100%;
                      border: 1.5px solid var(--card-border);
                      border-radius: 10px;
                      padding: 14px 16px;
                      font-family: var(--font);
                      font-size: 13.5px;
                      resize: none;
                      outline: none;
                      transition: border 0.2s;
                      background: #faf9fd;
                      line-height: 1.5;
                      box-sizing: border-box;
                    "
                    onfocus="this.style.borderColor = 'var(--purple-accent)'"
                    onblur="this.style.borderColor = 'var(--card-border)'"
                  ></textarea>
                  <div style="position: absolute; bottom: 10px; right: 12px">
                    <button
                      class="btn btn-primary btn-sm"
                      onmousedown="event.preventDefault()"
                      onclick="generateAudience()"
                      id="audGenBtn"
                      style="border-radius: 8px"
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="14"
                        height="14"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <polygon
                          points="13 2 3 14 12 14 11 22 21 10 12 10"
                        ></polygon>
                      </svg>
                      Generate
                    </button>
                  </div>
                </div>
              </div>

              <div class="drawer-section">
                <div
                  style="
                    font-size: 11px;
                    font-weight: 600;
                    color: var(--text-tertiary);
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 10px;
                  "
                >
                  Try an example
                </div>
                <div
                  style="display: flex; flex-wrap: wrap; gap: 6px"
                  id="audPills"
                >
                  <button class="aud-pill" onclick="fillPrompt(this)">
                    Competitor QSR buyers who switched away from BK in the last
                    90 days
                  </button>
                  <button class="aud-pill" onclick="fillPrompt(this)">
                    Gen Z males who order delivery via Uber Eats and DoorDash
                    weekly
                  </button>
                  <button class="aud-pill" onclick="fillPrompt(this)">
                    High-income families with kids who buy BK in-store 3x+ per
                    month
                  </button>
                  <button class="aud-pill" onclick="fillPrompt(this)">
                    Lapsed BK customers who now buy at Chick-fil-A or Popeye's
                  </button>
                  <button class="aud-pill" onclick="fillPrompt(this)">
                    Health-conscious women 30-50 who purchase at Sweetgreen and
                    Chipotle
                  </button>
                  <button class="aud-pill" onclick="fillPrompt(this)">
                    Value-seekers who use coupons and buy fast food 4+ times per
                    week
                  </button>
                </div>
              </div>

              <div
                style="
                  border-top: 1px solid var(--card-border);
                  padding-top: 16px;
                  margin-top: 8px;
                "
              >
                <div
                  style="
                    font-size: 11px;
                    font-weight: 600;
                    color: var(--text-tertiary);
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 10px;
                  "
                >
                  Or start from a universal cohort
                </div>
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 6px;
                  "
                >
                  <button class="aud-cohort-btn" onclick="fillPrompt(this)">
                    ✦ New-to-Category Buyers
                  </button>
                  <button class="aud-cohort-btn" onclick="fillPrompt(this)">
                    ⚔ Competitor Buyers
                  </button>
                  <button class="aud-cohort-btn" onclick="fillPrompt(this)">
                    ↺ Lapsed &amp; Lapsing
                  </button>
                  <button class="aud-cohort-btn" onclick="fillPrompt(this)">
                    ◔ Ultra-Light Buyers
                  </button>
                  <button class="aud-cohort-btn" onclick="fillPrompt(this)">
                    ▣ Frequent Buyers
                  </button>
                  <button class="aud-cohort-btn" onclick="fillPrompt(this)">
                    ♥ Most Loyal Buyers
                  </button>
                </div>
              </div>
            </div>

            <!-- PHASE 2: Generating animation -->
            <div id="audPhase2" style="display: none">
              <div style="text-align: center; padding: 60px 20px">
                <div
                  id="audSpinner"
                  style="
                    width: 64px;
                    height: 64px;
                    border-radius: 50%;
                    border: 3px solid var(--card-border);
                    border-top-color: var(--purple-accent);
                    animation: spin 0.8s linear infinite;
                    margin: 0 auto 24px;
                  "
                ></div>
                <div
                  style="
                    font-size: 16px;
                    font-weight: 600;
                    color: var(--text-primary);
                  "
                  id="audGenStatus"
                >
                  Analyzing purchase data...
                </div>
                <div
                  style="
                    font-size: 13px;
                    color: var(--text-secondary);
                    margin-top: 6px;
                  "
                  id="audGenSub"
                >
                  Querying 10M+ consumer profiles
                </div>
                <div
                  style="
                    margin-top: 32px;
                    text-align: left;
                    max-width: 340px;
                    margin-left: auto;
                    margin-right: auto;
                  "
                >
                  <div class="gen-step" id="genStep1" style="opacity: 1">
                    <span class="gen-check">✓</span> Parsing audience definition
                  </div>
                  <div class="gen-step" id="genStep2" style="opacity: 0.3">
                    <span class="gen-check">○</span> Matching purchase behaviors
                  </div>
                  <div class="gen-step" id="genStep3" style="opacity: 0.3">
                    <span class="gen-check">○</span> Applying demographic
                    filters
                  </div>
                  <div class="gen-step" id="genStep4" style="opacity: 0.3">
                    <span class="gen-check">○</span> Estimating addressable
                    reach
                  </div>
                  <div class="gen-step" id="genStep5" style="opacity: 0.3">
                    <span class="gen-check">○</span> Generating audience
                    insights
                  </div>
                </div>
              </div>
            </div>

            <!-- PHASE 3: Results -->
            <div id="audPhase3" style="display: none">
              <!-- Audience card -->
              <div
                id="audResultCard"
                style="
                  border: 2px solid var(--purple-accent);
                  border-radius: 14px;
                  padding: 20px;
                  background: linear-gradient(135deg, #faf9fd 0%, #f0eeff 100%);
                  margin-bottom: 20px;
                "
              >
                <div
                  style="
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 14px;
                  "
                >
                  <div style="display: flex; align-items: center; gap: 10px">
                    <div
                      style="
                        width: 40px;
                        height: 40px;
                        border-radius: 10px;
                        background: var(--purple-accent);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                      "
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="20"
                        height="20"
                        fill="none"
                        stroke="#fff"
                        stroke-width="2"
                      >
                        <path
                          d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                        ></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <line x1="19" y1="8" x2="19" y2="14"></line>
                        <line x1="22" y1="11" x2="16" y2="11"></line>
                      </svg>
                    </div>
                    <div>
                      <div
                        style="font-size: 14px; font-weight: 700"
                        id="audResultName"
                      >
                        Custom Audience
                      </div>
                      <div
                        style="font-size: 11px; color: var(--text-secondary)"
                      >
                        Generated just now • Burger King
                      </div>
                    </div>
                  </div>
                  <span class="badge" style="background: var(--purple-accent)"
                    >READY</span
                  >
                </div>
                <div
                  style="
                    font-size: 12.5px;
                    color: var(--text-secondary);
                    line-height: 1.5;
                    margin-bottom: 16px;
                    padding: 10px 14px;
                    background: rgba(255, 255, 255, 0.7);
                    border-radius: 8px;
                    border: 1px solid var(--card-border);
                  "
                  id="audResultDesc"
                ></div>

                <!-- Reach + KPIs -->
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr 1fr;
                    gap: 10px;
                    margin-bottom: 16px;
                  "
                >
                  <div
                    style="
                      background: #fff;
                      border: 1px solid var(--card-border);
                      border-radius: 8px;
                      padding: 12px;
                      text-align: center;
                    "
                  >
                    <div
                      style="
                        font-size: 9px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        color: var(--text-tertiary);
                      "
                    >
                      Est. Reach
                    </div>
                    <div
                      style="font-size: 22px; font-weight: 700; margin-top: 2px"
                      id="audReach"
                    >
                      —
                    </div>
                  </div>
                  <div
                    style="
                      background: #fff;
                      border: 1px solid var(--card-border);
                      border-radius: 8px;
                      padding: 12px;
                      text-align: center;
                    "
                  >
                    <div
                      style="
                        font-size: 9px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        color: var(--text-tertiary);
                      "
                    >
                      Match Rate
                    </div>
                    <div
                      style="font-size: 22px; font-weight: 700; margin-top: 2px"
                      id="audMatch"
                    >
                      —
                    </div>
                  </div>
                  <div
                    style="
                      background: #fff;
                      border: 1px solid var(--card-border);
                      border-radius: 8px;
                      padding: 12px;
                      text-align: center;
                    "
                  >
                    <div
                      style="
                        font-size: 9px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        color: var(--text-tertiary);
                      "
                    >
                      Panel Seed
                    </div>
                    <div
                      style="font-size: 22px; font-weight: 700; margin-top: 2px"
                      id="audSeed"
                    >
                      —
                    </div>
                  </div>
                </div>

                <!-- Structured spec -->
                <div style="margin-bottom: 16px" id="audSpecWrap"></div>

                <!-- Insights preview -->
                <div
                  style="
                    border-top: 1px solid var(--card-border);
                    padding-top: 14px;
                  "
                >
                  <div
                    style="
                      font-size: 12px;
                      font-weight: 600;
                      margin-bottom: 10px;
                      display: flex;
                      align-items: center;
                      gap: 6px;
                    "
                  >
                    <svg
                      viewBox="0 0 24 24"
                      width="14"
                      height="14"
                      fill="none"
                      stroke="var(--purple-accent)"
                      stroke-width="2"
                    >
                      <polygon
                        points="13 2 3 14 12 14 11 22 21 10 12 10"
                      ></polygon>
                    </svg>
                    Audience Insights
                  </div>
                  <div
                    id="audInsights"
                    style="
                      display: grid;
                      grid-template-columns: 1fr 1fr;
                      gap: 8px;
                    "
                  ></div>
                </div>
              </div>

              <!-- Distribution -->
              <div style="margin-bottom: 20px">
                <div
                  style="font-size: 13px; font-weight: 600; margin-bottom: 10px"
                >
                  Push to activation endpoints
                </div>
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 6px;
                  "
                  id="audEndpoints"
                >
                  <label class="endpoint-opt"
                    ><input type="checkbox" class="endpoint-cb" />
                    <span
                      class="endpoint-icon"
                      style="background: #1877f2"
                    ></span>
                    Meta</label
                  >
                  <label class="endpoint-opt"
                    ><input type="checkbox" class="endpoint-cb" />
                    <span class="endpoint-icon" style="background: #000"></span>
                    TikTok</label
                  >
                  <label class="endpoint-opt"
                    ><input type="checkbox" class="endpoint-cb" />
                    <span
                      class="endpoint-icon"
                      style="background: #4caf50"
                    ></span>
                    The Trade Desk</label
                  >
                  <label class="endpoint-opt"
                    ><input type="checkbox" class="endpoint-cb" />
                    <span
                      class="endpoint-icon"
                      style="background: #4285f4"
                    ></span>
                    DV360</label
                  >
                  <label class="endpoint-opt"
                    ><input type="checkbox" class="endpoint-cb" />
                    <span
                      class="endpoint-icon"
                      style="background: #6c5ce7"
                    ></span>
                    Pubmatic PMP</label
                  >
                  <label class="endpoint-opt"
                    ><input type="checkbox" class="endpoint-cb" />
                    <span
                      class="endpoint-icon"
                      style="background: #e17055"
                    ></span>
                    OpenX</label
                  >
                </div>
              </div>

              <!-- Attribution toggle -->
              <div
                style="
                  background: var(--purple-bg);
                  border: 1px solid #d5d0e8;
                  border-radius: 10px;
                  padding: 14px 16px;
                  margin-bottom: 20px;
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                "
              >
                <div>
                  <div style="font-size: 13px; font-weight: 600">
                    Layer sales attribution on this audience
                  </div>
                  <div
                    style="
                      font-size: 11.5px;
                      color: var(--text-secondary);
                      margin-top: 2px;
                    "
                  >
                    Track closed-loop ROAS in real time once activated
                  </div>
                </div>
                <label class="toggle-switch"
                  ><input type="checkbox" checked="" /><span
                    class="toggle-slider"
                  ></span
                ></label>
              </div>

              <!-- Actions -->
              <div style="display: flex; gap: 8px">
                <button
                  class="btn btn-teal"
                  style="flex: 1; justify-content: center"
                  onclick="publishAudience()"
                >
                  <svg
                    viewBox="0 0 24 24"
                    width="16"
                    height="16"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M22 2L11 13"></path>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                  </svg>
                  Publish Audience
                </button>
                <button class="btn btn-outline" onclick="resetAudience()">
                  Start Over
                </button>
              </div>
            </div>
          </div>
          <!-- close audTabBuilder -->

          <div id="audTabLibrary" style="display: none">
            <p
              style="
                font-size: 12.5px;
                color: var(--text-secondary);
                margin-bottom: 14px;
              "
            >
              Pre-built segments from Attain's audience library aligned to your
              Burger King workspace.
            </p>
            <div id="libCards"></div>
          </div>
        </div>
      </div>
      <div class="drawer" id="drawer-measurement" style="max-width: 560px">
        <div class="drawer-header">
          <h2>New Measurement Study</h2>
          <button class="drawer-close" onclick="closeDrawer()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="drawer-body" style="padding-bottom: 100px">
          <!-- Progress Steps -->
          <div
            style="display: flex; gap: 0; margin-bottom: 20px"
            id="intakeSteps"
          >
            <div class="intake-step active" data-step="1">
              <span class="intake-step-num">1</span> Study Type
            </div>
            <div class="intake-step" data-step="2">
              <span class="intake-step-num">2</span> Campaign Info
            </div>
            <div class="intake-step" data-step="3">
              <span class="intake-step-num">3</span> Parameters
            </div>
            <div class="intake-step" data-step="4">
              <span class="intake-step-num">4</span> Goals
            </div>
          </div>

          <!-- STEP 1: Study Type -->
          <div class="intake-page" id="intakePage1">
            <div style="margin-bottom: 16px">
              <div
                style="font-size: 15px; font-weight: 700; margin-bottom: 4px"
              >
                What would you like to measure?
              </div>
              <div
                style="
                  font-size: 11.5px;
                  color: var(--text-secondary);
                  line-height: 1.4;
                "
              >
                Select the study type that best aligns with your campaign goals.
                Studies can be combined.
              </div>
            </div>
            <div
              style="display: flex; flex-direction: column; gap: 8px"
              id="studyTypeCards"
            >
              <label
                class="intake-study-card"
                onclick="selectStudyType(this, 'sales_lift')"
              >
                <input
                  type="radio"
                  name="studyType"
                  value="sales_lift"
                  style="display: none"
                />
                <div
                  class="intake-study-icon"
                  style="background: var(--teal-bg); color: var(--teal)"
                >
                  📊
                </div>
                <div class="intake-study-info">
                  <div class="intake-study-name">Sales Lift</div>
                  <div class="intake-study-desc">
                    Measure incremental sales driven by media. Control vs
                    exposed methodology proves true lift on verified purchase
                    data.
                  </div>
                </div>
                <div class="intake-study-check"></div>
              </label>
              <label
                class="intake-study-card"
                onclick="selectStudyType(this, 'brand_lift')"
              >
                <input
                  type="radio"
                  name="studyType"
                  value="brand_lift"
                  style="display: none"
                />
                <div
                  class="intake-study-icon"
                  style="background: #fff3e0; color: #e17055"
                >
                  💡
                </div>
                <div class="intake-study-info">
                  <div class="intake-study-name">Brand Lift</div>
                  <div class="intake-study-desc">
                    Survey-based measurement of awareness, consideration, and
                    intent shift among exposed audiences vs control.
                  </div>
                </div>
                <div class="intake-study-check"></div>
              </label>
              <label
                class="intake-study-card"
                onclick="selectStudyType(this, 'brand_sales')"
              >
                <input
                  type="radio"
                  name="studyType"
                  value="brand_sales"
                  style="display: none"
                />
                <div
                  class="intake-study-icon"
                  style="
                    background: var(--purple-bg);
                    color: var(--purple-accent);
                  "
                >
                  🔗
                </div>
                <div class="intake-study-info">
                  <div class="intake-study-name">
                    Brand Lift &amp; Sales Impact
                    <span
                      style="
                        font-size: 8px;
                        font-weight: 700;
                        background: var(--purple-bg);
                        color: var(--purple-accent);
                        padding: 2px 5px;
                        border-radius: 3px;
                        margin-left: 4px;
                      "
                      >FULL-FUNNEL</span
                    >
                  </div>
                  <div class="intake-study-desc">
                    Connect upper-funnel brand perception shifts to lower-funnel
                    purchase outcomes. The complete story from awareness to
                    transaction.
                  </div>
                </div>
                <div class="intake-study-check"></div>
              </label>
              <label
                class="intake-study-card"
                onclick="selectStudyType(this, 'visit_sales')"
              >
                <input
                  type="radio"
                  name="studyType"
                  value="visit_sales"
                  style="display: none"
                />
                <div
                  class="intake-study-icon"
                  style="background: var(--teal-bg); color: var(--teal)"
                >
                  📍
                </div>
                <div class="intake-study-info">
                  <div class="intake-study-name">
                    Visitation &amp; Sales Impact
                  </div>
                  <div class="intake-study-desc">
                    Foot traffic attribution + sales lift. Measure store
                    visitation driven by media alongside verified purchase
                    conversion.
                  </div>
                </div>
                <div class="intake-study-check"></div>
              </label>
              <label
                class="intake-study-card"
                onclick="selectStudyType(this, 'brand_visit_sales')"
              >
                <input
                  type="radio"
                  name="studyType"
                  value="brand_visit_sales"
                  style="display: none"
                />
                <div
                  class="intake-study-icon"
                  style="background: var(--coral-bg); color: var(--coral)"
                >
                  🏆
                </div>
                <div class="intake-study-info">
                  <div class="intake-study-name">
                    Brand Lift &amp; Visitation &amp; Sales Impact
                  </div>
                  <div class="intake-study-desc">
                    The most comprehensive study: brand perception + foot
                    traffic + purchase outcomes. End-to-end marketing
                    effectiveness.
                  </div>
                </div>
                <div class="intake-study-check"></div>
              </label>
            </div>
          </div>

          <!-- STEP 2: Campaign Info -->
          <div class="intake-page" id="intakePage2" style="display: none">
            <div style="font-size: 15px; font-weight: 700; margin-bottom: 14px">
              Campaign &amp; Contact Details
            </div>
            <div class="intake-group">
              <div class="intake-label">Advertiser / Account Name</div>
              <input
                class="intake-input"
                id="intakeAdvertiser"
                placeholder="e.g. Burger King"
                value="Burger King"
              />
            </div>
            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
            >
              <div class="intake-group">
                <div class="intake-label">Agency Name</div>
                <input
                  class="intake-input"
                  id="intakeAgency"
                  placeholder="e.g. MediaCom"
                />
              </div>
              <div class="intake-group">
                <div class="intake-label">Main Contact Email</div>
                <input
                  class="intake-input"
                  id="intakeEmail"
                  type="email"
                  placeholder="name@agency.com"
                />
              </div>
            </div>
            <div class="intake-divider"></div>
            <div class="intake-group">
              <div class="intake-label">Campaign Name</div>
              <input
                class="intake-input"
                id="intakeCampName"
                placeholder="e.g. Q2 Whopper Value Awareness Push"
              />
            </div>
            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
            >
              <div class="intake-group">
                <div class="intake-label">Campaign Start Date</div>
                <input class="intake-input" id="intakeStart" type="date" />
              </div>
              <div class="intake-group">
                <div class="intake-label">Campaign End Date</div>
                <input class="intake-input" id="intakeEnd" type="date" />
              </div>
            </div>
            <div class="intake-group">
              <div class="intake-label">Campaign Objective</div>
              <textarea
                class="intake-input"
                id="intakeObjective"
                rows="2"
                placeholder="What is the overarching goal? e.g. Drive 50K incremental purchases of the new Whopper Melt in Q2"
                style="resize: vertical"
              ></textarea>
            </div>
            <div class="intake-group">
              <div class="intake-label">KPIs &amp; Benchmarks</div>
              <textarea
                class="intake-input"
                id="intakeKpis"
                rows="2"
                placeholder="What metrics will measure progress? e.g. iROAS &gt; 3.0x, CPA under $15, 10% incremental sales lift"
                style="resize: vertical"
              ></textarea>
            </div>
            <div class="intake-group">
              <div class="intake-label">Audience Targeting Strategy</div>
              <textarea
                class="intake-input"
                id="intakeAudience"
                rows="2"
                placeholder="Who are you targeting and how? e.g. QSR Competitive Conquesting via CTV + Display, Gen Z/Millennials"
                style="resize: vertical"
              ></textarea>
            </div>
            <div class="intake-group">
              <div class="intake-label">Creative Call to Action</div>
              <input
                class="intake-input"
                id="intakeCta"
                placeholder="e.g. Order Now on the BK App — $5 Meal Deal"
              />
            </div>
            <div class="intake-divider"></div>
            <div class="intake-group">
              <div class="intake-label">
                Upload Media Plan
                <span style="font-weight: 500; color: var(--text-tertiary)"
                  >(optional)</span
                >
              </div>
              <div
                class="intake-dropzone"
                id="intakeDropzone"
                onclick="document.getElementById('intakeFileInput').click()"
              >
                <input
                  type="file"
                  id="intakeFileInput"
                  accept=".xlsx,.xls,.csv,.pdf,.pptx,.docx"
                  style="display: none"
                  onchange="handleIntakeFile(this)"
                />
                <div id="intakeDropContent">
                  <svg
                    viewBox="0 0 24 24"
                    width="28"
                    height="28"
                    fill="none"
                    stroke="var(--text-tertiary)"
                    stroke-width="1.5"
                    style="margin-bottom: 6px"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                  <div
                    style="
                      font-size: 12px;
                      font-weight: 600;
                      color: var(--text-primary);
                      margin-bottom: 2px;
                    "
                  >
                    Drop your media plan here or click to browse
                  </div>
                  <div style="font-size: 10px; color: var(--text-tertiary)">
                    Accepts .xlsx, .csv, .pdf, .pptx, .docx
                  </div>
                </div>
                <div id="intakeFileAttached" style="display: none">
                  <div style="display: flex; align-items: center; gap: 10px">
                    <div
                      style="
                        width: 36px;
                        height: 36px;
                        border-radius: 8px;
                        background: var(--teal-bg);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                      "
                    >
                      <svg
                        viewBox="0 0 24 24"
                        width="18"
                        height="18"
                        fill="none"
                        stroke="var(--teal)"
                        stroke-width="2"
                      >
                        <path
                          d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                        ></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                      </svg>
                    </div>
                    <div style="flex: 1; min-width: 0">
                      <div
                        style="
                          font-size: 12px;
                          font-weight: 600;
                          color: var(--text-primary);
                          overflow: hidden;
                          text-overflow: ellipsis;
                          white-space: nowrap;
                        "
                        id="intakeFileName"
                      ></div>
                      <div
                        style="
                          font-size: 10px;
                          color: var(--teal);
                          font-weight: 600;
                        "
                      >
                        Attached ✓
                      </div>
                    </div>
                    <button
                      style="
                        background: none;
                        border: none;
                        color: var(--text-tertiary);
                        cursor: pointer;
                        padding: 4px;
                        font-size: 14px;
                      "
                      onclick="
                        event.stopPropagation();
                        removeIntakeFile();
                      "
                      title="Remove"
                    >
                      ✕
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- STEP 3: Parameters -->
          <div class="intake-page" id="intakePage3" style="display: none">
            <div style="font-size: 15px; font-weight: 700; margin-bottom: 14px">
              Measurement Parameters
            </div>
            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
            >
              <div class="intake-group">
                <div class="intake-label">Measurable Impressions</div>
                <input
                  class="intake-input"
                  id="intakeImpressions"
                  placeholder="e.g. 25,000,000"
                />
              </div>
              <div class="intake-group">
                <div class="intake-label">Total Measurement Spend</div>
                <input
                  class="intake-input"
                  id="intakeSpend"
                  placeholder="e.g. $250,000"
                />
              </div>
            </div>
            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
            >
              <div class="intake-group">
                <div class="intake-label">Attribution Window</div>
                <select class="intake-input" id="intakeAttrWindow">
                  <option value="">Select...</option>
                  <option value="7">7 days</option>
                  <option value="14" selected="">14 days</option>
                  <option value="30">30 days</option>
                  <option value="60">60 days</option>
                </select>
              </div>
              <div class="intake-group">
                <div class="intake-label">Net New Buyer Window</div>
                <select class="intake-input" id="intakeNnbWindow">
                  <option value="">Select...</option>
                  <option value="12">12 months</option>
                  <option value="24" selected="">24 months</option>
                  <option value="36">36 months</option>
                </select>
              </div>
            </div>
            <div class="intake-divider"></div>
            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
            >
              <div class="intake-group">
                <div class="intake-label">In-Flight Reporting Frequency</div>
                <select class="intake-input" id="intakeFrequency">
                  <option value="weekly" selected="">Weekly</option>
                  <option value="biweekly">Bi-Weekly</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
              <div class="intake-group">
                <div class="intake-label">Reporting Recipients</div>
                <input
                  class="intake-input"
                  id="intakeRecipients"
                  placeholder="Emails separated by commas"
                />
              </div>
            </div>
            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px"
            >
              <div class="intake-group">
                <div class="intake-label">Mid-Campaign Check-in</div>
                <input class="intake-input" id="intakeMidDate" type="date" />
                <div
                  style="
                    font-size: 9px;
                    color: var(--text-tertiary);
                    margin-top: 3px;
                  "
                >
                  Schedule ahead — you can always shift
                </div>
              </div>
              <div class="intake-group">
                <div class="intake-label">Wrap Report Meeting</div>
                <input class="intake-input" id="intakeWrapDate" type="date" />
                <div
                  style="
                    font-size: 9px;
                    color: var(--text-tertiary);
                    margin-top: 3px;
                  "
                >
                  Schedule ahead — you can always shift
                </div>
              </div>
            </div>
            <div class="intake-divider"></div>
            <div class="intake-label" style="margin-bottom: 8px">
              Include Incrementality Analysis?
            </div>
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <label
                class="intake-toggle-pill active"
                onclick="toggleIntakePill(this)"
                ><input
                  type="radio"
                  name="incr"
                  value="yes"
                  checked=""
                  style="display: none"
                />
                Yes — include</label
              >
              <label class="intake-toggle-pill" onclick="toggleIntakePill(this)"
                ><input
                  type="radio"
                  name="incr"
                  value="no"
                  style="display: none"
                />
                No</label
              >
            </div>
            <div
              style="
                font-size: 9px;
                color: var(--text-tertiary);
                margin-bottom: 12px;
              "
            >
              Requires minimum 20M measurable impressions for statistical
              significance
            </div>
            <div class="intake-group">
              <div class="intake-label">
                Reporting Breakouts for Optimization Tab
              </div>
              <div style="display: flex; flex-wrap: wrap; gap: 6px">
                <label class="intake-chip active"
                  ><input type="checkbox" checked="" style="display: none" />
                  Channel</label
                >
                <label class="intake-chip active"
                  ><input type="checkbox" checked="" style="display: none" />
                  Creative</label
                >
                <label class="intake-chip active"
                  ><input type="checkbox" checked="" style="display: none" />
                  Publisher</label
                >
                <label class="intake-chip"
                  ><input type="checkbox" style="display: none" /> Format
                  Size</label
                >
                <label class="intake-chip"
                  ><input type="checkbox" style="display: none" /> Device
                  Type</label
                >
                <label class="intake-chip"
                  ><input type="checkbox" style="display: none" /> DMA /
                  Geo</label
                >
                <label class="intake-chip"
                  ><input type="checkbox" style="display: none" />
                  Daypart</label
                >
                <label class="intake-chip"
                  ><input type="checkbox" style="display: none" />
                  Frequency</label
                >
              </div>
            </div>
          </div>

          <!-- STEP 4: Goals & Learning Agenda -->
          <div class="intake-page" id="intakePage4" style="display: none">
            <div style="font-size: 15px; font-weight: 700; margin-bottom: 4px">
              Defining Measurement Success
            </div>
            <div
              style="
                font-size: 11.5px;
                color: var(--text-secondary);
                line-height: 1.4;
                margin-bottom: 16px;
              "
            >
              These answers shape every report, weekly update, and wrap story we
              build for you. The more context you share, the more we connect raw
              data to what actually matters for your business.
            </div>
            <div class="intake-group">
              <div class="intake-label">
                What does successful measurement look like for this campaign?
              </div>
              <textarea
                class="intake-input"
                id="intakeSuccess"
                rows="3"
                placeholder="e.g. Prove that CTV drives incremental store visits at a lower CPA than linear. Demonstrate that our conquest targeting is converting McDonald's buyers at a rate that justifies the premium CPM."
                style="resize: vertical"
              ></textarea>
            </div>
            <div class="intake-group">
              <div class="intake-label">
                What questions are you aiming to answer by the end?
              </div>
              <textarea
                class="intake-input"
                id="intakeQuestions"
                rows="3"
                placeholder="e.g. Does upper-funnel CTV drive measurable lower-funnel purchase lift? Which creative message resonates with net-new buyers? Is our Gen Z targeting actually converting?"
                style="resize: vertical"
              ></textarea>
            </div>
            <div class="intake-divider"></div>
            <div class="intake-group">
              <div class="intake-label">Next Major Campaign</div>
              <textarea
                class="intake-input"
                id="intakeNextCamp"
                rows="2"
                placeholder="What's coming next? We use learnings from this study to build best practices for your next flight."
                style="resize: vertical"
              ></textarea>
            </div>
            <div class="intake-group">
              <div class="intake-label">Long-Term Learning Agenda</div>
              <textarea
                class="intake-input"
                id="intakeLongTerm"
                rows="3"
                placeholder="Beyond this campaign, what are you trying to prove or understand about your media investment? What has to be true for your team to invest in measurement long-term?"
                style="resize: vertical"
              ></textarea>
            </div>
            <div
              style="
                margin-top: 16px;
                padding: 14px;
                background: linear-gradient(135deg, #f0eeff, #faf9fd);
                border-radius: 10px;
                border: 1px solid #e0dced;
              "
            >
              <div
                style="
                  font-size: 12px;
                  font-weight: 700;
                  color: var(--purple-accent);
                  margin-bottom: 6px;
                "
              >
                📋 What happens next
              </div>
              <div
                style="
                  font-size: 11.5px;
                  color: var(--text-secondary);
                  line-height: 1.5;
                "
              >
                Your study will be scoped and confirmed within 1 business day.
                We'll send tag specs for your DSP, schedule the mid-campaign
                check-in, and begin delivering weekly reports aligned to the
                goals you've outlined above — starting within 7 days of campaign
                launch.
              </div>
            </div>
          </div>

          <!-- Sticky footer nav -->
          <div
            style="
              position: sticky;
              bottom: 0;
              left: 0;
              right: 0;
              padding: 12px 24px;
              background: #fff;
              border-top: 1px solid var(--card-border);
              display: flex;
              justify-content: space-between;
              align-items: center;
              z-index: 10;
              box-sizing: border-box;
              margin: 0 -24px;
              width: calc(100% + 48px);
            "
            id="intakeNav"
          >
            <button
              class="btn btn-outline btn-sm"
              id="intakePrev"
              onclick="intakeStep(-1)"
              style="visibility: hidden"
            >
              ← Back
            </button>
            <div
              style="font-size: 10px; color: var(--text-tertiary)"
              id="intakeStepLabel"
            >
              Step 1 of 4
            </div>
            <button
              class="btn btn-primary btn-sm"
              id="intakeNext"
              onclick="intakeStep(1)"
            >
              Continue →
            </button>
          </div>
        </div>
      </div>

      <!-- Insights Drawer -->
      <div class="drawer" id="drawer-insights">
        <div class="drawer-header">
          <h2>Premium Insights Suite</h2>
          <button class="drawer-close" onclick="closeDrawer()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="drawer-body">
          <div class="drawer-section">
            <h3>Profile any brand's customers instantly</h3>
            <p>
              Demographics, psychographics, purchase behavior, switching
              patterns, cross-shopping, share of wallet, propensity scoring, and
              CLV — across 10,000+ merchants, retailers, and brands down to the
              item level. No surveys. No clean rooms. Always on.
            </p>
          </div>
          <div class="drawer-section">
            <h3>What's included</h3>
            <p>
              <strong>Demographics &amp; Index Scoring</strong> — Age, income,
              education, geography, household size with index scores vs category
              baseline.<br />
              <strong>Psychographics</strong> — Amazon Prime, media consumption,
              payment preferences, lifestyle markers.<br />
              <strong>Switching Breakdown</strong> — See exactly which
              competitors your customers are switching from or defecting to.<br />
              <strong>Cross-Purchase &amp; Basket Association</strong> — Venn
              diagrams of buyer overlap. Top brands in the same cart.<br />
              <strong>Share of Wallet Over Time</strong> — Quarterly trend vs
              competitive set. Track share shifts.<br />
              <strong>Propensity &amp; CLV</strong> — Predict future buyers at
              30/60/90 day windows. Score lifetime value.<br />
              <strong>Category Shopping Affinities</strong> — What else your
              buyers spend on, ranked by index.
            </p>
          </div>
          <div class="drawer-section">
            <h3>Use cases</h3>
            <p>
              New business pitches and RFP research. Annual planning and
              category reviews. Competitive intelligence. Audience strategy
              development. Client QBR enrichment. Franchisee reporting.
            </p>
          </div>
          <button
            class="btn btn-primary"
            style="width: 100%; justify-content: center; margin-top: 8px"
            onclick="
              showToast(
                'Premium Insights Suite access requested — our team will reach out within 24 hours',
              );
              closeDrawer();
            "
          >
            Request Access →
          </button>
        </div>
      </div>

      <!-- AI Summary Drawer -->
      <div class="drawer" id="drawer-ai">
        <div class="drawer-header">
          <div>
            <h2 style="display: flex; align-items: center; gap: 8px">
              <svg
                viewBox="0 0 24 24"
                width="20"
                height="20"
                fill="none"
                stroke="var(--purple-accent)"
                stroke-width="2"
              >
                <polygon
                  points="13 2 3 14 12 14 11 22 21 10 12 10"
                ></polygon></svg
              >AI Summary
            </h2>
            <div
              style="
                font-size: 12px;
                color: var(--text-secondary);
                margin-top: 2px;
              "
            >
              OutcomeAI — Burger King workspace
            </div>
          </div>
          <button class="drawer-close" onclick="closeDrawer()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="drawer-body" id="aiBody"></div>
      </div>

      <!-- Reports Shelf -->
      <div class="reports-shelf" id="reportsShelf">
        <div class="reports-header">
          <div style="display: flex; align-items: center; gap: 10px">
            <svg
              viewBox="0 0 24 24"
              width="20"
              height="20"
              fill="none"
              stroke="var(--purple-accent)"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <div>
              <div style="font-size: 15px; font-weight: 700">
                Reports &amp; Exports
              </div>
              <div style="font-size: 11px; color: var(--text-secondary)">
                Queued and scheduled reports for Burger King
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 8px">
            <button
              class="btn btn-primary btn-sm"
              onclick="showToast('New report wizard coming soon')"
            >
              + New Report</button
            ><button class="btn btn-outline btn-sm" onclick="toggleReports()">
              Close
            </button>
          </div>
        </div>
        <div class="report-item">
          <div style="display: flex; align-items: center; gap: 14px">
            <div class="report-icon" style="background: var(--purple-bg)">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="var(--purple-accent)"
                stroke-width="2"
              >
                <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
              </svg>
            </div>
            <div>
              <div style="font-size: 13px; font-weight: 600">
                Weekly Cohort Performance
              </div>
              <div style="font-size: 11px; color: var(--text-secondary)">
                Every Monday 8am • PDF + CSV • Last sent Feb 10
              </div>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 8px">
            <span
              class="report-badge"
              style="background: var(--teal-bg); color: var(--teal)"
              >Active</span
            ><button
              class="btn btn-outline btn-sm"
              onclick="showToast('Downloading latest report...')"
            >
              Download
            </button>
          </div>
        </div>
        <div class="report-item">
          <div style="display: flex; align-items: center; gap: 14px">
            <div class="report-icon" style="background: var(--coral-bg)">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="var(--coral)"
                stroke-width="2"
              >
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
              </svg>
            </div>
            <div>
              <div style="font-size: 13px; font-weight: 600">
                Attribution Summary — Q1 2025
              </div>
              <div style="font-size: 11px; color: var(--text-secondary)">
                One-time • Excel • Requested Feb 12
              </div>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 8px">
            <span
              class="report-badge"
              style="background: var(--amber-bg); color: #e17055"
              >Processing</span
            >
            <div style="font-size: 11px; color: var(--text-secondary)">
              ~2 min
            </div>
          </div>
        </div>
        <div class="report-item">
          <div style="display: flex; align-items: center; gap: 14px">
            <div class="report-icon" style="background: var(--teal-bg)">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="var(--teal)"
                stroke-width="2"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
              </svg>
            </div>
            <div>
              <div style="font-size: 13px; font-weight: 600">
                Audience Delivery Confirmation
              </div>
              <div style="font-size: 11px; color: var(--text-secondary)">
                On activation • Email + PDF • Last sent Feb 8
              </div>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 8px">
            <span
              class="report-badge"
              style="background: var(--teal-bg); color: var(--teal)"
              >Active</span
            ><button
              class="btn btn-outline btn-sm"
              onclick="showToast('Downloading latest report...')"
            >
              Download
            </button>
          </div>
        </div>
        <div class="report-item">
          <div style="display: flex; align-items: center; gap: 14px">
            <div class="report-icon" style="background: var(--purple-bg)">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="var(--purple-accent)"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
              </svg>
            </div>
            <div>
              <div style="font-size: 13px; font-weight: 600">
                Competitive Share of Wallet — Monthly
              </div>
              <div style="font-size: 11px; color: var(--text-secondary)">
                1st of month • PowerPoint • Last sent Feb 1
              </div>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 8px">
            <span
              class="report-badge"
              style="background: var(--teal-bg); color: var(--teal)"
              >Active</span
            ><button
              class="btn btn-outline btn-sm"
              onclick="showToast('Downloading latest report...')"
            >
              Download
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- end accountView -->

    <!-- Toast -->
    <div class="toast" id="toast">
      <svg
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline></svg
      ><span id="toastMsg"></span>
    </div>

    <script>
      function escapeHtml(v) {
        return String(v)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }
      // Toast
      function showToast(msg) {
        const t = document.getElementById("toast");
        document.getElementById("toastMsg").textContent = msg;
        t.classList.add("show");
        setTimeout(() => t.classList.remove("show"), 2800);
      }

      // Drawers
      function openDrawer(type) {
        document.getElementById("drawerOverlay").classList.add("open");
        document.getElementById("drawer-" + type).classList.add("open");
        if (type === "audience") resetAudience();
        if (type === "ai") runAISummary();
      }
      function closeDrawer() {
        document.getElementById("drawerOverlay").classList.remove("open");
        document
          .querySelectorAll(".drawer")
          .forEach((d) => d.classList.remove("open"));
      }

      // Tag campaign button
      function tagCampaign(btn) {
        btn.outerHTML =
          '<span class="tagged"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Tagged</span>';
        showToast(
          "Campaign tagged — sales attribution is now tracking in real time",
        );
      }

      // Cohort grid
      const cohorts = [
        {
          icon: "star",
          color: "#6c5ce7",
          bg: "#f0eeff",
          name: "New-to-Category",
          desc: "First BK purchase in last 30d",
          count: "4,328",
          delta: "+14.4%",
          up: true,
          freq: "1.2x",
          spend: "$14.80",
          proj: "4,328",
          goal: "<strong>Goal:</strong> Drive household penetration",
          cvr: "1.8%",
          cpa: "$14.20",
          roas: "$8",
          sales: "$38.1K",
          _cvr: 1.8,
          _cpa: 14.2,
          _roas: 8,
          _sales: 38.1,
          _proj: 4328,
          _buyers: 4328,
          d_proj: "+14.4%",
          d_cvr: "+0.3%",
          d_cpa: "-$1.40",
          d_roas: "+$1.2",
          d_sales: "+$4.8K",
          up_proj: true,
          up_cvr: true,
          up_cpa: true,
          up_roas: true,
          up_sales: true,
          iSales: "$64.2K",
          iPctSales: "9.8%",
          iTxns: "4,328",
          iAov: "$14.80",
          iTotalSpend: "$18.04",
          iFreq: "1.2x",
          iRepeat: "12.1%",
          d_iSales: "+$7.8K",
          d_iTxns: "+548",
          d_iAov: "+$0.60",
          d_iFreq: "+0.1x",
          d_iRepeat: "+1.4%",
          up_iSales: true,
          up_iTxns: true,
          up_iAov: true,
          up_iFreq: true,
          up_iRepeat: true,
        },
        {
          icon: "conquest",
          color: "#e17055",
          bg: "#fff0ed",
          name: "Competitor Conquest",
          desc: "Active McD, Wendy's, Popeye's",
          count: "2,987",
          delta: "+11.5%",
          up: true,
          freq: "2.8x",
          spend: "$18.40",
          proj: "2,987",
          goal: "<strong>Goal:</strong> Conquest competitive share",
          cvr: "2.4%",
          cpa: "$9.80",
          roas: "$12",
          sales: "$51.8K",
          _cvr: 2.4,
          _cpa: 9.8,
          _roas: 12,
          _sales: 51.8,
          _proj: 2987,
          _buyers: 2987,
          d_proj: "+11.5%",
          d_cvr: "+0.6%",
          d_cpa: "-$0.90",
          d_roas: "+$2.1",
          d_sales: "+$6.2K",
          up_proj: true,
          up_cvr: true,
          up_cpa: true,
          up_roas: true,
          up_sales: true,
          iSales: "$155.0K",
          iPctSales: "23.7%",
          iTxns: "8,424",
          iAov: "$18.40",
          iTotalSpend: "$51.52",
          iFreq: "2.8x",
          iRepeat: "64.2%",
          d_iSales: "+$14.1K",
          d_iTxns: "+872",
          d_iAov: "+$0.90",
          d_iFreq: "+0.2x",
          d_iRepeat: "+2.1%",
          up_iSales: true,
          up_iTxns: true,
          up_iAov: true,
          up_iFreq: true,
          up_iRepeat: true,
        },
        {
          icon: "refresh",
          color: "#d63031",
          bg: "#ffeaea",
          name: "Lapsed & Lapsing",
          desc: "No BK purchase in 90+ days",
          count: "1,254",
          delta: "-3.2%",
          up: false,
          freq: "0.4x",
          spend: "$11.20",
          proj: "1,254",
          goal: "<strong>Goal:</strong> Win back before defection",
          cvr: "0.9%",
          cpa: "$18.50",
          roas: "$5",
          sales: "$10.9K",
          _cvr: 0.9,
          _cpa: 18.5,
          _roas: 5,
          _sales: 10.9,
          _proj: 1254,
          _buyers: 1254,
          d_proj: "-3.2%",
          d_cvr: "-0.2%",
          d_cpa: "+$2.10",
          d_roas: "-$0.8",
          d_sales: "-$1.1K",
          up_proj: false,
          up_cvr: false,
          up_cpa: false,
          up_roas: false,
          up_sales: false,
          iSales: "$5.6K",
          iPctSales: "0.9%",
          iTxns: "502",
          iAov: "$11.20",
          iTotalSpend: "$4.48",
          iFreq: "0.4x",
          iRepeat: "8.4%",
          d_iSales: "-$0.9K",
          d_iTxns: "-42",
          d_iAov: "-$0.40",
          d_iFreq: "-0.1x",
          d_iRepeat: "-1.2%",
          up_iSales: false,
          up_iTxns: false,
          up_iAov: false,
          up_iFreq: false,
          up_iRepeat: false,
        },
        {
          icon: "clock",
          color: "#74b9ff",
          bg: "#e8f4ff",
          name: "Ultra-Light Buyers",
          desc: "1-2 purchases / 90 days",
          count: "8,542",
          delta: "+9.8%",
          up: true,
          freq: "1.6x",
          spend: "$16.10",
          proj: "8,542",
          goal: "<strong>Goal:</strong> Increase freq. & basket",
          cvr: "1.4%",
          cpa: "$11.60",
          roas: "$9",
          sales: "$62.4K",
          _cvr: 1.4,
          _cpa: 11.6,
          _roas: 9,
          _sales: 62.4,
          _proj: 8542,
          _buyers: 8542,
          d_proj: "+9.8%",
          d_cvr: "+0.2%",
          d_cpa: "-$0.80",
          d_roas: "+$1.5",
          d_sales: "+$5.1K",
          up_proj: true,
          up_cvr: true,
          up_cpa: true,
          up_roas: true,
          up_sales: true,
          iSales: "$219.8K",
          iPctSales: "33.6%",
          iTxns: "13,667",
          iAov: "$16.10",
          iTotalSpend: "$25.76",
          iFreq: "1.6x",
          iRepeat: "52.8%",
          d_iSales: "+$18.4K",
          d_iTxns: "+1,204",
          d_iAov: "+$0.50",
          d_iFreq: "+0.1x",
          d_iRepeat: "+1.8%",
          up_iSales: true,
          up_iTxns: true,
          up_iAov: true,
          up_iFreq: true,
          up_iRepeat: true,
        },
        {
          icon: "frequent",
          color: "#00b894",
          bg: "#e8faf5",
          name: "Frequent Buyers",
          desc: "4+ purchases per month",
          count: "10,106",
          delta: "+7.1%",
          up: true,
          freq: "6.4x",
          spend: "$19.07",
          proj: "10,106",
          goal: "<strong>Goal:</strong> Optimize repeat purchase",
          cvr: "3.9%",
          cpa: "$6.20",
          roas: "$21",
          sales: "$86.2K",
          _cvr: 3.9,
          _cpa: 6.2,
          _roas: 21,
          _sales: 86.2,
          _proj: 10106,
          _buyers: 10106,
          d_proj: "+7.1%",
          d_cvr: "+0.4%",
          d_cpa: "-$0.50",
          d_roas: "+$2.8",
          d_sales: "+$8.4K",
          up_proj: true,
          up_cvr: true,
          up_cpa: true,
          up_roas: true,
          up_sales: true,
          iSales: "$122.2K",
          iPctSales: "18.7%",
          iTxns: "64,678",
          iAov: "$19.07",
          iTotalSpend: "$122.05",
          iFreq: "6.4x",
          iRepeat: "89.1%",
          d_iSales: "+$9.6K",
          d_iTxns: "+4,128",
          d_iAov: "+$0.40",
          d_iFreq: "+0.2x",
          d_iRepeat: "+0.8%",
          up_iSales: true,
          up_iTxns: true,
          up_iAov: true,
          up_iFreq: true,
          up_iRepeat: true,
        },
        {
          icon: "heart",
          color: "#fdcb6e",
          bg: "#fef9e7",
          name: "Most Loyal / VIP",
          desc: "8+ visits/mo, top spend tier",
          count: "1,733",
          delta: "+4.8%",
          up: true,
          freq: "9.1x",
          spend: "$24.30",
          proj: "1,733",
          goal: "<strong>Goal:</strong> Retain, upsell, grow app",
          cvr: "5.2%",
          cpa: "$4.80",
          roas: "$28",
          sales: "$22.4K",
          _cvr: 5.2,
          _cpa: 4.8,
          _roas: 28,
          _sales: 22.4,
          _proj: 1733,
          _buyers: 1733,
          d_proj: "+4.8%",
          d_cvr: "+0.1%",
          d_cpa: "-$0.30",
          d_roas: "+$1.0",
          d_sales: "+$1.2K",
          up_proj: true,
          up_cvr: true,
          up_cpa: true,
          up_roas: true,
          up_sales: true,
          iSales: "$86.2K",
          iPctSales: "13.2%",
          iTxns: "15,770",
          iAov: "$24.30",
          iTotalSpend: "$221.13",
          iFreq: "9.1x",
          iRepeat: "96.2%",
          d_iSales: "+$4.2K",
          d_iTxns: "+684",
          d_iAov: "+$0.80",
          d_iFreq: "+0.3x",
          d_iRepeat: "+0.4%",
          up_iSales: true,
          up_iTxns: true,
          up_iAov: true,
          up_iFreq: true,
          up_iRepeat: true,
        },
      ];
      const icons = {
        star: '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>',
        conquest: '<path d="M13 10V3L4 14h7v7l9-11h-7z"/>',
        refresh:
          '<polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>',
        clock:
          '<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>',
        frequent:
          '<path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/>',
        heart:
          '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>',
      };
      const grid = document.getElementById("cohortGrid");
      const rfmDefaults = [
        [30, 0, 0],
        [90, 2, 20],
        [120, 2, 15],
        [90, 1, 10],
        [30, 4, 40],
        [14, 8, 100],
      ];
      let currentMode = "attribution";

      var currentTimePeriod = "week";
      var customAudiences = [];
      function deltaLabel() {
        return currentTimePeriod === "week"
          ? "W/W Change"
          : currentTimePeriod === "30d"
            ? "30D Change"
            : "90D Change";
      }
      let cohortView = "tile";

      function renderCohortCards() {
        var sorted = cohorts.map(function (c, i) {
          return Object.assign({}, c, { _i: i });
        });
        var sortKey = document.getElementById("cohortSort")
          ? document.getElementById("cohortSort").value
          : "";
        if (sortKey) {
          var km = {
            buyers: "_buyers",
            cvr: "_cvr",
            cpa: "_cpa",
            roas: "_roas",
            sales: "_sales",
            proj: "_proj",
          };
          var k = km[sortKey];
          if (k)
            sorted.sort(function (a, b) {
              return k === "_cpa" ? a[k] - b[k] : b[k] - a[k];
            });
        }
        grid.className =
          "cohort-grid" + (cohortView === "list" ? " list-view" : "");
        var hdr = document.getElementById("cohortListHeader");
        if (hdr) hdr.style.display = cohortView === "list" ? "grid" : "none";
        grid.innerHTML = "";
        // Group labels
        if (!sortKey && cohortView !== "list") {
          grid.innerHTML +=
            '<div style="grid-column:1/4;display:flex;flex-direction:column;gap:4px;padding-bottom:2px"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--purple-accent)">Drive Household Penetration</div><div style="height:2px;border-radius:1px;background:linear-gradient(90deg,var(--purple-accent) 0%,rgba(108,92,231,.15) 100%)"></div></div>';
          grid.innerHTML +=
            '<div style="grid-column:4/7;display:flex;flex-direction:column;gap:4px;padding-bottom:2px"><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--teal)">Influence Buy Rate</div><div style="height:2px;border-radius:1px;background:linear-gradient(90deg,var(--teal) 0%,rgba(0,184,148,.15) 100%)"></div></div>';
        }
        sorted.forEach(function (c, idx) {
          var i = c._i;
          var tint = "";
          if (!sortKey && cohortView !== "list") {
            tint =
              i < 3
                ? "background:linear-gradient(135deg,#fbfaff 0%,#f5f3fc 100%);border-color:#ddd6f0"
                : "background:linear-gradient(135deg,#f7fcfa 0%,#f0faf6 100%);border-color:#c8e8d8";
          }
          renderSingleCard(c, idx === 0, tint);
        });
        renderCustomAudiences();
        renderAddCard();
      }

      function renderSingleCard(c, isActive, tint) {
        var i = c._i;
        var r = rfmDefaults[i];
        grid.innerHTML += `<div class="cohort-card${isActive ? " active" : ""}" onclick="selectCohort(this)" style="position:relative;${tint}">
      <div class="cohort-header">
        <div class="cohort-icon" style="background:${c.bg}"><svg viewBox="0 0 24 24" fill="none" stroke="${c.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${icons[c.icon]}</svg></div>
        <div class="cohort-header-text">
          <div class="cohort-name">${c.name}</div>
          <div class="cohort-desc">${c.desc}</div>
        </div>
        <div class="cohort-badge"><span class="live-dot"></span>Live</div>
      </div>
      <div class="cohort-kpis">
        <div class="cohort-kpi-hero">
          <div class="kh-left"><div class="cohort-kpi-val">${currentMode === "insights" ? c.iSales : c.proj}</div><div class="cohort-kpi-label">${currentMode === "insights" ? "Sales" : "Projected Buyers"}</div></div>
          <div class="cohort-kpi-delta" style="color:${currentMode === "insights" ? (c.up_iSales ? "var(--teal)" : "var(--red)") : c.up_proj ? "var(--teal)" : "var(--red)"}">${currentMode === "insights" ? c.d_iSales : c.d_proj}</div>
        </div>
        <div class="cohort-kpi-grid">${
          currentMode === "insights"
            ? `
          <div class="cohort-kpi-cell"><div><div class="cohort-kpi-val">${c.iPctSales}</div><div class="cohort-kpi-label">% of Sales</div></div></div>
          <div class="cohort-kpi-cell"><div><div class="cohort-kpi-val">${c.iAov}</div><div class="cohort-kpi-label">AOV</div></div><div class="cohort-kpi-delta" style="color:${c.up_iAov ? "var(--teal)" : "var(--red)"}">${c.d_iAov}</div></div>
          <div class="cohort-kpi-cell"><div><div class="cohort-kpi-val">${c.iFreq}</div><div class="cohort-kpi-label">Frequency</div></div><div class="cohort-kpi-delta" style="color:${c.up_iFreq ? "var(--teal)" : "var(--red)"}">${c.d_iFreq}</div></div>
          <div class="cohort-kpi-cell"><div><div class="cohort-kpi-val">${c.iRepeat}</div><div class="cohort-kpi-label">Repeat %</div></div><div class="cohort-kpi-delta" style="color:${c.up_iRepeat ? "var(--teal)" : "var(--red)"}">${c.d_iRepeat}</div></div>
        `
            : `
          <div class="cohort-kpi-cell"><div><div class="cohort-kpi-val">${c.cvr}</div><div class="cohort-kpi-label">CVR</div></div><div class="cohort-kpi-delta" style="color:${c.up_cvr ? "var(--teal)" : "var(--red)"}">${c.d_cvr}</div></div>
          <div class="cohort-kpi-cell"><div><div class="cohort-kpi-val">${c.cpa}</div><div class="cohort-kpi-label">CPA</div></div><div class="cohort-kpi-delta" style="color:${c.up_cpa ? "var(--teal)" : "var(--red)"}">${c.d_cpa}</div></div>
          <div class="cohort-kpi-cell"><div><div class="cohort-kpi-val">${c.roas}</div><div class="cohort-kpi-label">ROAS</div></div><div class="cohort-kpi-delta" style="color:${c.up_roas ? "var(--teal)" : "var(--red)"}">${c.d_roas}</div></div>
          <div class="cohort-kpi-cell"><div><div class="cohort-kpi-val">${c.sales}</div><div class="cohort-kpi-label">Sales</div></div><div class="cohort-kpi-delta" style="color:${c.up_sales ? "var(--teal)" : "var(--red)"}">${c.d_sales}</div></div>
        `
        }</div>
      </div>
      <div class="cohort-goal">${c.goal}</div>
      <div class="cohort-cta">
        <button class="cohort-cta-btn activate" onclick="event.stopPropagation();openDrawer('audience')">Activate</button>
        <button class="cohort-cta-btn track" onclick="event.stopPropagation();openDrawer('attribution')">Track</button>
        <button class="cohort-cta-btn edit-btn" onclick="event.stopPropagation();toggleCohortEdit('ce${i}')">✎</button>
      </div>
      <div class="cohort-edit" id="ce${i}">
        <div style="font-size:11px;font-weight:600;margin-bottom:8px;color:var(--text-primary)">Define: ${c.name}</div>
        <div class="rfm-row"><div class="rfm-label">Recency window <span id="rv${i}r">${r[0]}d</span></div><input type="range" class="rfm-slider" min="7" max="180" value="${r[0]}" oninput="document.getElementById('rv${i}r').textContent=this.value+'d'"></div>
        <div class="rfm-row"><div class="rfm-label">Min frequency <span id="rv${i}f">${r[1]}x</span></div><input type="range" class="rfm-slider" min="0" max="12" value="${r[1]}" oninput="document.getElementById('rv${i}f').textContent=this.value+'x'"></div>
        <div class="rfm-row"><div class="rfm-label">Spend threshold <span id="rv${i}s">$${r[2]}</span></div><input type="range" class="rfm-slider" min="0" max="200" value="${r[2]}" oninput="document.getElementById('rv${i}s').textContent='$'+this.value"></div>
        <div style="border-top:1px solid var(--card-border);margin:8px 0;padding-top:8px">
          <div style="font-size:9.5px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px">Filters</div>
          <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px">
            <label style="font-size:10px;display:flex;align-items:center;gap:3px;cursor:pointer"><input type="checkbox" checked style="accent-color:${c.color};width:12px;height:12px"> In-Store</label>
            <label style="font-size:10px;display:flex;align-items:center;gap:3px;cursor:pointer"><input type="checkbox" checked style="accent-color:${c.color};width:12px;height:12px"> Online</label>
            <label style="font-size:10px;display:flex;align-items:center;gap:3px;cursor:pointer"><input type="checkbox" checked style="accent-color:${c.color};width:12px;height:12px"> Delivery</label>
          </div>
          <div style="display:flex;gap:4px;margin-bottom:6px">
            <select style="font-family:var(--font);font-size:10px;padding:3px 6px;border:1px solid var(--card-border);border-radius:4px;flex:1"><option>All Ages</option><option>Gen Z (18-27)</option><option>Millennial (28-43)</option><option>Gen X (44-59)</option><option>Boomer+ (60+)</option></select>
            <select style="font-family:var(--font);font-size:10px;padding:3px 6px;border:1px solid var(--card-border);border-radius:4px;flex:1"><option>All Income</option><option>HHI &lt; $50K</option><option>HHI $50-100K</option><option>HHI $100K+</option></select>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:4px">
            <label style="font-size:10px;display:flex;align-items:center;gap:3px;cursor:pointer"><input type="checkbox" style="accent-color:${c.color};width:12px;height:12px"> Has children</label>
            <label style="font-size:10px;display:flex;align-items:center;gap:3px;cursor:pointer"><input type="checkbox" style="accent-color:${c.color};width:12px;height:12px"> Coupon users</label>
            <label style="font-size:10px;display:flex;align-items:center;gap:3px;cursor:pointer"><input type="checkbox" style="accent-color:${c.color};width:12px;height:12px"> App users</label>
          </div>
        </div>
        <button class="btn btn-primary btn-sm" style="width:100%;margin-top:8px;justify-content:center" onclick="document.getElementById('ce${i}').classList.remove('open');showToast('Cohort definition updated — recalculating...')">Apply Definition</button>
      </div>
    </div>`;
      }

      function renderCustomAudiences() {
        customAudiences.forEach(function (ca, ci) {
          grid.innerHTML += `<div class="cohort-card" onclick="selectCohort(this)" style="position:relative;border-color:var(--purple-accent);border-style:dashed">
      <div class="cohort-header">
        <div class="cohort-icon" style="background:var(--purple-bg)"><svg viewBox="0 0 24 24" fill="none" stroke="var(--purple-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg></div>
        <div class="cohort-header-text">
          <div class="cohort-name">${escapeHtml(ca.name)}</div>
          <div class="cohort-desc">${escapeHtml(ca.description.length > 50 ? ca.description.substring(0, 50) + "..." : ca.description)}</div>
        </div>
        <button class="cohort-trash-btn" onclick="event.stopPropagation();removeCustomAudience(${ci})" title="Remove audience">
          <svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      </div>
      <div class="cohort-kpis">
        <div class="cohort-kpi-hero">
          <div class="kh-left"><div class="cohort-kpi-val">${escapeHtml(ca.estimated_reach)}</div><div class="cohort-kpi-label">Est. Reach</div></div>
          <div class="cohort-kpi-delta" style="color:var(--teal)">${escapeHtml(ca.match_rate)} match</div>
        </div>
        <div class="cohort-kpi-grid">
          <div class="cohort-kpi-cell"><div><div class="cohort-kpi-val">${escapeHtml(ca.panel_seed)}</div><div class="cohort-kpi-label">Panel Seed</div></div></div>
          <div class="cohort-kpi-cell"><div><div class="cohort-kpi-val">${escapeHtml(ca.spec.cohort_alignment ? ca.spec.cohort_alignment.split(" ")[0] : "—")}</div><div class="cohort-kpi-label">Cohort</div></div></div>
          <div class="cohort-kpi-cell"><div><div class="cohort-kpi-val">${escapeHtml(ca.insights && ca.insights[1] ? ca.insights[1].value : "—")}</div><div class="cohort-kpi-label">${escapeHtml(ca.insights && ca.insights[1] ? ca.insights[1].label : "Spend")}</div></div></div>
          <div class="cohort-kpi-cell"><div><div class="cohort-kpi-val">${escapeHtml(ca.insights && ca.insights[2] ? ca.insights[2].value : "—")}</div><div class="cohort-kpi-label">${escapeHtml(ca.insights && ca.insights[2] ? ca.insights[2].label : "Channel")}</div></div></div>
        </div>
      </div>
      <div class="cohort-cta">
        <button class="cohort-cta-btn activate" onclick="event.stopPropagation();openDrawer('audience')">Activate</button>
        <button class="cohort-cta-btn track" onclick="event.stopPropagation();openDrawer('attribution')">Track</button>
      </div>
    </div>`;
        });
      }
      function renderAddCard() {
        grid.innerHTML += `<div class="cohort-card" onclick="openDrawer('audience')" style="position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:${cohortView === "list" ? "auto" : "220px"};border-style:dashed;border-color:#c8c3d6;background:var(--page-bg);cursor:pointer">
    <div style="width:40px;height:40px;border-radius:50%;background:var(--purple-bg);display:flex;align-items:center;justify-content:center;margin-bottom:8px"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="var(--purple-accent)" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>
    <div style="font-size:12px;font-weight:700;color:var(--purple-accent);margin-bottom:4px">Add Custom Audience</div>
    <div style="font-size:9.5px;color:var(--text-secondary);text-align:center;line-height:1.3;padding:0 8px">Build with AI or select from library</div>
  </div>`;
      }
      function setCohortView(v) {
        cohortView = v;
        document
          .getElementById("viewTile")
          .classList.toggle("active", v === "tile");
        document
          .getElementById("viewList")
          .classList.toggle("active", v === "list");
        renderCohortCards();
      }
      function sortCohortBy(key) {
        document.getElementById("cohortSort").value = key;
        renderCohortCards();
      }
      renderCohortCards();
      function toggleCohortEdit(id) {
        document.querySelectorAll(".cohort-edit.open").forEach((e) => {
          if (e.id !== id) e.classList.remove("open");
        });
        document.getElementById(id).classList.toggle("open");
      }
      function selectCohort(el) {
        document
          .querySelectorAll(".cohort-card")
          .forEach((c) => c.classList.remove("active"));
        el.classList.add("active");
      }

      // ═══ INTERACTIVE CHART SYSTEM ═══
      Chart.defaults.font.family = "'DM Sans',sans-serif";
      Chart.defaults.font.size = 11;
      Chart.defaults.color = "#9990ab";

      // State
      let chartState = {
        time: "week",
        view: "cohort",
        channels: ["all", "display", "social", "ctv"],
        creative: "all",
        compare: "",
      };
      let enabledSegments = null; // null = all visible
      var currentGranularity = "default"; // 'default' | 'daily' | 'weekly' | 'monthly'
      var chartDirty = false; // track if any filter changed from defaults

      // Interpolate aggregated data points into daily granularity with realistic noise
      function interpolateDaily(src, dayCount) {
        var labels = [];
        var datasets = {};
        var names = Object.keys(src.datasets);
        var pts = src.labels.length;
        var daysPerPt = Math.floor(dayCount / pts);

        // Generate day labels
        var monthNames = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        var startMonth = 0; // January
        if (dayCount <= 10) {
          for (var d = 1; d <= dayCount; d++) labels.push("Day " + d);
        } else {
          var dt = new Date(2025, 0, 15); // mid-January
          for (var d = 0; d < dayCount; d++) {
            var dd = new Date(dt.getTime() + d * 86400000);
            labels.push(monthNames[dd.getMonth()] + " " + dd.getDate());
          }
        }

        names.forEach(function (name) {
          var vals = src.datasets[name];
          var daily = [];
          for (var p = 0; p < pts; p++) {
            var start = vals[p];
            var end = p < pts - 1 ? vals[p + 1] : vals[p];
            var segs =
              p < pts - 1 ? daysPerPt : dayCount - daysPerPt * (pts - 1);
            for (var s = 0; s < segs; s++) {
              var t = s / segs;
              var base = start + (end - start) * t;
              // Add daily noise — ±5% of value for realism
              var noise = (Math.random() - 0.5) * base * 0.1;
              daily.push(+(base + noise).toFixed(2));
            }
          }
          // Trim or pad to exact day count
          while (daily.length > dayCount) daily.pop();
          while (daily.length < dayCount) daily.push(daily[daily.length - 1]);
          datasets[name] = daily;
        });
        return { labels: labels, datasets: datasets };
      }

      // Aggregate data into weekly buckets
      function aggregateWeekly(src) {
        var names = Object.keys(src.datasets);
        var pts = src.labels.length;
        if (pts <= 7) return src; // already weekly or less
        var weeks = Math.ceil(pts / 7);
        var labels = [];
        var datasets = {};
        for (var w = 0; w < weeks; w++) labels.push("Wk " + (w + 1));
        names.forEach(function (name) {
          var vals = src.datasets[name];
          var agg = [];
          for (var w = 0; w < weeks; w++) {
            var start = w * 7,
              end = Math.min(start + 7, pts);
            var sum = 0,
              cnt = 0;
            for (var i = start; i < end; i++) {
              sum += vals[i];
              cnt++;
            }
            agg.push(+(sum / cnt).toFixed(2));
          }
          datasets[name] = agg;
        });
        return { labels: labels, datasets: datasets };
      }

      // Aggregate into monthly buckets
      function aggregateMonthly(src) {
        var names = Object.keys(src.datasets);
        var pts = src.labels.length;
        if (pts <= 4) return src; // already monthly or less
        var months = Math.ceil(pts / 30);
        if (months < 2) months = 2;
        var mNames = ["Jan", "Feb", "Mar", "Apr", "May"];
        var labels = mNames.slice(0, months);
        var datasets = {};
        var perMonth = Math.floor(pts / months);
        names.forEach(function (name) {
          var vals = src.datasets[name];
          var agg = [];
          for (var m = 0; m < months; m++) {
            var start = m * perMonth,
              end = m === months - 1 ? pts : start + perMonth;
            var sum = 0,
              cnt = 0;
            for (var i = start; i < end; i++) {
              sum += vals[i];
              cnt++;
            }
            agg.push(+(sum / cnt).toFixed(2));
          }
          datasets[name] = agg;
        });
        return { labels: labels, datasets: datasets };
      }

      // Granularity-aware data cache
      var granCache = {};

      function getGranularData(baseSrc, time) {
        if (currentGranularity === "default") return baseSrc;
        var cacheKey =
          time +
          "_" +
          currentGranularity +
          "_" +
          JSON.stringify(Object.keys(baseSrc.datasets));
        if (granCache[cacheKey]) return granCache[cacheKey];

        var dayMap = { week: 7, "30d": 30, "90d": 90 };
        var days = dayMap[time] || 7;
        var result;

        if (currentGranularity === "daily") {
          if (days <= 7)
            result = baseSrc; // week is already daily
          else result = interpolateDaily(baseSrc, days);
        } else if (currentGranularity === "weekly") {
          if (time === "week") result = baseSrc;
          else {
            var daily = interpolateDaily(baseSrc, days);
            result = aggregateWeekly(daily);
          }
        } else if (currentGranularity === "monthly") {
          if (time === "90d")
            result = baseSrc; // already monthly
          else if (time === "week")
            result = { labels: ["This Week"], datasets: {} };
          else {
            var daily2 = interpolateDaily(baseSrc, days);
            result = aggregateMonthly(daily2);
          }
          // Handle single-point case
          if (result.labels.length <= 1) {
            var nm2 = Object.keys(baseSrc.datasets);
            result = { labels: ["This Month"], datasets: {} };
            nm2.forEach(function (n) {
              var vs = baseSrc.datasets[n];
              var avg =
                vs.reduce(function (a, b) {
                  return a + b;
                }, 0) / vs.length;
              result.datasets[n] = [+avg.toFixed(2)];
            });
          }
        }
        granCache[cacheKey] = result;
        return result;
      }

      function setGranularity(g) {
        currentGranularity = g;
        granCache = {}; // clear cache on change
        document
          .getElementById("granDay")
          .classList.toggle("active", g === "daily");
        document
          .getElementById("granWeek")
          .classList.toggle("active", g === "weekly" || g === "default");
        document
          .getElementById("granMonth")
          .classList.toggle("active", g === "monthly");
        updateChartDirty();
        buildChart();
      }

      function resetChart() {
        chartState = {
          time: "week",
          view: "cohort",
          channels: ["all", "display", "social", "ctv"],
          creative: "all",
          compare: "",
        };
        currentGranularity = "default";
        currentAttrMetric = "pct";
        currentChartType = "line";
        enabledSegments = null;
        granCache = {};
        // Reset all filter UI
        document
          .querySelectorAll("#timePills .filter-pill")
          .forEach(function (p) {
            p.classList.toggle("active", p.dataset.time === "week");
          });
        document
          .querySelectorAll("#viewPills .filter-pill")
          .forEach(function (p) {
            p.classList.toggle("active", p.dataset.view === "cohort");
          });
        document
          .querySelectorAll("#channelPills .filter-pill.toggle")
          .forEach(function (p) {
            p.classList.add("active");
          });
        document.getElementById("creativeSelect").value = "all";
        document.getElementById("compareSelect").value = "";
        document.getElementById("attrMetric").value = "pct";
        document.getElementById("chartLine").classList.add("active");
        document.getElementById("chartPie").classList.remove("active");
        document.getElementById("granDay").classList.remove("active");
        document.getElementById("granWeek").classList.add("active");
        document.getElementById("granMonth").classList.remove("active");
        currentTimePeriod = "week";
        updateChartDirty();
        renderCohortCards();
        buildChart();
        showToast("Chart reset to defaults");
      }

      function updateChartDirty() {
        var dirty =
          currentGranularity !== "default" ||
          chartState.time !== "week" ||
          chartState.view !== "cohort" ||
          chartState.creative !== "all" ||
          chartState.compare !== "" ||
          currentAttrMetric !== "pct" ||
          currentChartType !== "line" ||
          enabledSegments !== null;
        document.getElementById("chartResetBtn").style.display = dirty
          ? ""
          : "none";
      }

      function renderSegmentToggles(src) {
        var wrap = document.getElementById("segmentToggles");
        if (!wrap || !src || !src.datasets) return;
        var names = Object.keys(src.datasets);
        var html =
          '<span style="font-size:9px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.4px;margin-right:2px">Segments</span>';
        var allOn = !enabledSegments || enabledSegments.length === names.length;
        html +=
          '<div style="padding:3px 8px;font-size:10px;font-weight:600;border-radius:5px;cursor:pointer;border:1px solid ' +
          (allOn ? "var(--purple-accent)" : "var(--card-border)") +
          ";background:" +
          (allOn ? "var(--purple-accent)" : "var(--card-bg)") +
          ";color:" +
          (allOn ? "#fff" : "var(--text-secondary)") +
          '" onclick="toggleSegment(null)">All</div>';
        names.forEach(function (n) {
          var on = !enabledSegments || enabledSegments.includes(n);
          var c = cohortColors[n] || channelColors[n] || geoColors[n] || "#999";
          html +=
            '<div style="padding:3px 8px;font-size:10px;font-weight:600;border-radius:5px;cursor:pointer;display:flex;align-items:center;gap:4px;border:1.5px solid ' +
            (on ? c : "var(--card-border)") +
            ";background:" +
            (on ? c + "18" : "var(--card-bg)") +
            ";color:" +
            (on ? c : "var(--text-tertiary)") +
            ";opacity:" +
            (on ? "1" : "0.4") +
            '" onclick="toggleSegment(\'' +
            n.replace(/'/g, "\\'") +
            "')\">";
          html +=
            '<span style="width:7px;height:7px;border-radius:50%;background:' +
            c +
            '"></span>' +
            n +
            "</div>";
        });
        wrap.innerHTML = html;
      }

      function toggleSegment(name) {
        var src = getCurrentSrc();
        var names = src ? Object.keys(src.datasets) : [];
        if (!name) {
          if (!enabledSegments || enabledSegments.length === names.length)
            enabledSegments = [];
          else enabledSegments = null;
        } else {
          if (!enabledSegments) enabledSegments = names.slice();
          var idx = enabledSegments.indexOf(name);
          if (idx > -1) enabledSegments.splice(idx, 1);
          else enabledSegments.push(name);
          if (enabledSegments.length === names.length) enabledSegments = null;
        }
        updateChartDirty();
        buildChart();
      }

      function getCurrentSrc() {
        var time = chartState.time,
          view = chartState.view;
        var useMetric = view === "cohort" && currentAttrMetric !== "pct";
        var useAttr = currentMode === "attribution" && view === "cohort";
        var base;
        if (useMetric) {
          if (currentAttrMetric === "roas") base = attrChartData[time];
          else if (currentAttrMetric === "pct") base = chartData.cohort[time];
          else
            base = attrMetricData[currentAttrMetric]
              ? attrMetricData[currentAttrMetric][time]
              : attrChartData[time];
        } else {
          base = useAttr ? attrChartData[time] : chartData[view][time];
        }
        return base ? getGranularData(base, time) : base;
      }
      let salesChart = null;

      const cohortColors = {
        "New-to-Category": "#6c5ce7",
        "Ultra-Light": "#74b9ff",
        Competitor: "#e17055",
        Frequent: "#00b894",
        Loyal: "#fdcb6e",
        "Occasion-Driven": "#a29bfe",
      };

      // ── Data sets for each combination ──
      const chartData = {
        cohort: {
          week: {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: {
              "New-to-Category": [14.2, 14.8, 15.1, 14.6, 15.3, 16.0, 15.8],
              "Ultra-Light": [28.1, 27.5, 27.8, 28.3, 27.0, 26.4, 26.8],
              Competitor: [9.8, 10.2, 10.5, 10.1, 10.8, 11.2, 10.9],
              Frequent: [32.4, 32.0, 31.5, 31.8, 31.2, 30.5, 31.0],
              Loyal: [8.2, 8.4, 8.1, 8.3, 8.5, 8.7, 8.4],
              "Occasion-Driven": [7.3, 7.1, 7.0, 6.9, 7.2, 7.2, 7.1],
            },
          },
          "30d": {
            labels: ["Wk 1", "Wk 2", "Wk 3", "Wk 4"],
            datasets: {
              "New-to-Category": [13.8, 14.5, 15.0, 15.8],
              "Ultra-Light": [28.8, 28.2, 27.5, 26.8],
              Competitor: [9.4, 10.0, 10.6, 10.9],
              Frequent: [32.8, 32.2, 31.5, 31.0],
              Loyal: [8.0, 8.2, 8.4, 8.4],
              "Occasion-Driven": [7.2, 6.9, 7.0, 7.1],
            },
          },
          "90d": {
            labels: ["Jan", "Feb", "Mar"],
            datasets: {
              "New-to-Category": [12.5, 14.2, 15.8],
              "Ultra-Light": [30.1, 28.4, 26.8],
              Competitor: [8.6, 9.8, 10.9],
              Frequent: [34.0, 32.4, 31.0],
              Loyal: [7.8, 8.1, 8.4],
              "Occasion-Driven": [7.0, 7.1, 7.1],
            },
          },
        },
        channel: {
          week: {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: {
              "In-Store": [62, 64, 61, 63, 58, 55, 57],
              "Online Order": [24, 22, 25, 23, 26, 28, 27],
              Delivery: [14, 14, 14, 14, 16, 17, 16],
            },
          },
          "30d": {
            labels: ["Wk 1", "Wk 2", "Wk 3", "Wk 4"],
            datasets: {
              "In-Store": [63, 61, 59, 57],
              "Online Order": [23, 25, 26, 27],
              Delivery: [14, 14, 15, 16],
            },
          },
          "90d": {
            labels: ["Jan", "Feb", "Mar"],
            datasets: {
              "In-Store": [65, 61, 57],
              "Online Order": [21, 24, 27],
              Delivery: [14, 15, 16],
            },
          },
        },
        geo: {
          week: {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: {
              Southeast: [28, 29, 28, 29, 30, 31, 30],
              Midwest: [22, 22, 21, 22, 21, 20, 21],
              Northeast: [20, 19, 20, 19, 19, 18, 19],
              West: [18, 18, 19, 18, 18, 19, 18],
              Southwest: [12, 12, 12, 12, 12, 12, 12],
            },
          },
          "30d": {
            labels: ["Wk 1", "Wk 2", "Wk 3", "Wk 4"],
            datasets: {
              Southeast: [27, 28, 30, 30],
              Midwest: [23, 22, 21, 21],
              Northeast: [21, 20, 19, 19],
              West: [17, 18, 18, 18],
              Southwest: [12, 12, 12, 12],
            },
          },
          "90d": {
            labels: ["Jan", "Feb", "Mar"],
            datasets: {
              Southeast: [26, 28, 30],
              Midwest: [24, 22, 21],
              Northeast: [22, 20, 19],
              West: [16, 18, 18],
              Southwest: [12, 12, 12],
            },
          },
        },
      };

      // Competitor overlay data (cohort view only)
      const competitorData = {
        mcdonalds: {
          name: "McDonald's",
          data: {
            week: {
              "New-to-Category": [10.1, 10.4, 10.2, 10.0, 9.8, 9.5, 9.6],
              "Ultra-Light": [25.4, 25.8, 26.0, 26.2, 26.5, 27.0, 26.8],
              Competitor: [8.2, 8.0, 7.8, 8.1, 7.6, 7.4, 7.5],
              Frequent: [38.5, 38.2, 38.0, 37.8, 38.0, 38.2, 38.0],
              Loyal: [11.2, 11.0, 11.4, 11.3, 11.5, 11.3, 11.5],
              "Occasion-Driven": [6.6, 6.6, 6.6, 6.6, 6.6, 6.6, 6.6],
            },
            "30d": {
              "New-to-Category": [10.8, 10.4, 10.0, 9.6],
              "Ultra-Light": [24.8, 25.5, 26.2, 26.8],
              Competitor: [8.6, 8.2, 7.8, 7.5],
              Frequent: [38.8, 38.5, 38.2, 38.0],
              Loyal: [10.8, 11.0, 11.3, 11.5],
              "Occasion-Driven": [6.2, 6.4, 6.5, 6.6],
            },
            "90d": {
              "New-to-Category": [11.5, 10.4, 9.6],
              "Ultra-Light": [23.5, 25.2, 26.8],
              Competitor: [9.2, 8.2, 7.5],
              Frequent: [39.2, 38.5, 38.0],
              Loyal: [10.4, 11.2, 11.5],
              "Occasion-Driven": [6.2, 6.5, 6.6],
            },
          },
        },
        wendys: {
          name: "Wendy's",
          data: {
            week: {
              "New-to-Category": [11.5, 11.8, 12.0, 11.6, 12.2, 12.5, 12.3],
              "Ultra-Light": [30.2, 29.8, 29.5, 30.0, 29.2, 28.8, 29.0],
              Competitor: [12.0, 12.4, 12.8, 12.2, 13.0, 13.4, 13.1],
              Frequent: [30.0, 29.8, 29.5, 30.0, 29.4, 29.0, 29.2],
              Loyal: [9.5, 9.4, 9.4, 9.4, 9.4, 9.5, 9.5],
              "Occasion-Driven": [6.8, 6.8, 6.8, 6.8, 6.8, 6.8, 6.9],
            },
            "30d": {
              "New-to-Category": [10.8, 11.2, 11.8, 12.3],
              "Ultra-Light": [31.0, 30.5, 29.8, 29.0],
              Competitor: [11.0, 11.8, 12.6, 13.1],
              Frequent: [31.0, 30.5, 29.8, 29.2],
              Loyal: [9.5, 9.4, 9.4, 9.5],
              "Occasion-Driven": [6.7, 6.6, 6.6, 6.9],
            },
            "90d": {
              "New-to-Category": [10.0, 11.2, 12.3],
              "Ultra-Light": [32.0, 30.5, 29.0],
              Competitor: [10.0, 11.8, 13.1],
              Frequent: [32.0, 30.5, 29.2],
              Loyal: [9.5, 9.4, 9.5],
              "Occasion-Driven": [6.5, 6.6, 6.9],
            },
          },
        },
        popeyes: {
          name: "Popeye's",
          data: {
            week: {
              "New-to-Category": [16.0, 16.5, 16.8, 16.2, 17.0, 17.5, 17.2],
              "Ultra-Light": [26.5, 26.0, 25.8, 26.2, 25.5, 25.0, 25.2],
              Competitor: [14.2, 14.8, 15.0, 14.5, 15.2, 15.5, 15.3],
              Frequent: [28.0, 27.5, 27.2, 27.8, 27.0, 26.8, 27.0],
              Loyal: [7.5, 7.4, 7.4, 7.5, 7.5, 7.4, 7.5],
              "Occasion-Driven": [7.8, 7.8, 7.8, 7.8, 7.8, 7.8, 7.8],
            },
            "30d": {
              "New-to-Category": [15.0, 15.8, 16.5, 17.2],
              "Ultra-Light": [27.5, 27.0, 26.0, 25.2],
              Competitor: [13.0, 14.0, 14.8, 15.3],
              Frequent: [29.0, 28.2, 27.5, 27.0],
              Loyal: [7.5, 7.4, 7.4, 7.5],
              "Occasion-Driven": [8.0, 7.6, 7.8, 7.8],
            },
            "90d": {
              "New-to-Category": [13.8, 15.8, 17.2],
              "Ultra-Light": [29.0, 27.0, 25.2],
              Competitor: [11.8, 14.0, 15.3],
              Frequent: [30.0, 28.2, 27.0],
              Loyal: [7.6, 7.4, 7.5],
              "Occasion-Driven": [7.8, 7.6, 7.8],
            },
          },
        },
        chickfila: {
          name: "Chick-fil-A",
          data: {
            week: {
              "New-to-Category": [8.5, 8.2, 8.0, 8.4, 7.8, 7.5, 7.6],
              "Ultra-Light": [20.0, 20.5, 20.8, 20.2, 21.0, 21.5, 21.2],
              Competitor: [6.0, 5.8, 5.5, 6.0, 5.4, 5.2, 5.3],
              Frequent: [42.0, 42.5, 42.8, 42.2, 43.0, 43.2, 43.0],
              Loyal: [16.5, 16.2, 16.1, 16.4, 16.0, 15.8, 16.1],
              "Occasion-Driven": [7.0, 6.8, 6.8, 6.8, 6.8, 6.8, 6.8],
            },
            "30d": {
              "New-to-Category": [9.0, 8.5, 8.0, 7.6],
              "Ultra-Light": [19.0, 19.8, 20.5, 21.2],
              Competitor: [6.5, 6.2, 5.8, 5.3],
              Frequent: [41.5, 42.0, 42.5, 43.0],
              Loyal: [17.0, 16.5, 16.2, 16.1],
              "Occasion-Driven": [7.0, 7.0, 7.0, 6.8],
            },
            "90d": {
              "New-to-Category": [10.0, 8.5, 7.6],
              "Ultra-Light": [18.0, 19.8, 21.2],
              Competitor: [7.2, 6.2, 5.3],
              Frequent: [40.5, 42.0, 43.0],
              Loyal: [17.5, 16.5, 16.1],
              "Occasion-Driven": [6.8, 7.0, 6.8],
            },
          },
        },
        subway: {
          name: "Subway",
          data: {
            week: {
              "New-to-Category": [12.0, 12.5, 12.8, 12.2, 13.0, 13.5, 13.2],
              "Ultra-Light": [34.0, 33.5, 33.0, 34.0, 32.8, 32.0, 32.5],
              Competitor: [11.0, 11.5, 11.8, 11.2, 12.0, 12.5, 12.2],
              Frequent: [26.0, 25.8, 25.5, 26.0, 25.2, 25.0, 25.2],
              Loyal: [5.8, 5.5, 5.7, 5.8, 5.5, 5.4, 5.5],
              "Occasion-Driven": [11.2, 11.2, 11.2, 10.8, 11.5, 11.6, 11.4],
            },
            "30d": {
              "New-to-Category": [11.0, 11.8, 12.5, 13.2],
              "Ultra-Light": [35.5, 34.5, 33.2, 32.5],
              Competitor: [10.0, 10.8, 11.5, 12.2],
              Frequent: [27.0, 26.5, 25.8, 25.2],
              Loyal: [6.0, 5.8, 5.5, 5.5],
              "Occasion-Driven": [10.5, 10.6, 11.5, 11.4],
            },
            "90d": {
              "New-to-Category": [10.0, 11.8, 13.2],
              "Ultra-Light": [37.0, 34.5, 32.5],
              Competitor: [9.0, 10.8, 12.2],
              Frequent: [28.0, 26.5, 25.2],
              Loyal: [6.2, 5.8, 5.5],
              "Occasion-Driven": [9.8, 10.6, 11.4],
            },
          },
        },
      };

      // Creative modifiers (shifts applied to cohort data)
      const creativeShifts = {
        all: {},
        whopper: {
          Frequent: [+2, +2, +1.5, +2, +1, +1.5, +1],
          "Ultra-Light": [-1, -1, -0.5, -1, -0.5, -1, -0.5],
          Loyal: [-1, -1, -1, -1, -0.5, -0.5, -0.5],
        },
        flame: {
          Loyal: [+3, +3.5, +3, +3.2, +3, +2.8, +3],
          Frequent: [+1, +0.5, +1, +0.8, +1, +1, +0.8],
          "Ultra-Light": [-2, -2, -2, -2, -2, -2, -2],
          "Occasion-Driven": [-2, -2, -2, -2, -2, -1.8, -1.8],
        },
        family: {
          "Ultra-Light": [+4, +4.5, +5, +4.2, +5, +5.5, +5],
          "New-to-Category": [+2, +2, +1.5, +2, +1.5, +1.8, +1.5],
          Loyal: [-3, -3, -3, -3, -3, -3, -3],
          Frequent: [-3, -3.5, -3.5, -3.2, -3.5, -4, -3.5],
        },
        app: {
          "Occasion-Driven": [+5, +5.5, +6, +5.2, +6, +6.5, +6],
          Competitor: [+2, +2.5, +2, +2.2, +2, +2.5, +2],
          Frequent: [-4, -4.5, -4.5, -4, -4.5, -5, -4.5],
          Loyal: [-3, -3.5, -3.5, -3.4, -3.5, -4, -3.5],
        },
      };

      const channelColors = {
        "In-Store": "#6c5ce7",
        "Online Order": "#00b894",
        Delivery: "#e17055",
      };
      const geoColors = {
        Southeast: "#6c5ce7",
        Midwest: "#74b9ff",
        Northeast: "#e17055",
        West: "#00b894",
        Southwest: "#fdcb6e",
      };

      // Attribution mode chart data — ROAS by cohort over time
      const attrChartData = {
        week: {
          labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
          datasets: {
            "New-to-Category": [2.8, 3.1, 3.4, 3.2, 3.6, 3.9, 3.7],
            "Ultra-Light": [3.2, 3.0, 3.3, 3.5, 3.4, 3.8, 3.6],
            Competitor: [4.1, 4.3, 4.5, 4.2, 4.6, 4.8, 4.5],
            Frequent: [3.8, 3.6, 3.5, 3.7, 3.4, 3.3, 3.5],
            Loyal: [2.1, 2.0, 2.2, 2.1, 2.3, 2.2, 2.1],
            "Occasion-Driven": [1.8, 2.4, 2.8, 1.9, 2.1, 3.2, 2.6],
          },
        },
        "30d": {
          labels: ["Wk 1", "Wk 2", "Wk 3", "Wk 4"],
          datasets: {
            "New-to-Category": [2.6, 3.0, 3.4, 3.7],
            "Ultra-Light": [2.9, 3.1, 3.4, 3.6],
            Competitor: [3.8, 4.1, 4.5, 4.5],
            Frequent: [3.9, 3.7, 3.5, 3.5],
            Loyal: [2.2, 2.1, 2.1, 2.1],
            "Occasion-Driven": [2.0, 2.2, 2.5, 2.6],
          },
        },
        "90d": {
          labels: ["Jan", "Feb", "Mar"],
          datasets: {
            "New-to-Category": [2.2, 3.0, 3.7],
            "Ultra-Light": [2.5, 3.1, 3.6],
            Competitor: [3.2, 4.1, 4.5],
            Frequent: [4.1, 3.7, 3.5],
            Loyal: [2.3, 2.1, 2.1],
            "Occasion-Driven": [1.8, 2.2, 2.6],
          },
        },
      };

      // Forecast extensions (dashed projection)
      const forecastData = {
        cohort: {
          week: {
            labels: ["Mon+1", "Tue+1", "Wed+1"],
            datasets: {
              "New-to-Category": [16.8, 17.2, 17.5],
              "Ultra-Light": [23.8, 23.5, 23.2],
              Competitor: [12.8, 13.0, 13.2],
              Frequent: [32.8, 32.5, 32.0],
              Loyal: [7.8, 7.8, 7.9],
              "Occasion-Driven": [6.0, 6.0, 6.2],
            },
          },
          "30d": {
            labels: ["Wk 5", "Wk 6"],
            datasets: {
              "New-to-Category": [17.0, 17.4],
              "Ultra-Light": [23.2, 22.8],
              Competitor: [13.4, 13.8],
              Frequent: [32.5, 32.2],
              Loyal: [7.9, 7.8],
              "Occasion-Driven": [6.0, 6.0],
            },
          },
          "90d": {
            labels: ["Apr"],
            datasets: {
              "New-to-Category": [17.8],
              "Ultra-Light": [22.5],
              Competitor: [14.0],
              Frequent: [31.8],
              Loyal: [7.9],
              "Occasion-Driven": [6.0],
            },
          },
        },
        attr: {
          week: {
            labels: ["Mon+1", "Tue+1", "Wed+1"],
            datasets: {
              "New-to-Category": [3.9, 4.1, 4.2],
              "Ultra-Light": [3.8, 3.9, 4.0],
              Competitor: [4.7, 4.8, 4.9],
              Frequent: [3.3, 3.2, 3.1],
              Loyal: [2.0, 2.0, 1.9],
              "Occasion-Driven": [2.8, 3.0, 3.1],
            },
          },
          "30d": {
            labels: ["Wk 5", "Wk 6"],
            datasets: {
              "New-to-Category": [3.9, 4.1],
              "Ultra-Light": [3.8, 3.9],
              Competitor: [4.7, 4.8],
              Frequent: [3.3, 3.2],
              Loyal: [2.0, 1.9],
              "Occasion-Driven": [2.8, 3.0],
            },
          },
          "90d": {
            labels: ["Apr"],
            datasets: {
              "New-to-Category": [4.0],
              "Ultra-Light": [3.9],
              Competitor: [4.8],
              Frequent: [3.2],
              Loyal: [1.9],
              "Occasion-Driven": [3.0],
            },
          },
        },
      };

      // Attribution metric data sets
      const attrMetricData = {
        roas: null, // uses attrChartData
        cpa: {
          week: {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: {
              "New-to-Category": [15.2, 14.6, 13.8, 14.1, 13.2, 12.5, 13.0],
              "Ultra-Light": [12.4, 12.8, 11.9, 11.4, 11.8, 10.8, 11.2],
              Competitor: [10.5, 10.1, 9.6, 10.2, 9.4, 9.0, 9.3],
              Frequent: [6.8, 7.0, 7.2, 6.9, 7.4, 7.6, 7.1],
              Loyal: [5.2, 5.4, 5.0, 5.1, 4.8, 4.9, 4.7],
              "Occasion-Driven": [16.0, 14.2, 12.8, 15.1, 13.8, 11.0, 12.5],
            },
          },
          "30d": {
            labels: ["Wk 1", "Wk 2", "Wk 3", "Wk 4"],
            datasets: {
              "New-to-Category": [16.0, 14.8, 13.5, 13.0],
              "Ultra-Light": [13.0, 12.4, 11.5, 11.2],
              Competitor: [11.2, 10.4, 9.5, 9.3],
              Frequent: [7.2, 7.0, 6.5, 6.2],
              Loyal: [5.5, 5.2, 4.9, 4.8],
              "Occasion-Driven": [17.0, 15.0, 13.0, 12.5],
            },
          },
          "90d": {
            labels: ["Jan", "Feb", "Mar"],
            datasets: {
              "New-to-Category": [17.5, 14.8, 13.0],
              "Ultra-Light": [14.0, 12.4, 11.2],
              Competitor: [12.5, 10.4, 9.3],
              Frequent: [7.8, 7.0, 6.2],
              Loyal: [6.0, 5.2, 4.8],
              "Occasion-Driven": [18.5, 15.0, 12.5],
            },
          },
        },
        aov: {
          week: {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: {
              "New-to-Category": [14.8, 15.2, 15.1, 14.9, 15.5, 15.8, 15.4],
              "Ultra-Light": [16.1, 16.4, 16.2, 16.5, 16.8, 17.1, 16.9],
              Competitor: [18.4, 18.8, 19.1, 18.6, 19.2, 19.5, 19.3],
              Frequent: [19.07, 19.3, 19.5, 19.2, 19.6, 19.8, 19.7],
              Loyal: [24.3, 24.8, 25.1, 24.5, 25.2, 25.6, 25.4],
              "Occasion-Driven": [13.2, 13.8, 14.2, 13.5, 14.0, 14.8, 14.4],
            },
          },
          "30d": {
            labels: ["Wk 1", "Wk 2", "Wk 3", "Wk 4"],
            datasets: {
              "New-to-Category": [14.2, 14.8, 15.2, 15.4],
              "Ultra-Light": [15.5, 16.1, 16.5, 16.9],
              Competitor: [17.8, 18.4, 18.9, 19.3],
              Frequent: [18.5, 19.07, 19.4, 19.7],
              Loyal: [23.5, 24.3, 24.8, 25.4],
              "Occasion-Driven": [12.5, 13.2, 13.8, 14.4],
            },
          },
          "90d": {
            labels: ["Jan", "Feb", "Mar"],
            datasets: {
              "New-to-Category": [13.5, 14.8, 15.4],
              "Ultra-Light": [14.8, 16.1, 16.9],
              Competitor: [16.9, 18.4, 19.3],
              Frequent: [17.8, 19.07, 19.7],
              Loyal: [22.5, 24.3, 25.4],
              "Occasion-Driven": [11.8, 13.2, 14.4],
            },
          },
        },
        cvr: {
          week: {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: {
              "New-to-Category": [1.4, 1.5, 1.7, 1.6, 1.8, 2.0, 1.9],
              "Ultra-Light": [1.2, 1.3, 1.4, 1.3, 1.5, 1.6, 1.5],
              Competitor: [2.1, 2.2, 2.4, 2.2, 2.5, 2.6, 2.5],
              Frequent: [3.5, 3.6, 3.8, 3.6, 3.9, 4.1, 3.9],
              Loyal: [4.8, 5.0, 5.2, 4.9, 5.3, 5.5, 5.3],
              "Occasion-Driven": [0.6, 0.8, 1.0, 0.7, 0.9, 1.2, 1.0],
            },
          },
          "30d": {
            labels: ["Wk 1", "Wk 2", "Wk 3", "Wk 4"],
            datasets: {
              "New-to-Category": [1.2, 1.5, 1.7, 1.9],
              "Ultra-Light": [1.0, 1.3, 1.4, 1.5],
              Competitor: [1.8, 2.2, 2.4, 2.5],
              Frequent: [3.2, 3.6, 3.8, 3.9],
              Loyal: [4.5, 5.0, 5.2, 5.3],
              "Occasion-Driven": [0.5, 0.8, 1.0, 1.0],
            },
          },
          "90d": {
            labels: ["Jan", "Feb", "Mar"],
            datasets: {
              "New-to-Category": [0.8, 1.5, 1.9],
              "Ultra-Light": [0.7, 1.3, 1.5],
              Competitor: [1.4, 2.2, 2.5],
              Frequent: [2.8, 3.6, 3.9],
              Loyal: [4.0, 5.0, 5.3],
              "Occasion-Driven": [0.3, 0.8, 1.0],
            },
          },
        },
      };
      // Insights-mode time period data (longitudinal)
      const insightsChartData = {
        "1m": {
          labels: ["Wk 1", "Wk 2", "Wk 3", "Wk 4"],
          datasets: {
            "New-to-Category": [13.8, 14.5, 15.0, 15.8],
            "Ultra-Light": [28.8, 28.2, 27.5, 26.8],
            Competitor: [9.4, 10.0, 10.6, 10.9],
            Frequent: [32.8, 32.2, 31.5, 31.0],
            Loyal: [8.0, 8.2, 8.4, 8.4],
            "Occasion-Driven": [7.2, 6.9, 7.0, 7.1],
          },
        },
        "3m": {
          labels: ["Jan", "Feb", "Mar"],
          datasets: {
            "New-to-Category": [12.5, 14.2, 15.8],
            "Ultra-Light": [30.1, 28.4, 26.8],
            Competitor: [8.6, 9.8, 10.9],
            Frequent: [34.0, 32.4, 31.0],
            Loyal: [7.8, 8.1, 8.4],
            "Occasion-Driven": [7.0, 7.1, 7.1],
          },
        },
        "6m": {
          labels: ["Oct", "Nov", "Dec", "Jan", "Feb", "Mar"],
          datasets: {
            "New-to-Category": [10.2, 11.0, 11.8, 12.5, 14.2, 15.8],
            "Ultra-Light": [32.5, 31.8, 31.0, 30.1, 28.4, 26.8],
            Competitor: [7.2, 7.8, 8.2, 8.6, 9.8, 10.9],
            Frequent: [35.5, 35.0, 34.5, 34.0, 32.4, 31.0],
            Loyal: [7.2, 7.4, 7.6, 7.8, 8.1, 8.4],
            "Occasion-Driven": [7.4, 7.0, 6.9, 7.0, 7.1, 7.1],
          },
        },
        "12m": {
          labels: [
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
            "Jan",
            "Feb",
            "Mar",
          ],
          datasets: {
            "New-to-Category": [
              8.4, 8.8, 9.2, 9.5, 9.8, 10.0, 10.2, 11.0, 11.8, 12.5, 14.2, 15.8,
            ],
            "Ultra-Light": [
              35.2, 34.8, 34.2, 33.6, 33.2, 32.8, 32.5, 31.8, 31.0, 30.1, 28.4,
              26.8,
            ],
            Competitor: [
              5.8, 6.0, 6.4, 6.6, 6.9, 7.0, 7.2, 7.8, 8.2, 8.6, 9.8, 10.9,
            ],
            Frequent: [
              37.2, 37.0, 36.6, 36.2, 35.8, 35.6, 35.5, 35.0, 34.5, 34.0, 32.4,
              31.0,
            ],
            Loyal: [6.4, 6.6, 6.8, 7.0, 7.0, 7.1, 7.2, 7.4, 7.6, 7.8, 8.1, 8.4],
            "Occasion-Driven": [
              7.0, 6.8, 6.8, 7.1, 7.3, 7.5, 7.4, 7.0, 6.9, 7.0, 7.1, 7.1,
            ],
          },
        },
      };
      var currentInsightsTime = "12m";

      let currentAttrMetric = "pct";
      let currentChartType = "line";

      function buildChart() {
        let { time, view, channels, creative, compare } = chartState;

        // In insights mode, override time with insights-specific period
        if (currentMode === "insights") {
          time = currentInsightsTime;
        }

        // In attribution mode + cohort view, use selected metric data
        const useAttr = currentMode === "attribution" && view === "cohort";
        const useMetric = view === "cohort" && currentAttrMetric !== "pct";
        var attrSrc;
        if (currentAttrMetric === "roas") attrSrc = attrChartData[time];
        else if (currentAttrMetric === "pct") attrSrc = chartData.cohort[time];
        else
          attrSrc = attrMetricData[currentAttrMetric]
            ? attrMetricData[currentAttrMetric][time]
            : attrChartData[time];

        // Insights mode: always use insightsChartData for cohort view
        var src;
        if (currentMode === "insights" && view === "cohort") {
          src = insightsChartData[time] || insightsChartData["12m"];
        } else {
          src = useMetric
            ? attrSrc
            : useAttr
              ? attrChartData[time]
              : chartData[view][time];
        }

        // Show/hide attribution metric dropdown — visible only in attribution + cohort
        document.getElementById("attrMetric").style.display =
          currentMode === "attribution" && view === "cohort" ? "" : "none";
        // Show granularity pills for 30D and 90D
        var granEl = document.getElementById("granPills");
        granEl.style.display =
          time === "30d" || time === "90d" ? "flex" : "none";
        if (!src) return;
        // Apply granularity transform
        src = getGranularData(src, time);

        // Update header
        const metricLabels = {
          pct: "% of Sales",
          roas: "ROAS",
          cpa: "CPA",
          aov: "AOV",
          cvr: "CVR",
        };
        const metricUnits = {
          pct: "%",
          roas: "x",
          cpa: "$",
          aov: "$",
          cvr: "%",
        };
        const mLabel = metricLabels[currentAttrMetric] || "% of Sales";
        const showMetric = useAttr || useMetric;
        const titles = showMetric
          ? { cohort: mLabel + " by Buyer Cohort" }
          : {
              cohort: "Cohort Mix — % of Sales by Buyer Segment",
              channel: "Purchase Channel Mix — Online vs In-Store",
              geo: "Geographic Mix — % of Sales by Region",
            };
        const subtitles = showMetric
          ? {
              cohort:
                mLabel + " by cohort — track and compare segment performance",
            }
          : {
              cohort:
                "How purchase composition shifts across your six universal buyer segments over time",
              channel:
                "Tracking how purchase channel preferences are shifting for Burger King buyers",
              geo: "Regional sales composition — identify geographic growth and concentration patterns",
            };
        document.getElementById("chartTitle").innerHTML =
          (titles[view] || titles.cohort) +
          ' <span class="badge"><span class="live-dot" style="width:6px;height:6px;margin-right:4px"></span>LIVE</span>';
        document.getElementById("chartSubtitle").textContent =
          subtitles[view] || subtitles.cohort;

        // Active filter tags
        const tagsEl = document.getElementById("chartActiveFilters");
        let tags = [];
        if (creative !== "all")
          tags.push(
            '<span class="active-filter-tag">Creative: ' +
              document.getElementById("creativeSelect").selectedOptions[0]
                .text +
              "</span>",
          );
        if (compare)
          tags.push(
            '<span class="active-filter-tag" style="background:var(--coral-bg);color:var(--coral)">vs ' +
              competitorData[compare].name +
              "</span>",
          );
        tagsEl.innerHTML = tags.join("");

        // Render segment toggles
        renderSegmentToggles(src);

        // Build datasets
        let datasets = [];
        const names = Object.keys(src.datasets);
        const colorMap =
          view === "channel"
            ? channelColors
            : view === "geo"
              ? geoColors
              : cohortColors;
        var visibleNames =
          enabledSegments && enabledSegments.length > 0
            ? names.filter(function (n) {
                return enabledSegments.includes(n);
              })
            : enabledSegments && enabledSegments.length === 0
              ? []
              : names;

        if (visibleNames.length === 0 && view === "cohort") {
          // Show aggregate total line
          var len = src.datasets[names[0]].length;
          var totalData = [];
          for (var ti = 0; ti < len; ti++) {
            var sum = 0;
            names.forEach(function (n) {
              sum += src.datasets[n][ti];
            });
            totalData.push(+(sum / names.length).toFixed(1));
          }
          datasets.push({
            label: "Total (avg)",
            data: totalData,
            borderColor: "var(--purple-accent)",
            backgroundColor: "rgba(108,92,231,0.08)",
            fill: true,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 4,
            pointBackgroundColor: "var(--purple-accent)",
            pointHoverRadius: 6,
          });
        } else {
          visibleNames.forEach((name) => {
            let data = [...src.datasets[name]];
            if (
              view === "cohort" &&
              creative !== "all" &&
              creativeShifts[creative] &&
              creativeShifts[creative][name]
            ) {
              const shift = creativeShifts[creative][name];
              data = data.map((v, i) =>
                Math.max(0, +(v + (shift[i % shift.length] || 0)).toFixed(1)),
              );
            }
            datasets.push({
              label: name,
              data,
              borderColor: colorMap[name] || "#9990ab",
              backgroundColor: (colorMap[name] || "#9990ab") + "10",
              fill: true,
              tension: 0.4,
              borderWidth: 2.5,
              pointRadius: 3,
              pointBackgroundColor: colorMap[name] || "#9990ab",
              pointHoverRadius: 5,
            });
          });
        }

        // Competitor overlay (cohort view only)
        if (view === "cohort" && compare && competitorData[compare]) {
          const cd = competitorData[compare].data[time];
          if (cd) {
            Object.keys(cd).forEach((name) => {
              datasets.push({
                label: competitorData[compare].name + " — " + name,
                data: cd[name],
                borderColor: cohortColors[name] || "#9990ab",
                backgroundColor: "transparent",
                fill: false,
                tension: 0.4,
                borderWidth: 1.5,
                borderDash: [6, 4],
                pointRadius: 0,
                pointHoverRadius: 3,
              });
            });
          }
          document.getElementById("compareLegend").style.display = "";
          document.getElementById("compareName").textContent =
            competitorData[compare].name;
        } else {
          document.getElementById("compareLegend").style.display = "none";
        }

        // Add forecast extensions
        var fcKey = useAttr ? "attr" : "cohort";
        var fc =
          view === "cohort" && forecastData[fcKey] && forecastData[fcKey][time]
            ? forecastData[fcKey][time]
            : null;
        var allLabels = src.labels.slice();
        if (fc && currentChartType === "line") {
          allLabels = src.labels.concat(fc.labels);
          var fcDatasets = [];
          datasets.forEach(function (ds) {
            var fcVals = fc.datasets[ds.label];
            if (fcVals) {
              var lastReal = ds.data[ds.data.length - 1];
              fcDatasets.push({
                label: ds.label + " (forecast)",
                data: new Array(src.labels.length - 1)
                  .fill(null)
                  .concat([lastReal])
                  .concat(fcVals),
                borderColor: ds.borderColor,
                backgroundColor: "transparent",
                borderWidth: 2,
                borderDash: [5, 4],
                pointRadius: 0,
                tension: 0.35,
                fill: false,
              });
            }
          });
          datasets = datasets.concat(fcDatasets);
        }

        // Pie chart mode
        if (currentChartType === "pie" && view === "cohort") {
          var pieLabels = Object.keys(
            useAttr
              ? attrChartData[time].datasets
              : chartData.cohort[time].datasets,
          );
          var pieData = pieLabels.map(function (n) {
            var arr = useAttr
              ? attrChartData[time].datasets[n]
              : chartData.cohort[time].datasets[n];
            return arr[arr.length - 1];
          });
          var pieColors = pieLabels.map(function (n) {
            return cohortColors[n] || "#999";
          });
          if (salesChart) salesChart.destroy();
          salesChart = new Chart(document.getElementById("salesChart"), {
            type: "doughnut",
            data: {
              labels: pieLabels,
              datasets: [
                {
                  data: pieData,
                  backgroundColor: pieColors,
                  borderWidth: 2,
                  borderColor: "#fff",
                  hoverOffset: 8,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "55%",
              plugins: { legend: { display: false } },
              onClick: function (evt, els) {
                if (!els.length || currentMode !== "insights") return;
                var idx = els[0].index;
                var name = pieLabels[idx];
                showToast(
                  "Building audience: " +
                    name +
                    " — redirecting to Audience Builder...",
                );
                setTimeout(function () {
                  openDrawer("audience");
                }, 800);
              },
            },
          });
          // Cursor hint for insights mode
          var cv = document.getElementById("salesChart");
          if (cv)
            cv.style.cursor =
              currentMode === "insights" ? "pointer" : "default";
          renderPieCohortPanel(pieLabels, pieData, pieColors, useAttr);
          return;
        }

        // Hide pie panel for line mode
        var pp = document.getElementById("pieCohortPanel");
        if (pp) pp.style.display = "none";

        // Destroy and rebuild
        if (salesChart) salesChart.destroy();
        salesChart = new Chart(document.getElementById("salesChart"), {
          type: "line",
          data: { labels: allLabels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 600, easing: "easeOutQuart" },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    var u = showMetric
                      ? metricUnits[currentAttrMetric] || "x"
                      : "%";
                    var pre = u === "$" ? "$" : "";
                    var suf = u === "$" ? "" : u;
                    return (
                      ctx.dataset.label +
                      ": " +
                      pre +
                      ctx.parsed.y.toFixed(1) +
                      suf
                    );
                  },
                  title: (arr) => arr[0].label,
                },
              },
            },
            scales: {
              x: { grid: { display: false } },
              y: {
                grid: { color: "rgba(0,0,0,0.04)" },
                ticks: {
                  callback: function (v) {
                    if (showMetric) {
                      var u = metricUnits[currentAttrMetric] || "x";
                      return u === "$" ? "$" + v.toFixed(0) : v.toFixed(1) + u;
                    }
                    return v + "%";
                  },
                },
                stacked: false,
                min: 0,
                max: showMetric
                  ? currentAttrMetric === "cpa"
                    ? 20
                    : currentAttrMetric === "aov"
                      ? 30
                      : currentAttrMetric === "cvr"
                        ? 7
                        : 6
                  : view === "cohort"
                    ? creative !== "all"
                      ? 50
                      : 40
                    : view === "channel"
                      ? 75
                      : 35,
              },
            },
            interaction: { intersect: false, mode: "index" },
          },
        });
      }

      // ── Filter handlers ──
      function setTime(el) {
        document
          .querySelectorAll("#timePills .filter-pill")
          .forEach((p) => p.classList.remove("active"));
        el.classList.add("active");
        chartState.time = el.dataset.time;
        currentTimePeriod = el.dataset.time;
        // Reset granularity to default for new time period
        currentGranularity = "default";
        granCache = {};
        document.getElementById("granDay").classList.remove("active");
        document.getElementById("granWeek").classList.add("active");
        document.getElementById("granMonth").classList.remove("active");
        updateChartDirty();
        renderCohortCards();
        buildChart();
      }

      function setView(el) {
        document
          .querySelectorAll("#viewPills .filter-pill")
          .forEach((p) => p.classList.remove("active"));
        el.classList.add("active");
        chartState.view = el.dataset.view;
        enabledSegments = null; // reset segment selection on view change
        if (el.dataset.view !== "cohort") {
          chartState.compare = "";
          document.getElementById("compareSelect").value = "";
        }
        updateChartDirty();
        buildChart();
      }

      function toggleChannel(el) {
        if (el.dataset.ch === "all") {
          // Toggle all on
          document
            .querySelectorAll("#channelPills .filter-pill.toggle")
            .forEach((p) => p.classList.add("active"));
          chartState.channels = ["all", "display", "social", "ctv", "audio"];
          document.getElementById("channelHint").style.display = "none";
          buildChart();
          return;
        }
        el.classList.toggle("active");
        // Update "All" pill
        const allPill = document.querySelector('#channelPills [data-ch="all"]');
        const others = document.querySelectorAll(
          '#channelPills .filter-pill.toggle:not([data-ch="all"])',
        );
        const allActive = Array.from(others).every((p) =>
          p.classList.contains("active"),
        );
        if (allActive) allPill.classList.add("active");
        else allPill.classList.remove("active");

        // Show hint when something is deselected
        const inactive = Array.from(others)
          .filter((p) => !p.classList.contains("active"))
          .map((p) => p.textContent);
        if (inactive.length > 0) {
          const hint = document.getElementById("channelHint");
          const names = inactive.join(" & ");
          hint.style.display = "";
          document.getElementById("channelHintText").innerHTML =
            "<strong>" +
            names +
            " excluded.</strong> What would these cohort trends look like if " +
            names +
            ' were in the mix? <button class="btn-ghost" style="font-size:12px" onclick="openDrawer(\'attribution\')">Tag ' +
            names +
            " campaigns →</button>";
        } else {
          document.getElementById("channelHint").style.display = "none";
        }
        buildChart();
      }

      function setCreative(val) {
        chartState.creative = val;
        updateChartDirty();
        buildChart();
        if (val !== "all") {
          const name =
            document.getElementById("creativeSelect").selectedOptions[0].text;
          showToast('Showing cohort response to "' + name + '" creative');
        }
      }

      function toggleCompare() {
        document.getElementById("compareSelect").value = "";
        chartState.compare = "";
        updateChartDirty();
        buildChart();
      }

      function setCompare(val) {
        chartState.compare = val;
        if (chartState.view !== "cohort" && val) {
          setView(document.querySelector('#viewPills [data-view="cohort"]'));
          showToast("Switched to Cohort Mix view for competitor overlay");
        }
        updateChartDirty();
        buildChart();
        if (val)
          showToast(
            "Overlaying " + competitorData[val].name + " buyer segments",
          );
      }

      // ═══ CHART TYPE + ATTR METRIC ═══
      function renderPieCohortPanel(labels, data, colors, isAttr) {
        var panel = document.getElementById("pieCohortPanel");
        if (!panel) return;
        panel.style.display = "";
        var total = data.reduce(function (a, b) {
          return a + b;
        }, 0);
        var projectedSales = isAttr ? "$271.8K" : "$653K";
        var salesLabel = isAttr ? "Attributed Sales" : "Total Sales";
        var isInsights = currentMode === "insights";

        var cohortDollars = isAttr
          ? {
              Frequent: "$86.2K",
              "Ultra-Light": "$62.4K",
              Competitor: "$51.8K",
              "New-to-Category": "$38.1K",
              Loyal: "$22.4K",
              "Occasion-Driven": "$10.9K",
            }
          : {
              Frequent: "$208.4K",
              "Ultra-Light": "$135.7K",
              Competitor: "$104.2K",
              "New-to-Category": "$89.1K",
              Loyal: "$72.8K",
              "Occasion-Driven": "$42.8K",
            };

        var h = "";
        h +=
          '<div style="padding:6px 10px;background:var(--page-bg);border-radius:8px;margin-bottom:6px;text-align:center">';
        h +=
          '<div style="font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;color:var(--text-tertiary)">' +
          salesLabel +
          "</div>";
        h +=
          '<div style="font-size:20px;font-weight:800;color:var(--text-primary);margin:1px 0">' +
          projectedSales +
          "</div>";
        h += "</div>";

        labels.forEach(function (name, i) {
          var pct = ((data[i] / total) * 100).toFixed(1);
          var dollars = cohortDollars[name] || "";
          var cursor = isInsights ? "cursor:pointer" : "";
          var hover = isInsights
            ? "onmouseenter=\"this.style.background='var(--page-bg)'\" onmouseleave=\"this.style.background='transparent'\""
            : "";
          var click = isInsights
            ? "onclick=\"showToast('Building audience: " +
              name.replace(/'/g, "\\'") +
              "');setTimeout(function(){openDrawer('audience')},600)\""
            : "";
          h +=
            '<div style="display:flex;align-items:center;gap:6px;padding:5px 4px;border-radius:6px;' +
            cursor +
            '" ' +
            hover +
            " " +
            click +
            ">";
          h +=
            '<div style="width:8px;height:8px;border-radius:50%;background:' +
            colors[i] +
            ';flex-shrink:0"></div>';
          h +=
            '<div style="font-size:10.5px;font-weight:600;color:var(--text-primary);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' +
            name +
            "</div>";
          h +=
            '<div style="font-size:10px;color:var(--text-tertiary);flex-shrink:0;width:32px;text-align:right">' +
            pct +
            "%</div>";
          if (dollars)
            h +=
              '<div style="font-size:10.5px;font-weight:700;color:var(--text-primary);flex-shrink:0;width:48px;text-align:right">' +
              dollars +
              "</div>";
          h += "</div>";
        });

        if (isInsights) {
          h +=
            '<div style="margin-top:6px;text-align:center;font-size:9px;color:var(--teal);font-weight:600"><svg viewBox="0 0 24 24" width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:2px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Click a segment to activate</div>';
        }

        panel.innerHTML = h;
      }

      function updateHeroOnramp() {
        var el = document.getElementById("heroOnramp");
        if (!el) return;
        if (currentMode === "insights") {
          el.innerHTML =
            '<div class="inline-prompt teal"><div><div class="inline-prompt-text"><strong>See how these segments respond to your media.</strong> Activate these buyer cohorts as audiences, measure sales lift by segment, and track real-time conversion by cohort.</div><div class="inline-prompt-sub">Audiences deliver in 5 days. Full-funnel measurement via PMP.</div></div><button class="btn btn-teal btn-sm" onclick="openDrawer(\'audience\')" style="white-space:nowrap">Activate & Track →</button></div>';
        } else {
          el.innerHTML =
            '<div class="inline-prompt teal"><div><div class="inline-prompt-text"><strong>Scale what\u2019s converting.</strong> Build lookalike audiences from your highest-ROAS cohorts and activate them directly into your next campaign flight.</div><div class="inline-prompt-sub">Audiences built from verified converters. Ready in 5 business days.</div></div><button class="btn btn-teal btn-sm" onclick="openDrawer(\'audience\')" style="white-space:nowrap">Build Audience →</button></div>';
        }
      }

      function setChartType(t) {
        currentChartType = t;
        document
          .getElementById("chartLine")
          .classList.toggle("active", t === "line");
        document
          .getElementById("chartPie")
          .classList.toggle("active", t === "pie");
        updateChartDirty();
        buildChart();
      }
      function setAttrMetric(v) {
        currentAttrMetric = v;
        updateChartDirty();
        buildChart();
      }

      // ═══ MEDIA OPTIMIZATION GRID ═══
      var optDim = "channel";
      var optExpanded = {};
      var optSort = { col: null, asc: false };

      // Helper to generate sub-placements for a parent row
      function genSubs(parent, count) {
        var pubs = [
          "Hulu",
          "YouTube",
          "Peacock",
          "Roku",
          "Pluto TV",
          "Tubi",
          "Amazon Fire",
          "Samsung TV+",
          "Fox News App",
          "ESPN App",
          "CNN Go",
          "NYT",
          "BuzzFeed",
          "Reddit",
          "DV360 Open",
          "Xandr PMP",
          "Index Exch",
          "PubMatic",
          "Outbrain",
          "Taboola",
        ];
        var fmts_v = [
          ":30 Pre-Roll",
          ":15 Pre-Roll",
          ":30 Mid-Roll",
          ":06 Bumper",
          ":15 CTV",
          ":30 CTV",
        ];
        var fmts_d = [
          "300x250",
          "728x90",
          "320x50",
          "160x600",
          "970x250",
          "Native In-Feed",
        ];
        var subs = [];
        for (var s = 0; s < count; s++) {
          var pct = 0.35 - s * 0.05 + Math.random() * 0.04;
          if (pct < 0.02) pct = 0.02;
          var impr = Math.round(parent.impr * pct);
          var spend = Math.round(parent.spend * pct);
          var cpm = (spend / impr) * 1000;
          var isVid = parent.fmt === "video";
          var mNum = isVid
            ? parent.media_num * (0.7 + Math.random() * 0.5)
            : Math.max(0.02, parent.media_num * (0.4 + Math.random() * 1.2));
          var conv = Math.round(
            impr * (parent.conv / parent.impr) * (0.5 + Math.random()),
          );
          var sales = Math.round(
            conv * (parent.sales / parent.conv) * (0.7 + Math.random() * 0.6),
          );
          var cvr = conv / impr;
          var cpa = conv > 0 ? spend / conv : 0;
          var roas = spend > 0 ? sales / spend : 0;
          var nm = isVid
            ? fmts_v[s % fmts_v.length]
            : fmts_d[s % fmts_d.length];
          nm = pubs[s % pubs.length] + " — " + nm;
          subs.push({
            name: nm,
            impr: impr,
            spend: spend,
            cpm: cpm,
            fmt: parent.fmt,
            media_num: mNum,
            conv: conv,
            cvr: cvr,
            cpa: cpa,
            roas: roas,
            sales: sales,
          });
        }
        subs.sort(function (a, b) {
          return b.impr - a.impr;
        });
        return subs;
      }

      var optData = {
        channel: [
          {
            name: "CTV / OTT",
            impr: 4200000,
            spend: 84000,
            cpm: 20.0,
            fmt: "video",
            media_num: 94.2,
            conv: 3780,
            cvr: 0.09,
            cpa: 22.22,
            roas: 3.32,
            sales: 278880,
          },
          {
            name: "Pre-Roll Video",
            impr: 6800000,
            spend: 68000,
            cpm: 10.0,
            fmt: "video",
            media_num: 76.5,
            conv: 5440,
            cvr: 0.08,
            cpa: 12.5,
            roas: 5.84,
            sales: 397120,
          },
          {
            name: "Display Standard",
            impr: 12400000,
            spend: 49600,
            cpm: 4.0,
            fmt: "display",
            media_num: 0.08,
            conv: 4960,
            cvr: 0.04,
            cpa: 10.0,
            roas: 4.16,
            sales: 206336,
          },
          {
            name: "Native",
            impr: 3100000,
            spend: 21700,
            cpm: 7.0,
            fmt: "display",
            media_num: 0.22,
            conv: 2170,
            cvr: 0.07,
            cpa: 10.0,
            roas: 6.27,
            sales: 136071,
          },
          {
            name: "Social Display",
            impr: 8600000,
            spend: 51600,
            cpm: 6.0,
            fmt: "display",
            media_num: 0.14,
            conv: 3440,
            cvr: 0.04,
            cpa: 15.0,
            roas: 2.86,
            sales: 147600,
          },
          {
            name: "Audio / Podcast",
            impr: 1800000,
            spend: 16200,
            cpm: 9.0,
            fmt: "audio",
            media_num: 97.1,
            conv: 720,
            cvr: 0.04,
            cpa: 22.5,
            roas: 2.14,
            sales: 34668,
          },
        ],
        creative: [
          {
            name: "Whopper Value :30",
            impr: 9200000,
            spend: 73600,
            cpm: 8.0,
            fmt: "video",
            media_num: 88.4,
            conv: 7360,
            cvr: 0.08,
            cpa: 10.0,
            roas: 5.12,
            sales: 376832,
          },
          {
            name: "Flame Grilled :15",
            impr: 7400000,
            spend: 51800,
            cpm: 7.0,
            fmt: "video",
            media_num: 91.2,
            conv: 5180,
            cvr: 0.07,
            cpa: 10.0,
            roas: 4.87,
            sales: 252274,
          },
          {
            name: "Family Bundle 300x250",
            impr: 5600000,
            spend: 22400,
            cpm: 4.0,
            fmt: "display",
            media_num: 0.12,
            conv: 2240,
            cvr: 0.04,
            cpa: 10.0,
            roas: 3.94,
            sales: 88256,
          },
          {
            name: "BK App 728x90",
            impr: 4100000,
            spend: 20500,
            cpm: 5.0,
            fmt: "display",
            media_num: 0.19,
            conv: 2870,
            cvr: 0.07,
            cpa: 7.14,
            roas: 9.87,
            sales: 202335,
          },
          {
            name: "$5 Meal Deal Native",
            impr: 3800000,
            spend: 26600,
            cpm: 7.0,
            fmt: "display",
            media_num: 0.31,
            conv: 2660,
            cvr: 0.07,
            cpa: 10.0,
            roas: 6.43,
            sales: 170998,
          },
          {
            name: "Impossible Whopper :30",
            impr: 2400000,
            spend: 21600,
            cpm: 9.0,
            fmt: "video",
            media_num: 85.7,
            conv: 1440,
            cvr: 0.06,
            cpa: 15.0,
            roas: 2.22,
            sales: 47952,
          },
        ],
        publisher: [
          {
            name: "Hulu",
            impr: 3800000,
            spend: 76000,
            cpm: 20.0,
            fmt: "video",
            media_num: 96.1,
            conv: 3420,
            cvr: 0.09,
            cpa: 22.22,
            roas: 3.68,
            sales: 279680,
          },
          {
            name: "YouTube",
            impr: 5200000,
            spend: 41600,
            cpm: 8.0,
            fmt: "video",
            media_num: 72.3,
            conv: 4160,
            cvr: 0.08,
            cpa: 10.0,
            roas: 5.38,
            sales: 223808,
          },
          {
            name: "Open Exchange",
            impr: 14800000,
            spend: 44400,
            cpm: 3.0,
            fmt: "display",
            media_num: 0.06,
            conv: 4440,
            cvr: 0.03,
            cpa: 10.0,
            roas: 3.24,
            sales: 143856,
          },
          {
            name: "Meta Audience Net.",
            impr: 6200000,
            spend: 37200,
            cpm: 6.0,
            fmt: "display",
            media_num: 0.11,
            conv: 2480,
            cvr: 0.04,
            cpa: 15.0,
            roas: 2.58,
            sales: 95976,
          },
          {
            name: "Spotify",
            impr: 1800000,
            spend: 16200,
            cpm: 9.0,
            fmt: "audio",
            media_num: 97.1,
            conv: 720,
            cvr: 0.04,
            cpa: 22.5,
            roas: 2.14,
            sales: 34668,
          },
          {
            name: "Peacock",
            impr: 1600000,
            spend: 35200,
            cpm: 22.0,
            fmt: "video",
            media_num: 97.8,
            conv: 1280,
            cvr: 0.08,
            cpa: 27.5,
            roas: 2.48,
            sales: 87296,
          },
        ],
        format: [
          {
            name: "CTV Video :30",
            impr: 4200000,
            spend: 84000,
            cpm: 20.0,
            fmt: "video",
            media_num: 94.2,
            conv: 3780,
            cvr: 0.09,
            cpa: 22.22,
            roas: 3.32,
            sales: 278880,
          },
          {
            name: "Pre-Roll :15",
            impr: 4800000,
            spend: 33600,
            cpm: 7.0,
            fmt: "video",
            media_num: 81.3,
            conv: 3840,
            cvr: 0.08,
            cpa: 8.75,
            roas: 7.14,
            sales: 240000,
          },
          {
            name: "Pre-Roll :30",
            impr: 2000000,
            spend: 20000,
            cpm: 10.0,
            fmt: "video",
            media_num: 69.4,
            conv: 1600,
            cvr: 0.08,
            cpa: 12.5,
            roas: 4.8,
            sales: 96000,
          },
          {
            name: "Display 300x250",
            impr: 7200000,
            spend: 28800,
            cpm: 4.0,
            fmt: "display",
            media_num: 0.09,
            conv: 2880,
            cvr: 0.04,
            cpa: 10.0,
            roas: 3.61,
            sales: 103968,
          },
          {
            name: "Display 728x90",
            impr: 5200000,
            spend: 20800,
            cpm: 4.0,
            fmt: "display",
            media_num: 0.06,
            conv: 2080,
            cvr: 0.04,
            cpa: 10.0,
            roas: 4.14,
            sales: 86112,
          },
          {
            name: "Native In-Feed",
            impr: 3800000,
            spend: 26600,
            cpm: 7.0,
            fmt: "display",
            media_num: 0.31,
            conv: 2660,
            cvr: 0.07,
            cpa: 10.0,
            roas: 6.43,
            sales: 170998,
          },
        ],
        device: [
          {
            name: "Mobile",
            impr: 18200000,
            spend: 109200,
            cpm: 6.0,
            fmt: "display",
            media_num: 0.14,
            conv: 9100,
            cvr: 0.05,
            cpa: 12.0,
            roas: 4.58,
            sales: 500136,
          },
          {
            name: "Desktop",
            impr: 8400000,
            spend: 50400,
            cpm: 6.0,
            fmt: "display",
            media_num: 0.09,
            conv: 3360,
            cvr: 0.04,
            cpa: 15.0,
            roas: 3.22,
            sales: 162288,
          },
          {
            name: "CTV",
            impr: 5800000,
            spend: 116000,
            cpm: 20.0,
            fmt: "video",
            media_num: 95.1,
            conv: 5220,
            cvr: 0.09,
            cpa: 22.22,
            roas: 3.05,
            sales: 353880,
          },
          {
            name: "Tablet",
            impr: 1200000,
            spend: 7200,
            cpm: 6.0,
            fmt: "display",
            media_num: 0.07,
            conv: 480,
            cvr: 0.04,
            cpa: 15.0,
            roas: 2.89,
            sales: 20808,
          },
        ],
        platform: [
          {
            name: "The Trade Desk",
            impr: 18400000,
            spend: 147200,
            cpm: 8.0,
            fmt: "display",
            media_num: 0.12,
            conv: 11040,
            cvr: 0.06,
            cpa: 13.33,
            roas: 4.82,
            sales: 709504,
            logo: "TTD",
          },
          {
            name: "DV360",
            impr: 10200000,
            spend: 61200,
            cpm: 6.0,
            fmt: "display",
            media_num: 0.09,
            conv: 5100,
            cvr: 0.05,
            cpa: 12.0,
            roas: 4.14,
            sales: 253368,
            logo: "DV",
          },
          {
            name: "Direct Publishers",
            impr: 5000000,
            spend: 82500,
            cpm: 16.5,
            fmt: "video",
            media_num: 93.6,
            conv: 4000,
            cvr: 0.08,
            cpa: 20.63,
            roas: 3.28,
            sales: 270600,
            logo: "DP",
          },
        ],
      };

      var availablePlatforms = {
        dataIn: [
          {
            name: "The Trade Desk",
            color: "#0099FA",
            status: "active",
            desc: "Programmatic measurement via PMP tags",
            stats: "18.4M impr · 4.82x ROAS",
            icon: '<svg viewBox="0 0 28 28" width="20" height="20"><rect x="2" y="6" width="6" height="16" rx="1" fill="#0099FA"/><rect x="11" y="2" width="6" height="24" rx="1" fill="#0099FA"/><rect x="20" y="10" width="6" height="12" rx="1" fill="#0099FA"/></svg>',
          },
          {
            name: "DV360",
            color: "#4285f4",
            status: "active",
            desc: "Google programmatic campaign attribution",
            stats: "10.2M impr · 4.14x ROAS",
            icon: '<svg viewBox="0 0 28 28" width="20" height="20"><path d="M14 3L3 8v5c0 7.2 4.7 13.5 11 15 6.3-1.5 11-7.8 11-15V8L14 3z" fill="none" stroke="#4285f4" stroke-width="2"/><path d="M9 14l3 3 7-7" fill="none" stroke="#4285f4" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
          },
          {
            name: "Direct Publishers",
            color: "#6c5ce7",
            status: "active",
            desc: "Publisher-direct deal measurement",
            stats: "5M impr · 3.28x ROAS",
            icon: '<svg viewBox="0 0 28 28" width="20" height="20"><rect x="3" y="4" width="22" height="20" rx="3" fill="none" stroke="#6c5ce7" stroke-width="2"/><line x1="3" y1="10" x2="25" y2="10" stroke="#6c5ce7" stroke-width="2"/><line x1="10" y1="10" x2="10" y2="24" stroke="#6c5ce7" stroke-width="2"/></svg>',
          },
          {
            name: "Yahoo DSP",
            color: "#6001d2",
            status: "off",
            desc: "Closed-loop attribution for Yahoo demand-side buys",
            icon: '<svg viewBox="0 0 28 28" width="20" height="20"><path d="M4 6l7 9v7h6v-7l7-9" fill="none" stroke="#6001d2" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
          },
          {
            name: "Roku OneView",
            color: "#662d91",
            status: "off",
            desc: "CTV-to-purchase measurement for Roku campaigns",
            icon: '<svg viewBox="0 0 28 28" width="20" height="20"><rect x="3" y="5" width="22" height="14" rx="2" fill="none" stroke="#662d91" stroke-width="2"/><line x1="10" y1="22" x2="18" y2="22" stroke="#662d91" stroke-width="2" stroke-linecap="round"/><line x1="14" y1="19" x2="14" y2="22" stroke="#662d91" stroke-width="2"/><circle cx="14" cy="12" r="3" fill="#662d91" opacity=".3"/></svg>',
          },
          {
            name: "Amazon DSP",
            color: "#ff9900",
            status: "off",
            desc: "Measure purchase outcomes from Amazon programmatic campaigns",
            icon: '<svg viewBox="0 0 28 28" width="20" height="20"><path d="M6 18c4 3 12 3 16 0" fill="none" stroke="#ff9900" stroke-width="2.5" stroke-linecap="round"/><path d="M20 18l2.5-1" fill="none" stroke="#ff9900" stroke-width="2.5" stroke-linecap="round"/><text x="14" y="14" text-anchor="middle" font-size="11" font-weight="800" fill="#ff9900">a</text></svg>',
          },
          {
            name: "Walmart DSP",
            color: "#0071dc",
            status: "off",
            desc: "Connect in-store and online purchase data to Walmart media",
            icon: '<svg viewBox="0 0 28 28" width="20" height="20"><line x1="14" y1="4" x2="14" y2="12" stroke="#0071dc" stroke-width="3" stroke-linecap="round"/><line x1="6" y1="10" x2="10" y2="16" stroke="#0071dc" stroke-width="3" stroke-linecap="round"/><line x1="22" y1="10" x2="18" y2="16" stroke="#0071dc" stroke-width="3" stroke-linecap="round"/><line x1="14" y1="24" x2="14" y2="16" stroke="#0071dc" stroke-width="3" stroke-linecap="round"/><line x1="6" y1="18" x2="10" y2="12" stroke="#0071dc" stroke-width="3" stroke-linecap="round"/><line x1="22" y1="18" x2="18" y2="12" stroke="#0071dc" stroke-width="3" stroke-linecap="round"/></svg>',
          },
        ],
        dataOut: [
          {
            name: "Meta CAPI",
            color: "#0081fb",
            status: "active",
            desc: "Server-side conversion feed",
            stats: "3.2K events/day · 94% match rate",
            icon: '<svg viewBox="0 0 28 28" width="20" height="20"><path d="M14 4C8.5 4 4 8.5 4 14s4.5 10 10 10 10-4.5 10-10S19.5 4 14 4z" fill="none" stroke="#0081fb" stroke-width="2"/><path d="M14 4c-3 0-5 4.5-5 10s2 10 5 10 5-4.5 5-10-2-10-5-10z" fill="none" stroke="#0081fb" stroke-width="1.5"/><line x1="4" y1="14" x2="24" y2="14" stroke="#0081fb" stroke-width="1.5"/></svg>',
          },
          {
            name: "Google Ads",
            color: "#4285f4",
            status: "active",
            desc: "Offline conversion import",
            stats: "1.8K events/day · 89% match rate",
            icon: '<svg viewBox="0 0 28 28" width="20" height="20"><circle cx="9" cy="19" r="5" fill="#4285f4" opacity=".2" stroke="#4285f4" stroke-width="1.5"/><rect x="12" y="4" width="5" height="20" rx="2.5" fill="#fbbc04" opacity=".8"/><rect x="4" y="4" width="5" height="20" rx="2.5" fill="#4285f4" opacity=".8" transform="rotate(-30 6.5 14)"/></svg>',
          },
          {
            name: "TikTok Events API",
            color: "#010101",
            status: "off",
            desc: "Purchase attribution for TikTok ad campaigns",
            icon: '<svg viewBox="0 0 28 28" width="20" height="20"><path d="M18 5c0 3 2.5 5 5 5.5v4c-2.5 0-4.5-1-5.5-2v7.5c0 4-3 7-7 7s-7-3-7-7 3-7 7-7v4c-1.7 0-3 1.3-3 3s1.3 3 3 3 3-1.3 3-3V5h4z" fill="#010101" opacity=".7"/></svg>',
          },
          {
            name: "Snap CAPI",
            color: "#FFFC00",
            status: "off",
            desc: "Push purchase signals to Snap ad optimization",
            icon: '<svg viewBox="0 0 28 28" width="20" height="20"><path d="M14 4c-3 0-5.5 2-5.5 5.5 0 2-.5 4-2.5 5 1 .5 2.5 1 2 2-.3.8-2 1.5-2 1.5s2.5.5 3 1.5c.3.5-.5 1.5-.5 1.5s2-1 5-1 5 1 5 1-.8-1-.5-1.5c.5-1 3-1.5 3-1.5s-1.7-.7-2-1.5c-.5-1 1-1.5 2-2-2-1-2.5-3-2.5-5C19.5 6 17 4 14 4z" fill="#FFFC00" stroke="#ccc" stroke-width=".5"/></svg>',
          },
          {
            name: "Pinterest CAPI",
            color: "#e60023",
            status: "off",
            desc: "Conversion event feed for Pinterest campaigns",
            icon: '<svg viewBox="0 0 28 28" width="20" height="20"><circle cx="14" cy="14" r="10" fill="none" stroke="#e60023" stroke-width="2"/><path d="M14 7c-3 0-5.5 2.5-5.5 5.5 0 2 1 3.5 2.5 4.3 0-.5 0-1 .3-1.5l1-3.5s-.3-.5-.3-1.2c0-1.2.7-2 1.5-2s1.2.5 1.2 1.3c0 .8-.5 2-.8 3 0 .8.5 1.3 1.3 1.3 1.5 0 2.5-2 2.5-4.3 0-1.8-1.2-3-3.5-3-2.5 0-4 2-4 4 0 .7.2 1.2.5 1.5.2.2.2.3.2.4l-.2.7c0 .2-.2.3-.3.2-1.2-.5-1.8-2-1.8-3.3 0-2.5 2-5.3 6-5.3s5.2 2.8 5.2 5.3c0 3.2-1.8 5.5-4.5 5.5-.8 0-1.7-.5-2-1l-.5 2.2c-.2.7-.7 1.5-1 2" fill="#e60023"/></svg>',
          },
        ],
      };

      // Cache generated subs
      var optSubCache = {};

      function setOptDim(dim, el) {
        optDim = dim;
        optExpanded = {};
        optSort = { col: null, asc: false };
        document.querySelectorAll(".opt-tab").forEach(function (t) {
          t.classList.remove("active");
        });
        if (el) el.classList.add("active");
        renderOptGrid();
      }

      function toggleOptRow(idx) {
        optExpanded[idx] = !optExpanded[idx];
        renderOptGrid();
      }

      function sortOptCol(col) {
        if (optSort.col === col) optSort.asc = !optSort.asc;
        else {
          optSort.col = col;
          optSort.asc = false;
        }
        optExpanded = {};
        renderOptGrid();
      }

      function getMediaMetrics(r) {
        // Return the format-appropriate media metrics with calc breakdown
        if (r.fmt === "video") {
          var completions = Math.round((r.impr * r.media_num) / 100);
          var cpcv = r.spend / completions;
          return {
            metric: "VCR",
            val: r.media_num.toFixed(1) + "%",
            calc:
              completions.toLocaleString() +
              " completions ÷ " +
              r.impr.toLocaleString() +
              " impr",
            secondary: "CPCV",
            secVal: "$" + cpcv.toFixed(3),
            secCalc:
              "$" +
              (r.spend / 1000).toFixed(0) +
              "K spend ÷ " +
              completions.toLocaleString() +
              " compl.",
          };
        } else if (r.fmt === "audio") {
          var listens = Math.round((r.impr * r.media_num) / 100);
          var cpl = r.spend / listens;
          return {
            metric: "Listen Rate",
            val: r.media_num.toFixed(1) + "%",
            calc:
              listens.toLocaleString() +
              " listens ÷ " +
              r.impr.toLocaleString() +
              " impr",
            secondary: "CPL",
            secVal: "$" + cpl.toFixed(3),
            secCalc:
              "$" +
              (r.spend / 1000).toFixed(0) +
              "K spend ÷ " +
              listens.toLocaleString() +
              " listens",
          };
        } else {
          var clicks = Math.round((r.impr * r.media_num) / 100);
          var cpc = clicks > 0 ? r.spend / clicks : 0;
          return {
            metric: "CTR",
            val: r.media_num.toFixed(2) + "%",
            calc:
              clicks.toLocaleString() +
              " clicks ÷ " +
              r.impr.toLocaleString() +
              " impr",
            secondary: "CPC",
            secVal: "$" + cpc.toFixed(2),
            secCalc:
              "$" +
              (r.spend / 1000).toFixed(0) +
              "K spend ÷ " +
              clicks.toLocaleString() +
              " clicks",
          };
        }
      }

      function computeEfficiency(r, outcome) {
        // Media-to-Outcome ratio: normalizes media metric vs outcome metric
        // High = media effort converts well to sales outcomes
        // Low = lots of media activity but poor outcome yield
        var mediaScore = r.media_num;
        var outcomeScore;
        if (outcome === "roas") outcomeScore = r.roas;
        else if (outcome === "cvr") outcomeScore = r.cvr * 100;
        else if (outcome === "cpa")
          outcomeScore = (1 / (r.cpa || 1)) * 100; // invert
        else outcomeScore = r.sales / r.spend; // sales efficiency

        // Normalize: for video/audio, media_num is 60-100 range. For display, 0.01-0.5 range.
        // We want the ratio to be comparable, so express as outcome per unit of media cost
        // Simpler: outcome per $1 CPM (cost efficiency)
        var costEfficiency;
        if (outcome === "roas") costEfficiency = r.roas;
        else if (outcome === "cvr")
          costEfficiency = (r.cvr * 100) / (r.cpm / 5); // normalize by cpm
        else if (outcome === "cpa")
          costEfficiency = (5 / (r.cpa || 1)) * 10; // invert, normalize
        else costEfficiency = r.sales / r.spend;

        return costEfficiency;
      }

      function renderOptGrid() {
        var rows = optData[optDim];
        if (!rows) return;
        var outcome = document.getElementById("optMetricSelect").value;
        var maxImpr = Math.max.apply(
          null,
          rows.map(function (r) {
            return r.impr;
          }),
        );
        var outcomeLabel = {
          cvr: "CVR",
          roas: "ROAS",
          cpa: "CPA",
          sales: "Sales",
        }[outcome];

        // Compute efficiency scores for color grading
        var effScores = rows.map(function (r) {
          return computeEfficiency(r, outcome);
        });
        var effSorted = effScores.slice().sort(function (a, b) {
          return b - a;
        });
        var effQ1 = effSorted[Math.floor(effSorted.length * 0.25)];
        var effQ2 = effSorted[Math.floor(effSorted.length * 0.5)];

        function pillClass(v) {
          if (v >= effQ1) return "top";
          if (v >= effQ2) return "good";
          return "low";
        }
        function fmtOutcome(r) {
          if (outcome === "cvr") return (r.cvr * 100).toFixed(2) + "%";
          if (outcome === "roas") return "$" + r.roas.toFixed(2);
          if (outcome === "cpa") return "$" + r.cpa.toFixed(2);
          return "$" + (r.sales / 1000).toFixed(0) + "K";
        }
        function fmtNum(n) {
          if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
          if (n >= 1000) return (n / 1000).toFixed(0) + "K";
          return n.toString();
        }
        function effLabel(score) {
          // Express as ratio: x.xx : 1
          var ratio = Math.max(0.01, score);
          if (outcome === "cpa") ratio = score;
          if (ratio >= 10) return ratio.toFixed(0) + " : 1";
          if (ratio >= 1) return ratio.toFixed(1) + " : 1";
          return ratio.toFixed(2) + " : 1";
        }

        // Header — clickable for sorting
        function sHdr(label, col, cls, extra) {
          var arrow = optSort.col === col ? (optSort.asc ? " ↑" : " ↓") : "";
          var style = optSort.col === col ? "color:var(--purple-accent)" : "";
          return (
            '<th class="' +
            cls +
            '" style="cursor:pointer;' +
            style +
            ";" +
            (extra || "") +
            '" onclick="sortOptCol(\'' +
            col +
            "')\">" +
            label +
            arrow +
            "</th>"
          );
        }
        var hd = sHdr(
          optDim.charAt(0).toUpperCase() + optDim.slice(1),
          "name",
          "media-col",
          "text-align:left",
        );
        hd += sHdr("Impr.", "impr", "media-col");
        hd += sHdr("Spend", "spend", "media-col");
        hd += sHdr("CPM", "cpm", "media-col");
        hd += '<th class="media-col" colspan="2">Media Metric</th>';
        hd += '<th class="divider-col"></th>';
        hd += sHdr("Conv.", "conv", "outcome-col");
        hd += sHdr(outcomeLabel, "outcome", "outcome-col");
        hd += sHdr("Efficiency", "eff", "outcome-col");
        document.getElementById("optHead").innerHTML = hd;

        // Sort rows if active
        var indexed = rows.map(function (r, i) {
          return { r: r, i: i, eff: effScores[i] };
        });
        if (optSort.col) {
          indexed.sort(function (a, b) {
            var av, bv;
            if (optSort.col === "name") {
              av = a.r.name.toLowerCase();
              bv = b.r.name.toLowerCase();
              return optSort.asc ? av.localeCompare(bv) : bv.localeCompare(av);
            }
            if (optSort.col === "impr") {
              av = a.r.impr;
              bv = b.r.impr;
            } else if (optSort.col === "spend") {
              av = a.r.spend;
              bv = b.r.spend;
            } else if (optSort.col === "cpm") {
              av = a.r.cpm;
              bv = b.r.cpm;
            } else if (optSort.col === "conv") {
              av = a.r.conv;
              bv = b.r.conv;
            } else if (optSort.col === "outcome") {
              if (outcome === "cvr") {
                av = a.r.cvr;
                bv = b.r.cvr;
              } else if (outcome === "roas") {
                av = a.r.roas;
                bv = b.r.roas;
              } else if (outcome === "cpa") {
                av = a.r.cpa;
                bv = b.r.cpa;
                return optSort.asc ? av - bv : bv - av;
              } // CPA lower is better but still sort by value
              else {
                av = a.r.sales;
                bv = b.r.sales;
              }
            } else if (optSort.col === "eff") {
              av = a.eff;
              bv = b.eff;
            } else {
              av = 0;
              bv = 0;
            }
            return optSort.asc ? av - bv : bv - av;
          });
        }

        // Body
        var bd = "";
        indexed.forEach(function (item) {
          var r = item.r,
            i = item.i;
          var barW = ((r.impr / maxImpr) * 100).toFixed(0);
          var mm = getMediaMetrics(r);
          var eff = item.eff;
          var pc = pillClass(eff);
          var hasChildren = true;
          var isOpen = !!optExpanded[i];
          var chevron =
            '<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.5" style="transition:transform .2s;transform:rotate(' +
            (isOpen ? "90" : "0") +
            'deg);flex-shrink:0"><polyline points="9 18 15 12 9 6"/></svg>';

          bd +=
            '<tr class="opt-parent" onclick="toggleOptRow(' +
            i +
            ')" style="cursor:pointer">';
          bd +=
            '<td style="position:relative"><div class="opt-imp-bar" style="width:' +
            barW +
            '%;background:var(--purple-accent)"></div><span style="position:relative;z-index:1;display:flex;align-items:center;gap:6px">' +
            chevron +
            r.name +
            "</span></td>";
          bd += "<td>" + fmtNum(r.impr) + "</td>";
          bd += "<td>$" + fmtNum(r.spend) + "</td>";
          bd += "<td>$" + r.cpm.toFixed(2) + "</td>";
          // Media metric with calc tooltip
          bd +=
            '<td style="font-size:9px;font-weight:600;color:var(--text-tertiary);text-align:right;padding-right:2px" title="' +
            mm.calc +
            '">' +
            mm.metric +
            "</td>";
          bd +=
            '<td style="font-weight:700;padding-left:4px" title="' +
            mm.calc +
            '">' +
            mm.val +
            "</td>";
          bd += '<td class="divider-col"></td>';
          bd += '<td style="font-weight:700">' + fmtNum(r.conv) + "</td>";
          bd +=
            '<td><span class="opt-pill ' +
            pc +
            '">' +
            fmtOutcome(r) +
            "</span></td>";
          bd +=
            '<td><span class="opt-signal ' +
            pc +
            '" title="Media cost to outcome ratio" style="font-size:10px">' +
            effLabel(eff) +
            "</span></td>";
          bd += "</tr>";

          // Sub-placements (if expanded)
          if (isOpen) {
            var cacheKey = optDim + "_" + i;
            if (!optSubCache[cacheKey]) optSubCache[cacheKey] = genSubs(r, 8);
            var subs = optSubCache[cacheKey];
            var subMax = Math.max.apply(
              null,
              subs.map(function (s) {
                return s.impr;
              }),
            );
            subs.forEach(function (sub, si) {
              var subBarW = ((sub.impr / subMax) * 100).toFixed(0);
              var smm = getMediaMetrics(sub);
              var subEff = computeEfficiency(sub, outcome);
              var spc = pillClass(subEff);
              bd += '<tr class="opt-child">';
              bd +=
                '<td style="padding-left:32px;position:relative;font-weight:500;color:var(--text-secondary);font-size:11px"><div class="opt-imp-bar" style="width:' +
                subBarW +
                '%;background:var(--teal)"></div><span style="position:relative;z-index:1">' +
                sub.name +
                "</span></td>";
              bd +=
                '<td style="font-size:11px;color:var(--text-secondary)">' +
                fmtNum(sub.impr) +
                "</td>";
              bd +=
                '<td style="font-size:11px;color:var(--text-secondary)">$' +
                fmtNum(sub.spend) +
                "</td>";
              bd +=
                '<td style="font-size:11px;color:var(--text-secondary)">$' +
                sub.cpm.toFixed(2) +
                "</td>";
              bd +=
                '<td style="font-size:8px;font-weight:600;color:var(--text-tertiary);text-align:right;padding-right:2px" title="' +
                smm.calc +
                '">' +
                smm.metric +
                "</td>";
              bd +=
                '<td style="font-weight:600;font-size:11px;padding-left:4px" title="' +
                smm.calc +
                '">' +
                smm.val +
                "</td>";
              bd += '<td class="divider-col"></td>';
              bd +=
                '<td style="font-size:11px;font-weight:600">' +
                fmtNum(sub.conv) +
                "</td>";
              bd +=
                '<td><span class="opt-pill ' +
                spc +
                '" style="font-size:10px;padding:2px 6px">' +
                fmtOutcome(sub) +
                "</span></td>";
              bd +=
                '<td><span class="opt-signal ' +
                spc +
                '" style="font-size:9px">' +
                effLabel(subEff) +
                "</span></td>";
              bd += "</tr>";
            });
          }
        });
        document.getElementById("optBody").innerHTML = bd;

        // Insight
        var best = rows.slice().sort(function (a, b) {
          return computeEfficiency(b, outcome) - computeEfficiency(a, outcome);
        })[0];
        var worst = rows.slice().sort(function (a, b) {
          return computeEfficiency(a, outcome) - computeEfficiency(b, outcome);
        })[0];
        var insight =
          '<span style="font-weight:700;color:var(--purple-accent)">⚡ Optimization signal:</span> ';
        insight +=
          "<strong>" +
          best.name +
          "</strong> delivers the best efficiency at " +
          effLabel(computeEfficiency(best, outcome)) +
          " (media cost → " +
          outcomeLabel +
          ") on " +
          fmtNum(best.impr) +
          " impressions. ";
        if (best.name !== worst.name) {
          insight +=
            "<strong>" +
            worst.name +
            "</strong> shows weakest conversion at " +
            effLabel(computeEfficiency(worst, outcome)) +
            " — consider reallocating budget or testing new placements.";
        }
        document.getElementById("optInsight").innerHTML = insight;

        // Platform integrations section (always visible)
        var apEl = document.getElementById("optAvailPlatforms");
        if (apEl) apEl.remove();
        var apHTML =
          '<div id="optAvailPlatforms" style="margin-top:16px;border-top:2px solid var(--card-border);padding-top:14px">';

        function renderPlatformGroup(title, subtitle, icon, platforms) {
          apHTML +=
            '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;margin-top:4px"><div style="display:flex;align-items:center;gap:6px"><span style="font-size:13px">' +
            icon +
            '</span><span style="font-size:11px;font-weight:700;color:var(--text-primary)">' +
            title +
            '</span><span style="font-size:9px;color:var(--text-tertiary);font-weight:500">' +
            subtitle +
            "</span></div></div>";
          apHTML +=
            '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:6px;margin-bottom:14px">';
          platforms.forEach(function (p) {
            var isActive = p.status === "active";
            var borderStyle = isActive
              ? "border:1px solid #c8e8d8"
              : "border:1px dashed #d8d6de";
            var bg = isActive ? "#f4fbf8" : "#fafafa";
            var statusBadge = isActive
              ? '<div style="display:flex;align-items:center;gap:3px;flex-shrink:0"><div style="width:6px;height:6px;border-radius:50%;background:#00b894;animation:pulse 2s infinite"></div><span style="font-size:8px;font-weight:600;color:#00b894">LIVE</span></div>'
              : '<button class="btn btn-sm" style="font-size:8px;padding:2px 8px;border:1px dashed var(--purple-accent);color:var(--purple-accent);background:none;white-space:nowrap;flex-shrink:0" onclick="event.stopPropagation();showToast(\'' +
                p.name +
                " integration requested — our team will reach out')\">Connect →</button>";
            var statsLine = p.stats
              ? '<div style="font-size:8px;color:#00b894;font-weight:600;margin-top:2px">' +
                p.stats +
                "</div>"
              : "";
            var iconEl = p.icon
              ? '<div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;flex-shrink:0;opacity:' +
                (isActive ? "1" : ".4") +
                '">' +
                p.icon +
                "</div>"
              : '<div style="width:28px;height:28px;border-radius:6px;background:' +
                p.color +
                "15;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:8px;font-weight:800;color:" +
                p.color +
                '">' +
                p.logo +
                "</div>";
            apHTML +=
              '<div style="' +
              borderStyle +
              ";border-radius:8px;padding:10px 12px;display:flex;align-items:center;gap:8px;background:" +
              bg +
              ';transition:all .15s">';
            apHTML += iconEl;
            apHTML +=
              '<div style="flex:1;min-width:0"><div style="font-size:10px;font-weight:700;color:' +
              (isActive ? "var(--text-primary)" : "var(--text-secondary)") +
              '">' +
              p.name +
              '</div><div style="font-size:8px;color:var(--text-secondary);line-height:1.3">' +
              p.desc +
              "</div>" +
              statsLine +
              "</div>";
            apHTML += statusBadge;
            apHTML += "</div>";
          });
          apHTML += "</div>";
        }

        renderPlatformGroup(
          "Data In",
          "DSP & programmatic measurement",
          "📡",
          availablePlatforms.dataIn,
        );
        renderPlatformGroup(
          "Data Out",
          "CAPI & conversion feeds",
          "📤",
          availablePlatforms.dataOut,
        );

        apHTML += "</div>";
        document
          .getElementById("optInsight")
          .insertAdjacentHTML("afterend", apHTML);
      }

      // ═══ MEASURED CAMPAIGNS ═══
      var mcExpanded = {};
      var mcRecapOpen = {};
      var measuredCampaigns = [
        {
          id: "mc1",
          advertiser: "Burger King",
          name: 'Black Friday "Flame Deals" Blitz',
          status: "active",
          study: "Sales Lift",
          dates: "Nov 15 – Dec 15, 2025",
          context:
            "Drive incremental sales and net-new buyer acquisition through conquest targeting of competitive QSR buyers via CTV + Display, achieving iROAS above 3.0x",
          kpis: "iROAS > 3.0x, NNB acquisition +15% vs baseline, incremental sales $1M+",
          audience:
            "Competitive QSR buyers (McDonald's, Wendy's, Popeye's switchers), Lapsed BK 90d+",
          channels: "CTV :30, CTV :15, Display 300x250, Native In-Feed",
          spend: "$312K",
          iRoas: "4.2x",
          incSales: "$1.31M",
          incTxnLift: "18.7%",
          incSalesLift: "12.4%",
          cvr: "6.8%",
          roas: "5.12x",
          nnbRoas: "3.87x",
          recap:
            "<strong>On track to exceed targets.</strong> Through week 4, iROAS is holding at 4.2x with strong Competitor Conquest conversion — 34% of incremental sales from McDonald's/Wendy's switchers. CTV :30 is the top-performing format at 6.1x iROAS, while Display 300x250 is underperforming at 1.8x. Recommend shifting 15% of display budget to CTV for remaining 2 weeks. Net-new buyer acquisition is 22% above forecast.",
        },
        {
          id: "mc2",
          advertiser: "Burger King",
          name: "Q1 2025 Whopper Conquest Campaign",
          status: "active",
          study: "Brand Lift & Sales Impact",
          dates: "Jan 6 – Mar 31, 2025",
          context:
            "Full-funnel brand and sales measurement for Whopper-focused conquest campaign targeting competitive QSR households in top 20 DMAs",
          kpis: "Brand awareness +5pp, purchase intent +8pp, iROAS > 3.0x, regional lift parity",
          audience: "Competitive QSR households in top 20 DMAs, 18-49 demo",
          channels: "CTV :30, CTV :15, OLV :15, Native",
          spend: "$485K",
          iRoas: "3.8x",
          incSales: "$1.84M",
          incTxnLift: "14.2%",
          incSalesLift: "9.8%",
          cvr: "5.4%",
          roas: "4.67x",
          nnbRoas: "3.21x",
          recap:
            '<strong>Full-funnel measurement in progress.</strong> Brand lift survey shows +8.4pp unaided awareness lift and +12.1pp purchase intent lift among exposed vs control. Sales impact is strongest in Southeast (+16.2% lift) and weakest in Northeast (+6.1%). The "Flame Grilled :15" creative is driving highest brand recall at 31% while "Whopper Value :30" drives strongest sales conversion. Recommend extending flight by 2 weeks based on current momentum.',
        },
        {
          id: "mc3",
          advertiser: "Burger King",
          name: "Summer BBQ Season Push",
          status: "completed",
          study: "Sales Lift",
          dates: "Jun 1 – Aug 15, 2024",
          context:
            "Seasonal sales lift study measuring incremental impact of summer campaign on lapsed and light buyer reactivation",
          kpis: "iROAS > 2.5x, lapsed buyer reactivation +10%, NNB share > 15%",
          audience:
            "Lapsed BK 90d+, Ultra-Light 1-2 purchases/quarter, seasonal QSR intenders",
          channels: "CTV :30, Display 300x250, Native In-Feed",
          spend: "$224K",
          iRoas: "3.1x",
          incSales: "$694K",
          incTxnLift: "11.3%",
          incSalesLift: "7.6%",
          cvr: "4.9%",
          roas: "3.94x",
          nnbRoas: "2.64x",
          recap:
            "<strong>Study complete — final results delivered.</strong> Campaign drove $694K in verified incremental sales at 3.1x iROAS. Top performing audience was Lapsed Buyers (5.8x iROAS) who returned at 2.4x higher frequency than control. CTV + Native combination delivered strongest cross-channel incrementality. 18% of all incremental transactions were from net-new buyers with no prior BK purchase history. Full report exported to Reports shelf.",
        },
        {
          id: "mc4",
          advertiser: "Burger King",
          name: "Impossible Whopper Health-Conscious Launch",
          status: "completed",
          study: "Brand Lift & Visitation & Sales Impact",
          dates: "Mar 1 – May 30, 2024",
          context:
            "Multi-methodology study measuring brand perception shift, foot traffic incrementality, and sales impact for plant-based menu launch targeting health-conscious demographics",
          kpis: 'Perception shift +5pp "healthy options", visitation lift +10%, Gen Z/Millennial iROAS > 2.0x',
          audience:
            "Health-conscious consumers 18-44, flexitarian/plant-curious, competitive health QSR (Chipotle, Sweetgreen)",
          channels: "CTV :30, CTV :15, OLV :15, Social, Display",
          spend: "$178K",
          iRoas: "2.4x",
          incSales: "$427K",
          incTxnLift: "8.1%",
          incSalesLift: "5.2%",
          cvr: "3.8%",
          roas: "3.22x",
          nnbRoas: "2.91x",
          recap:
            '<strong>Study complete — multi-methodology results.</strong> Brand lift showed +6.2pp in "BK has healthy options" perception among target demo. Foot traffic attribution confirmed a 12.8% incremental visitation lift within 1mi of store locations in test markets. Sales impact was concentrated in Gen Z / Millennial segments (4.1x iROAS) while Boomer+ showed negligible lift (0.9x). This audience-specific signal led to mid-flight reallocation that improved overall iROAS from 1.8x to 2.4x.',
        },
      ];

      function renderMeasuredCampaigns() {
        var body = document.getElementById("mcBody");
        if (!body) return;
        var filter = document.getElementById("mcFilter").value;
        var filtered = measuredCampaigns.filter(function (c) {
          return filter === "all" || c.status === filter;
        });

        var html = "";
        filtered.forEach(function (c) {
          var isOpen = !!mcExpanded[c.id];
          var isRecap = !!mcRecapOpen[c.id];
          var statusCls = c.status === "active" ? "active" : "completed";
          var statusLabel =
            c.status === "active"
              ? '<span class="mc-dot"></span> Live'
              : "Completed";
          var chevron =
            '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="var(--text-tertiary)" stroke-width="2" style="transition:transform .2s;transform:rotate(' +
            (isOpen ? "180" : "0") +
            'deg)"><polyline points="6 9 12 15 18 9"/></svg>';

          html += '<div class="mc-card">';

          // Collapsed row — always visible
          html +=
            '<div style="display:flex;align-items:center;gap:10px;cursor:pointer" onclick="toggleMcCard(\'' +
            c.id +
            "')\">";
          html += '<div style="flex-shrink:0">' + chevron + "</div>";
          html += '<div style="flex:1;min-width:0">';
          html +=
            '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">';
          html +=
            '<span class="mc-status ' +
            statusCls +
            '" style="font-size:9px">' +
            statusLabel +
            "</span>";
          html +=
            '<span style="font-size:13px;font-weight:700;color:var(--text-primary)">' +
            c.name +
            "</span>";
          html +=
            '<span class="mc-study-type" style="font-size:9px">' +
            c.study +
            "</span>";
          html += "</div>";
          html +=
            '<div style="font-size:10px;color:var(--text-tertiary);margin-top:1px">' +
            c.advertiser +
            " · " +
            c.dates +
            "</div>";
          html += "</div>";
          // Key metrics inline (collapsed view)
          html +=
            '<div style="display:flex;gap:12px;align-items:center;flex-shrink:0">';
          html +=
            '<div style="text-align:center"><div style="font-size:14px;font-weight:800;color:var(--teal)">' +
            c.iRoas +
            '</div><div style="font-size:7px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;color:var(--text-tertiary)">iROAS</div></div>';
          html +=
            '<div style="text-align:center"><div style="font-size:14px;font-weight:800;color:var(--text-primary)">' +
            c.incSales +
            '</div><div style="font-size:7px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;color:var(--text-tertiary)">Inc. Sales</div></div>';
          html +=
            '<div style="text-align:center"><div style="font-size:14px;font-weight:800;color:var(--text-primary)">' +
            c.cvr +
            '</div><div style="font-size:7px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;color:var(--text-tertiary)">CVR</div></div>';
          html += "</div>";
          // Action buttons (always visible, with labels)
          html +=
            '<div style="display:flex;gap:5px;flex-shrink:0" onclick="event.stopPropagation()">';
          html +=
            '<button class="mc-expand-btn" onclick="toggleMcRecap(\'' +
            c.id +
            "')\">";
          html +=
            '<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>';
          html += isRecap ? "Hide Recap" : "AI Recap";
          html += "</button>";
          if (c.status === "active") {
            html +=
              '<button class="mc-report-btn" onclick="openReportSettings(\'' +
              c.id +
              "')\">";
            html +=
              '<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><polyline points="8 21 12 17 16 21"/></svg>';
            html += "Weekly Report</button>";
          }
          if (c.status === "completed") {
            html +=
              '<button class="mc-wrap-btn" onclick="showToast(\'Downloading wrap report for ' +
              c.name.replace(/'/g, "\\'") +
              '...\')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Wrap Report</button>';
          }
          html += "</div>";
          html += "</div>";

          // AI Recap (independent toggle)
          if (isRecap) {
            html +=
              '<div class="mc-ai-recap" style="margin-top:10px"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="var(--purple-accent)" stroke-width="2" style="vertical-align:-2px;margin-right:6px"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>' +
              c.recap +
              "</div>";
          }

          // Expanded details
          if (isOpen) {
            html +=
              '<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--card-border);animation:fadeSlide .3s ease">';
            html += '<div class="mc-metrics">';
            html +=
              '<div class="mc-metric"><div class="mc-metric-val">' +
              c.spend +
              '</div><div class="mc-metric-label">Media Spend</div></div>';
            html +=
              '<div class="mc-metric"><div class="mc-metric-val" style="color:var(--teal)">' +
              c.iRoas +
              '</div><div class="mc-metric-label">iROAS</div></div>';
            html +=
              '<div class="mc-metric"><div class="mc-metric-val">' +
              c.incSales +
              '</div><div class="mc-metric-label">Inc. Sales</div></div>';
            html +=
              '<div class="mc-metric"><div class="mc-metric-val">' +
              c.incTxnLift +
              '</div><div class="mc-metric-label">Txn Lift</div></div>';
            html +=
              '<div class="mc-metric"><div class="mc-metric-val">' +
              c.incSalesLift +
              '</div><div class="mc-metric-label">Sales Lift</div></div>';
            html +=
              '<div class="mc-metric"><div class="mc-metric-val">' +
              c.cvr +
              '</div><div class="mc-metric-label">CVR</div></div>';
            html +=
              '<div class="mc-metric"><div class="mc-metric-val">' +
              c.roas +
              '</div><div class="mc-metric-label">ROAS</div></div>';
            html +=
              '<div class="mc-metric"><div class="mc-metric-val">' +
              c.nnbRoas +
              '</div><div class="mc-metric-label">NNB ROAS</div></div>';
            html += "</div>";
            html += '<div class="mc-footer">';
            html +=
              '<a class="mc-link" onclick="showToast(\'Opening full measurement dashboard for ' +
              c.name.replace(/'/g, "\\'") +
              '...\')">View Full Dashboard <svg viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>';
            html += "</div>";
            html += "</div>";
          }

          html += "</div>";
        });

        // Setup CTA card
        html +=
          '<div class="mc-setup-card" onclick="openDrawer(\'measurement\')">';
        html +=
          '<div style="width:44px;height:44px;border-radius:50%;background:var(--purple-bg);display:flex;align-items:center;justify-content:center;margin:0 auto 10px"><svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="var(--purple-accent)" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>';
        html +=
          '<div style="font-size:13px;font-weight:700;color:var(--purple-accent);margin-bottom:4px">Set Up a New Measurement Study</div>';
        html +=
          '<div style="font-size:10.5px;color:var(--text-secondary);line-height:1.4;max-width:400px;margin:0 auto">Launch Sales Lift, Brand Lift, Full-Funnel, or Visitation studies.<br>Turnkey setup via PMP — results begin within 7 days of campaign start.</div>';
        html += "</div>";

        body.innerHTML = html;

        // Update toggle all button
        var allOpen = filtered.every(function (c) {
          return !!mcExpanded[c.id];
        });
        var lbl = document.getElementById("mcToggleLabel");
        if (lbl) lbl.textContent = allOpen ? "Collapse All" : "Expand All";
        var chevEl = document.querySelector("#mcToggleAllBtn svg");
        if (chevEl) chevEl.style.transform = allOpen ? "rotate(180deg)" : "";
      }

      function toggleMcCard(id) {
        mcExpanded[id] = !mcExpanded[id];
        renderMeasuredCampaigns();
      }

      function toggleMcRecap(id) {
        mcRecapOpen[id] = !mcRecapOpen[id];
        renderMeasuredCampaigns();
      }

      function mcToggleAll() {
        var filter = document.getElementById("mcFilter").value;
        var filtered = measuredCampaigns.filter(function (c) {
          return filter === "all" || c.status === filter;
        });
        var allOpen = filtered.every(function (c) {
          return !!mcExpanded[c.id];
        });
        filtered.forEach(function (c) {
          mcExpanded[c.id] = !allOpen;
        });
        renderMeasuredCampaigns();
      }

      // ═══ WEEKLY REPORT MODAL ═══
      var currentReportCampId = null;
      function openReportSettings(campId) {
        var camp = measuredCampaigns.find(function (c) {
          return c.id === campId;
        });
        if (!camp) return;
        currentReportCampId = campId;
        document.getElementById("rptCampName").textContent = camp.name;
        document.getElementById("rptOverlay").style.display = "";
        // Populate context fields
        document.getElementById("rptContext").value = camp.context || "";
        document.getElementById("rptKpis").value = camp.kpis || "";
        document.getElementById("rptAudience").value = camp.audience || "";
        document.getElementById("rptChannels").value = camp.channels || "";
        // Sync time display
        var timeEl = document.getElementById("rptTime");
        if (timeEl) {
          timeEl.onchange = function () {
            var sel = timeEl.options[timeEl.selectedIndex].text;
            document.getElementById("rptNextTime").textContent =
              "Delivers " + sel;
          };
        }
        renderEmailPreview(camp);
      }
      function updateCampContext() {
        if (!currentReportCampId) return;
        var camp = measuredCampaigns.find(function (c) {
          return c.id === currentReportCampId;
        });
        if (!camp) return;
        camp.context = document.getElementById("rptContext").value;
        camp.kpis = document.getElementById("rptKpis").value;
        camp.audience = document.getElementById("rptAudience").value;
        camp.channels = document.getElementById("rptChannels").value;
        renderEmailPreview(camp);
      }
      function closeReportModal() {
        document.getElementById("rptOverlay").style.display = "none";
      }

      function renderEmailPreview(c) {
        var el = document.getElementById("rptPreview");
        var h = '<div class="email-card">';
        // Header banner
        h +=
          '<div style="background:linear-gradient(135deg,#2d1b69 0%,#6c5ce7 50%,#e17055 100%);padding:20px 28px;display:flex;align-items:center;justify-content:space-between">';
        h +=
          '<div style="color:#fff;font-size:18px;font-weight:700;letter-spacing:-.3px">outcome<sup style="font-size:9px;opacity:.7">HQ</sup></div>';
        h +=
          '<div style="color:rgba(255,255,255,.7);font-size:11px">Weekly Performance Report</div>';
        h += "</div>";

        // Greeting + executive summary
        h += '<div style="padding:24px 28px 0">';
        h +=
          '<div style="font-size:14px;font-weight:600;color:#2d3436;margin-bottom:10px">Hi Vlad,</div>';
        h +=
          '<div style="font-size:13px;color:#636e72;line-height:1.6;margin-bottom:18px">Here\'s your Week 4 performance report for <strong style="color:#2d3436">' +
          c.name +
          "</strong>. This report covers activity through Feb 14, 2025 and is tied to the campaign objectives you outlined at kickoff.</div>";
        h += "</div>";

        // Campaign objective reminder
        h +=
          '<div style="margin:0 28px 18px;padding:12px 16px;background:#f8f7fd;border-left:3px solid #6c5ce7;border-radius:0 8px 8px 0">';
        h +=
          '<div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#6c5ce7;margin-bottom:4px">Campaign Objective</div>';
        h +=
          '<div style="font-size:12px;color:#2d3436;line-height:1.5">' +
          (c.context ||
            "No objective defined — edit campaign context in settings.") +
          "</div>";
        if (c.kpis) {
          h +=
            '<div style="font-size:10px;color:#636e72;margin-top:6px"><strong style="color:#2d3436">Target KPIs:</strong> ' +
            c.kpis +
            "</div>";
        }
        h += "</div>";

        // KPI Hero Grid
        h += '<div style="padding:0 28px 18px">';
        h +=
          '<div style="font-size:13px;font-weight:700;color:#2d3436;margin-bottom:10px">Campaign-to-Date Performance</div>';
        h +=
          '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">';
        var kpis = [
          {
            v: c.iRoas,
            l: "iROAS",
            color: "#00b894",
            delta: "+0.3x vs last week",
          },
          {
            v: c.incSales,
            l: "Incremental Sales",
            color: "#6c5ce7",
            delta: "+$142K this week",
          },
          {
            v: c.cvr,
            l: "CVR",
            color: "#2d3436",
            delta: "+0.4pp vs last week",
          },
          {
            v: c.spend,
            l: "Media Spend",
            color: "#2d3436",
            delta: "62% paced",
          },
          {
            v: c.incTxnLift,
            l: "Transaction Lift",
            color: "#00b894",
            delta: "Above benchmark",
          },
          {
            v: c.nnbRoas,
            l: "Net-New Buyer ROAS",
            color: "#6c5ce7",
            delta: "+18% of goal",
          },
        ];
        kpis.forEach(function (k) {
          h +=
            '<div style="background:#f8f9fa;border-radius:8px;padding:12px;text-align:center">';
          h +=
            '<div style="font-size:20px;font-weight:800;color:' +
            k.color +
            '">' +
            k.v +
            "</div>";
          h +=
            '<div style="font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;color:#b2bec3;margin-top:2px">' +
            k.l +
            "</div>";
          h +=
            '<div style="font-size:9px;color:#00b894;margin-top:4px;font-weight:600">' +
            k.delta +
            "</div>";
          h += "</div>";
        });
        h += "</div></div>";

        // Vs Benchmarks
        h += '<div style="padding:0 28px 18px">';
        h +=
          '<div style="font-size:13px;font-weight:700;color:#2d3436;margin-bottom:10px">Progress vs. Your KPIs</div>';
        h +=
          '<div style="border:1px solid #e8e8e8;border-radius:8px;overflow:hidden">';
        var benchmarks = [
          {
            kpi: "iROAS Target",
            goal: "3.0x",
            actual: c.iRoas,
            status: "ahead",
          },
          {
            kpi: "CPA Target",
            goal: "Under $15",
            actual: "$12.22",
            status: "ahead",
          },
          {
            kpi: "Sales Lift",
            goal: "10%",
            actual: c.incSalesLift,
            status: "ahead",
          },
          {
            kpi: "Net-New Buyers",
            goal: "2,500",
            actual: "1,847",
            status: "on_track",
          },
        ];
        h +=
          '<div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:0">';
        h +=
          '<div style="padding:8px 12px;background:#f8f9fa;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#b2bec3">KPI</div>';
        h +=
          '<div style="padding:8px 12px;background:#f8f9fa;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#b2bec3;text-align:center">Goal</div>';
        h +=
          '<div style="padding:8px 12px;background:#f8f9fa;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#b2bec3;text-align:center">Actual</div>';
        h +=
          '<div style="padding:8px 12px;background:#f8f9fa;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#b2bec3;text-align:center">Status</div>';
        benchmarks.forEach(function (b) {
          var sColor = b.status === "ahead" ? "#00b894" : "#fdcb6e";
          var sLabel = b.status === "ahead" ? "✓ Ahead" : "⟳ On Track";
          h +=
            '<div style="padding:10px 12px;border-top:1px solid #f0f0f0;font-size:12px;font-weight:600;color:#2d3436">' +
            b.kpi +
            "</div>";
          h +=
            '<div style="padding:10px 12px;border-top:1px solid #f0f0f0;font-size:12px;text-align:center;color:#b2bec3">' +
            b.goal +
            "</div>";
          h +=
            '<div style="padding:10px 12px;border-top:1px solid #f0f0f0;font-size:12px;text-align:center;font-weight:700;color:#2d3436">' +
            b.actual +
            "</div>";
          h +=
            '<div style="padding:10px 12px;border-top:1px solid #f0f0f0;text-align:center"><span style="font-size:10px;font-weight:700;padding:3px 8px;border-radius:4px;background:' +
            sColor +
            "20;color:" +
            sColor +
            '">' +
            sLabel +
            "</span></div>";
        });
        h += "</div></div></div>";

        // AI Performance Narrative
        h +=
          '<div style="margin:0 28px 18px;padding:18px;background:linear-gradient(135deg,#f8f7fd,#faf9fd);border:1px solid #e0dced;border-radius:10px">';
        h +=
          '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">';
        h +=
          '<div style="font-size:13px;font-weight:700;color:#2d3436">AI Performance Narrative</div>';
        h +=
          '<div style="font-size:10px;color:#6c5ce7;font-weight:600">outcome<sup style="font-size:7px">AI</sup></div>';
        h += "</div>";
        h += '<div style="font-size:12px;color:#2d3436;line-height:1.65">';
        h +=
          "<strong>This week's headline:</strong> CTV is your conversion engine. The :30 Whopper Value creative on CTV drove 34% of all incremental sales this week at 6.1x iROAS — your strongest format-creative combination. Meanwhile, Competitor Conquest audiences continue outperforming all segments, with McDonald's switchers converting at 2.4x the rate of your general audience.";
        h += "</div>";
        h +=
          '<div style="margin-top:12px;padding-top:12px;border-top:1px solid #e0dced;font-size:12px;color:#636e72;line-height:1.65">';
        h +=
          '<strong style="color:#2d3436">Tied to your objective:</strong> You targeted 3.0x iROAS — you\'re currently at ' +
          c.iRoas +
          ". The conquest strategy is working: 22% of incremental transactions are from net-new buyers with no prior purchase history, tracking 18% above your forecast.";
        h += "</div>";
        h += "</div>";

        // Optimization Recommendations
        h += '<div style="padding:0 28px 18px">';
        h +=
          '<div style="font-size:13px;font-weight:700;color:#2d3436;margin-bottom:10px">Recommended Actions</div>';
        var recs = [
          {
            icon: "🔥",
            title: "Shift 15% of Display budget to CTV",
            desc: "CTV is delivering 6.1x iROAS vs Display at 2.3x. Reallocating $12K from Display 300x250 to CTV :30 could yield an estimated additional $73K in incremental sales over the remaining flight.",
            urgency: "high",
          },
          {
            icon: "🎯",
            title: "Double down on Conquest audiences",
            desc: "McDonald's and Wendy's switchers are converting at 8.2% vs 4.1% for general audiences. Recommend expanding conquest seed from 1.2M to 2M to capture more share of wallet.",
            urgency: "medium",
          },
          {
            icon: "⏸",
            title: "Pause underperforming Display 728x90",
            desc: "This format is running at 1.1x iROAS with high impression volume. Reallocating spend to Native In-Feed (currently 4.8x iROAS) would improve overall efficiency.",
            urgency: "high",
          },
        ];
        recs.forEach(function (r) {
          var uColor = r.urgency === "high" ? "#e17055" : "#fdcb6e";
          h +=
            '<div style="padding:12px 14px;border:1px solid #e8e8e8;border-radius:8px;margin-bottom:8px;display:flex;gap:12px;align-items:flex-start">';
          h +=
            '<div style="font-size:18px;flex-shrink:0;margin-top:2px">' +
            r.icon +
            "</div>";
          h +=
            '<div style="flex:1"><div style="font-size:12px;font-weight:700;color:#2d3436;margin-bottom:3px">' +
            r.title +
            ' <span style="font-size:8px;font-weight:700;padding:2px 6px;border-radius:3px;background:' +
            uColor +
            "22;color:" +
            uColor +
            ';text-transform:uppercase;vertical-align:1px">' +
            r.urgency +
            "</span></div>";
          h +=
            '<div style="font-size:11px;color:#636e72;line-height:1.5">' +
            r.desc +
            "</div></div>";
          h += "</div>";
        });
        h += "</div>";

        // Media Investment Digest
        h += '<div style="padding:0 28px 18px">';
        h +=
          '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">';
        h +=
          '<div style="font-size:13px;font-weight:700;color:#2d3436">Media Investment Digest</div>';
        h +=
          '<div style="font-size:9px;color:#6c5ce7;font-weight:600;cursor:pointer">View full optimizer →</div>';
        h += "</div>";
        h +=
          '<div style="border:1px solid #e8e8e8;border-radius:8px;overflow:hidden">';
        // Header row
        h +=
          '<div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;background:#f8f9fa;gap:0">';
        h +=
          '<div style="padding:7px 12px;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#b2bec3">Channel</div>';
        h +=
          '<div style="padding:7px 10px;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#b2bec3;text-align:right">Spend</div>';
        h +=
          '<div style="padding:7px 10px;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#b2bec3;text-align:right">Media</div>';
        h +=
          '<div style="padding:7px 10px;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#6c5ce7;text-align:right">iROAS</div>';
        h +=
          '<div style="padding:7px 10px;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#6c5ce7;text-align:right">Efficiency</div>';
        h += "</div>";
        var mediaRows = [
          {
            ch: "CTV / OTT",
            spend: "$84K",
            media: "94.2% VCR",
            roas: "3.32x",
            eff: "3.3 : 1",
            best: false,
          },
          {
            ch: "Pre-Roll Video",
            spend: "$68K",
            media: "76.5% VCR",
            roas: "5.84x",
            eff: "5.8 : 1",
            best: true,
          },
          {
            ch: "Display Standard",
            spend: "$50K",
            media: "0.08% CTR",
            roas: "4.16x",
            eff: "4.2 : 1",
            best: false,
          },
          {
            ch: "Native",
            spend: "$22K",
            media: "0.22% CTR",
            roas: "6.27x",
            eff: "6.3 : 1",
            best: true,
          },
          {
            ch: "Social Display",
            spend: "$52K",
            media: "0.14% CTR",
            roas: "2.86x",
            eff: "2.9 : 1",
            best: false,
          },
        ];
        mediaRows.forEach(function (r) {
          var roasColor = r.best ? "#00b894" : "#2d3436";
          h +=
            '<div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;border-top:1px solid #f0f0f0">';
          h +=
            '<div style="padding:9px 12px;font-size:11px;font-weight:600;color:#2d3436">' +
            r.ch +
            "</div>";
          h +=
            '<div style="padding:9px 10px;font-size:11px;text-align:right;color:#636e72">' +
            r.spend +
            "</div>";
          h +=
            '<div style="padding:9px 10px;font-size:10px;text-align:right;color:#b2bec3">' +
            r.media +
            "</div>";
          h +=
            '<div style="padding:9px 10px;font-size:11px;text-align:right;font-weight:700;color:' +
            roasColor +
            '">' +
            r.roas +
            "</div>";
          h +=
            '<div style="padding:9px 10px;font-size:10px;text-align:right"><span style="padding:2px 6px;border-radius:3px;font-weight:700;background:' +
            (r.best ? "#d4efdf" : "#f8f9fa") +
            ";color:" +
            (r.best ? "#00b894" : "#636e72") +
            '">' +
            r.eff +
            "</span></div>";
          h += "</div>";
        });
        h += "</div>";
        h +=
          '<div style="font-size:10px;color:#636e72;margin-top:8px;line-height:1.4"><strong style="color:#6c5ce7">⚡ Signal:</strong> Native and Pre-Roll deliver strongest efficiency. Display Standard has the highest impression load but weakest return — consider shifting 10% to Native for estimated +$31K incremental impact.</div>';
        h += "</div>";

        // Cohort Composition Digest
        h += '<div style="padding:0 28px 18px">';
        h +=
          '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">';
        h +=
          '<div style="font-size:13px;font-weight:700;color:#2d3436">Converter Composition by Cohort</div>';
        h +=
          '<div style="font-size:9px;color:#6c5ce7;font-weight:600;cursor:pointer">Explore segments →</div>';
        h += "</div>";
        var cohorts = [
          {
            name: "Frequent Buyers",
            pct: 31,
            conv: "2,284",
            color: "#6c5ce7",
            delta: "-1.2pp",
          },
          {
            name: "Ultra-Light",
            pct: 27,
            conv: "1,990",
            color: "#74b9ff",
            delta: "+2.4pp",
          },
          {
            name: "Competitor Conquest",
            pct: 18,
            conv: "1,325",
            color: "#e17055",
            delta: "+3.1pp",
          },
          {
            name: "New-to-Category",
            pct: 11,
            conv: "810",
            color: "#00b894",
            delta: "+1.8pp",
          },
          {
            name: "Loyal",
            pct: 8,
            conv: "589",
            color: "#fdcb6e",
            delta: "-0.3pp",
          },
          {
            name: "Lapsed / Occasion",
            pct: 5,
            conv: "368",
            color: "#a29bfe",
            delta: "-0.2pp",
          },
        ];
        // Stacked bar
        h +=
          '<div style="display:flex;height:22px;border-radius:6px;overflow:hidden;margin-bottom:10px">';
        cohorts.forEach(function (co) {
          h +=
            '<div style="width:' +
            co.pct +
            "%;background:" +
            co.color +
            '" title="' +
            co.name +
            ": " +
            co.pct +
            '%"></div>';
        });
        h += "</div>";
        // Legend rows
        h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">';
        cohorts.forEach(function (co) {
          var deltaColor = co.delta.charAt(0) === "+" ? "#00b894" : "#e17055";
          h +=
            '<div style="display:flex;align-items:center;gap:8px;padding:7px 10px;background:#f8f9fa;border-radius:6px">';
          h +=
            '<div style="width:8px;height:8px;border-radius:50%;background:' +
            co.color +
            ';flex-shrink:0"></div>';
          h += '<div style="flex:1;min-width:0">';
          h +=
            '<div style="font-size:10px;font-weight:600;color:#2d3436;display:flex;justify-content:space-between"><span>' +
            co.name +
            "</span><span>" +
            co.pct +
            "%</span></div>";
          h +=
            '<div style="font-size:9px;color:#b2bec3;display:flex;justify-content:space-between"><span>' +
            co.conv +
            ' conv.</span><span style="color:' +
            deltaColor +
            ';font-weight:600">' +
            co.delta +
            " WoW</span></div>";
          h += "</div>";
          h += "</div>";
        });
        h += "</div>";
        h +=
          '<div style="font-size:10px;color:#636e72;margin-top:8px;line-height:1.4"><strong style="color:#6c5ce7">📊 Trend:</strong> Competitor Conquest share is growing fastest (+3.1pp WoW) — your conquest strategy is actively pulling share from McDonald\'s and Wendy\'s. Ultra-Light buyers are accelerating too, suggesting upper-funnel media is converting awareness into first purchases.</div>';
        h += "</div>";

        // Audience activation CTA
        h +=
          '<div style="margin:0 28px 18px;padding:16px 20px;background:linear-gradient(135deg,#e8f8f5,#d4efdf);border-radius:10px;border:1px solid #b8e6d0">';
        h +=
          '<div style="font-size:13px;font-weight:700;color:#00b894;margin-bottom:6px">💡 Audience Opportunity</div>';
        h +=
          '<div style="font-size:12px;color:#2d3436;line-height:1.5;margin-bottom:10px">Your campaign data reveals a high-value segment: <strong>Lapsed Frequent Buyers</strong> who last purchased 60-90 days ago are converting at 5.8x iROAS when re-engaged via CTV. We can build and activate this audience in 5 business days.</div>';
        h +=
          '<div style="display:inline-block;padding:8px 16px;background:#00b894;color:#fff;font-size:11px;font-weight:700;border-radius:6px;cursor:pointer">Activate This Audience →</div>';
        h += "</div>";

        // View dashboard CTA
        h += '<div style="padding:0 28px 20px;text-align:center">';
        h +=
          '<div style="display:inline-block;padding:10px 28px;background:#6c5ce7;color:#fff;font-size:12px;font-weight:700;border-radius:8px;cursor:pointer;letter-spacing:.2px">Open Full Dashboard →</div>';
        h +=
          '<div style="font-size:10px;color:#b2bec3;margin-top:8px">Dive deeper into every dimension, creative, and audience segment</div>';
        h += "</div>";

        // Footer
        h +=
          '<div style="padding:16px 28px;background:#f8f9fa;border-top:1px solid #e8e8e8;text-align:center">';
        h +=
          '<div style="font-size:10px;color:#b2bec3;line-height:1.5">This report was generated for ' +
          c.advertiser +
          " by OutcomeHQ<br>Campaign: " +
          c.name +
          " · " +
          c.dates +
          "</div>";
        h +=
          '<div style="font-size:9px;color:#dfe6e9;margin-top:8px">Terms · Privacy · Unsubscribe</div>';
        h += "</div>";

        h += "</div>";
        el.innerHTML = h;
      }

      renderMeasuredCampaigns();

      // ═══ INTAKE FORM WIZARD ═══
      var intakeCurrentStep = 1;
      var intakeTotalSteps = 4;

      function selectStudyType(el, val) {
        document.querySelectorAll(".intake-study-card").forEach(function (c) {
          c.classList.remove("selected");
        });
        el.classList.add("selected");
      }

      function toggleIntakePill(el) {
        el.parentElement
          .querySelectorAll(".intake-toggle-pill")
          .forEach(function (p) {
            p.classList.remove("active");
          });
        el.classList.add("active");
      }

      function intakeStep(dir) {
        var next = intakeCurrentStep + dir;
        if (next < 1 || next > intakeTotalSteps + 1) return;

        // On final step, submit
        if (next > intakeTotalSteps) {
          var campName =
            document.getElementById("intakeCampName").value || "New Campaign";
          showToast(
            'Study submitted: "' +
              campName +
              '" — confirmation within 1 business day',
          );
          setTimeout(function () {
            closeDrawer();
            intakeCurrentStep = 1;
            resetIntakeUI();
          }, 1500);
          return;
        }

        intakeCurrentStep = next;

        // Show/hide pages
        for (var p = 1; p <= intakeTotalSteps; p++) {
          var pg = document.getElementById("intakePage" + p);
          if (pg) pg.style.display = p === next ? "" : "none";
        }

        // Update step indicators
        document.querySelectorAll(".intake-step").forEach(function (s) {
          var sn = parseInt(s.dataset.step);
          s.classList.remove("active", "done");
          if (sn === next) s.classList.add("active");
          else if (sn < next) s.classList.add("done");
        });

        // Update nav
        document.getElementById("intakePrev").style.visibility =
          next === 1 ? "hidden" : "";
        document.getElementById("intakeStepLabel").textContent =
          "Step " + next + " of " + intakeTotalSteps;
        document.getElementById("intakeNext").textContent =
          next === intakeTotalSteps ? "Submit Study →" : "Continue →";
        if (next === intakeTotalSteps)
          document.getElementById("intakeNext").className =
            "btn btn-teal btn-sm";
        else
          document.getElementById("intakeNext").className =
            "btn btn-primary btn-sm";
      }

      function resetIntakeUI() {
        intakeCurrentStep = 1;
        for (var p = 1; p <= intakeTotalSteps; p++) {
          var pg = document.getElementById("intakePage" + p);
          if (pg) pg.style.display = p === 1 ? "" : "none";
        }
        document.querySelectorAll(".intake-step").forEach(function (s) {
          s.classList.remove("active", "done");
          if (s.dataset.step === "1") s.classList.add("active");
        });
        document.querySelectorAll(".intake-study-card").forEach(function (c) {
          c.classList.remove("selected");
        });
        document.getElementById("intakePrev").style.visibility = "hidden";
        document.getElementById("intakeStepLabel").textContent = "Step 1 of 4";
        document.getElementById("intakeNext").textContent = "Continue →";
        document.getElementById("intakeNext").className =
          "btn btn-primary btn-sm";
      }

      // Chip toggle handler via event delegation
      try {
        document.addEventListener("click", function (e) {
          var chip = e.target.closest(".intake-chip");
          if (chip) {
            chip.classList.toggle("active");
            var cb = chip.querySelector("input[type=checkbox]");
            if (cb) cb.checked = chip.classList.contains("active");
          }
        });
        // Drag and drop for media plan
        var dz = document.getElementById("intakeDropzone");
        if (dz) {
          ["dragenter", "dragover"].forEach(function (ev) {
            dz.addEventListener(ev, function (e) {
              e.preventDefault();
              e.stopPropagation();
              dz.classList.add("drag-over");
            });
          });
          ["dragleave", "drop"].forEach(function (ev) {
            dz.addEventListener(ev, function (e) {
              e.preventDefault();
              e.stopPropagation();
              dz.classList.remove("drag-over");
            });
          });
          dz.addEventListener("drop", function (e) {
            if (e.dataTransfer.files.length > 0)
              attachIntakeFile(e.dataTransfer.files[0]);
          });
        }
      } catch (e) {}

      function handleIntakeFile(input) {
        if (input.files.length > 0) attachIntakeFile(input.files[0]);
      }

      function attachIntakeFile(file) {
        var dz = document.getElementById("intakeDropzone");
        document.getElementById("intakeFileName").textContent = file.name;
        document.getElementById("intakeDropContent").style.display = "none";
        document.getElementById("intakeFileAttached").style.display = "";
        dz.classList.add("has-file");
      }

      function removeIntakeFile() {
        var dz = document.getElementById("intakeDropzone");
        document.getElementById("intakeFileInput").value = "";
        document.getElementById("intakeDropContent").style.display = "";
        document.getElementById("intakeFileAttached").style.display = "none";
        dz.classList.remove("has-file");
      }

      // Init
      buildChart();
      updateHeroOnramp();

      // ═══ AGENCY HUB ═══
      var agencyAccounts = [
        {
          id: "bk",
          name: "Burger King",
          logo: "BK",
          logoBg: "linear-gradient(135deg,#e17055,#fdcb6e)",
          category: "QSR",
          totalSpend: "$18.2M",
          impressions: "1.84B",
          attrSales: "$44.6M",
          attrD: "+9.8%",
          attrUp: true,
          pltv: "$112M",
          pltvD: "+14.2%",
          pltvUp: true,
          campaigns: 3,
          active: true,
        },
        {
          id: "scj",
          name: "SC Johnson",
          logo: "SCJ",
          logoBg: "linear-gradient(135deg,#d63031,#e17055)",
          category: "Household",
          totalSpend: "$22.8M",
          impressions: "2.46B",
          attrSales: "$77.6M",
          attrD: "+11.2%",
          attrUp: true,
          pltv: "$194M",
          pltvD: "+8.6%",
          pltvUp: true,
          campaigns: 4,
          active: true,
        },
        {
          id: "clx",
          name: "Clorox",
          logo: "CLX",
          logoBg: "linear-gradient(135deg,#0984e3,#74b9ff)",
          category: "Household",
          totalSpend: "$14.6M",
          impressions: "\u2014",
          attrSales: "\u2014",
          attrD: "",
          attrUp: false,
          pltv: "\u2014",
          pltvD: "",
          pltvUp: false,
          campaigns: 0,
          active: false,
        },
        {
          id: "gb",
          name: "Grupo Bimbo",
          logo: "GB",
          logoBg: "linear-gradient(135deg,#00b894,#55efc4)",
          category: "Packaged Bakery",
          totalSpend: "$9.4M",
          impressions: "892M",
          attrSales: "$35.0M",
          attrD: "+15.3%",
          attrUp: true,
          pltv: "$86M",
          pltvD: "+18.1%",
          pltvUp: true,
          campaigns: 2,
          active: true,
        },
        {
          id: "dg",
          name: "Dollar General",
          logo: "DG",
          logoBg: "linear-gradient(135deg,#fdcb6e,#e17055)",
          category: "Discount Retail",
          totalSpend: "$8.1M",
          impressions: "1.12B",
          attrSales: "$16.7M",
          attrD: "+4.1%",
          attrUp: true,
          pltv: "$41M",
          pltvD: "-1.8%",
          pltvUp: false,
          campaigns: 2,
          active: true,
        },
        {
          id: "pb",
          name: "Pernod Ricard",
          logo: "PR",
          logoBg: "linear-gradient(135deg,#6c5ce7,#a29bfe)",
          category: "Spirits & Wine",
          totalSpend: "$11.3M",
          impressions: "1.38B",
          attrSales: "$54.6M",
          attrD: "+12.8%",
          attrUp: true,
          pltv: "$148M",
          pltvD: "+10.4%",
          pltvUp: true,
          campaigns: 3,
          active: true,
        },
        {
          id: "hrl",
          name: "Hormel Foods",
          logo: "HRL",
          logoBg: "linear-gradient(135deg,#d63031,#fdcb6e)",
          category: "Packaged Meats",
          totalSpend: "$6.8M",
          impressions: "\u2014",
          attrSales: "\u2014",
          attrD: "",
          attrUp: false,
          pltv: "\u2014",
          pltvD: "",
          pltvUp: false,
          campaigns: 0,
          active: false,
        },
        {
          id: "kd",
          name: "Keurig Dr Pepper",
          logo: "KDP",
          logoBg: "linear-gradient(135deg,#00b894,#0984e3)",
          category: "Beverages",
          totalSpend: "$16.4M",
          impressions: "2.08B",
          attrSales: "$53.2M",
          attrD: "+7.9%",
          attrUp: true,
          pltv: "$138M",
          pltvD: "+6.3%",
          pltvUp: true,
          campaigns: 3,
          active: true,
        },
        {
          id: "cc",
          name: "Church & Dwight",
          logo: "CHD",
          logoBg: "linear-gradient(135deg,#0984e3,#6c5ce7)",
          category: "Household",
          totalSpend: "$7.2M",
          impressions: "684M",
          attrSales: "$18.9M",
          attrD: "+5.6%",
          attrUp: true,
          pltv: "$47M",
          pltvD: "+4.1%",
          pltvUp: true,
          campaigns: 2,
          active: true,
        },
        {
          id: "es",
          name: "Edgewell Personal Care",
          logo: "EPC",
          logoBg: "linear-gradient(135deg,#fdcb6e,#00b894)",
          category: "Personal Care",
          totalSpend: "$5.1M",
          impressions: "\u2014",
          attrSales: "\u2014",
          attrD: "",
          attrUp: false,
          pltv: "\u2014",
          pltvD: "",
          pltvUp: false,
          campaigns: 0,
          active: false,
        },
        {
          id: "post",
          name: "Post Holdings",
          logo: "PST",
          logoBg: "linear-gradient(135deg,#e17055,#d63031)",
          category: "Cereal & Snacks",
          totalSpend: "$4.8M",
          impressions: "412M",
          attrSales: "$12.0M",
          attrD: "+8.9%",
          attrUp: true,
          pltv: "$31M",
          pltvD: "+11.2%",
          pltvUp: true,
          campaigns: 1,
          active: true,
        },
        {
          id: "sm",
          name: "Spectrum Brands",
          logo: "SPB",
          logoBg: "linear-gradient(135deg,#a29bfe,#74b9ff)",
          category: "Home & Garden",
          totalSpend: "$3.9M",
          impressions: "\u2014",
          attrSales: "\u2014",
          attrD: "",
          attrUp: false,
          pltv: "\u2014",
          pltvD: "",
          pltvUp: false,
          campaigns: 0,
          active: false,
        },
      ];
      var agencyExpanded = {};

      function renderAgencyAccounts() {
        var body = document.getElementById("agencyBody");
        if (!body) return;
        var filter = document.getElementById("agencyFilter").value;
        var sort = document.getElementById("agencySort").value;
        var filtered = agencyAccounts.filter(function (a) {
          if (filter === "active") return a.active;
          if (filter === "inactive") return !a.active;
          return true;
        });
        filtered.sort(function (a, b) {
          if (sort === "iroas")
            return (
              (parseFloat(b.attrSales.replace(/[$M,]/g, "")) || 0) -
              (parseFloat(a.attrSales.replace(/[$M,]/g, "")) || 0)
            );
          if (sort === "coverage") return b.campaigns - a.campaigns;
          return (
            (parseFloat(b.totalSpend.replace(/[$M,]/g, "")) || 0) -
            (parseFloat(a.totalSpend.replace(/[$M,]/g, "")) || 0)
          );
        });

        var h = "";
        filtered.forEach(function (a) {
          var isOpen = !!agencyExpanded[a.id];
          var logoBox =
            '<div style="width:40px;height:40px;border-radius:10px;background:' +
            a.logoBg +
            ';display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#fff;flex-shrink:0;letter-spacing:.3px">' +
            a.logo +
            "</div>";

          if (!a.active) {
            h +=
              '<div style="border:1px dashed #d8d0ef;border-radius:10px;padding:14px 16px;margin-bottom:6px;background:linear-gradient(135deg,#fafafe,#f8f6fc);display:flex;align-items:center;gap:14px">';
            h += logoBox;
            h += '<div style="flex:1">';
            h +=
              '<div style="display:flex;align-items:center;gap:8px"><span style="font-size:13px;font-weight:700;color:var(--text-primary)">' +
              a.name +
              '</span><span style="font-size:9px;padding:2px 7px;border-radius:10px;background:var(--page-bg);color:var(--text-tertiary);font-weight:600">' +
              a.category +
              "</span></div>";
            h +=
              '<div style="font-size:10.5px;color:var(--text-tertiary);margin-top:2px">' +
              a.totalSpend +
              " est. media spend \u00B7 No campaigns measured \u00B7 No attributed sales tracked</div>";
            h += "</div>";
            h += '<div style="display:flex;gap:6px;flex-shrink:0">';
            h +=
              '<button class="btn btn-outline btn-sm" style="font-size:10px;padding:5px 12px" onclick="openAccount(\'' +
              a.id +
              "')\">View Insights \u2192</button>";
            h +=
              '<button class="btn btn-primary btn-sm" style="font-size:10px;padding:5px 12px" onclick="showToast(\'Starting onboarding for ' +
              a.name.replace(/'/g, "\\'") +
              "...');openDrawer('measurement')\">Onboard \u2192</button>";
            h += "</div>";
            h += "</div>";
            return;
          }

          var chev =
            '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="var(--text-tertiary)" stroke-width="2" style="transition:transform .2s;transform:rotate(' +
            (isOpen ? "180" : "0") +
            'deg);flex-shrink:0"><polyline points="6 9 12 15 18 9"/></svg>';

          h +=
            '<div style="border:1px solid var(--card-border);border-radius:10px;padding:14px 16px;margin-bottom:6px;background:#fff;transition:border-color .2s" onmouseenter="this.style.borderColor=\'var(--purple-accent)\'" onmouseleave="this.style.borderColor=\'var(--card-border)\'">';

          h +=
            '<div style="display:flex;align-items:center;gap:12px;cursor:pointer" onclick="toggleAgencyCard(\'' +
            a.id +
            "')\">";
          h += chev;
          h += logoBox;
          h += '<div style="flex:1;min-width:0">';
          h +=
            '<div style="display:flex;align-items:center;gap:8px"><span style="font-size:13px;font-weight:700;color:var(--text-primary)">' +
            a.name +
            '</span><span style="font-size:9px;padding:2px 7px;border-radius:10px;background:var(--page-bg);color:var(--text-tertiary);font-weight:600">' +
            a.category +
            "</span></div>";
          h +=
            '<div style="font-size:10.5px;color:var(--text-tertiary);margin-top:1px">' +
            a.campaigns +
            " campaigns \u00B7 " +
            a.impressions +
            " impressions \u00B7 " +
            a.totalSpend +
            " spend</div>";
          h += "</div>";

          h +=
            '<div style="display:flex;gap:18px;align-items:center;flex-shrink:0">';
          h +=
            '<div style="text-align:right"><div style="font-size:15px;font-weight:800;color:var(--text-primary)">' +
            a.attrSales +
            '</div><div style="font-size:7.5px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;color:var(--text-tertiary)">Attr. Sales</div></div>';
          h +=
            '<div style="text-align:right"><div style="font-size:15px;font-weight:800;color:var(--purple-accent)">' +
            a.pltv +
            '</div><div style="font-size:7.5px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;color:var(--text-tertiary)">Predicted LTV</div></div>';
          h += "</div>";

          h +=
            '<div style="flex-shrink:0;margin-left:8px" onclick="event.stopPropagation()">';
          h +=
            '<button class="btn btn-outline btn-sm" style="font-size:10px;padding:5px 10px" onclick="openAccount(\'' +
            a.id +
            "')\">Open \u2192</button>";
          h += "</div>";
          h += "</div>";

          if (isOpen) {
            h +=
              '<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--card-border);animation:fadeSlide .3s ease">';
            h +=
              '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:2px;background:var(--page-bg);border-radius:8px;padding:2px;margin-bottom:12px">';
            var xm = [
              { l: "Measured Impressions", v: a.impressions },
              {
                l: "Attributed Sales",
                v: a.attrSales,
                d: a.attrD,
                u: a.attrUp,
              },
              {
                l: "Predicted LTV",
                v: a.pltv,
                c: "var(--purple-accent)",
                d: a.pltvD,
                u: a.pltvUp,
              },
              { l: "Campaigns Measured", v: a.campaigns },
              { l: "Total Media Spend", v: a.totalSpend },
            ];
            xm.forEach(function (m) {
              h +=
                '<div style="background:#fff;border-radius:6px;padding:10px 8px;text-align:center">';
              h +=
                '<div style="font-size:17px;font-weight:800;color:' +
                (m.c || "var(--text-primary)") +
                '">' +
                m.v +
                "</div>";
              if (m.d)
                h +=
                  '<div style="font-size:9px;font-weight:600;color:' +
                  (m.u ? "var(--teal)" : "var(--coral)") +
                  '">' +
                  m.d +
                  " QoQ</div>";
              h +=
                '<div style="font-size:8px;font-weight:600;text-transform:uppercase;letter-spacing:.3px;color:var(--text-tertiary);margin-top:2px">' +
                m.l +
                "</div>";
              h += "</div>";
            });
            h += "</div>";
            h += '<div style="display:flex;gap:8px;justify-content:flex-end">';
            h +=
              '<button class="btn btn-outline btn-sm" style="font-size:10px" onclick="showToast(\'Adding measurement study...\')">+ Add Study</button>';
            h +=
              '<button class="btn btn-primary btn-sm" style="font-size:10px" onclick="openAccount(\'' +
              a.id +
              "')\">Open Full Dashboard \u2192</button>";
            h += "</div>";
            h += "</div>";
          }

          h += "</div>";
        });

        body.innerHTML = h;
      }

      function toggleAgencyCard(id) {
        agencyExpanded[id] = !agencyExpanded[id];
        renderAgencyAccounts();
      }

      function openAccount(id) {
        document.getElementById("agencyHub").style.display = "none";
        document.getElementById("accountView").style.display = "";
        window.scrollTo(0, 0);
      }

      function backToHub() {
        document.getElementById("accountView").style.display = "none";
        document.getElementById("agencyHub").style.display = "";
        window.scrollTo(0, 0);
      }

      function toggleAccountSwitcher() {
        var el = document.getElementById("accountSwitcher");
        var isOpen = el.style.display !== "none";
        el.style.display = isOpen ? "none" : "";
        if (!isOpen) renderAccountSwitcherList();
      }
      function renderAccountSwitcherList() {
        var list = document.getElementById("accountSwitcherList");
        var h = "";
        agencyAccounts.forEach(function (a) {
          var isCurrent = a.id === "bk";
          var action = a.active
            ? "openAccount('" + a.id + "')"
            : "showToast('Starting onboarding for " +
              a.name.replace(/'/g, "\\'") +
              "...')";
          h +=
            '<div onclick="event.stopPropagation();toggleAccountSwitcher();' +
            action +
            '" style="display:flex;align-items:center;gap:10px;padding:7px 14px;cursor:pointer;transition:background .15s' +
            (isCurrent ? ";background:var(--purple-bg)" : "") +
            '" onmouseenter="this.style.background=\'' +
            (isCurrent ? "var(--purple-bg)" : "var(--page-bg)") +
            "'\" onmouseleave=\"this.style.background='" +
            (isCurrent ? "var(--purple-bg)" : "transparent") +
            "'\">";
          h +=
            '<div style="width:28px;height:28px;border-radius:7px;background:' +
            a.logoBg +
            ';display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:800;color:#fff;flex-shrink:0;letter-spacing:.2px">' +
            a.logo +
            "</div>";
          h +=
            '<div style="flex:1;min-width:0"><div style="font-size:11px;font-weight:' +
            (isCurrent ? "700" : "600") +
            ';color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' +
            a.name +
            "</div>";
          h +=
            '<div style="font-size:9px;color:var(--text-tertiary)">' +
            a.category +
            (a.active ? "" : " \u00B7 Not onboarded") +
            "</div></div>";
          if (isCurrent)
            h +=
              '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="var(--purple-accent)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>';
          if (!a.active)
            h +=
              '<span style="font-size:8px;padding:2px 5px;border-radius:3px;background:var(--amber-bg);color:#e17055;font-weight:600;flex-shrink:0">Setup</span>';
          h += "</div>";
        });
        list.innerHTML = h;
      }
      document.addEventListener("click", function (e) {
        var sw = document.getElementById("accountSwitcher");
        if (
          sw &&
          sw.style.display !== "none" &&
          !sw.parentElement.contains(e.target)
        )
          sw.style.display = "none";
      });

      renderAgencyAccounts();

      // ═══ COMPETITIVE INTELLIGENCE ═══
      var ciTab = "wallet";
      var ciCompetitors = [
        { name: "Burger King", color: "#6c5ce7", self: true },
        { name: "McDonald's", color: "#e17055" },
        { name: "Wendy's", color: "#fdcb6e" },
        { name: "Popeye's", color: "#00b894" },
      ];
      var ciWalletData = {
        overall: [34.0, 29.2, 21.6, 15.2],
        trends: {
          "90d": {
            labels: ["Wk 1", "Wk 4", "Wk 8", "Wk 13"],
            data: [
              [32.4, 33.0, 33.5, 34.0],
              [30.0, 29.7, 29.4, 29.2],
              [22.2, 21.9, 21.7, 21.6],
              [15.4, 15.4, 15.4, 15.2],
            ],
          },
          "6m": {
            labels: ["Sep", "Oct", "Nov", "Dec", "Jan", "Feb"],
            data: [
              [31.8, 32.2, 32.8, 33.1, 33.6, 34.0],
              [30.4, 30.2, 29.9, 29.8, 29.5, 29.2],
              [22.4, 22.2, 22.0, 21.9, 21.8, 21.6],
              [15.4, 15.4, 15.3, 15.2, 15.1, 15.2],
            ],
          },
          "1y": {
            labels: ["Q1 '25", "Q2 '25", "Q3 '25", "Q4 '25"],
            data: [
              [31.0, 32.5, 33.1, 34.0],
              [30.5, 30.1, 29.8, 29.2],
              [22.8, 22.2, 21.9, 21.6],
              [15.7, 15.2, 15.2, 15.2],
            ],
          },
          "2y": {
            labels: [
              "Q1 '24",
              "Q2 '24",
              "Q3 '24",
              "Q4 '24",
              "Q1 '25",
              "Q2 '25",
              "Q3 '25",
              "Q4 '25",
            ],
            data: [
              [27.2, 28.1, 29.0, 30.2, 31.0, 32.5, 33.1, 34.0],
              [33.1, 32.6, 31.8, 31.0, 30.5, 30.1, 29.8, 29.2],
              [23.8, 23.4, 23.1, 22.8, 22.8, 22.2, 21.9, 21.6],
              [15.9, 15.9, 16.1, 16.0, 15.7, 15.2, 15.2, 15.2],
            ],
          },
        },
      };
      var ciTimePeriod = "1y";
      var ciShareChart = null;
      var ciCampOverlay = "";
      var ciCohortShare = [
        {
          cohort: "Frequent Buyers",
          vals: [42.1, 26.8, 19.4, 11.7],
          delta: ["+2.4", "-1.1", "-0.8", "-0.5"],
        },
        {
          cohort: "Ultra-Light",
          vals: [28.3, 31.6, 23.4, 16.7],
          delta: ["+3.8", "-2.1", "-0.9", "-0.8"],
        },
        {
          cohort: "Competitor Conquest",
          vals: [18.6, 38.2, 27.1, 16.1],
          delta: ["+4.2", "-2.8", "-0.7", "-0.7"],
        },
        {
          cohort: "New-to-Category",
          vals: [31.4, 28.9, 22.1, 17.6],
          delta: ["+1.9", "-0.4", "-0.6", "-0.9"],
        },
        {
          cohort: "Loyal",
          vals: [58.2, 18.4, 14.6, 8.8],
          delta: ["+0.6", "-0.2", "-0.3", "-0.1"],
        },
        {
          cohort: "Lapsed / Occasion",
          vals: [24.1, 32.8, 25.3, 17.8],
          delta: ["+2.1", "-1.4", "-0.4", "-0.3"],
        },
      ];
      var ciCrossShop = [
        [100, 61, 38, 22],
        [54, 100, 41, 19],
        [44, 52, 100, 24],
        [38, 42, 34, 100],
      ];
      var ciIndexed = [
        { dim: "18–34", vals: [142, 88, 96, 112] },
        { dim: "35–54", vals: [108, 104, 98, 92] },
        { dim: "55+", vals: [82, 118, 106, 88] },
        { dim: "Southeast", vals: [138, 92, 84, 122] },
        { dim: "Northeast", vals: [94, 114, 102, 86] },
        { dim: "Midwest", vals: [112, 98, 108, 78] },
        { dim: "West", vals: [96, 106, 92, 106] },
      ];

      function setCiTab(tab, el) {
        ciTab = tab;
        document.querySelectorAll("#ciTabs .opt-tab").forEach(function (t) {
          t.classList.remove("active");
        });
        if (el) el.classList.add("active");
        renderCi();
      }

      function renderCi() {
        var body = document.getElementById("ciBody");
        if (!body) return;
        var h = "";
        var isCamp = ciCampOverlay !== "";

        if (ciTab === "wallet") {
          // Leaderboard table
          var leaders = [
            {
              name: "Burger King",
              color: "#6c5ce7",
              share: 34.0,
              wow: isCamp ? "+1.8" : "+0.4",
              mom: isCamp ? "+3.2" : "+0.9",
              self: true,
            },
            {
              name: "McDonald's",
              color: "#e17055",
              share: 29.2,
              wow: isCamp ? "-1.2" : "-0.3",
              mom: isCamp ? "-2.1" : "-0.6",
            },
            {
              name: "Wendy's",
              color: "#fdcb6e",
              share: 21.6,
              wow: isCamp ? "-0.1" : "0.0",
              mom: isCamp ? "-0.4" : "-0.3",
            },
            {
              name: "Popeye's",
              color: "#00b894",
              share: 15.2,
              wow: isCamp ? "+0.1" : "+0.1",
              mom: isCamp ? "+0.1" : "+0.2",
            },
          ];
          h +=
            '<table style="width:100%;border-collapse:collapse;font-size:11px;margin-bottom:12px">';
          h += "<thead><tr>";
          h +=
            '<th style="text-align:left;padding:5px 8px;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--text-tertiary);border-bottom:1px solid var(--card-border)">#</th>';
          h +=
            '<th style="text-align:left;padding:5px 8px;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--text-tertiary);border-bottom:1px solid var(--card-border)">Brand</th>';
          h +=
            '<th style="text-align:right;padding:5px 8px;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--text-tertiary);border-bottom:1px solid var(--card-border)">Share</th>';
          h +=
            '<th style="text-align:right;padding:5px 6px;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--text-tertiary);border-bottom:1px solid var(--card-border)">WoW</th>';
          h +=
            '<th style="text-align:right;padding:5px 6px;font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--text-tertiary);border-bottom:1px solid var(--card-border)">MoM</th>';
          h +=
            '<th style="padding:5px 8px;border-bottom:1px solid var(--card-border);width:30%"></th>';
          h += "</tr></thead><tbody>";
          leaders.forEach(function (l, i) {
            var wVal = parseFloat(l.wow),
              mVal = parseFloat(l.mom);
            var wC =
              wVal > 0
                ? "var(--teal)"
                : wVal < 0
                  ? "var(--coral)"
                  : "var(--text-tertiary)";
            var mC =
              mVal > 0
                ? "var(--teal)"
                : mVal < 0
                  ? "var(--coral)"
                  : "var(--text-tertiary)";
            var bg = l.self ? "background:var(--purple-bg)" : "";
            h += '<tr style="' + bg + '">';
            h +=
              '<td style="padding:7px 8px;font-size:11px;font-weight:700;color:var(--text-tertiary);border-bottom:1px solid var(--page-bg)">' +
              (i + 1) +
              "</td>";
            h +=
              '<td style="padding:7px 8px;border-bottom:1px solid var(--page-bg)"><div style="display:flex;align-items:center;gap:6px"><div style="width:8px;height:8px;border-radius:50%;background:' +
              l.color +
              '"></div><span style="font-weight:' +
              (l.self ? "700" : "600") +
              ";color:" +
              (l.self ? l.color : "var(--text-primary)") +
              '">' +
              l.name +
              "</span></div></td>";
            h +=
              '<td style="text-align:right;padding:7px 8px;font-size:14px;font-weight:800;color:var(--text-primary);border-bottom:1px solid var(--page-bg)">' +
              l.share +
              "%</td>";
            h +=
              '<td style="text-align:right;padding:7px 6px;font-weight:700;color:' +
              wC +
              ';border-bottom:1px solid var(--page-bg);font-size:11px">' +
              l.wow +
              "</td>";
            h +=
              '<td style="text-align:right;padding:7px 6px;font-weight:700;color:' +
              mC +
              ';border-bottom:1px solid var(--page-bg);font-size:11px">' +
              l.mom +
              "</td>";
            h +=
              '<td style="padding:7px 8px;border-bottom:1px solid var(--page-bg)"><div style="height:10px;background:var(--page-bg);border-radius:4px;overflow:hidden"><div style="height:100%;width:' +
              l.share +
              "%;background:" +
              l.color +
              ';border-radius:4px;opacity:0.5"></div></div></td>';
            h += "</tr>";
          });
          h += "</tbody></table>";

          // Controls row: campaign dropdown + time pills
          h +=
            '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">';
          h +=
            '<div style="font-size:10px;font-weight:600;color:var(--text-tertiary);white-space:nowrap">SHARE TREND</div>';
          if (isCamp)
            h +=
              '<span style="font-size:8px;font-weight:700;padding:2px 6px;border-radius:3px;background:var(--teal-bg);color:var(--teal);white-space:nowrap">EXPOSED</span>';
          h += '<div style="flex:1"></div>';
          h +=
            '<select class="filter-select" style="font-size:10px;padding:3px 24px 3px 8px" onchange="setCiCamp(this.value)">';
          h +=
            '<option value=""' +
            (ciCampOverlay === "" ? " selected" : "") +
            ">Organic</option>";
          measuredCampaigns.forEach(function (mc) {
            var label =
              mc.name.length > 30 ? mc.name.substring(0, 28) + "..." : mc.name;
            h +=
              '<option value="' +
              mc.id +
              '"' +
              (ciCampOverlay === mc.id ? " selected" : "") +
              ">" +
              label +
              "</option>";
          });
          h += "</select>";
          h += '<div style="display:flex;gap:2px">';
          [
            { k: "90d", l: "90D" },
            { k: "6m", l: "6M" },
            { k: "1y", l: "1Y" },
            { k: "2y", l: "2Y" },
          ].forEach(function (p) {
            h +=
              '<div class="filter-pill' +
              (p.k === ciTimePeriod ? " active" : "") +
              '" style="font-size:9px;padding:3px 7px;cursor:pointer" onclick="setCiTime(\'' +
              p.k +
              "')\">" +
              p.l +
              "</div>";
          });
          h += "</div>";
          h += "</div>";
          h +=
            '<div style="height:140px"><canvas id="ciShareCanvas"></canvas></div>';
        } else if (ciTab === "cohort") {
          h +=
            '<div style="font-size:10px;font-weight:600;color:var(--text-tertiary);margin-bottom:8px">SHARE OF WALLET BY COHORT — 90-DAY DELTA</div>';
          h +=
            '<table style="width:100%;border-collapse:collapse;font-size:11px">';
          h +=
            '<thead><tr><th style="text-align:left;padding:6px 8px;font-size:9px;font-weight:600;color:var(--text-tertiary);border-bottom:1px solid var(--card-border)">Cohort</th>';
          ciCompetitors.forEach(function (c) {
            h +=
              '<th style="text-align:center;padding:6px 4px;font-size:9px;font-weight:600;color:' +
              c.color +
              ';border-bottom:1px solid var(--card-border)">' +
              c.name
                .replace("McDonald\'s", "McD\'s")
                .replace("Popeye\'s", "Pop.") +
              "</th>";
          });
          h += "</tr></thead><tbody>";
          ciCohortShare.forEach(function (row) {
            h += "<tr>";
            h +=
              '<td style="padding:7px 8px;font-weight:600;color:var(--text-primary);border-bottom:1px solid var(--page-bg);font-size:10.5px">' +
              row.cohort +
              "</td>";
            row.vals.forEach(function (v, i) {
              var maxV = Math.max.apply(null, row.vals);
              var isMax = v === maxV;
              var bg = isMax ? ciCompetitors[i].color + "18" : "transparent";
              var d = row.delta[i];
              var dC = d.charAt(0) === "+" ? "var(--teal)" : "var(--coral)";
              h +=
                '<td style="text-align:center;padding:7px 4px;border-bottom:1px solid var(--page-bg);background:' +
                bg +
                '">';
              h +=
                '<div style="font-weight:' +
                (isMax ? "700" : "500") +
                ';font-size:12px">' +
                v +
                "%</div>";
              h +=
                '<div style="font-size:8px;font-weight:600;color:' +
                dC +
                '">' +
                d +
                "pp</div></td>";
            });
            h += "</tr>";
          });
          h += "</tbody></table>";
        } else if (ciTab === "crossshop") {
          h +=
            '<div style="font-size:10px;font-weight:600;color:var(--text-tertiary);margin-bottom:8px">CROSS-SHOP OVERLAP — % WHO ALSO BUY</div>';
          h +=
            '<table style="width:100%;border-collapse:collapse;font-size:11px">';
          h +=
            '<thead><tr><th style="padding:6px 8px;border-bottom:1px solid var(--card-border)"></th>';
          ciCompetitors.forEach(function (c) {
            h +=
              '<th style="text-align:center;padding:6px 4px;font-size:9px;font-weight:600;color:' +
              c.color +
              ';border-bottom:1px solid var(--card-border)">' +
              c.name
                .replace("McDonald\'s", "McD\'s")
                .replace("Popeye\'s", "Pop.") +
              "</th>";
          });
          h += "</tr></thead><tbody>";
          ciCompetitors.forEach(function (c, ri) {
            h +=
              '<tr><td style="padding:7px 8px;font-weight:600;color:' +
              c.color +
              ';border-bottom:1px solid var(--page-bg);font-size:10.5px">' +
              c.name +
              "</td>";
            ciCrossShop[ri].forEach(function (v, ci) {
              if (ri === ci) {
                h +=
                  '<td style="text-align:center;padding:7px 4px;border-bottom:1px solid var(--page-bg);background:var(--page-bg);color:var(--text-tertiary);font-size:10px">\u2014</td>';
              } else {
                var a = (Math.min(v / 65, 1) * 0.18).toFixed(2);
                h +=
                  '<td style="text-align:center;padding:7px 4px;border-bottom:1px solid var(--page-bg);background:rgba(108,92,231,' +
                  a +
                  ");font-weight:" +
                  (v >= 50 ? "700" : "500") +
                  '"><div style="font-size:12px">' +
                  v +
                  "%</div></td>";
              }
            });
            h += "</tr>";
          });
          h += "</tbody></table>";
          h +=
            '<div class="inline-prompt teal" style="margin-top:10px"><div><div class="inline-prompt-text"><strong>Activate against cross-shoppers.</strong> Build audiences of BK buyers who also shop competitors \u2014 ready for conquest targeting in 5 days.</div></div><button class="btn btn-teal btn-sm" onclick="openDrawer(\'audience\')" style="white-space:nowrap">Build Audience \u2192</button></div>';
        } else if (ciTab === "indexed") {
          h +=
            '<div style="font-size:10px;font-weight:600;color:var(--text-tertiary);margin-bottom:8px">INDEXED SHARE \u2014 100 = EXPECTED</div>';
          h +=
            '<table style="width:100%;border-collapse:collapse;font-size:11px">';
          h +=
            '<thead><tr><th style="text-align:left;padding:6px 8px;font-size:9px;font-weight:600;color:var(--text-tertiary);border-bottom:1px solid var(--card-border)">Dimension</th>';
          ciCompetitors.forEach(function (c) {
            h +=
              '<th style="text-align:center;padding:6px 4px;font-size:9px;font-weight:600;color:' +
              c.color +
              ';border-bottom:1px solid var(--card-border)">' +
              c.name
                .replace("McDonald\'s", "McD\'s")
                .replace("Popeye\'s", "Pop.") +
              "</th>";
          });
          h += "</tr></thead><tbody>";
          ciIndexed.forEach(function (row) {
            h +=
              '<tr><td style="padding:7px 8px;font-weight:600;color:var(--text-primary);border-bottom:1px solid var(--page-bg);font-size:10.5px">' +
              row.dim +
              "</td>";
            row.vals.forEach(function (v, i) {
              var color, bg;
              if (v >= 120) {
                color = "var(--teal)";
                bg = "var(--teal-bg)";
              } else if (v >= 105) {
                color = "var(--teal)";
                bg = "transparent";
              } else if (v <= 85) {
                color = "var(--coral)";
                bg = "var(--coral-bg)";
              } else if (v <= 95) {
                color = "var(--coral)";
                bg = "transparent";
              } else {
                color = "var(--text-secondary)";
                bg = "transparent";
              }
              h +=
                '<td style="text-align:center;padding:7px 4px;border-bottom:1px solid var(--page-bg);background:' +
                bg +
                '"><span style="font-size:12px;font-weight:700;color:' +
                color +
                '">' +
                v +
                "</span></td>";
            });
            h += "</tr>";
          });
          h += "</tbody></table>";
          h +=
            '<div style="margin-top:6px;display:flex;gap:12px;font-size:9px;color:var(--text-tertiary)"><span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:var(--teal-bg);border:1px solid var(--teal);vertical-align:-1px;margin-right:3px"></span>Over-index (120+)</span><span><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:var(--coral-bg);border:1px solid var(--coral);vertical-align:-1px;margin-right:3px"></span>Under-index (85-)</span></div>';
        }

        // Dynamic AI insight — shifts per tab + campaign filter
        h += getCiInsight();
        body.innerHTML = h;
        if (ciTab === "wallet") buildCiChart();
      }

      function getCiInsight() {
        var isCamp = ciCampOverlay !== "";
        var h =
          '<div style="margin-top:10px;padding:11px 14px;background:linear-gradient(135deg,#f0eeff,#faf9fd);border-radius:8px;border:1px solid #e0dced;font-size:11px;line-height:1.55">';
        h +=
          '<div style="display:flex;align-items:center;gap:5px;margin-bottom:5px"><svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="var(--purple-accent)" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg><span style="font-size:9px;font-weight:700;color:var(--purple-accent);text-transform:uppercase;letter-spacing:.4px">outcome AI</span></div>';
        if (ciTab === "wallet" && !isCamp) {
          h +=
            '<strong style="color:var(--text-primary)">BK is gaining share for the 4th consecutive week.</strong> <span style="color:var(--text-secondary)">You\'re up +0.4pp WoW and +0.9pp MoM, primarily at McDonald\'s expense (\u20130.3pp WoW). This organic momentum suggests strong brand health independent of media. Select a measured campaign from the dropdown to see how much media is accelerating these gains.</span>';
        } else if (ciTab === "wallet" && isCamp) {
          h +=
            '<strong style="color:var(--text-primary)">Media is amplifying share capture by 4.5x.</strong> <span style="color:var(--text-secondary)">Among exposed buyers, BK share grew +1.8pp WoW vs +0.4pp organically. McDonald\'s dropped \u20131.2pp in the exposed group vs \u20130.3pp organic \u2014 your conquest CTV is directly pulling their buyers. 58% of exposed share gains flow from McDonald\'s specifically.</span>';
        } else if (ciTab === "cohort") {
          h +=
            '<strong style="color:var(--text-primary)">Conquest is your fastest-growing segment.</strong> <span style="color:var(--text-secondary)">BK share among Competitor Conquest buyers grew +4.2pp \u2014 the highest gain of any cohort \u2014 while McDonald\'s lost 2.8pp in the same group. Ultra-Light is next at +3.8pp, suggesting upper-funnel media is converting awareness into trial. Your weakest competitive position is Lapsed buyers where McDonald\'s leads at 32.8%.</span>';
        } else if (ciTab === "crossshop") {
          h +=
            '<strong style="color:var(--text-primary)">61% of Frequent Buyers also buy McDonald\'s monthly.</strong> <span style="color:var(--text-secondary)">This is your largest wallet vulnerability. Among cross-shoppers targeted with conquest CTV, BK purchase frequency increased 18% while McDonald\'s frequency dropped 11%. The opportunity: build a cross-shopper audience and target with competitive messaging to shift wallet share.</span>';
        } else if (ciTab === "indexed") {
          h +=
            '<strong style="color:var(--text-primary)">18\u201334 and Southeast are your competitive moats.</strong> <span style="color:var(--text-secondary)">BK indexes 142 among 18\u201334 while McDonald\'s under-indexes at 88 \u2014 a 54-point gap and your strongest demographic advantage. In the Southeast, both BK (138) and Popeye\'s (122) over-index, signaling regional competitive intensity. Consider increasing Southeast media weight to defend against Popeye\'s expansion.</span>';
        }
        h += "</div>";
        return h;
      }

      function setCiTime(period) {
        ciTimePeriod = period;
        renderCi();
      }

      function setCiCamp(val) {
        ciCampOverlay = val;
        renderCi();
      }

      function buildCiChart() {
        var canvas = document.getElementById("ciShareCanvas");
        if (!canvas) return;
        if (ciShareChart) {
          try {
            ciShareChart.destroy();
          } catch (e) {}
        }
        var trend = ciWalletData.trends[ciTimePeriod];
        var datasets = ciCompetitors.map(function (c, i) {
          return {
            label: c.name,
            data: trend.data[i],
            borderColor: c.color,
            borderWidth: c.self ? 2.5 : 1.5,
            tension: 0.35,
            pointRadius: c.self ? 4 : 2.5,
            pointBackgroundColor: c.color,
            pointHoverRadius: 5,
          };
        });
        ciShareChart = new Chart(canvas, {
          type: "line",
          data: { labels: trend.labels, datasets: datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "bottom",
                labels: {
                  padding: 10,
                  usePointStyle: true,
                  pointStyle: "circle",
                  boxWidth: 6,
                  font: { size: 9.5 },
                },
              },
            },
            scales: {
              x: { grid: { display: false }, ticks: { font: { size: 9 } } },
              y: {
                grid: { color: "rgba(0,0,0,0.04)" },
                ticks: {
                  font: { size: 9 },
                  callback: function (v) {
                    return v + "%";
                  },
                },
                min:
                  Math.floor(
                    Math.min.apply(
                      null,
                      trend.data.map(function (d) {
                        return Math.min.apply(null, d);
                      }),
                    ) / 5,
                  ) * 5,
                max:
                  Math.ceil(
                    Math.max.apply(
                      null,
                      trend.data.map(function (d) {
                        return Math.max.apply(null, d);
                      }),
                    ) / 5,
                  ) * 5,
              },
            },
            interaction: { mode: "index", intersect: false },
          },
        });
      }

      setCiTab("wallet", document.querySelector("#ciTabs .opt-tab"));

      // ═══ AUDIENCE BUILDER LOGIC ═══

      function fillPrompt(el) {
        document.getElementById("audInput").value = el.textContent.trim();
        document.getElementById("audInput").focus();
      }

      function resetAudience() {
        document.getElementById("audPhase1").style.display = "";
        document.getElementById("audPhase2").style.display = "none";
        document.getElementById("audPhase3").style.display = "none";
        document.getElementById("audInput").value = "";
        document.getElementById("audNudge").innerHTML = "";
        // Reset gen steps
        for (let i = 1; i <= 5; i++) {
          const s = document.getElementById("genStep" + i);
          s.className = "gen-step";
          s.style.opacity = i === 1 ? "1" : "0.3";
          s.querySelector(".gen-check").textContent = i === 1 ? "✓" : "○";
        }
      }

      async function generateAudience() {
        try {
          const input = document.getElementById("audInput").value.trim();
          if (!input) {
            showToast("Please describe your audience first");
            return;
          }

          // Clear any previous nudge
          document.getElementById("audNudge").innerHTML = "";

          // ═══ SMART VALIDATION — detect unsupported signals ═══
          var inputLower = input.toLowerCase();
          var flags = [];

          var rules = [
            {
              test: function (s) {
                return (
                  /\.(com|org|net|io|co)\b/.test(s) ||
                  /\bwebsite\b|\bbrowsed?\b|\bweb traffic\b|\bsite visit|\bpageview|\blanded on\b|\bviewed page/.test(
                    s,
                  )
                );
              },
              type: "website/browsing data",
              why: "We don't track web visits — but we do see what people <strong>buy</strong>.",
            },
            {
              test: function (s) {
                return (
                  /\bvisit(ed|ors?|ing)?\b/.test(s) &&
                  /store|shop|location|mall|outlet/i.test(s)
                );
              },
              type: "foot traffic / store visits",
              why: "We don't track store visits directly, but we capture <strong>in-store purchase transactions</strong>.",
            },
            {
              test: function (s) {
                return /\bapp install|\bdownloaded app|\bopened app|\bmobile app\b|\bin-app\b/.test(
                  s,
                );
              },
              type: "app install/usage",
              why: "We don't see app installs, but we can target <strong>mobile order purchasers</strong>.",
            },
            {
              test: function (s) {
                return /\binstagram\b|\btiktok\b|\bfacebook\b|\btwitter\b|\bsocial media\b|\binfluencer|\bretweeted|\bfollowed\b/.test(
                  s,
                );
              },
              type: "social media activity",
              why: "We don't capture social behavior, but we know what those audiences <strong>actually purchase</strong>.",
            },
            {
              test: function (s) {
                return /\bsearched? (for)?\b|\bgoogled\b|\bsearch intent\b|\bkeyword/.test(
                  s,
                );
              },
              type: "search behavior",
              why: "We don't see search queries — but we can find people who <strong>purchased</strong> what others search for.",
            },
            {
              test: function (s) {
                return /\bemail open|\bclicked email|\bnewsletter|\bemail engagement/.test(
                  s,
                );
              },
              type: "email engagement",
              why: "We don't track email opens, but we see <strong>coupon and promotion redemption</strong> behavior.",
            },
            {
              test: function (s) {
                return /\bcredit score|\bbank account|\bloan\b|\bmortgage\b|\bnet worth/.test(
                  s,
                );
              },
              type: "financial/credit data",
              why: "We don't access credit data, but we infer <strong>household income from purchase patterns</strong>.",
            },
            {
              test: function (s) {
                return /\bnetflix\b|\bhulu\b|\bspotify\b|\bstreaming\b|\blistened to\b|\bplaylist/.test(
                  s,
                );
              },
              type: "streaming/media consumption",
              why: "We don't see streaming data, but we know the <strong>demographics and purchase habits</strong> of those audiences.",
            },
            {
              test: function (s) {
                return /\bcookie\b|\bpixel\b|\bdevice id\b|\bip address/.test(
                  s,
                );
              },
              type: "device-level tracking",
              why: "We build audiences from <strong>opted-in panelist purchase data</strong>, not cookies or device IDs.",
            },
          ];

          rules.forEach(function (r) {
            if (r.test(inputLower)) flags.push(r);
          });

          if (flags.length > 0) {
            var nudge = document.getElementById("audNudge");
            var reasons = flags
              .map(function (f) {
                return f.why;
              })
              .join(" ");
            var typeList = flags
              .map(function (f) {
                return f.type;
              })
              .join(", ");

            // Build 3 smart suggestions based on what they probably meant
            var suggestions = [];
            if (/nike/i.test(input))
              suggestions = [
                "Nike product purchasers in the last 90 days",
                "Athletic apparel buyers, $100+ spend, 25-44",
                "Sneaker enthusiasts who cross-shop Nike and Adidas",
              ];
            else if (/burger king|bk\b/i.test(input))
              suggestions = [
                "BK in-store purchasers, 2x+ per month",
                "BK buyers who also purchase McDonald's",
                "Lapsed BK customers, no purchase in 90 days",
              ];
            else if (/starbucks|coffee/i.test(input))
              suggestions = [
                "Weekly Starbucks purchasers, $25+ avg spend",
                "Coffee chain cross-shoppers: Starbucks + Dunkin",
                "Morning coffee buyers who use mobile ordering",
              ];
            else if (/amazon/i.test(input))
              suggestions = [
                "Frequent Amazon purchasers, 4x+ per month",
                "Amazon buyers who also shop at Walmart and Target",
                "High-AOV online shoppers, $150+ per transaction",
              ];
            else {
              // Generic suggestions based on detected intent
              var brand = input
                .replace(
                  /\b(visitors?|of|who|the|to|on|at|in|from|and|or|that|their|our|my|your|a|an|this|those|these|\.com|\.org|\.net|visited|browsed?|clicked?|searched?|for|site|website|page|app|social|media|email|streaming|watched)\b/gi,
                  "",
                )
                .replace(/\s+/g, " ")
                .trim();
              if (brand.length > 2) {
                suggestions = [
                  brand + " product purchasers in the last 90 days",
                  "People who spend $50+/month at " + brand,
                  "Cross-shoppers of " + brand + " and competitive brands",
                ];
              } else {
                suggestions = [
                  "QSR frequent purchasers, 4+ visits per month",
                  "Value-seekers who use coupons, buy fast food 3x+ weekly",
                  "Competitive QSR switchers who changed brands in last 6 months",
                ];
              }
            }

            nudge.innerHTML =
              '<div style="background:linear-gradient(135deg,#fff5ed,#fff0e8);border:1.5px solid #f0c8a0;border-radius:10px;padding:16px;margin-bottom:14px">' +
              '<div style="display:flex;align-items:flex-start;gap:10px">' +
              '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#e17055" stroke-width="2" style="flex-shrink:0;margin-top:2px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>' +
              '<div style="flex:1">' +
              '<div style="font-size:12px;font-weight:700;color:#c0392b;margin-bottom:6px">Can\'t build from ' +
              typeList +
              "</div>" +
              '<div style="font-size:11.5px;color:#6b5e4b;line-height:1.5;margin-bottom:12px">' +
              reasons +
              "</div>" +
              '<div style="font-size:10px;font-weight:600;color:#8a7a6b;text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px">Try one of these instead</div>' +
              suggestions
                .map(function (s) {
                  return (
                    "<div style=\"display:flex;align-items:center;gap:8px;margin-bottom:6px;cursor:pointer;padding:8px 10px;background:rgba(255,255,255,.7);border:1px solid #f0dcc8;border-radius:8px;transition:all .15s\" onmouseover=\"this.style.background='#fff';this.style.borderColor='var(--purple-accent)'\" onmouseout=\"this.style.background='rgba(255,255,255,.7)';this.style.borderColor='#f0dcc8'\" onclick=\"document.getElementById('audInput').value=this.querySelector('span').textContent;document.getElementById('audNudge').innerHTML=''\">" +
                    '<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="var(--purple-accent)" stroke-width="2" style="flex-shrink:0"><polyline points="9 18 15 12 9 6"/></svg>' +
                    '<span style="font-size:12px;color:var(--text-primary)">' +
                    s +
                    "</span></div>"
                  );
                })
                .join("") +
              '<div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:10px;padding-top:8px;border-top:1px solid #f0dcc8">' +
              '<span style="font-size:8px;padding:2px 6px;border-radius:3px;background:#f0eeff;color:var(--purple-accent);font-weight:600">Demographics</span>' +
              '<span style="font-size:8px;padding:2px 6px;border-radius:3px;background:var(--teal-bg);color:var(--teal);font-weight:600">Purchase Behavior</span>' +
              '<span style="font-size:8px;padding:2px 6px;border-radius:3px;background:var(--amber-bg);color:#e17055;font-weight:600">Psychographics</span>' +
              '<span style="font-size:8px;padding:2px 6px;border-radius:3px;background:#e8f4ff;color:#74b9ff;font-weight:600">Transactions</span>' +
              '<span style="font-size:8px;padding:2px 6px;border-radius:3px;background:var(--coral-bg);color:var(--coral);font-weight:600">Merchant/Product</span>' +
              '<span style="font-size:8px;padding:2px 6px;border-radius:3px;background:#fef9e7;color:#f39c12;font-weight:600">Occasion</span>' +
              "</div></div></div></div>";

            // Scroll nudge into view
            nudge.scrollIntoView({ behavior: "smooth", block: "nearest" });
            return;
          }

          // Phase 1 → Phase 2
          document.getElementById("audPhase1").style.display = "none";
          document.getElementById("audPhase2").style.display = "";

          // Animate steps
          const steps = [
            { id: 1, label: "Parsing audience definition", dur: 800 },
            { id: 2, label: "Matching purchase behaviors", dur: 1200 },
            { id: 3, label: "Applying demographic filters", dur: 1000 },
            { id: 4, label: "Estimating addressable reach", dur: 900 },
            { id: 5, label: "Generating audience insights", dur: 1400 },
          ];

          // Call Claude API in parallel with animation
          const apiPromise = callClaudeForAudience(input);

          for (const step of steps) {
            const el = document.getElementById("genStep" + step.id);
            el.style.opacity = "1";
            el.classList.add("active");
            el.querySelector(".gen-check").textContent = "◉";
            document.getElementById("audGenStatus").textContent =
              step.label + "...";
            await sleep(step.dur);
            el.classList.remove("active");
            el.classList.add("done");
            el.querySelector(".gen-check").textContent = "✓";
          }

          document.getElementById("audGenStatus").textContent =
            "Audience ready!";
          document.getElementById("audGenSub").textContent = "";

          let result;
          try {
            result = await apiPromise;
          } catch (e) {
            console.error(e);
            result = getFallbackResult(input);
          }

          await sleep(400);
          renderAudienceResult(result);
        } catch (globalErr) {
          console.error("generateAudience error:", globalErr);
          renderAudienceResult(getFallbackResult(""));
        }
      }

      function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }

      async function callClaudeForAudience(userPrompt) {
        try {
          const response = await fetch(
            "https://api.anthropic.com/v1/messages",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                model: "claude-sonnet-4-20250514",
                max_tokens: 1000,
                system: `You are an audience design AI for Attain, a consumer purchase data company with 10M+ opted-in panelists. 

IMPORTANT DATA BOUNDARIES: Attain's data is built from VERIFIED PURCHASE TRANSACTIONS. You can build audiences based on:
- Demographics: Age, Gender, Race/Ethnicity, Marital Status, Children in HH, Own vs Rent, HHI, Geography, Education
- Psychographics: Declared Interests, Life Events, Brand Loyalty, Merchant Loyalty, Purchase Motivation, Purchase Barriers, Predicted Spend
- Spend Behaviors: Purchase Recency, Frequency, Brand Switching, Cross-Brand, RFM Trending, Lapsed Buyers
- Transaction Types: Cash vs Card, Online vs In-Store, Single vs Subscription, AOV, Episodic Purchasing, Purchase Size
- Purchase Data: Merchant Vertical, Category, Specific Merchant, Specific Product, Sub-Brand
- Occasion/Season: Tentpole Events, Shopping Season, Dayparts, Cultural Tentpoles

You CANNOT build audiences based on: website visits, app installs, social media behavior, search intent, streaming/content consumption, email engagement, credit scores, device IDs, or cookies. If the user's query touches on these, translate it into the nearest purchase-based equivalent.

If the user's input is nonsensical, offensive, off-topic, or not a real audience description (e.g. "your mother", "asdf", "test", profanity, or jokes), still return valid JSON but interpret it charitably into the closest real audience. For example "your mother" becomes an audience of Mothers/Women with Children in Household. "pizza" becomes Pizza QSR purchasers. Always be helpful and creative in translation — never refuse, just reinterpret into purchase data terms.

Given a natural language audience description, return ONLY valid JSON (no markdown, no backticks, no preamble) with this exact structure:
{
  "name": "short catchy audience name, 3-6 words",
  "description": "1-2 sentence description of who this audience is and why they matter",
  "estimated_reach": "a realistic number between 800K and 4.2M formatted like 1.8M",
  "match_rate": "a percentage between 88-96%",
  "panel_seed": "a realistic number between 45K and 380K formatted like 142K",
  "spec": {
    "demographics": ["list of 2-3 demographic attributes like Age 25-44, Female, HHI $75K+"],
    "purchase_behaviors": ["list of 2-4 purchase behavior attributes like Buys BK 2x+/month, Shops at Walmart weekly"],
    "psychographics": ["list of 1-3 psychographic attributes like Value-seekers, Deal-motivated"],
    "cohort_alignment": "which of the 6 universal cohorts this best maps to: New-to-Category, Competitor Buyers, Lapsed & Lapsing, Ultra-Light Buyers, Frequent Buyers, or Most Loyal"
  },
  "insights": [
    {"label": "Top Generation", "value": "e.g. Millennials", "detail": "e.g. 48% of audience"},
    {"label": "Avg. Spend", "value": "e.g. $24.30/visit", "detail": "e.g. +12% vs category"},
    {"label": "Purchase Channel", "value": "e.g. 68% In-Store", "detail": "e.g. 32% delivery"},
    {"label": "Cross-Shop", "value": "e.g. McDonald's", "detail": "e.g. 57% also purchase"}
  ]
}
Make the data realistic and plausible for a QSR / CPG advertising context. The brand context is Burger King.`,
                messages: [{ role: "user", content: userPrompt }],
              }),
            },
          );
          const data = await response.json();
          if (
            !response.ok ||
            !data ||
            !data.content ||
            !Array.isArray(data.content)
          ) {
            console.warn("Unexpected API response shape:", data);
            return getFallbackResult(userPrompt);
          }
          const text = data.content
            .filter((i) => i && i.type === "text")
            .map((i) => i.text)
            .join("\n");
          if (!text) return getFallbackResult(userPrompt);
          const clean = text.replace(/```json|```/g, "").trim();
          return JSON.parse(clean);
        } catch (e) {
          console.error("API error:", e);
          return getFallbackResult(userPrompt);
        }
      }

      function getFallbackResult(input) {
        return {
          name: "Custom Purchase Audience",
          description:
            "Audience built from verified purchase data matching: " +
            input.substring(0, 120),
          estimated_reach: "1.6M",
          match_rate: "92%",
          panel_seed: "127K",
          spec: {
            demographics: ["Adults 25-54", "Census Balanced"],
            purchase_behaviors: [
              "Verified QSR purchasers",
              "Active in last 90 days",
              "2+ transactions/month",
            ],
            psychographics: ["Value-conscious", "Convenience-driven"],
            cohort_alignment: "Frequent Buyers",
          },
          insights: [
            {
              label: "Top Generation",
              value: "Millennials",
              detail: "43% of audience",
            },
            {
              label: "Avg. Spend",
              value: "$18.50/visit",
              detail: "+8% vs QSR avg",
            },
            {
              label: "Purchase Channel",
              value: "72% In-Store",
              detail: "28% delivery/online",
            },
            {
              label: "Cross-Shop",
              value: "McDonald's",
              detail: "61% also purchase",
            },
          ],
        };
      }

      function renderAudienceResult(r) {
        try {
          window._lastAudienceResult = r;
          r = r || {};
          r.spec = r.spec || {};
          r.insights = r.insights || [];
          document.getElementById("audPhase2").style.display = "none";
          document.getElementById("audPhase3").style.display = "";
          document
            .getElementById("audResultCard")
            .classList.add("result-burst");

          document.getElementById("audResultName").textContent =
            r.name || "Custom Audience";
          document.getElementById("audResultDesc").textContent =
            r.description || "";
          document.getElementById("audReach").textContent =
            r.estimated_reach || "1.6M";
          document.getElementById("audMatch").textContent =
            r.match_rate || "92%";
          document.getElementById("audSeed").textContent =
            r.panel_seed || "127K";

          // Spec
          const specWrap = document.getElementById("audSpecWrap");
          specWrap.innerHTML = `
    <div style="background:#faf9fd;border:1px solid var(--card-border);border-radius:8px;overflow:hidden">
      <div class="spec-row"><div class="spec-label">Demographics</div><div class="spec-value">${(r.spec.demographics || []).map((d) => '<span class="spec-tag">' + escapeHtml(d) + "</span>").join(" ")}</div></div>
      <div class="spec-row"><div class="spec-label">Purchase</div><div class="spec-value">${(r.spec.purchase_behaviors || []).map((d) => '<span class="spec-tag" style="background:var(--teal-bg);color:var(--teal)">' + escapeHtml(d) + "</span>").join(" ")}</div></div>
      <div class="spec-row"><div class="spec-label">Psychographic</div><div class="spec-value">${(r.spec.psychographics || []).map((d) => '<span class="spec-tag" style="background:var(--amber-bg);color:#e17055">' + escapeHtml(d) + "</span>").join(" ")}</div></div>
      <div class="spec-row"><div class="spec-label">Cohort</div><div class="spec-value"><span class="spec-tag" style="background:var(--coral-bg);color:var(--coral)">${escapeHtml(r.spec.cohort_alignment || "—")}</span></div></div>
    </div>`;

          // Insights
          const insWrap = document.getElementById("audInsights");
          insWrap.innerHTML = (r.insights || [])
            .map(
              (i) => `
    <div class="insight-mini">
      <div class="insight-mini-label">${escapeHtml((i && i.label) || "")}</div>
      <div class="insight-mini-value">${escapeHtml((i && i.value) || "")}</div>
      <div class="insight-mini-sub">${escapeHtml((i && i.detail) || "")}</div>
    </div>`,
            )
            .join("");
        } catch (e) {
          console.error("renderAudienceResult error:", e);
        }
      }

      function publishAudience() {
        const checked = document.querySelectorAll(".endpoint-cb:checked");
        if (checked.length === 0) {
          showToast("Select at least one activation endpoint");
          return;
        }
        const endpoints = [];
        checked.forEach((cb) =>
          endpoints.push(cb.parentElement.textContent.trim()),
        );
        // Capture the audience result and add to custom audiences
        if (window._lastAudienceResult) {
          customAudiences.push(window._lastAudienceResult);
          renderCohortCards();
        }
        showToast(
          "Audience published to " +
            endpoints.join(", ") +
            " — delivering within 5 business days",
        );
        setTimeout(() => closeDrawer(), 1500);
      }

      function removeCustomAudience(idx) {
        customAudiences.splice(idx, 1);
        renderCohortCards();
        showToast("Custom audience removed");
      }

      // ═══ MODE & KPI ═══
      function setMode(mode, el) {
        if (mode === currentMode) return;
        currentMode = mode;
        document
          .querySelectorAll(".mode-opt")
          .forEach((o) => o.classList.remove("active"));
        el.classList.add("active");
        var hint = document.getElementById("modeHint");
        hint.textContent =
          mode === "insights"
            ? "Showing longitudinal purchase insights"
            : "Showing media-attributed performance";
        hint.classList.remove("hint-pulse");
        void hint.offsetWidth;
        hint.classList.add("hint-pulse");
        // Toggle filter visibility
        document.getElementById("insightsFilters").style.display =
          mode === "insights" ? "flex" : "none";
        document.getElementById("attrFilters").style.display =
          mode === "attribution" ? "flex" : "none";
        // Show/hide media optimization grid
        var optEl = document.getElementById("mediaOptGrid");
        if (optEl) {
          optEl.style.display = mode === "attribution" ? "" : "none";
          if (mode === "attribution") renderOptGrid();
        }
        renderKPIs();
        renderCohortCards();
        buildChart();
        updateMigration();
        updateHeroOnramp();
        // Trigger swap animation on cohort cards and KPI tiles
        document.querySelectorAll(".cohort-card").forEach(function (card, i) {
          card.classList.remove("mode-swap");
          void card.offsetWidth;
          card.classList.add("mode-swap");
          card.style.animationDelay = i * 0.04 + "s";
        });
        document
          .querySelectorAll("#kpiRow .kpi-card")
          .forEach(function (card, i) {
            card.classList.remove("mode-swap");
            void card.offsetWidth;
            card.classList.add("mode-swap");
            card.style.animationDelay = i * 0.05 + "s";
          });
      }
      function setInsightsTime(el) {
        document
          .querySelectorAll("#insTimePills .filter-pill")
          .forEach(function (p) {
            p.classList.remove("active");
          });
        el.classList.add("active");
        currentInsightsTime = el.dataset.time;
        buildChart();
      }
      function setDimension(val) {
        showToast("Dimension: " + val);
      }
      function renderKPIs() {
        var row = document.getElementById("kpiRow");
        if (currentMode === "insights") {
          row.innerHTML =
            '<div class="kpi-card dark"><div class="kpi-label">Avg. Total Spend</div><div class="kpi-value">$111.90 <span class="kpi-delta up">&#9650; 4.2%</span></div></div><div class="kpi-card"><div class="kpi-label">Avg. Spend / Txn</div><div class="kpi-value">$19.07 <span class="kpi-delta up">&#9650; 3.2%</span></div></div><div class="kpi-card"><div class="kpi-label">Avg. Purchase Freq.</div><div class="kpi-value">6.4x <span class="kpi-delta up">&#9650; 1.8%</span></div></div><div class="kpi-card"><div class="kpi-label">Repeat Buyer %</div><div class="kpi-value">70.9% <span class="kpi-delta down">&#9660; 0.8%</span></div></div><div class="kpi-card"><div class="kpi-label">Net New Buyers</div><div class="kpi-value">4,328 <span class="kpi-delta up">&#9650; 14.4%</span></div></div>';
        } else {
          var showNnb = !!kpiBuyerNnb;
          var buyerVal = showNnb ? "1,847" : "19,461";
          var buyerDelta = showNnb
            ? '<span class="kpi-delta up">&#9650; 22.3%</span>'
            : '<span class="kpi-delta down">&#9660; 2.0%</span>';
          var buyerLabel = showNnb ? "Net-New Buyers" : "Converting Buyers";
          var gearSvg =
            '<svg viewBox="0 0 24 24" width="11" height="11" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>';

          // Toggle
          var toggleHtml = '<div style="display:flex;gap:0;margin-top:5px">';
          toggleHtml +=
            '<div onclick="event.stopPropagation();kpiBuyerNnb=false;renderKPIs()" style="font-size:8px;font-weight:600;padding:2px 6px;border-radius:3px 0 0 3px;cursor:pointer;border:1px solid var(--card-border);' +
            (showNnb
              ? "background:transparent;color:var(--text-tertiary)"
              : "background:var(--purple-accent);color:#fff;border-color:var(--purple-accent)") +
            '">All</div>';
          toggleHtml +=
            '<div onclick="event.stopPropagation();kpiBuyerNnb=true;renderKPIs()" style="font-size:8px;font-weight:600;padding:2px 6px;border-radius:0 3px 3px 0;cursor:pointer;border:1px solid var(--card-border);border-left:0;' +
            (showNnb
              ? "background:var(--purple-accent);color:#fff;border-color:var(--purple-accent)"
              : "background:transparent;color:var(--text-tertiary)") +
            '">Net-New</div>';
          toggleHtml += "</div>";

          // Buyers card with gear
          var attrWindowLabel =
            kpiAttrWindow === "default"
              ? ""
              : ' <span style="font-size:8px;color:var(--purple-accent);font-weight:600">' +
                kpiAttrWindow +
                "</span>";
          var nnbWindowLabel =
            kpiNnbWindow === "default"
              ? ""
              : ' <span style="font-size:8px;color:var(--purple-accent);font-weight:600">' +
                kpiNnbWindow +
                "</span>";
          var buyersCard = '<div class="kpi-card" style="position:relative">';
          buyersCard +=
            '<div style="display:flex;align-items:center;justify-content:space-between"><div class="kpi-label">' +
            buyerLabel +
            attrWindowLabel +
            "</div>";
          buyersCard +=
            '<div onclick="event.stopPropagation();toggleKpiGear(\'buyerGear\')" style="cursor:pointer;color:var(--text-tertiary);padding:2px;border-radius:4px;transition:color .15s" onmouseenter="this.style.color=\'var(--purple-accent)\'" onmouseleave="this.style.color=\'var(--text-tertiary)\'">' +
            gearSvg +
            "</div></div>";
          buyersCard +=
            '<div class="kpi-value">' + buyerVal + " " + buyerDelta + "</div>";
          buyersCard += toggleHtml;
          // Gear dropdown
          buyersCard +=
            '<div id="buyerGear" style="display:none;position:absolute;top:calc(100% + 4px);left:-4px;right:-4px;z-index:50;background:#fff;border:1px solid var(--card-border);border-radius:10px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.12)">';
          buyersCard +=
            '<div style="font-size:10px;font-weight:700;color:var(--text-primary);margin-bottom:8px">Attribution Window</div>';
          buyersCard +=
            '<div style="font-size:9px;color:var(--text-tertiary);margin-bottom:8px">How long after ad exposure should a purchase receive campaign credit?</div>';
          var attrOpts = [
            "1 day",
            "3 days",
            "4 days",
            "7 days",
            "14 days",
            "30 days",
            "45 days",
          ];
          buyersCard +=
            '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">';
          attrOpts.forEach(function (o) {
            var isActive = kpiAttrWindow === o;
            buyersCard +=
              "<div onclick=\"event.stopPropagation();setKpiAttrWindow('" +
              o +
              '\')" style="font-size:9px;font-weight:600;padding:3px 8px;border-radius:4px;cursor:pointer;border:1px solid ' +
              (isActive ? "var(--purple-accent)" : "var(--card-border)") +
              ";background:" +
              (isActive ? "var(--purple-bg)" : "transparent") +
              ";color:" +
              (isActive ? "var(--purple-accent)" : "var(--text-secondary)") +
              '">' +
              o +
              "</div>";
          });
          buyersCard += "</div>";
          if (showNnb) {
            buyersCard +=
              '<div style="font-size:10px;font-weight:700;color:var(--text-primary);margin-bottom:8px;padding-top:8px;border-top:1px solid var(--card-border)">Net-New Lookback</div>';
            buyersCard +=
              '<div style="font-size:9px;color:var(--text-tertiary);margin-bottom:8px">How far back should we check for prior purchases to define a buyer as net-new?</div>';
            var nnbOpts = [
              "30 days",
              "45 days",
              "90 days",
              "180 days",
              "12 months",
              "18 months",
            ];
            buyersCard +=
              '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">';
            nnbOpts.forEach(function (o) {
              var isActive = kpiNnbWindow === o;
              buyersCard +=
                "<div onclick=\"event.stopPropagation();setKpiNnbWindow('" +
                o +
                '\')" style="font-size:9px;font-weight:600;padding:3px 8px;border-radius:4px;cursor:pointer;border:1px solid ' +
                (isActive ? "var(--purple-accent)" : "var(--card-border)") +
                ";background:" +
                (isActive ? "var(--purple-bg)" : "transparent") +
                ";color:" +
                (isActive ? "var(--purple-accent)" : "var(--text-secondary)") +
                '">' +
                o +
                "</div>";
            });
            buyersCard += "</div>";
          }
          buyersCard +=
            '<div onclick="event.stopPropagation();resetKpiWindows()" style="font-size:9px;font-weight:600;color:var(--coral);cursor:pointer;text-align:center;padding-top:6px;border-top:1px solid var(--card-border)">Reset to defaults</div>';
          buyersCard += "</div>";
          buyersCard += "</div>";

          // CLTV card with gear
          var cltvCard =
            '<div class="kpi-card" style="position:relative;background:linear-gradient(135deg,#f0eeff,#faf9fd);border:1px solid #e0dced">';
          cltvCard +=
            '<div style="display:flex;align-items:center;justify-content:space-between"><div class="kpi-label" style="color:var(--purple-accent)">Predicted CLTV' +
            nnbWindowLabel +
            "</div>";
          cltvCard +=
            '<div onclick="event.stopPropagation();toggleKpiGear(\'cltvGear\')" style="cursor:pointer;color:var(--text-tertiary);padding:2px;border-radius:4px;transition:color .15s" onmouseenter="this.style.color=\'var(--purple-accent)\'" onmouseleave="this.style.color=\'var(--text-tertiary)\'">' +
            gearSvg +
            "</div></div>";
          cltvCard +=
            '<div class="kpi-value" style="color:var(--purple-accent)">$4.2M <span class="kpi-delta up">&#9650; 18.6%</span></div>';
          cltvCard +=
            '<div style="font-size:8.5px;color:var(--text-tertiary);margin-top:3px">From 1,847 net-new converters</div>';
          // CLTV gear dropdown
          cltvCard +=
            '<div id="cltvGear" style="display:none;position:absolute;top:calc(100% + 4px);right:-4px;left:-4px;z-index:50;background:#fff;border:1px solid var(--card-border);border-radius:10px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.12)">';
          cltvCard +=
            '<div style="font-size:10px;font-weight:700;color:var(--text-primary);margin-bottom:8px">LTV Prediction Window</div>';
          cltvCard +=
            '<div style="font-size:9px;color:var(--text-tertiary);margin-bottom:8px">How far back should we look to define a converter as net-new for LTV modeling?</div>';
          var cltvNnbOpts = [
            "30 days",
            "45 days",
            "90 days",
            "180 days",
            "12 months",
            "18 months",
          ];
          cltvCard +=
            '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px">';
          cltvNnbOpts.forEach(function (o) {
            var isActive = kpiNnbWindow === o;
            cltvCard +=
              "<div onclick=\"event.stopPropagation();setKpiNnbWindow('" +
              o +
              '\')" style="font-size:9px;font-weight:600;padding:3px 8px;border-radius:4px;cursor:pointer;border:1px solid ' +
              (isActive ? "var(--purple-accent)" : "var(--card-border)") +
              ";background:" +
              (isActive ? "var(--purple-bg)" : "transparent") +
              ";color:" +
              (isActive ? "var(--purple-accent)" : "var(--text-secondary)") +
              '">' +
              o +
              "</div>";
          });
          cltvCard += "</div>";
          cltvCard +=
            '<div onclick="event.stopPropagation();resetKpiWindows()" style="font-size:9px;font-weight:600;color:var(--coral);cursor:pointer;text-align:center;padding-top:6px;border-top:1px solid var(--card-border)">Reset to defaults</div>';
          cltvCard += "</div>";
          cltvCard += "</div>";

          row.innerHTML =
            '<div class="kpi-card dark"><div class="kpi-label">Total Sales</div><div class="kpi-value">$653K <span class="kpi-delta up">&#9650; 9.8%</span></div></div>' +
            '<div class="kpi-card"><div class="kpi-label">Attributed Sales</div><div class="kpi-value">$271.8K <span class="kpi-delta up">&#9650; 41.6%</span></div></div>' +
            '<div class="kpi-card"><div class="kpi-label">ROAS</div><div class="kpi-value">3.59x <span class="kpi-delta up">&#9650; 12.1%</span></div></div>' +
            buyersCard +
            cltvCard;
        }
      }
      var kpiBuyerNnb = false;
      var kpiAttrWindow = "default";
      var kpiNnbWindow = "default";
      function toggleKpiGear(id) {
        var el = document.getElementById(id);
        if (!el) return;
        var other = id === "buyerGear" ? "cltvGear" : "buyerGear";
        var otherEl = document.getElementById(other);
        if (otherEl) {
          otherEl.style.display = "none";
          if (otherEl.parentElement) otherEl.parentElement.style.zIndex = "";
        }
        var opening = el.style.display === "none";
        el.style.display = opening ? "" : "none";
        if (el.parentElement)
          el.parentElement.style.zIndex = opening ? "40" : "";
      }
      function setKpiAttrWindow(v) {
        kpiAttrWindow = v;
        renderKPIs();
      }
      function setKpiNnbWindow(v) {
        kpiNnbWindow = v;
        renderKPIs();
      }
      function resetKpiWindows() {
        kpiAttrWindow = "default";
        kpiNnbWindow = "default";
        kpiBuyerNnb = false;
        renderKPIs();
      }
      renderKPIs();
      renderOptGrid();

      // ═══ AI SUMMARY ═══
      async function runAISummary() {
        var body = document.getElementById("aiBody");
        var mode = currentMode;
        body.innerHTML =
          '<div style="display:flex;background:var(--page-bg);border-radius:10px;overflow:hidden;margin-bottom:20px"><div class="ai-mode-btn' +
          (mode === "insights" ? " active" : "") +
          '" onclick="switchAIMode(\'insights\')" style="flex:1;padding:10px;text-align:center;font-size:12px;font-weight:600;cursor:pointer;color:' +
          (mode === "insights" ? "#fff" : "var(--text-tertiary)") +
          ";background:" +
          (mode === "insights" ? "var(--purple-accent)" : "transparent") +
          ';transition:all .2s">Purchase Insights</div><div class="ai-mode-btn' +
          (mode === "attribution" ? " active" : "") +
          '" onclick="switchAIMode(\'attribution\')" style="flex:1;padding:10px;text-align:center;font-size:12px;font-weight:600;cursor:pointer;color:' +
          (mode === "attribution" ? "#fff" : "var(--text-tertiary)") +
          ";background:" +
          (mode === "attribution" ? "var(--purple-accent)" : "transparent") +
          ';transition:all .2s">Attribution</div></div><div id="aiContent"><div style="text-align:center;padding:30px"><div class="ai-typing"></div><div style="font-size:13px;color:var(--text-secondary);margin-top:12px">Analyzing ' +
          (mode === "insights" ? "purchase behavior" : "media attribution") +
          "...</div></div></div>";

        var insightBlocks = [
          {
            t: "\u{1F4CA} Performance Overview",
            b: "Burger King is showing strong momentum. Total spend per buyer is up 4.2% to $111.90, with purchase frequency at 6.4x. Repeat buyer rate (70.9%) is trending slightly down \u2014 worth monitoring, but offset by a 14.4% surge in net new buyers.",
            m: [
              { v: "$111.90", l: "Avg Spend" },
              { v: "6.4x", l: "Frequency" },
              { v: "70.9%", l: "Repeat Rate" },
            ],
          },
          {
            t: "\u{1F3AF} Cohort Insights",
            b: "Your <strong>New-to-Category</strong> segment is the standout \u2014 growing 14.4% and now 15.8% of sales mix. Competitor conquest is accelerating (+11.5%). The concern: <strong>Lapsed & Lapsing</strong> is down 3.2%, with 156 frequent buyers showing lapsing signals.",
          },
          {
            t: "\u26A1 Creative Signal",
            b: "The <strong>Family Bundle</strong> creative drives disproportionate response from Ultra-Light and New-to-Category buyers. <strong>Flame-Grilled Taste</strong> resonates most with Loyal and Frequent buyers. Consider splitting creative allocation by cohort objective.",
          },
          {
            t: "\u{1F3C6} Competitive Position",
            b: "BK holds 34% share of wallet in QSR, up from 31% in Q1 2025. McDonald's is declining (30.5% \u2192 29.2%) while Popeye's is gaining. Your share growth correlates with increased new-buyer acquisition.",
          },
          {
            t: "\u{1F4A1} Recommended Actions",
            b: "<strong>1.</strong> Activate a retention audience from the 156 lapsing frequent buyers.<br><strong>2.</strong> Scale the Family Bundle creative \u2014 best new-buyer driver.<br><strong>3.</strong> Tag Q1 Conquest campaign for attribution to quantify share gains.",
          },
        ];
        var attrBlocks = [
          {
            t: "\u{1F4B0} Attribution Summary",
            b: "$271.8K in sales attributed to tagged media this period, representing 41.6% of total sales. Overall blended ROAS is 3.59x \u2014 up 12.1% from prior period. Media is demonstrably driving real purchase behavior.",
            m: [
              { v: "$271.8K", l: "Attributed" },
              { v: "3.59x", l: "ROAS" },
              { v: "41.6%", l: "Attr. Rate" },
            ],
          },
          {
            t: "\u{1F3AF} ROAS by Cohort",
            b: "<strong>Competitor Buyers</strong> are your highest-ROAS segment at 4.5x \u2014 every dollar spent conquesting delivers $4.50 in sales. <strong>New-to-Category</strong> is accelerating to 3.7x. <strong>Loyal</strong> buyers show the lowest ROAS (2.1x), which makes sense \u2014 they were already buying. Consider shifting budget toward conquest and penetration.",
            m: [
              { v: "4.5x", l: "Competitor" },
              { v: "3.7x", l: "New-to-Cat" },
              { v: "2.1x", l: "Loyal" },
            ],
          },
          {
            t: "\u{1F4FA} Channel Efficiency",
            b: "<strong>CTV</strong> is driving the most efficient new buyer acquisition at $18.40 CPA, while <strong>Social</strong> leads on Competitor conquest. <strong>Display</strong> has the broadest reach but lowest ROAS. Consider shifting 15-20% of display budget to CTV for the next flight.",
          },
          {
            t: "\u{1F4C8} Campaign Performance",
            b: "The <strong>Black Friday</strong> campaign is your top performer at 3.59x ROAS with 1,212 new buyers attributed. <strong>Q1 Conquest</strong> is untagged \u2014 tagging it would likely push your overall attributed rate above 50%. <strong>Loyalty CTV</strong> at 2.18x is underperforming but efficiently retaining high-value buyers.",
          },
          {
            t: "\u{1F4A1} Optimization Actions",
            b: "<strong>1.</strong> Tag the Q1 Conquest campaign immediately \u2014 it's your largest blind spot.<br><strong>2.</strong> Shift 15% of display budget to CTV based on CPA efficiency.<br><strong>3.</strong> Send conversion signals to Meta via CAPI to close the attribution loop.<br><strong>4.</strong> Layer sales attribution on your next audience activation to prove incrementality.",
          },
        ];

        var blocks = mode === "attribution" ? attrBlocks : insightBlocks;
        var content = document.getElementById("aiContent");
        content.innerHTML = "";
        for (var j = 0; j < blocks.length; j++) {
          await sleep(700);
          var bl = blocks[j];
          var mhtml = "";
          if (bl.m) {
            mhtml =
              '<div class="ai-metric-row">' +
              bl.m
                .map(function (mm) {
                  return (
                    '<div class="ai-metric"><div class="ai-metric-val">' +
                    mm.v +
                    '</div><div class="ai-metric-label">' +
                    mm.l +
                    "</div></div>"
                  );
                })
                .join("") +
              "</div>";
          }
          content.innerHTML +=
            '<div class="ai-block" style="animation-delay:' +
            j * 0.1 +
            's"><div class="ai-block-title">' +
            bl.t +
            '</div><div class="ai-block-body">' +
            bl.b +
            mhtml +
            "</div></div>";
          body.scrollTop = body.scrollHeight;
        }
      }
      function switchAIMode(m) {
        currentMode = m;
        document.querySelectorAll(".mode-opt").forEach(function (o) {
          o.classList.remove("active");
        });
        document.querySelectorAll(".mode-opt").forEach(function (o) {
          if (
            (m === "insights" && o.textContent.includes("Insights")) ||
            (m === "attribution" && o.textContent.includes("Attribution"))
          )
            o.classList.add("active");
        });
        document.getElementById("modeHint").textContent =
          m === "insights"
            ? "Showing longitudinal purchase insights"
            : "Showing media-attributed performance";
        renderKPIs();
        renderCohortCards();
        buildChart();
        updateMigration();
        updateHeroOnramp();
        runAISummary();
      }

      // ═══ MIGRATION SANKEY ═══
      var migMode = "organic";
      var migLeft = "3-6";
      var migRight = "3";
      function setMigMode(m, el) {
        migMode = m;
        document
          .querySelectorAll("#migOrgBtn,#migAttrBtn")
          .forEach(function (b) {
            b.classList.remove("active");
          });
        el.classList.add("active");
        updateMigration();
      }
      function setMigLeft(v, el) {
        migLeft = v;
        document
          .querySelectorAll("#migLeftPills .filter-pill")
          .forEach(function (p) {
            p.classList.remove("active");
          });
        el.classList.add("active");
        updateMigration();
      }
      function setMigRight(v, el) {
        migRight = v;
        document
          .querySelectorAll("#migRightPills .filter-pill")
          .forEach(function (p) {
            p.classList.remove("active");
          });
        el.classList.add("active");
        updateMigration();
      }

      function updateMigration() {
        var mb = document.getElementById("migBody");
        var isAttr = migMode === "attribution";
        var leftLabel =
          migLeft === "3-6" ? "3–6 Months Ago" : "6–12 Months Ago";
        var rightLabel = migRight === "3" ? "Last 3 Months" : "Last 6 Months";
        document.getElementById("migSub").textContent = isAttr
          ? "Media-exposed buyer movement · " + leftLabel + " → " + rightLabel
          : "All buyer movement · " + leftLabel + " → " + rightLabel;

        var segs = [
          { name: "New-to-Cat", color: "#6c5ce7", label: "New-to-Category" },
          {
            name: "Competitor",
            color: "#e17055",
            label: "Competitor Conquest",
          },
          { name: "Lapsed", color: "#d63031", label: "Lapsed & Lapsing" },
          {
            name: "Ultra-Light",
            color: "#74b9ff",
            label: "Ultra-Light Buyers",
          },
          { name: "Frequent", color: "#00b894", label: "Frequent Buyers" },
          { name: "Loyal", color: "#fdcb6e", label: "Most Loyal / VIP" },
        ];

        // Migration flow data keyed by left_right_mode
        var flowSets = {
          "3-6_3_organic": [
            { f: 0, t: 3, v: 1204, d: "up" },
            { f: 0, t: 0, v: 2180, d: "stay" },
            { f: 0, t: 2, v: 944, d: "down" },
            { f: 1, t: 0, v: 312, d: "up" },
            { f: 1, t: 1, v: 1840, d: "stay" },
            { f: 1, t: 3, v: 835, d: "up" },
            { f: 2, t: 0, v: 148, d: "up" },
            { f: 2, t: 2, v: 820, d: "stay" },
            { f: 2, t: 3, v: 286, d: "up" },
            { f: 3, t: 4, v: 847, d: "up" },
            { f: 3, t: 3, v: 6100, d: "stay" },
            { f: 3, t: 2, v: 1595, d: "down" },
            { f: 4, t: 5, v: 211, d: "up" },
            { f: 4, t: 4, v: 8400, d: "stay" },
            { f: 4, t: 3, v: 1495, d: "down" },
            { f: 5, t: 5, v: 1420, d: "stay" },
            { f: 5, t: 4, v: 157, d: "down" },
            { f: 5, t: 2, v: 156, d: "down" },
          ],
          "6-12_3_organic": [
            { f: 0, t: 3, v: 1680, d: "up" },
            { f: 0, t: 0, v: 1420, d: "stay" },
            { f: 0, t: 2, v: 1228, d: "down" },
            { f: 1, t: 0, v: 480, d: "up" },
            { f: 1, t: 1, v: 1200, d: "stay" },
            { f: 1, t: 3, v: 1307, d: "up" },
            { f: 2, t: 0, v: 210, d: "up" },
            { f: 2, t: 2, v: 600, d: "stay" },
            { f: 2, t: 3, v: 444, d: "up" },
            { f: 3, t: 4, v: 1280, d: "up" },
            { f: 3, t: 3, v: 5200, d: "stay" },
            { f: 3, t: 2, v: 2062, d: "down" },
            { f: 4, t: 5, v: 380, d: "up" },
            { f: 4, t: 4, v: 7800, d: "stay" },
            { f: 4, t: 3, v: 1926, d: "down" },
            { f: 5, t: 5, v: 1100, d: "stay" },
            { f: 5, t: 4, v: 320, d: "down" },
            { f: 5, t: 2, v: 313, d: "down" },
          ],
          "3-6_6_organic": [
            { f: 0, t: 3, v: 1540, d: "up" },
            { f: 0, t: 0, v: 1900, d: "stay" },
            { f: 0, t: 2, v: 888, d: "down" },
            { f: 1, t: 0, v: 420, d: "up" },
            { f: 1, t: 1, v: 1600, d: "stay" },
            { f: 1, t: 3, v: 967, d: "up" },
            { f: 2, t: 0, v: 190, d: "up" },
            { f: 2, t: 2, v: 710, d: "stay" },
            { f: 2, t: 3, v: 354, d: "up" },
            { f: 3, t: 4, v: 1100, d: "up" },
            { f: 3, t: 3, v: 5600, d: "stay" },
            { f: 3, t: 2, v: 1842, d: "down" },
            { f: 4, t: 5, v: 290, d: "up" },
            { f: 4, t: 4, v: 8100, d: "stay" },
            { f: 4, t: 3, v: 1716, d: "down" },
            { f: 5, t: 5, v: 1260, d: "stay" },
            { f: 5, t: 4, v: 240, d: "down" },
            { f: 5, t: 2, v: 233, d: "down" },
          ],
          "6-12_6_organic": [
            { f: 0, t: 3, v: 2100, d: "up" },
            { f: 0, t: 0, v: 1100, d: "stay" },
            { f: 0, t: 2, v: 1128, d: "down" },
            { f: 1, t: 0, v: 620, d: "up" },
            { f: 1, t: 1, v: 980, d: "stay" },
            { f: 1, t: 3, v: 1387, d: "up" },
            { f: 2, t: 0, v: 280, d: "up" },
            { f: 2, t: 2, v: 500, d: "stay" },
            { f: 2, t: 3, v: 474, d: "up" },
            { f: 3, t: 4, v: 1600, d: "up" },
            { f: 3, t: 3, v: 4800, d: "stay" },
            { f: 3, t: 2, v: 2142, d: "down" },
            { f: 4, t: 5, v: 520, d: "up" },
            { f: 4, t: 4, v: 7200, d: "stay" },
            { f: 4, t: 3, v: 2386, d: "down" },
            { f: 5, t: 5, v: 900, d: "stay" },
            { f: 5, t: 4, v: 440, d: "down" },
            { f: 5, t: 2, v: 393, d: "down" },
          ],
        };
        // Attribution versions — smaller numbers, media-exposed only
        ["3-6_3", "6-12_3", "3-6_6", "6-12_6"].forEach(function (k) {
          flowSets[k + "_attribution"] = flowSets[k + "_organic"].map(
            function (fl) {
              var scale = fl.d === "up" ? 0.52 : fl.d === "stay" ? 0.38 : 0.28;
              return { f: fl.f, t: fl.t, v: Math.round(fl.v * scale), d: fl.d };
            },
          );
        });

        var key = migLeft + "_" + migRight + "_" + migMode;
        var flows = flowSets[key] || flowSets["3-6_3_organic"];

        // Compute totals per side
        var leftTotals = [0, 0, 0, 0, 0, 0];
        var rightTotals = [0, 0, 0, 0, 0, 0];
        flows.forEach(function (fl) {
          leftTotals[fl.f] += fl.v;
          rightTotals[fl.t] += fl.v;
        });

        // SVG dimensions
        var W = 520,
          nodeW = 100,
          gap = 12,
          topPad = 18;
        var nodeH = 28;
        var totalH = segs.length * (nodeH + gap) - gap + topPad + 20;

        var svg =
          '<svg viewBox="0 0 ' +
          W +
          " " +
          totalH +
          '" style="width:100%;height:' +
          totalH +
          'px;margin-top:8px" id="migSvg">';

        // Build node positions
        var leftNodes = [],
          rightNodes = [];
        segs.forEach(function (s, i) {
          var y = topPad + i * (nodeH + gap);
          leftNodes.push({
            name: s.name,
            color: s.color,
            label: s.label,
            y: y,
            total: leftTotals[i],
          });
          rightNodes.push({
            name: s.name,
            color: s.color,
            label: s.label,
            y: y,
            total: rightTotals[i],
          });
        });

        var maxFlow = Math.max.apply(
          null,
          flows.map(function (f) {
            return f.v;
          }),
        );

        // Draw flows
        flows.forEach(function (fl, fi) {
          var ln = leftNodes[fl.f],
            rn = rightNodes[fl.t];
          var x1 = nodeW,
            y1 = ln.y + nodeH / 2;
          var x2 = W - nodeW,
            y2 = rn.y + nodeH / 2;
          var thickness = Math.max(2, (fl.v / maxFlow) * 18);
          var cx1 = x1 + (x2 - x1) * 0.35,
            cx2 = x1 + (x2 - x1) * 0.65;
          var flowColor =
            fl.d === "up"
              ? "rgba(0,184,148,.2)"
              : fl.d === "down"
                ? "rgba(214,48,49,.15)"
                : "rgba(150,150,170,.12)";
          var hoverColor =
            fl.d === "up"
              ? "rgba(0,184,148,.5)"
              : fl.d === "down"
                ? "rgba(214,48,49,.4)"
                : "rgba(150,150,170,.35)";
          svg +=
            '<g class="mig-flow" data-fi="' +
            fi +
            '" data-from="' +
            segs[fl.f].label +
            '" data-to="' +
            segs[fl.t].label +
            '" data-val="' +
            fl.v +
            '" data-dir="' +
            fl.d +
            '" style="cursor:pointer">';
          svg +=
            '<path d="M' +
            x1 +
            " " +
            y1 +
            " C" +
            cx1 +
            " " +
            y1 +
            " " +
            cx2 +
            " " +
            y2 +
            " " +
            x2 +
            " " +
            y2 +
            '" fill="none" stroke="' +
            flowColor +
            '" stroke-width="' +
            thickness +
            '" class="mig-path" data-base="' +
            flowColor +
            '" data-hover="' +
            hoverColor +
            '"/>';
          if (fl.v > maxFlow * 0.08) {
            var midY = y1 + (y2 - y1) * 0.5;
            svg +=
              '<text x="' +
              W / 2 +
              '" y="' +
              (midY - 1) +
              '" text-anchor="middle" font-size="8" font-weight="700" fill="' +
              (fl.d === "up"
                ? "#00b894"
                : fl.d === "down"
                  ? "#d63031"
                  : "#9990ab") +
              '" opacity=".5" class="mig-flow-label">' +
              fl.v.toLocaleString() +
              "</text>";
          }
          svg += "</g>";
        });

        // Left nodes
        leftNodes.forEach(function (n, i) {
          svg +=
            '<rect x="0" y="' +
            n.y +
            '" width="' +
            nodeW +
            '" height="' +
            nodeH +
            '" rx="5" fill="' +
            n.color +
            '" opacity="0.1"/>';
          svg +=
            '<text x="8" y="' +
            (n.y + 12) +
            '" font-size="9" font-weight="700" fill="' +
            n.color +
            '">' +
            n.name +
            "</text>";
          svg +=
            '<text x="8" y="' +
            (n.y + 23) +
            '" font-size="7.5" fill="' +
            n.color +
            '" opacity=".5">' +
            n.total.toLocaleString() +
            " buyers</text>";
        });

        // Right nodes
        rightNodes.forEach(function (n, i) {
          svg +=
            '<rect x="' +
            (W - nodeW) +
            '" y="' +
            n.y +
            '" width="' +
            nodeW +
            '" height="' +
            nodeH +
            '" rx="5" fill="' +
            n.color +
            '" opacity="0.1"/>';
          svg +=
            '<text x="' +
            (W - nodeW + 8) +
            '" y="' +
            (n.y + 12) +
            '" font-size="9" font-weight="700" fill="' +
            n.color +
            '">' +
            n.name +
            "</text>";
          svg +=
            '<text x="' +
            (W - nodeW + 8) +
            '" y="' +
            (n.y + 23) +
            '" font-size="7.5" fill="' +
            n.color +
            '" opacity=".5">' +
            n.total.toLocaleString() +
            " buyers</text>";
        });

        // Column labels
        svg +=
          '<text x="' +
          nodeW / 2 +
          '" y="10" text-anchor="middle" font-size="8" font-weight="600" fill="#9990ab" letter-spacing=".5">' +
          leftLabel.toUpperCase() +
          "</text>";
        svg +=
          '<text x="' +
          (W - nodeW / 2) +
          '" y="10" text-anchor="middle" font-size="8" font-weight="600" fill="#9990ab" letter-spacing=".5">' +
          rightLabel.toUpperCase() +
          "</text>";
        svg += "</svg>";

        // Hover tooltip container
        svg +=
          '<div id="migTooltip" style="display:none;position:absolute;z-index:30;background:#fff;border:1px solid var(--card-border);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:12px 16px;pointer-events:auto;min-width:220px"></div>';

        // Summary line
        var upTotal = 0,
          downTotal = 0,
          stayTotal = 0;
        flows.forEach(function (fl) {
          if (fl.d === "up") upTotal += fl.v;
          else if (fl.d === "down") downTotal += fl.v;
          else stayTotal += fl.v;
        });
        var summaryLine = isAttr
          ? '<div style="margin-top:10px;padding:8px 12px;background:linear-gradient(135deg,#f0eeff,#faf9fd);border-radius:8px;border:1px solid #e0dced;font-size:11px;color:var(--text-secondary);line-height:1.5"><strong style="color:var(--purple-accent)">' +
            upTotal.toLocaleString() +
            ' media-driven upgrades</strong> vs <strong style="color:var(--red)">' +
            downTotal.toLocaleString() +
            " downgrades</strong> among exposed buyers. Media is driving a <strong>" +
            (upTotal / Math.max(downTotal, 1)).toFixed(1) +
            "x</strong> net positive migration ratio.</div>"
          : '<div style="margin-top:10px;padding:8px 12px;background:linear-gradient(135deg,#e8faf5,#f0fcf8);border-radius:8px;border:1px solid #c8e8d8;font-size:11px;color:var(--text-secondary);line-height:1.5"><strong style="color:var(--teal)">' +
            upTotal.toLocaleString() +
            ' buyers moved up</strong> the loyalty ladder, <strong style="color:var(--red)">' +
            downTotal.toLocaleString() +
            " moved down</strong>, and <strong>" +
            stayTotal.toLocaleString() +
            " retained</strong> their cohort. Net migration ratio: <strong>" +
            (upTotal / Math.max(downTotal, 1)).toFixed(1) +
            "x</strong> positive.</div>";

        // AI Audience Recommendations based on migration patterns
        var aiRecos = "";
        aiRecos +=
          '<div style="margin-top:14px;padding:14px;background:linear-gradient(135deg,#f8f7ff,#f0eeff);border-radius:10px;border:1px solid #e0dced">';
        aiRecos +=
          '<div style="display:flex;align-items:center;gap:6px;margin-bottom:10px"><div class="ai-typing" style="animation:none;width:16px;height:16px;background:linear-gradient(135deg,var(--purple-accent),#a29bfe);border-radius:4px;display:flex;align-items:center;justify-content:center"><svg viewBox="0 0 24 24" width="10" height="10" fill="none" stroke="#fff" stroke-width="2"><path d="M12 2l3 7h7l-5.5 4 2 7L12 16l-6.5 4 2-7L2 9h7z"/></svg></div><span style="font-size:11px;font-weight:700;color:var(--purple-accent)">AI Audience Recommendations</span><span style="font-size:9px;color:var(--text-tertiary)">Based on migration patterns</span></div>';
        aiRecos += '<div style="display:flex;flex-direction:column;gap:8px">';

        // Reco 1: Revive lapsed customers
        var lapsedDown = 0;
        flows.forEach(function (fl) {
          if (
            (fl.f === 0 || fl.f === 1 || fl.f === 4 || fl.f === 5) &&
            fl.f > fl.t &&
            fl.d === "down"
          )
            lapsedDown += fl.v;
        });
        aiRecos +=
          '<div style="display:flex;align-items:center;gap:12px;padding:10px 12px;background:#fff;border-radius:8px;border:1px solid var(--card-border)">';
        aiRecos += '<div style="flex:1;min-width:0">';
        aiRecos +=
          '<div style="font-size:11px;font-weight:700;color:var(--text-primary)">Revive Lapsed & Lapsing Buyers</div>';
        aiRecos +=
          '<div style="font-size:10px;color:var(--text-secondary);line-height:1.4;margin-top:2px"><strong style="color:var(--red)">' +
          downTotal.toLocaleString() +
          "</strong> buyers migrated down the loyalty ladder. Target those who were active Frequent or Loyal buyers and have since lapsed — they already know the brand but need a reason to come back.</div>";
        aiRecos += "</div>";
        aiRecos +=
          "<button class=\"btn btn-primary btn-sm\" style=\"white-space:nowrap;flex-shrink:0;font-size:9px\" onclick=\"document.getElementById('audInput').value='Previously Frequent and Loyal buyers who lapsed or moved down — winback campaign targeting buyers with proven purchase history who have gone dormant in the last 3-6 months';openDrawer('audience');showToast('Seeded: Lapsed Winback audience')\">Build Audience →</button>";
        aiRecos += "</div>";

        // Reco 2: Accelerate new-to-category to loyalty
        var ntcUp = 0;
        flows.forEach(function (fl) {
          if (fl.f === 0 && fl.t > fl.f && fl.d === "up") ntcUp += fl.v;
        });
        aiRecos +=
          '<div style="display:flex;align-items:center;gap:12px;padding:10px 12px;background:#fff;border-radius:8px;border:1px solid var(--card-border)">';
        aiRecos += '<div style="flex:1;min-width:0">';
        aiRecos +=
          '<div style="font-size:11px;font-weight:700;color:var(--text-primary)">Accelerate New-to-Category → Loyalty</div>';
        aiRecos +=
          '<div style="font-size:10px;color:var(--text-secondary);line-height:1.4;margin-top:2px"><strong style="color:var(--teal)">' +
          ntcUp.toLocaleString() +
          "</strong> new-to-category buyers progressed to light or frequent status. Double down — seed an audience from these early converts to accelerate them up the loyalty ladder with frequency-driving creative.</div>";
        aiRecos += "</div>";
        aiRecos +=
          "<button class=\"btn btn-primary btn-sm\" style=\"white-space:nowrap;flex-shrink:0;font-size:9px\" onclick=\"document.getElementById('audInput').value='New-to-Category buyers who became Ultra-Light or Frequent — accelerate their purchase frequency with repeat-visit incentives and loyalty-driving messaging';openDrawer('audience');showToast('Seeded: NTC Acceleration audience')\">Build Audience →</button>";
        aiRecos += "</div>";

        // Reco 3: Defend against competitor conquest
        var compLoss = 0;
        flows.forEach(function (fl) {
          if (fl.f === 1 && fl.t < fl.f) compLoss += fl.v;
        });
        aiRecos +=
          '<div style="display:flex;align-items:center;gap:12px;padding:10px 12px;background:#fff;border-radius:8px;border:1px solid var(--card-border)">';
        aiRecos += '<div style="flex:1;min-width:0">';
        aiRecos +=
          '<div style="font-size:11px;font-weight:700;color:var(--text-primary)">Defend Against Competitive Switching</div>';
        aiRecos +=
          '<div style="font-size:10px;color:var(--text-secondary);line-height:1.4;margin-top:2px">Competitor Conquest buyers who didn\'t stick are at high risk of switching back. Build a retention audience from conquest buyers who regressed — they tried you once but need reinforcement to stay.</div>';
        aiRecos += "</div>";
        aiRecos +=
          "<button class=\"btn btn-primary btn-sm\" style=\"white-space:nowrap;flex-shrink:0;font-size:9px\" onclick=\"document.getElementById('audInput').value='Competitor Conquest buyers who regressed or lapsed — defensive retention campaign to prevent switch-back with value-reinforcing creative';openDrawer('audience');showToast('Seeded: Conquest Defense audience')\">Build Audience →</button>";
        aiRecos += "</div>";

        aiRecos += "</div></div>";

        mb.innerHTML =
          '<div style="position:relative">' +
          svg +
          "</div>" +
          summaryLine +
          aiRecos;

        // Attach hover events
        setTimeout(function () {
          document.querySelectorAll(".mig-flow").forEach(function (g) {
            g.addEventListener("mouseenter", function (e) {
              var path = g.querySelector(".mig-path");
              path.setAttribute("stroke", path.dataset.hover);
              path.setAttribute(
                "stroke-width",
                parseFloat(path.getAttribute("stroke-width")) * 1.5,
              );
              // Dim other flows
              document.querySelectorAll(".mig-flow").forEach(function (og) {
                if (og !== g) {
                  og.style.opacity = "0.2";
                }
              });
              // Show tooltip
              var tip = document.getElementById("migTooltip");
              var from = g.dataset.from,
                to = g.dataset.to,
                val = parseInt(g.dataset.val),
                dir = g.dataset.dir;
              var dirLabel =
                dir === "up"
                  ? '<span style="color:var(--teal)">▲ Moved Up</span>'
                  : dir === "down"
                    ? '<span style="color:var(--red)">▼ Moved Down</span>'
                    : '<span style="color:var(--text-tertiary)">● Retained</span>';
              tip.innerHTML =
                '<div style="font-size:12px;font-weight:700;margin-bottom:4px">' +
                from +
                " → " +
                to +
                "</div>" +
                '<div style="font-size:10px;color:var(--text-secondary);margin-bottom:8px">' +
                dirLabel +
                " · <strong>" +
                val.toLocaleString() +
                "</strong> buyers</div>" +
                "<button class=\"btn btn-primary btn-sm\" style=\"width:100%;justify-content:center;font-size:9px\" onclick=\"event.stopPropagation();document.getElementById('migTooltip').style.display='none';document.getElementById('audInput').value='" +
                from.replace(/'/g, "\\'") +
                " buyers who migrated to " +
                to.replace(/'/g, "\\'") +
                "';openDrawer('audience');showToast('Seeded audience: " +
                from.replace(/'/g, "\\'") +
                " → " +
                to.replace(/'/g, "\\'") +
                "')\">Publish Audience →</button>";
              var rect = g.getBoundingClientRect();
              var container = mb.getBoundingClientRect();
              tip.style.display = "";
              tip.style.left =
                rect.left - container.left + rect.width / 2 - 110 + "px";
              tip.style.top = rect.top - container.top - 80 + "px";
            });
            g.addEventListener("mouseleave", function () {
              var path = g.querySelector(".mig-path");
              path.setAttribute("stroke", path.dataset.base);
              path.setAttribute(
                "stroke-width",
                parseFloat(path.getAttribute("stroke-width")) / 1.5,
              );
              document.querySelectorAll(".mig-flow").forEach(function (og) {
                og.style.opacity = "1";
              });
              // Delay-hide tooltip
              setTimeout(function () {
                var tip = document.getElementById("migTooltip");
                if (tip && !tip.matches(":hover")) tip.style.display = "none";
              }, 300);
            });
          });
          var tip = document.getElementById("migTooltip");
          if (tip)
            tip.addEventListener("mouseleave", function () {
              this.style.display = "none";
            });
        }, 100);
      }
      updateMigration();

      // ═══ COLLAPSIBLE SECTIONS ═══
      function toggleSection(headerEl) {
        var card = headerEl.closest(".collapsible-card");
        if (card) card.classList.toggle("collapsed");
        updateCollapseAllLabel();
        // Force Chart.js to resize after expand
        if (
          card &&
          !card.classList.contains("collapsed") &&
          typeof salesChart !== "undefined" &&
          salesChart
        ) {
          setTimeout(function () {
            salesChart.resize();
          }, 50);
        }
      }
      function toggleAllSections() {
        var cards = document.querySelectorAll(".collapsible-card");
        var anyExpanded = Array.from(cards).some(function (c) {
          return !c.classList.contains("collapsed");
        });
        cards.forEach(function (c) {
          if (anyExpanded) c.classList.add("collapsed");
          else c.classList.remove("collapsed");
        });
        updateCollapseAllLabel();
      }
      function updateCollapseAllLabel() {
        var cards = document.querySelectorAll(".collapsible-card");
        var anyExpanded = Array.from(cards).some(function (c) {
          return !c.classList.contains("collapsed");
        });
        var label = document.getElementById("collapseAllLabel");
        if (label)
          label.textContent = anyExpanded ? "Collapse All" : "Expand All";
      }

      // ═══ AUDIENCE LIBRARY ═══
      function showAudTab(tab, el) {
        document.querySelectorAll(".aud-tab").forEach(function (t) {
          t.classList.remove("active");
        });
        el.classList.add("active");
        document.getElementById("audTabBuilder").style.display =
          tab === "builder" ? "" : "none";
        document.getElementById("audTabLibrary").style.display =
          tab === "library" ? "" : "none";
        if (tab === "library") renderLibrary();
      }
      function renderLibrary() {
        var libs = [
          {
            n: "QSR Frequent Diners",
            s: "4+ QSR visits/month, all brands",
            r: "3.8M",
          },
          {
            n: "BK Lapsed 90-Day",
            s: "Purchased BK 90-180 days ago",
            r: "1.2M",
          },
          {
            n: "Fast Food Value Seekers",
            s: "High coupon/deal usage, price-sensitive",
            r: "2.9M",
          },
          {
            n: "Competitive QSR Switchers",
            s: "Changed primary QSR brand last 6mo",
            r: "1.6M",
          },
          {
            n: "Family Meal Buyers",
            s: "$30+ avg order, has children",
            r: "2.1M",
          },
          { n: "Late Night QSR", s: "Purchases 9PM-2AM, 2x+/month", r: "890K" },
          {
            n: "QSR + Grocery Cross-Shop",
            s: "Buy QSR and Walmart/Target weekly",
            r: "4.1M",
          },
          {
            n: "Mobile Order Adopters",
            s: "50%+ QSR orders via app",
            r: "1.4M",
          },
        ];
        document.getElementById("libCards").innerHTML = libs
          .map(function (l) {
            return (
              '<div class="lib-card" onclick="showToast(\'Adding ' +
              l.n +
              '...\')"><div><div style="font-size:12.5px;font-weight:600">' +
              l.n +
              '</div><div style="font-size:11px;color:var(--text-secondary);margin-top:2px">' +
              l.s +
              '</div></div><div style="font-size:12px;font-weight:700;color:var(--purple-accent)">' +
              l.r +
              "</div></div>"
            );
          })
          .join("");
      }

      // ═══ COLLAPSIBLE FILTERS ═══
      function toggleFilters() {
        var bar = document.getElementById("filterBar");
        var btn = document.getElementById("filterCollapseBtn");
        var inner = document.getElementById("filterInner");
        if (inner.style.display === "none") {
          inner.style.display = "flex";
          btn.classList.remove("collapsed");
        } else {
          inner.style.display = "none";
          btn.classList.add("collapsed");
        }
      }

      // ═══ REPORTS SHELF ═══
      function toggleReports() {
        document.getElementById("reportsShelf").classList.toggle("open");
      }
    </script>
    <!-- Weekly Report Settings & Preview Modal -->
    <div
      class="rpt-overlay"
      id="rptOverlay"
      style="display: none"
      onclick="if (event.target === this) closeReportModal();"
    >
      <div class="rpt-modal">
        <div class="rpt-header">
          <h3>Weekly Report — <span id="rptCampName"></span></h3>
          <button
            style="
              background: none;
              border: none;
              cursor: pointer;
              padding: 4px;
            "
            onclick="closeReportModal()"
          >
            <svg
              viewBox="0 0 24 24"
              width="18"
              height="18"
              fill="none"
              stroke="var(--text-secondary)"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="rpt-body">
          <div class="rpt-settings">
            <div class="rpt-toggle-wrap">
              <div
                class="rpt-toggle on"
                id="rptToggle"
                onclick="this.classList.toggle('on')"
              ></div>
              <span
                style="font-size: 12px; font-weight: 600"
                id="rptToggleLabel"
                >Active</span
              >
            </div>
            <div class="rpt-settings-group">
              <div class="rpt-settings-label">Frequency</div>
              <select
                class="intake-input"
                id="rptFreq"
                style="font-size: 11px; padding: 7px 10px"
              >
                <option value="weekly" selected="">Weekly (Mondays)</option>
                <option value="biweekly">Bi-Weekly</option>
                <option value="daily">Daily</option>
              </select>
            </div>
            <div class="rpt-settings-group">
              <div class="rpt-settings-label">Send Time</div>
              <select
                class="intake-input"
                id="rptTime"
                style="font-size: 11px; padding: 7px 10px"
              >
                <option value="6am">6:00 AM ET</option>
                <option value="7am">7:00 AM ET</option>
                <option value="8am" selected="">8:00 AM ET</option>
                <option value="9am">9:00 AM ET</option>
                <option value="10am">10:00 AM ET</option>
                <option value="12pm">12:00 PM ET</option>
                <option value="3pm">3:00 PM ET</option>
                <option value="5pm">5:00 PM ET</option>
              </select>
            </div>
            <div class="rpt-settings-group">
              <div class="rpt-settings-label">Send To</div>
              <textarea
                class="intake-input"
                id="rptRecipients"
                rows="3"
                style="font-size: 11px; padding: 7px 10px"
                placeholder="vlad@attainoutcomes.com
media.buyer@agency.com"
              ></textarea>
            </div>
            <div class="rpt-settings-group">
              <div class="rpt-settings-label">Next Send</div>
              <div
                style="
                  font-size: 12px;
                  font-weight: 600;
                  color: var(--text-primary);
                "
              >
                Monday, Feb 17
              </div>
              <div
                style="
                  font-size: 10px;
                  color: var(--text-tertiary);
                  margin-top: 2px;
                "
                id="rptNextTime"
              >
                Delivers 8:00 AM ET
              </div>
            </div>
            <div
              style="
                border-top: 1px solid var(--card-border);
                padding-top: 12px;
                margin-top: 12px;
              "
            >
              <div
                class="rpt-settings-label"
                style="
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  margin-bottom: 8px;
                "
              >
                <span>Campaign Context</span
                ><span
                  style="
                    font-size: 9px;
                    color: var(--text-tertiary);
                    font-weight: 400;
                  "
                  >From intake — edits update report</span
                >
              </div>
              <div class="rpt-settings-group">
                <div class="rpt-settings-label">Objective</div>
                <textarea
                  class="intake-input"
                  id="rptContext"
                  rows="3"
                  style="font-size: 11px; padding: 7px 10px"
                  onchange="updateCampContext()"
                ></textarea>
              </div>
              <div class="rpt-settings-group">
                <div class="rpt-settings-label">Target KPIs</div>
                <textarea
                  class="intake-input"
                  id="rptKpis"
                  rows="2"
                  style="font-size: 11px; padding: 7px 10px"
                  onchange="updateCampContext()"
                ></textarea>
              </div>
              <div class="rpt-settings-group">
                <div class="rpt-settings-label">Target Audiences</div>
                <textarea
                  class="intake-input"
                  id="rptAudience"
                  rows="2"
                  style="font-size: 11px; padding: 7px 10px"
                  onchange="updateCampContext()"
                ></textarea>
              </div>
              <div class="rpt-settings-group">
                <div class="rpt-settings-label">Channels &amp; Formats</div>
                <textarea
                  class="intake-input"
                  id="rptChannels"
                  rows="2"
                  style="font-size: 11px; padding: 7px 10px"
                  onchange="updateCampContext()"
                ></textarea>
              </div>
            </div>
            <div
              style="
                border-top: 1px solid var(--card-border);
                padding-top: 12px;
                margin-top: 12px;
              "
            >
              <button
                class="btn btn-primary btn-sm"
                style="width: 100%; justify-content: center; font-size: 11px"
                onclick="
                  showToast('Report settings saved');
                  closeReportModal();
                "
              >
                Save Settings
              </button>
              <button
                class="btn btn-outline btn-sm"
                style="
                  width: 100%;
                  justify-content: center;
                  font-size: 11px;
                  margin-top: 6px;
                "
                onclick="showToast('Sending test email...')"
              >
                Send Test Email
              </button>
            </div>
          </div>
          <div class="rpt-preview" id="rptPreview">
            <!-- Email preview rendered by JS -->
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
